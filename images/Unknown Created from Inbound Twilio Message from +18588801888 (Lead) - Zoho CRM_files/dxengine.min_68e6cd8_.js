!function(t){var DXEngine=null,e=null,r=null,n=null,i=null,o=window,s="DXEngine",a=!1,l="",u=3e3,p=null,h=[],c=null,E=null,g=null;DXEngine=(n=n||o)[i=i||s]||null;var d=0,_=0,f={};function y(t){return function(e){var r=this._callbackStack[t];return"function"==typeof e&&r.push(e),this}}for(g in msgUID=function(){return d=Math.random().toString(36).substring(2,15)+ ++_+Math.random().toString(36).substring(2,15)},null!==DXEngine&&(e=DXEngine),E=Array.prototype.slice,r=window.Worker,(DXEngine=function(){this._constructor.apply(this,arguments)})._dxinstance={},DXEngine.prototype._$=null,DXEngine.prototype._callbackStack=null,DXEngine.prototype._lastError=null,DXEngine.prototype._coreWorker=null,DXEngine.prototype._state=null,DXEngine.prototype._uqe=null,DXEngine.prototype._workerBlobUrl=null,DXEngine.prototype._workerUrl=null,DXEngine.prototype._constructor=function(e,r){e=e||"cscript",DXEngine._dxinstance[e]?Object.assign(this,DXEngine._dxinstance[e]):(Object.defineProperty(this,"_$",{configurable:!1,enumerable:!0,value:t(this),writable:!1}),r=r||null,this._callbackStack={error:[],loading:[],loaded:[],injecting:[],starting:[],restarting:[],started:[],terminating:[],terminated:[]},this._assignEventHandlers(),this._state=DXEngine.State.INITIALIZED,this._uqe=Math.floor(899999*Math.random()+1e5),this.trigger(DXEngine.Event.INITIALIZED),DXEngine._dxinstance[e]=this)},DXEngine.prototype.getUrl=function(){return this._workerUrl},DXEngine.prototype.getBlobUrl=function(){return this._workerBlobUrl},DXEngine.prototype.getLogs=function(){return h},DXEngine.prototype.getCoreWorker=function(){return this._coreWorker},DXEngine.prototype.getState=function(){return this._state},DXEngine.prototype.isLoading=function(){return this.getState()===DXEngine.State.LOADING},DXEngine.prototype.isLoaded=function(){return this.getState()>=DXEngine.State.LOADED&&!this.isTerminated()},DXEngine.prototype.isStarting=function(){return this.getState()===DXEngine.State.STARTING},DXEngine.prototype.isStarted=function(){return this.getState()>=DXEngine.State.STARTED&&!this.isTerminated()},DXEngine.prototype.isTerminated=function(){return this.getState()===DXEngine.State.TERMINATED},DXEngine.prototype.load=function(){var t=this;return t.isLoading()||t.isLoaded()||(t.trigger(DXEngine.Event.ENGINE_LOADING),t.getUrl(),function(){var e=null;if(""===l)throw"preScriptURI not found";fetch(l).then((t=>t.text())).then((r=>{e=new window.Blob([`(function () { \n ${r.replace(/\{\{_uqe\}\}/g,t._uqe)}\n})()`],{type:"text/javascript"}),t._workerBlobUrl=window.URL.createObjectURL(e),t._createWorker(),URL.revokeObjectURL(t._workerBlobUrl)}))}()),t},DXEngine.prototype._onEngineStarted=function(t){this.dispatchEvent.apply(this,t.data)},DXEngine.prototype._getCircularReplacer=function(){const t=new WeakSet;return(e,r)=>{if("object"==typeof r&&null!==r){if(t.has(r))return;t.add(r)}return r}},DXEngine.prototype.log=function(){var t=Array.prototype.slice.call(arguments)[0],e=(t.timeStamp,t.data,this),r=t.data.shift(),n={timeStamp:t.timeStamp,msg_head:r,message:t.data.map((function(t){return"object"==typeof t?JSON.stringify(t,e._getCircularReplacer()):t})).join("")};return h.push(n),this},DXEngine.prototype._createWorker=function(){return this._coreWorker=new r(this.getBlobUrl()),this._attachMessageParser(),this},DXEngine.prototype._assignEventHandlers=function(){function t(t){return function(){var e,r=this._callbackStack[t];(e=t.toUpperCase())in DXEngine.State&&(this._state=DXEngine.State[e]);var n=this;r.forEach((function(t){t.apply(n,arguments)}))}}return this.on(DXEngine.Event.ERROR,t("error")),this.on(DXEngine.Event.ENGINE_LOADED,t("loaded")),this.on(DXEngine.Event.ENGINE_STARTED,t("started")),this.on(DXEngine.Event.ENGINE_RESTARTING,t("restarting")),this.on(DXEngine.Event.ENGINE_TERMINATED,t("terminated")),this.on("eval_response",this.eventResponseFn),this},DXEngine.prototype.onError=y("error"),DXEngine.prototype.onLoad=y("loaded"),DXEngine.prototype.onStart=y("started"),DXEngine.prototype.onRestart=y("restarting"),DXEngine.prototype.onTerminate=y("terminated"),DXEngine.prototype.flushListeners=function(t){this._callbackStack[t]=[]},DXEngine.prototype.start=function(){var t=null;return this.isStarting()||this.isStarted()?this:(t=E.call(arguments),this.isLoaded()?(h=[],this.trigger(DXEngine.Event.ENGINE_STARTING),this.sendMessage(DXEngine.Action.START,t),this):(this.isTerminated()||this.on(DXEngine.Event.ENGINE_LOADED,(function(){this.start.apply(this,t)})),this.load(),this))},DXEngine.prototype.restart=function(){if(this.isStarting())return this;var t=E.call(arguments)[0];f[t.uid]&&(f[t.uid].reject({reason:"timeout",event:t.event,current_snippet:t.current_snippet}),delete f[t.uid]),this.trigger(DXEngine.Event.ENGINE_RESTARTING),this.terminateNow(),this.start()},DXEngine.prototype.loadScripts=function(){var t=null;return this.isLoaded()?(t=E.call(arguments),this.trigger(DXEngine.Event.INJECTING),this.sendMessage(DXEngine.Action.INJECT_SCRIPTS,[t]),this):this},DXEngine.prototype.evalScript=function(){var t=this;if(!this.isLoaded())return this;var e=E.call(arguments)[0],r=AsyncAwait.compile(`${e}`,{functionScope:!1,noExecWrapper:!0,minify:!1,sourceFileName:`${Math.random().toString(36).substring(2,15)}-console`,prefix:!0});return new Promise((function(e,n){f[msgUID()]={resolve:e,reject:n},t.sendMessage(DXEngine.Action.EVAL_SCRIPT,[r],d)}))},DXEngine.prototype.loadVariables=function(){var t=null;return this.isLoaded()?(t=E.call(arguments),this.trigger(DXEngine.Event.INJECTING),this.sendMessage(DXEngine.Action.INJECT_VARIABLES,[t]),this):this},DXEngine.prototype.invokeMethod=function(){var t=null;return this.isLoaded()?(t=E.call(arguments),this.sendMessage(t[0],t.splice(1,t.length)),this):this},DXEngine.prototype.importScripts=function(){var t=null;return this.isLoaded()?(t=E.call(arguments),this.sendMessage("_importScripts",t),this):this},DXEngine.prototype.InjectScript=function(){var t=null;if(!this.isLoaded())return this;t=E.call(arguments);var e=this;return e.trigger(DXEngine.Event.INJECTING),e.sendMessage(DXEngine.Action.INJECT_RESOURCE,t),this},DXEngine.prototype.requestHandler=function(){return this.isLoaded()?(this._$.off.apply(this._$,["zdk_request"]),this._$.off.apply(this._$,["event_response"]),this.on("zdk_request",E.call(arguments)[0]),this.on("event_response",this.eventResponseFn),this):this},DXEngine.prototype.onExecutionStart=function(){return this.isLoaded()?(this._$.off.apply(this._$,["execution_start"]),this.on("execution_start",E.call(arguments)[0]),this):this},DXEngine.prototype.logHandler=function(){return this.isLoaded()?(this._$.off.apply(this._$,["execution_log"]),this.on("execution_log",E.call(arguments)[0]),this):this},DXEngine.prototype.trackerHandler=function(){return this.isLoaded()?(this._$.off.apply(this._$,["tracking"]),this.on("tracking",E.call(arguments)[0]),this):this},DXEngine.prototype.onExecutionEnd=function(){return this.isLoaded()?(this._$.off.apply(this._$,["execution_end"]),this.on("execution_end",E.call(arguments)[0]),this):this},DXEngine.prototype.onExecutionError=function(){return this.isLoaded()?(this._$.off.apply(this._$,["execution_error"]),this.on("execution_error",E.call(arguments)[0]),this.on("execution_error",this.eventResponseFn),this):this},DXEngine.prototype.onExecutionTimeout=function(){return this.isLoaded()?(this._$.off.apply(this._$,["execution_timeout"]),this.on("execution_timeout",E.call(arguments)[0]),this.on("execution_timeout",this.eventResponseFn),this):this},DXEngine.prototype.errorHandler=function(){return this._$.off.apply(this._$,["error"]),this.on("error",E.call(arguments)[0]),this},DXEngine.prototype.restrictObjects=function(){var t=null;return this.isLoaded()?(t=E.call(arguments)[0],this.sendMessage(DXEngine.Action.OVERRIDE_OBJECTS,[t]),this):this},DXEngine.prototype.eventResponseFn=function(t){var e=t.originalEvent||t,r=e.data,n=e.messageUID;f[n]&&(void 0!==r||["execution_error","execution_timeout"].includes(e.type)?f[n].resolve(r):f[n].resolve()),delete f[n]},DXEngine.prototype.isDevelopment=function(){return void 0!==E.call(arguments)[0]&&(a=E.call(arguments)[0],this.sendMessage("isDev",[a])),this},DXEngine.prototype.isDebugMode=function(){return void 0!==E.call(arguments)[0]&&this.sendMessage("isDebug",[E.call(arguments)[0]]),this},DXEngine.prototype.preScriptURI=function(){return void 0!==E.call(arguments)[0]&&(l=E.call(arguments)[0]),this},DXEngine.prototype.setTimeout=function(){void 0!==E.call(arguments)[0]&&(u=E.call(arguments)[0],this.sendMessage("timeout",[u]))},DXEngine.prototype.dispatchEvent=function(){var t=null,e=this;return t=E.call(arguments),this.isStarted()?new Promise((function(r,n){e.isLoaded()||n("engine is idle"),f[msgUID()]={resolve:r,reject:n},e.sendMessage(DXEngine.Action.EXECUTE,t,d)})):(this.one(DXEngine.Event.ENGINE_STARTED,t,this._onEngineStarted),this)},DXEngine.prototype.dispatchResponse=function(){var t=null;if(!this.isLoaded())return this;t=E.call(arguments),this.trigger({type:"zdk_response",messageUID:t[0].messageUID,isError:t[2],data:t[1]})},DXEngine.prototype.sendMessage=function(t,e,r){var n=null,i=null;return e=e||null,null===(t=t||null)||((i={__isDXEngineMsg:!0}).action=t,i.args=e,i.uid=r,e&&e[0]&&"zdk_response"==e[0].type&&(i._triggerAsync=!0),(n=this.getCoreWorker())&&n.postMessage(i)),this},DXEngine.prototype._attachMessageParser=function(){var e=null;return(e=t(this.getCoreWorker())).on("message",t.proxy((function(t){var e=(t.originalEvent||t).data,r=null,n=null;if("object"==typeof e&&"__isDXEngineMsg"in e&&e.__isDXEngineMsg){if(r=e.action,n=e.args,!this[r])throw" :: "+r+" is undefined";this[r].apply(this,n)}}),this)),e.on("error",t.proxy(this.throwError,this)),this},DXEngine.prototype.terminate=function(){var t=this.getCoreWorker()||null;return h=[],t&&(this.trigger(DXEngine.Event.ENGINE_TERMINATING),this.sendMessage(DXEngine.Action.TERMINATE,E.call(arguments))),this},DXEngine.prototype.terminateNow=function(){var t=null;return h=[],this._$.off.apply(this._$,[DXEngine.Event.ENGINE_STARTED,void 0,this._onEngineStarted]),this.trigger(DXEngine.Event.ENGINE_TERMINATING),(t=this.getCoreWorker()||null)&&(t.terminate(),this._coreWorker=null,this.trigger(DXEngine.Event.ENGINE_TERMINATED)),this},DXEngine.prototype.on=function(){var t=this._$;return t.on.apply(t,arguments),this},DXEngine.prototype.one=function(){var t=this._$;return t.one.apply(t,arguments),this},DXEngine.prototype.off=function(){var t=this._$;return t.off.apply(t,arguments),this._assignEventHandlers(),this},DXEngine.prototype.trigger=function(e){var r=!1,n=null,i=null;return"object"==typeof e&&(n=e.type||null),"string"==typeof e&&(n=e||null,r=!0),null===n?this:n in p?(r&&(e=new t.Event(n)),e.worker=this,i=[e],arguments.length>1&&(i=i.concat(E.call(arguments,1))),this._triggerSelf.apply(this,i),this):(r&&(e={type:n,data:null}),i=[e],this.sendMessage(DXEngine.Action.trigger_SELF,i),this)},DXEngine.prototype.triggerSelf=function(e){var r=null,n=null;return null===(e=e||null)||("string"==typeof e&&(r=e,e=new t.Event(r)),e.originalEvent=e.originalEvent||e,e.worker=this,n=[e],arguments.length>1&&(n=n.concat(E.call(arguments,1))),this._triggerSelf.apply(this,n)),this},DXEngine.prototype._triggerSelf=function(){var t=null;return(t=this._$).trigger.apply(t,arguments),this},DXEngine.prototype.throwError=function(t,e,r){var n=null;if("object"==typeof(t=t||c.UNKNOWN)&&(n=(t=t.originalEvent||t).data||null),n=void 0===e?n:e,r=r||!1,this._lastError=t,DXEngine._lastError=t,"_triggerError"in this&&this._triggerError(t,e,r),r)throw new window.Error(t);return this},DXEngine.prototype._triggerError=function(e,r,n){var i=null;return(i=new t.Event(DXEngine.Event.ERROR)).message=this.getLastError(),i.errorData=r,i.throwsException=!!n,this.trigger(i),this},DXEngine.prototype.getLastError=function(){return this._lastError},DXEngine._lastError=null,DXEngine.State={INITIALIZED:0,LOADING:1,LOADED:2,STARTING:3,STARTED:4,TERMINATING:5,TERMINATED:6},DXEngine.Action={LOG:"log",START:"EngineStart",TERMINATE:"EngineKill",INJECT_SCRIPTS:"InjectScript",EVAL_SCRIPT:"EvalScript",INJECT_VARIABLES:"InjectVariable",INJECT_RESOURCE:"InjectResource",OVERRIDE_OBJECTS:"RestrictObjects",EXECUTE:"TriggerCXS",trigger:"trigger",trigger_SELF:"triggerSelf"},DXEngine.Event={INITIALIZED:"initialized",ERROR:"error",ENGINE_LOADING:"engine-loading",ENGINE_LOADED:"engine-loaded",INJECTING_RESOURCE:"engine-injecting-resource",ENGINE_STARTING:"engine-starting",ENGINE_RESTARTING:"engine-restarting",ENGINE_STARTED:"engine-started",ENGINE_TERMINATING:"engine-terminating",ENGINE_TERMINATED:"engine-terminated"},p={},DXEngine.EventMap=p,DXEngine.Event)DXEngine.Event[g]="dx-engine:"+DXEngine.Event[g],p[DXEngine.Event[g]]=g;c={UNKNOWN:"An unknown error occured.",INVALID_ARGUMENTS:"Invalid arguments were supplied to this method.",ENGINE_DID_NOT_LOAD:"Unable to load worker."},DXEngine.Error=c,DXEngine.getLastError=DXEngine.prototype.getLastError,DXEngine.changeContext=function(t,r){return t=t||null,r=r||null,o.DXEngine===DXEngine&&(delete o.DXEngine,e&&(o.DXEngine=e)),t&&r&&(t[r]=DXEngine),DXEngine},n[i]=DXEngine}(jQuery);
