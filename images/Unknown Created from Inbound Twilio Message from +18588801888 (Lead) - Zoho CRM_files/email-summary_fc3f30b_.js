Lyte.Component.register("email-summary",{_template:'<template tag-name="email-summary"> <lyte-popover lt-prop-show-close-button="false" lt-prop-auto-align="true" lt-prop-duration="{{ud}}" lt-prop-content-padding="0px" lt-prop-origin-elem=".summary_{{message_id}}" lt-prop-close-on-body-click="true" lt-prop-show="true" lt-prop-freeze="false" lt-prop-placement="left right" lt-prop-width="440px" class="ecnSummeryView w440 curv3px pA dIB bgwit" id="emailSummaryPopOver"> <template is="registerYield" yield-name="popover"> <lyte-popover-content> <div id="ecnSummeryView"> <div class="p20"> <template is="if" value="{{expHandlers(hasSummary,\'!\')}}"><template case="true"> <div id="SummaryDetailView"> <div class="flexCenter pB20 pT25"> <div class="fDC dF alignItemCenter"> <span class="noSummaryAvailableCRM dIB mB20"></span> <span class="proximas col36 f14">{{getI18n(\'crm.view.email.summary.not.available\')}}</span> </div> </div> <div class="aligncenter pB10"> <a class="dIB zcrm_svgIcons ern-info vam cP" href="{{getSummaryHelpLink()}}" target="_blank" rel="noopener noreferrer"></a> <span class="vam helpLinkColor">{{getI18n(\'crm.view.email.how.summary.works\')}}</span> </div> </div> </template><template case="false"><template is="if" value="{{isLoading}}"><template case="true"> <div id="summaryLoading" class="alignItemCenter dF jCC summaryLoading"> <div class="loading-ring"><div id="loadingRingDiv"></div><div></div><div></div><div></div></div> </div> </template><template case="false"> <div class="ecnSView"> <div class="alignCenter dF ecnSVHeader pB10 spaceBetween"> <span data-zcqa="summarySubject" class="crm-font-bold f18 ellipsistext" style="overflow-wrap: break-word;" title="{{mail.subject}}">{{mail.subject}}</span> <span class="cP ernSummaryBlue f14 fR noWrap" onclick="{{action(\'openViewMail\')}}">{{getI18n(\'crm.signal.view.email.link\')}}</span> </div> <div class="f14px pB15 ernSummeryList" style="overflow-wrap: break-word;" data-zcqa="summaryContent"> {{mail.summary}} </div> <div class="cBafter f13"> <template is="if" value="{{expHandlers(mail.attachLen,\'>\',0)}}"><template case="true"> <div class="fL" id="attachmentsDiv"> <span class="ernBlueTxt" id="attachLen">{{mail.attachLen}}</span><span class="ernSort ernBlueTxt cP mL5" onclick="{{action(\'ernShowAttachmentView\',this)}}" data-zcqa="attachmentList">{{getI18n(\'Attachments\')}}</span> </div> </template></template><template is="if" value="{{expHandlers(mail.isScheduled,\'&amp;&amp;\',mail.isEditable)}}"><template case="true"> <div class="fR" id="editMail"> <span class="pL20 ernBlueTxt cP" onclick="{{action(\'openComposeView\',this)}}" data-zcqa="editMail">{{getI18n(\'crm.button.edit\')}}</span> </div> </template><template case="false"><template is="if" value="{{expHandlers(mail.isFailed,\'&amp;&amp;\',mail.isEditable)}}"><template case="true"> <div class="fR" id="resendMail"> <span class="pL20 ernBlueTxt cP" onclick="{{action(\'openComposeView\',this)}}" data-zcqa="resendMail">{{getI18n(\'crm.button.resend\')}}</span> </div> </template><template case="false"><template is="if" value="{{expHandlers(expHandlers(mail.isScheduled,\'!\'),\'&amp;&amp;\',expHandlers(mail.isFailed,\'!\'))}}"><template case="true"> <div class="fR" id="replyOptions"> <template is="if" value="{{emailConfigured}}"><template case="true"> <span class="pL20 ernBlueTxt cP" onclick="{{action(\'replyMail\',module,entityId,\'reply\',mailType)}}" data-zcqa="replyMail">{{getI18n(\'crm.button.reply\')}}</span> <span class="ceDropDownIcon dIB vab cP" onclick="{{action(\'ernShowOptions\')}}" data-zcqa="replyDropDown"></span> </template><template case="false"> <span class="pL20 ernBlueTxt cP" onclick="{{action(\'mailPrintView\',mailType)}}" data-zcqa="printPreviewMail">{{getI18n(\'crm.button.print.view\')}}</span> </template></template> </div> </template></template></template></template></template></template> </div> </div>   <template is="if" value="{{mail.attach}}"><template case="true"> <div class="ecnAttachment pA dIB bgwit curv3px hide" id="ecnAttachment"> <lyte-menu lt-prop-query="#attachmentsDiv" lt-prop-yield="true" lt-prop-event="click" lt-prop-position="down" lt-prop-freeze="false" id="ecnAttachmentUl"> <template is="registerYield" yield-name="yield"> <lyte-menu-body> <template is="for" items="{{mail.attach}}" item="attachment" index="index"> <lyte-menu-item data-id="{{attachment.id}}" data-name="{{attachment.name}}" onclick="{{action(\'downloadEmailAttachments\',this)}}" class="m8 p5 ecnAttachmentli" data-zcqa="attachment_{{attachment.id}}" on-before-close="{{method(\'keepMenuOpen\')}}"> <lyte-menu-label><span class="attachmentImg dIB vat mT0 mR5 {{getAttachmentStyle(attachment.name)}}"></span>{{attachment.name}}</lyte-menu-label> </lyte-menu-item> </template> </lyte-menu-body> </template> </lyte-menu> </div> </template></template> <template is="if" value="{{emailConfigured}}"><template case="true"> <div class="ernOptions pT5 pB5 curv3px dIB bgwit pA zI31 hide" id="ernOptions"> <div class="ernOptionList"> <lyte-menu lt-prop-query=".ceDropDownIcon" lt-prop-yield="true" lt-prop-event="click" lt-prop-position="downLeft" lt-prop-freeze="false" on-open="{{method(\'setErnOptionMenuPos\',this)}}" id="replyOptionsMenu" on-close="{{method(&quot;onCloseMenu&quot;)}}"> <template is="registerYield" yield-name="yield"> <lyte-menu-body> <lyte-menu-item onclick="{{action(\'replyMail\',module,entityId,\'replyAll\',mailType)}}" data-zcqa="replyAllMail"> <lyte-menu-label>{{getI18n(\'crm.button.replyall\')}}</lyte-menu-label> </lyte-menu-item> <lyte-menu-item onclick="{{action(\'replyMail\',module,entityId,\'forward\',mailType)}}" data-zcqa="forwardMail"> <lyte-menu-label>{{getI18n(\'crm.email.label.forward\')}}</lyte-menu-label> </lyte-menu-item> <lyte-menu-item onclick="{{action(\'mailPrintView\',mailType)}}" data-zcqa="printPreviewMail"> <lyte-menu-label>{{getI18n(\'crm.button.print.view\')}}</lyte-menu-label> </lyte-menu-item> <lyte-menu-item id="unlinkDeal" class="{{showUnlinkDeal(mail.linked_deal)}}" data-zcqa="unlinkDeal" onclick="{{action(\'linkUnlinkDeal\')}}" data-id="{{getDealId(mail.linked_deal)}}" data-name="{{getDealName(mail.linked_deal)}}"> <lyte-menu-label>{{getI18n(\'crm.relatedList.deals.unlinkdeal\',getSingularLabel(\'Potentials\'))}}</lyte-menu-label> </lyte-menu-item> <lyte-menu-item id="linkDeal" class="{{showlinkDeal(mail.showLinkDeal)}}" data-zcqa="linkDeal" onclick="{{action(\'linkUnlinkDeal\')}}"> <lyte-menu-label>{{getI18n(\'crm.relatedList.deals.link\',getSingularLabel(\'Potentials\'))}}</lyte-menu-label> </lyte-menu-item> </lyte-menu-body> </template> </lyte-menu> </div> </div> </template></template></template></template></template></template> <span id="summaryMailDet" class="hide"></span>  </div></div></lyte-popover-content></template> </lyte-popover> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"attr",position:[1,1,1,1]},{type:"if",position:[1,1,1,1],cases:{true:{dynamicNodes:[{type:"text",position:[1,1,1,3,0]},{type:"attr",position:[1,3,1]},{type:"text",position:[1,3,3,0]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[]},false:{dynamicNodes:[{type:"attr",position:[1,1,1]},{type:"text",position:[1,1,1,0]},{type:"attr",position:[1,1,3]},{type:"text",position:[1,1,3,0]},{type:"text",position:[1,3,1]},{type:"attr",position:[1,5,1]},{type:"if",position:[1,5,1],cases:{true:{dynamicNodes:[{type:"text",position:[1,1,0]},{type:"attr",position:[1,2]},{type:"text",position:[1,2,0]}]}},default:{}},{type:"attr",position:[1,5,2]},{type:"if",position:[1,5,2],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"text",position:[1,1,0]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"text",position:[1,1,0]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]},{type:"attr",position:[3]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]}]}},default:{}}]}},default:{}}]}},default:{}}]}},default:{}},{type:"attr",position:[3]},{type:"if",position:[3],cases:{true:{dynamicNodes:[{type:"registerYield",position:[1,1,1],dynamicNodes:[{type:"attr",position:[1,1]},{type:"for",position:[1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1,0]},{type:"text",position:[1,1,1]},{type:"componentDynamic",position:[1,1]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1,1]}]}},default:{}},{type:"attr",position:[5]},{type:"if",position:[5],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1,1]},{type:"registerYield",position:[1,1,1,1],dynamicNodes:[{type:"attr",position:[1,1]},{type:"text",position:[1,1,1,0]},{type:"componentDynamic",position:[1,1,1]},{type:"componentDynamic",position:[1,1]},{type:"attr",position:[1,3]},{type:"text",position:[1,3,1,0]},{type:"componentDynamic",position:[1,3,1]},{type:"componentDynamic",position:[1,3]},{type:"attr",position:[1,5]},{type:"text",position:[1,5,1,0]},{type:"componentDynamic",position:[1,5,1]},{type:"componentDynamic",position:[1,5]},{type:"attr",position:[1,7]},{type:"text",position:[1,7,1,0]},{type:"componentDynamic",position:[1,7,1]},{type:"componentDynamic",position:[1,7]},{type:"attr",position:[1,9]},{type:"text",position:[1,9,1,0]},{type:"componentDynamic",position:[1,9,1]},{type:"componentDynamic",position:[1,9]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1,1,1]}]}},default:{}}]}},default:{}}]}},default:{}},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1]}],_observedAttributes:["mail","hasSummary","isLoading","emailConfigured","mailType","entityId","module","ud"],data:function(){return{mail:Lyte.attr("object"),hasSummary:Lyte.attr("boolean",{default:!1}),isLoading:Lyte.attr("boolean",{default:!1}),emailConfigured:Lyte.attr("boolean",{default:!1}),mailType:Lyte.attr("string",{default:""}),entityId:Lyte.attr("string",{default:""}),module:Lyte.attr("string",{default:""}),ud:Lyte.attr("string",{default:void 0})}},actions:{openComposeView:function(e){openComposeView(e)},mailPrintView:function(e){mailPrintView(e)},replyMail:function(e,t,a,i){replyMail(e,t,a,i,"summaryView")},linkUnlinkDeal:function(){EntityEmail.linkUnlinkDeal()},downloadEmailAttachments:function(e){var t=$L("#module").val(),a=$L("#id").val(),i=null,n=$L("#selectMails"),l=$L("#isFromNewAPI"),o=$L(e).data("id"),s=$L(e).data("name"),p=$L("#summaryMailDet");if(t=void 0===moduleApiMapping[t]?opener.window.moduleApiMapping[t]:moduleApiMapping[t],n.length>0){var m=void 0===n[0].value?n[0].getAttribute("lt-prop-selected"):n[0].value;l.length>0&&(m=n[0].getAttribute("lt-prop-selected")),i="IMAP_ALL"===m?p.data("mailOwnerId"):m.substring(0,m.indexOf("_"))}null!==i&&""!==i||(i=Crm.userDetails.USER_ID);var r="/crm/email/v2/"+t+"/"+a+"/Emails/attachments",c={};c.id=o,c.name=s,c.user_id=i,c.message_id=p.data("msgid");var d=networkUtils.constructEncodedUrl(r,c),y=new XMLHttpRequest;y.open("GET",d),y.setRequestHeader("X-ZCSRF-TOKEN",csrfParamName+"="+cookieUtils.getCookie("crmcsr")),y.setRequestHeader("X-CRM-ORG",crmZgid),y.responseType="blob",commonUtils.showHideLoadingDiv(!0),y.onload=function(e){if(200===e.currentTarget.status&&e.currentTarget.response.size>0)try{var t=new Blob([e.currentTarget.response],{type:"application/octet-stream"});if(void 0!==window.navigator.msSaveBlob)window.navigator.msSaveBlob(t,s);else{var a=(window.URL||window.webkitURL).createObjectURL(t);if(s){commonUtils.showHideLoadingDiv(!1);var i=document.createElement("a");i.style.display="none",void 0===i.download?window.location=encodeURI(a):(i.href=encodeURI(a),i.download=s,document.getElementById("ecnAttachment").append(i),i.target="_blank",i.click(),i.remove())}else window.location=encodeURI(a)}}catch(e){murphy.error(e),crmui.showMsgBand("error",I18n.getMsg("crm.mail.error"),"3000")}else renderingUtils.displayPermissionDenied(null,null,I18n.getMsg("crm.security.error"))},y.send()},openViewMail:function(){$L(".ernActiveSummary").parents("lyte-tr").find(".rLEmailSub").trigger("click")},ernShowAttachmentView:function(e){ernShowAttachmentView(e)},ernShowOptions:function(e){ernShowOptions(e)}},methods:{setErnOptionMenuPos:function(e){var t=$L(".lyteMenuDown");t.length>1&&(t=$(t.eq(1)));var a=parseInt(t.css("left"));t.css("left",a+10)},keepMenuOpen:function(){return!1},onCloseMenu:function(){$L(".ernOptionOpens").removeClass("ernOptionOpens")}}}),Lyte.Component.registerHelper("getAttachmentStyle",(function(e){var t="";switch(e.substr(e.lastIndexOf(".")+1).toLowerCase()){case"jpg":case"gif":case"png":case"jpeg":case"bmp":t="attachmentsPng";break;case"pdf":t="attachmentsPdf";break;case"docx":case"doc":t="attachmentsDocx";break;case"ppt":case"pptx":t="attachmentsPpt";break;case"xlsx":case"xls":t="attachmentsXls";break;case"html":case"xml":case"xhtml":t="attachmentsHtml";break;case"zip":case"rar":case"7z":case"zipx":t="attachmentsRar";break;case"3gp":case"mp4":case"avi":case"flv":case"mpeg":case"wmv":t="attachmentsVideo";break;case"mp3":case"wav":case"wma":t="attachmentsAudio";break;default:t="attachmentsFile"}return t})),Lyte.Component.registerHelper("getDealId",(function(e){return e?e.id:""})),Lyte.Component.registerHelper("getDealName",(function(e){return e?e.name:""})),Lyte.Component.registerHelper("showUnlinkDeal",(function(e){return e?"":"hide"})),Lyte.Component.registerHelper("showlinkDeal",(function(e){return e?"":"hide"})),Lyte.Component.registerHelper("getSummaryHelpLink",(function(){return RebrandLinkUtil.getProperty("EMAIL_SUMMARY_HELP_DOC_URL")}));
