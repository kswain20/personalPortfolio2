Lyte.Component.register("crm-similarity-result",{_template:'<template tag-name="crm-similarity-result"> <template is="if" value="{{expHandlers(showSimilarities,\'===\',true)}}"><template case="true"> <div class="recommended-products dIB vtop slides pR w100p"> <div class="referencecustomer"> <div class="crm-font-bold crmBaseColor mB20 f17"> {{getI18n(\'zia.similarity.similar\')}} {{module.plural_label}} <div class="fR mT5"> <div data-zcqa="goPreviousSimilarity" class="rec-ico-arrow-left2 cP similarityArrowIcons pR zcrm_svgIcons dIB mR10 {{if(expHandlers(currentIndex,\'>\',minIndex),\'\',\'AddDisabledBgClass\')}}" onclick="{{action(\'clickToGoPrev\')}}"></div> <div data-zcqa="goForwardSimilarity" class="rec-ico-arrow-right2 cP similarityArrowIcons pR dIB zcrm_svgIcons {{if(expHandlers(currentIndex,\'<\',maxIndex),\'\',\'AddDisabledBgClass\')}}" onclick="{{action(\'clickToGoNext\')}}"></div> </div> </div> <div class="recommendedDivEleCnt"> <ul class="recommendedUL pL0 pR" style="width:calc( 100% * {{similarities.length}});{{navStyle}}"> <template items="{{similarities}}" item="similarity" index="index" is="for"> <li class="p0 m0 liproducts" style="width:calc(( 100% / {{similarities.length}}) - 2.8px);"> <div class="pR similarityAnimatecontainer {{if(isAnimate,\'similarityAnimateLeft\',\'\')}}"> <div class="dIB w100p"> <template is="if" value="{{expHandlers(isProfileImage,\'===\',true)}}"><template case="true"> <template is="if" value="{{expHandlers(expHandlers(similarity.record.Record_Image,\'===\',undefined),\'||\',expHandlers(similarity.record.Record_Image,\'===\',null))}}"><template case="true"> <div class="dIB userProfImage similarNoimage similarImageInRecordParent pR mR10 bgColorSimilar{{similarity.randomNumber}}"> <div class="crm-font-regular f20 colfff lh20 similarUserFirstChar pA">{{substr(similarity.record[module.display_field.api_name],0,1)}}</div> </div> </template><template case="false"> <div class="dIB userProfImage pR mR10"> <img src="{{getCrmBasePath()}}/EntityImageAttach.do?action_module={{module.module_name}}&amp;entityId={{similarity.record.id}}&amp;actionName=readImage&amp;fileId={{similarity.record.Record_Image}}" alt="{{similarity.record.name}}"> </div> </template></template> </template></template> <div class="dIB {{if(expHandlers(isProfileImage,\'===\',true),\'cmpWdthCnt mL5\',\'w100p\')}}"> <a class="crm-font-bold ellipsistext f15 lh15 mw100per similaritydetname mB5 dIB vam" onclick="Crm.trackSpotLightAction(\'Lookup Click\',{\'Module\':\'{{module.module_name}}\'});" onmouseenter="crmLookupBusinessCard.showLookupDetails(this)" onmouseout="crmui.hideTooltip()" data-params="{&quot;lookback&quot;:&quot;true&quot;,&quot;module&quot;:&quot;{{module.module_name}}&quot;,&quot;id&quot;:&quot;{{similarity.record.id}}&quot;}" href="{{getCrmBasePath()}}/EntityInfo.do?module={{module.module_name}}&amp;id={{similarity.record.id}}" rel="noopener noreferrer" target="_blank"> {{similarity.record[module.display_field.api_name]}} </a> <template items="{{selectedFields}}" item="selectedField" index="index" is="for"> <template is="if" value="{{expHandlers(expHandlers(similarity.record[selectedField.api_name],\'!==\',undefined),\'&amp;&amp;\',expHandlers(similarity.record[selectedField.api_name],\'!==\',null))}}"><template case="true"> <template is="if" value="{{expHandlers(selectedField.data_type,\'===\',&quot;datetime&quot;)}}"><template case="true"> <div class="f15 crmBaseColor ellipsistext mB10" title="{{dateTimeUserFormat(similarity.record[selectedField.api_name])}}"> {{dateTimeUserFormat(similarity.record[selectedField.api_name])}} </div> </template><template case="false"><template is="if" value="{{expHandlers(selectedField.data_type,\'===\',&quot;date&quot;)}}"><template case="true"> <div class="f15 crmBaseColor ellipsistext mB10" title="{{convertAPIDateFormatToUserDateFormat(similarity.record[selectedField.api_name])}}"> {{convertAPIDateFormatToUserDateFormat(similarity.record[selectedField.api_name])}} </div> </template><template case="false"><template is="if" value="{{expHandlers(selectedField.data_type,\'===\',&quot;currency&quot;)}}"><template case="true"> <div class="f15 crmBaseColor ellipsistext mB10" title="{{formatCurrencyValue(similarity.record[selectedField.api_name])}}"> <template is="if" value="{{similarity.record.Currency}}"><template case="true"> {{formatCurrencyValue(similarity.record[selectedField.api_name],similarity.record.Currency)}} </template><template case="false"> {{formatCurrencyValue(similarity.record[selectedField.api_name])}} </template></template> </div> </template><template case="false"> <div class="f15 crmBaseColor ellipsistext mB10" title="{{renderDataFromObject(similarity.record[selectedField.api_name])}}"> {{renderDataFromObject(similarity.record[selectedField.api_name])}} </div> </template></template></template></template></template></template> </template></template> </template> <div class="dB"> <div class="tagfordet dIB mT5 crmBaseColor f15"> {{getI18n(\'zia.similarity.feature.title\')}} {{getI18n(\'zia.similarity.score\')}} {{similarity.score}} </div> </div> </div> </div> <template is="if" value="{{similarity.reasons}}"><template case="true"> <template is="if" value="{{expHandlers(similarity.reasons[0],\'===\',&quot;NO_PERMISSION&quot;)}}"><template case="true"> <div class="f14 crm-font-regular dIB w100p crmParagraphColor mT20 similarNopermission"> {{getI18n(\'zia.similarity.result.reason.hidden\')}} </div> </template><template case="false"> <div class="dIB w100p mT20"> <div class="mB10 f15 crmBaseColor crm-font-bold"> {{getI18n(\'zia.similarity.widget.question\',module.singular_label)}} </div> <template items="{{similarity.reasons}}" item="reason" index="indexval" is="for"> <div class="pL15 similarbulletpoints mB15 pR crmBaseColor ellipsistext" data-zcqa="simReason_{{indexval}}" title="{{reason}}"> {{reason}} </div> </template> </div> </template></template> </template></template> </div> </li> </template> </ul> </div> </div> </div> </template></template> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"text",position:[1,1,1,1]},{type:"text",position:[1,1,1,3]},{type:"attr",position:[1,1,1,5,1]},{type:"attr",position:[1,1,1,5,3]},{type:"attr",position:[1,1,3,1],attr:{style:{name:"style",helperInfo:{name:"concat",args:["'width:calc( 100% * '","similarities.length","');'","navStyle"]}}}},{type:"attr",position:[1,1,3,1,1]},{type:"for",position:[1,1,3,1,1],dynamicNodes:[{type:"attr",position:[1],attr:{style:{name:"style",helperInfo:{name:"concat",args:["'width:calc(( 100% / '","similarities.length","') - 2.8px);'"]}}}},{type:"attr",position:[1,1]},{type:"attr",position:[1,1,1,1]},{type:"if",position:[1,1,1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1,0]}]},false:{dynamicNodes:[{type:"attr",position:[1,1]}]}},default:{}}]}},default:{}},{type:"attr",position:[1,1,1,3]},{type:"attr",position:[1,1,1,3,1]},{type:"text",position:[1,1,1,3,1,1]},{type:"attr",position:[1,1,1,3,3]},{type:"for",position:[1,1,1,3,3],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"text",position:[1]}]},false:{dynamicNodes:[{type:"text",position:[1]}]}},default:{}}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1]}]}},default:{}}]}},default:{}}]}},default:{}}]}},default:{}}]},{type:"text",position:[1,1,1,3,5,1,1]},{type:"text",position:[1,1,1,3,5,1,3]},{type:"text",position:[1,1,1,3,5,1,5]},{type:"attr",position:[1,1,3]},{type:"if",position:[1,1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"text",position:[1,1]}]},false:{dynamicNodes:[{type:"text",position:[1,1,1]},{type:"attr",position:[1,3]},{type:"for",position:[1,3],dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1]}]}]}},default:{}}]}},default:{}}]}]}},default:{}}],_observedAttributes:["currentIndex","isAnimate","showSimilarities","navStyle","minIndex","maxIndex","selectedFields","similarities","isCanvasView","isProfileImage","entity_module","entity_id"],data:function(){return{currentIndex:Lyte.attr("number",{default:0}),isAnimate:Lyte.attr("boolean",{default:!1}),showSimilarities:Lyte.attr("boolean",{default:!1}),navStyle:Lyte.attr("string",{default:""}),minIndex:Lyte.attr("number",{default:0}),maxIndex:Lyte.attr("number",{default:0}),selectedFields:Lyte.attr("array",{default:[]}),similarities:Lyte.attr("array"),isCanvasView:Lyte.attr("boolean",{default:!1}),isProfileImage:Lyte.attr("boolean",{default:!1}),entity_module:Lyte.attr("string",{default:""}),entity_id:Lyte.attr("string",{default:""})}},actions:{clickToGoPrev:function(){var e=this.getData("currentIndex");0!==e&&(e-=1,Crm.userDetails.RTL_ENABLED?this.setData("navStyle","right:calc(-100% * "+e+" )"):this.setData("navStyle","left:calc(-100% * "+e+" )"),this.setData("currentIndex",e))},clickToGoNext:function(){var e=this.getData("similarities"),t=this.getData("currentIndex");t!==e.length-1&&(t+=1,Crm.userDetails.RTL_ENABLED?this.setData("navStyle","right:calc(-100% * "+t+" )"):this.setData("navStyle","left:calc(-100% * "+t+" )"),this.setData("currentIndex",t),!0===this.getData("hasRelatedList")&&setTimeout(this.actions.fetchRelatedListData(e[t],this),200))},fetchRelatedListData:function(e,t){if(!0!==e.record.isRelatedListFetched){e.record.isRelatedListFetched=!0;var i=t.getData("module"),a=t.getData("similarityConfig.selected_views")[0].selected_resources,s="crm/v2.2/"+i.api_name+"/"+e.record.id+"/",r=[],l=moduleRecordMapping[i.api_name].related_lists;a.forEach((function(e){if("related_list"===e.type){var t=e.resource.api_name,i={};i.api_name=t,i.url=s+t;var a=l.filter((function(t){return t.id===e.resource.id}))[0];a&&a.module&&(i.module_name=a.module.api_name),r.push(i)}})),store.batch((function(){for(var e=r.length,t=0;t<e;t++)store.findAll("dummy",null,!1,!1,{url:r[t].url})})).then((function(t){if(t)for(var i=t.length,a=0;a<i;a++)if(t[a].data){for(var s=[],l=t[a].data.length>2?2:t[a].data.length,o=0;o<l;o++){var d=t[a].data[o],n=r[a].module_name,m=crmConstants.moduleDisplayField[n];m&&d[m[0]]?s.push(d[m[0]]):d.Name&&s.push(d.Name)}s.length>0&&Lyte.objectUtils(e.record,"add",r[a].api_name,s)}}))}}},methods:{loader:function(e,t){var i=t.getData("module"),a=t.getData("similarities"),s="crm/v2/"+i.api_name,r=t.getData("similarityConfig").selected_views[0].selected_resources;t.setData("maxIndex",a.length-1);var l="";a.forEach((function(e){var t,i;l+=","+e.record.id,e.randomNumber=(t=1,i=10,Math.floor(Math.random()*(i-t+1))+t)})),s=s+"?ids="+(l=l.slice(1,l.length));var o=!1,d=[],n=moduleRecordMapping[i.module_name].fields,m=moduleRecordMapping[i.module_name].related_lists;r.sort(((e,t)=>e.sequence_number<t.sequence_number?-1:1)),r.forEach((function(e){var t=e.resource.id;if("related_list"===e.type){o=!0;var i=m.filter((function(e){return e.id===t&&(!0===e.visible||"default"===e.type)}))[0];i&&d.push(i)}else{var a=n.filter((function(e){return e.id===t&&!0===e.available_in_user_layout}))[0];a&&d.push(a)}})),t.setData("selectedFields",d),t.setData("hasRelatedList",o),store.findAll("dummy",null,!1,!1,{url:s}).then((function(i){if(void 0!==i&&void 0!==i.data){var s=i.data;a.forEach((function(e){var t=s.filter((function(t){return t.id===e.record.id}))[0];Lyte.objectUtils(e,"add","record",t)})),!0===o&&t.actions.fetchRelatedListData(a[0],t),t.setData("showSimilarities",!0),t.getData("isCanvasView")||(e.style.display="block")}}))}},init:function(){var e=this;if(this.getData("isCanvasView")){this.setData("isProfileImage",!1);var t=Lyte.registeredMixins["zia-insights-utils"],i=e.getData("entity_module"),a=moduleRecordMapping[i];e.setData("module",a);var s=e.getData("entity_id");t.getInsights(a,s,{include_inner_details:"similarity_data.similarity.selected_views"}).then((function(t){if(t){var i=t.zia_insights.similarity_data?t.zia_insights.similarity_data:void 0;if(i){var a=i[0].output;a.sort((function(e,t){return t.score-e.score})),e.setData("similarities",a),e.setData("similarityConfig",i[0].similarity),e.methods.loader(null,e)}}}))}else this.setData("isProfileImage",businessCardJson.isProfileImageAccessible)}},{mixins:["zia-insights-utils"]});
