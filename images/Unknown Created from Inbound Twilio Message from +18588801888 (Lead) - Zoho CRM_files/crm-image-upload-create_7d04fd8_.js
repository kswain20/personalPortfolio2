Lyte.Component.register("crm-image-upload-create",{_template:'<template tag-name="crm-image-upload-create"> <template is="if" value="{{expHandlers(expHandlers(expHandlers(readonly,\'===\',false),\'&amp;&amp;\',expHandlers(configuration.fromsetup,\'===\',false)),\'&amp;&amp;\',expHandlers(showpopup,\'===\',true))}}"><template case="true"> <crm-image-upload-picker allowed-size="{{allowedSize}}" show-uploads="true" show-popup="{{lbind(showpopup)}}" image-data-existing="{{imageData}}" fieldid="{{fieldid}}" entity-id="{{entityId}}" module="{{module}}" parent-feature="{{parentFeature}}" on-upload="{{method(&quot;finishUploadCallback&quot;)}}" on-delete="{{method(&quot;onDeleteCallback&quot;)}}"></crm-image-upload-picker> </template></template> <template is="if" value="{{expHandlers(expHandlers(expHandlers(readonly,\'===\',false),\'&amp;&amp;\',expHandlers(configuration.fromsetup,\'===\',false)),\'&amp;&amp;\',expHandlers(showPreview,\'===\',true))}}"><template case="true"> <crm-image-preview show-preview="{{lbind(showPreview)}}" on-crop="{{method(&quot;afterCropCallBack&quot;)}}" on-name-change="{{method(&quot;nameChangeCallBack&quot;)}}" on-desc-change="{{method(&quot;descChangeCallBack&quot;)}}" image-data="{{imageData}}" is-editable="true" fieldid="{{fieldid}}" module="{{module}}" preview-configuration="{{previewConfiguration}}" entity-id="{{entityId}}" readonly="{{readonly}}" on-delete="{{method(&quot;deleteImageFromPreview&quot;)}}"></crm-image-preview> </template></template> <img src="//:0" alt="//:0" class="temporaryImageOrientationCheck dN "> <div class="{{concat(\'create_image_upload \',if(fromWindowsMachine,\'fromWindowsMachine\',\'\'))}}" id="{{if(ifNotEquals(fieldid,\'undefined\'),fieldid,\'\')}}"> <div class="{{concat(\'imageUploadWrap \',\'pR \',if(ifEquals(storedCount,\'0\'),\' \',\'border \'),if(singleColumnLayout,\'singleColLayout \',\'doubleColLayout \'))}}"> <div class="{{concat(\'uploadedImageList \',if(ifEquals(storedCount,\'0\'),\' \',\'dB \'))}}" data-zcqa="uploadedImageList_scroll" onscroll="{{action(\'uploadedImageList\',this)}}"> <ul class="p0 m0 uploadedImageListUL"> <template is="if" value="{{expHandlers(storedCount,\'>\',0)}}"><template case="true"> <template is="for" items="{{imageData}}" item="item" index="index"> <template is="if" value="{{expHandlers(expHandlers(expHandlers(parentFeature,\'===\',\'Image_Validation\'),\'&amp;&amp;\',expHandlers(item.state,\'!==\',undefined)),\'&amp;&amp;\',expHandlers(item.state,\'!==\',null))}}"><template case="true"> <li class="{{concat(\'uploadedImageListElem \',constructErrorClassesCreate(item.state))}}" data-sel-image="{{index}}" id="{{item.uploadid}}"> <div class="createImgThumnail dIB vam"> <img class="w100per createThumbImg" alt="{{item.src}}" src="{{item.src}}"> </div> <div class="createImgThumnailDesc dIB vam mL5" lt-prop-title="{{renderNameToolTip(item.filename)}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;top&quot;, &quot;margin&quot; : &quot;7px&quot;, &quot;maxdisplaytime&quot;:3000}"> <span class="createImgThumnailName dIB vat fL"> {{getNameHeadFromFileName(item.filename)}} </span> <span class="dIB vat fL mT_1"> {{getExtnFromFileName(item.filename)}} </span> <div class="clearB"></div> </div> <div class="createImgThumnailManage"> <span class="dIB vat ico-edit" data-zcqa="openPreview_field_failed" onclick="{{action(\'openPopupHandler\',item.uploadid,item.state)}}" lt-prop-title="{{getI18n(\'crm.button.edit\')}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"></span> <template is="if" value="{{expHandlers(expHandlers(readonly,\'!\'),\'&amp;&amp;\',expHandlers(item.state,\'===\',\'system_rejected\'))}}"><template case="true"> <span class="dIB vam ico-delete" data-zcqa="removeThisImage_field_failed" onclick="{{action(\'removeThisImage\',item.uploadid)}}" lt-prop-title="{{getI18n(\'crm.button.delete\')}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"></span> </template></template> </div> </li> </template><template case="false"> <li class="uploadedImageListElem imageRendered_{{configuration.componentCount}}" data-lytecbox-title="{{item.filename}}" data-lytecbox-href="{{item.original_src}}" data-sel-image="{{index}}" id="{{item.uploadid}}"> <div class="createImgThumnail dIB vam"> <img class="w100per createThumbImg" alt="{{item.src}}" src="{{item.src}}"> </div> <div class="createImgThumnailDesc dIB vam mL5" lt-prop-title="{{renderNameToolTip(item.filename)}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;top&quot;, &quot;margin&quot; : &quot;7px&quot;, &quot;maxdisplaytime&quot;:3000}"> <span class="createImgThumnailName dIB vat fL"> {{getNameHeadFromFileName(item.filename)}} </span> <span class="dIB vat fL mT_1"> {{getExtnFromFileName(item.filename)}} </span> <div class="clearB"></div> </div> <template is="if" value="{{expHandlers(readonly,\'!\')}}"><template case="true"> <div class="createImgThumnailManage"> <span class="dIB vat ico-edit" data-zcqa="openPreview_field" onclick="{{action(\'openPreview\',item.uploadid)}}" lt-prop-title="{{getI18n(\'crm.button.edit\')}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"></span> <span class="dIB vam ico-delete" data-zcqa="removeThisImage_field" onclick="{{action(\'removeThisImage\',item.uploadid)}}" lt-prop-title="{{getI18n(\'crm.button.delete\')}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"></span> </div> </template></template> </li> </template></template> </template> </template></template> <li class="{{concat(\'addImageWrapContainer \',\'fL \',\'pR \',\'\',\'cP \',if(ifEquals(storedCount,\'0\'),\'noImageList \',\'\'),if(readonly,\'readonlyF op5 \',\'\'),if(expHandlers(storedCount,\'>=\',allowedSize),\'readonlyF op5\',\' \'))}}" data-zcqa="openImageUploadPop_field" onclick="{{action(\'openImageUploadPop\')}}"> <template is="if" value="{{expHandlers(storedCount,\'>=\',allowedSize)}}"><template case="true"> <div class="{{concat(\'addImageWrap \',\'outlineprimaryflat \',\'dIB \',if(configuration.fromsetup,\'eventNone \',\' \'))}}" lt-prop-title="{{getI18n(\'crm.imageupload.allowed.field.length\',allowedSize)}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"> <div class="imageText"> <span class="dIB vat"> {{getI18n(\'crm.imageupload.addimage\')}} </span> </div> </div> </template><template case="false"> <div class="{{concat(\'addImageWrap \',\'outlineprimaryflat \',\'dIB \',if(readonly,\' \',\'cP \'),if(configuration.fromsetup,\'eventNone \',\' \'))}}"> <div class="imageText"> <span class="dIB vat"> {{getI18n(\'crm.imageupload.addimage\')}} </span> </div> </div> </template></template> </li> <li class="clearB p0"></li> </ul> </div> <template is="if" value="{{readonly}}"><template case="true"> <span class="readOnlyLockIcon" lt-prop-tooltip-class="lcreateTooltip" lt-prop-title="{{getI18n(\'crm.label.readonly\')}}" lt-prop-tooltip-config="{&quot;position&quot; : &quot;followcursor&quot;,&quot;margin&quot; : &quot;5&quot;}"></span> </template></template> </div> </div> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}},{type:"attr",position:[3]},{type:"if",position:[3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}},{type:"attr",position:[7]},{type:"attr",position:[7,1]},{type:"attr",position:[7,1,1]},{type:"attr",position:[7,1,1,1,1]},{type:"if",position:[7,1,1,1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"for",position:[1],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1,1]},{type:"attr",position:[1,3]},{type:"text",position:[1,3,1,1]},{type:"text",position:[1,3,3,1]},{type:"attr",position:[1,5,1]},{type:"attr",position:[1,5,3]},{type:"if",position:[1,5,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1,1]},{type:"attr",position:[1,3]},{type:"text",position:[1,3,1,1]},{type:"text",position:[1,3,3,1]},{type:"attr",position:[1,5]},{type:"if",position:[1,5],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"attr",position:[1,3]}]}},default:{}}]}},default:{}}]}]}},default:{}},{type:"attr",position:[7,1,1,1,3]},{type:"attr",position:[7,1,1,1,3,1]},{type:"if",position:[7,1,1,1,3,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1,1,1]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1,1,1]}]}},default:{}},{type:"attr",position:[7,1,3]},{type:"if",position:[7,1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}}],_observedAttributes:["imageData","existingData","previewPageChanges","removedIds","tempRemovedIds","fieldid","entityId","parentFeature","module","currentStatus","storedCount","allowedSize","readonly","singleColumnLayout","showpopup","showPreview","thumbnailRequest","configuration","previewConfiguration","sequenceChanges"],data:function(){return{imageData:Lyte.attr("array",{default:[],hideAttr:!0}),existingData:Lyte.attr("array",{default:[],hideAttr:!0}),previewPageChanges:Lyte.attr("array",{default:[],hideAttr:!0}),removedIds:Lyte.attr("array",{default:[],hideAttr:!0}),tempRemovedIds:Lyte.attr("array",{default:[],hideAttr:!0}),fieldid:Lyte.attr("string",{default:void 0,hideAttr:!0}),entityId:Lyte.attr("string",{default:void 0,hideAttr:!0}),parentFeature:Lyte.attr("string",{default:void 0,hideAttr:!0}),module:Lyte.attr("string",{default:void 0,hideAttr:!0}),currentStatus:Lyte.attr("string",{default:void 0,hideAttr:!0}),storedCount:Lyte.attr("number",{default:0,hideAttr:!0}),allowedSize:Lyte.attr("number",{default:0,hideAttr:!0}),readonly:Lyte.attr("boolean",{default:!1,hideAttr:!0}),singleColumnLayout:Lyte.attr("boolean",{default:!1,hideAttr:!0}),showpopup:Lyte.attr("boolean",{default:!1,hideAttr:!0}),showPreview:Lyte.attr("boolean",{default:!1,hideAttr:!0}),thumbnailRequest:Lyte.attr("boolean",{default:!0,hideAttr:!0}),configuration:Lyte.attr("object",{default:{DOMConstructed:!1,componentCount:0}}),previewConfiguration:Lyte.attr("object",{default:{},hideAttr:!0}),sequenceChanges:Lyte.attr("object",{default:{},hideAttr:!0})}},init:function(){var e=$L(this.$node.closest(".labelValCreate, .FValue")),t=$L("#formRuleMandatoryFields").is(":visible");e.addClass("imgUploadCont"),t||e.addClass("boxShadowNone"),this.getData("readonly")&&e.addClass("imgUploadContReadOnly"),-1!=navigator.appVersion.indexOf("Win")&&this.setData("fromWindowsMachine",!0)},didConnect:function(){for(var e=[].concat(this.getData("existingData")),t=(e=this.sortImagesComplete(e)).length,a=0;a<t;a++)void 0===e[a].original_src&&(e[a].original_src=this.constructImageUrl(e[a].fileId,this.getData("module"),this.getData("entityId"),e[a].uploadid,e[a].filename,e[a].state)),Lyte.arrayUtils(this.getData("imageData"),"push",e[a]);if(this.setData("storedCount",t),this.removeWrapContainer(t),t>0){$L(this.$node).find(".uploadedImageListUL").addClass("contentLoading");var i=$L.debounce(function(){this.isInViewport(this.$node)&&(window.removeEventListener("scroll",i),window.removeEventListener("resize",i),window.removeEventListener("orientationchange",i),this.constructImageData())}.bind(this),300);window.addEventListener("scroll",i),window.addEventListener("resize",i),window.addEventListener("orientationchange",i),i()}"setup"===this.getData("currentStatus")?Lyte.objectUtils(this.getData("configuration"),"add","fromsetup",!0):Lyte.objectUtils(this.getData("configuration"),"add","fromsetup",!1),Lyte.objectUtils(this.getData("configuration"),"add","componentCount",crmTemplate.imageUploadFieldRenderedCount++)},constructImageData:function(){!1===this.getData("configuration").DOMConstructed&&this.makeRequestForThumbnail()},actions:{removeThisImage:function(e){this.removeThisImageComplete(e)},openPopupHandler:function(e,t){this.openFeaturePopup(this,e,t,!0,!1)},openPreview:function(e){if(!1===this.getData("readonly")){var t={currentId:e,selector:"imageRendered_"+this.getData("configuration").componentCount,crop:!0,downloadImage:!0,fileName:!0,description:!0,infoIcon:!0,deleteIcon:!0,zoom:!0};this.setData({previewConfiguration:t,showPreview:!0}),$L(".imagePreviewParent").focus()}},openImageUploadPop:function(){!1===this.getData("readonly")&&this.getData("storedCount")<this.getData("allowedSize")&&this.setData("showpopup",!0)}},methods:{finishUploadCallback:function(e,t,a){this.fetchDeletedImageIdsPopup([].concat(this.getData("imageData")));for(var i=[],o=e.length,s=0;s<o;s++)i.push(JSON.parse(JSON.stringify(e[s])));this.fetchPreviewPageChangesPopup(t);var n=this.getData("sequenceChanges");if(Object.keys(a).length>0)for(var s in a)n[s]=a[s];this.setData("imageData",i),this.setData("storedCount",i.length),this.bindSortableWithDOM(),this.removeWrapContainer(i.length),this.getMethods("onImageAddition")&&this.executeMethod("onImageAddition")},nameChangeCallBack:function(e,t){this.retreiveNameData(e,t,!1),this.bindSortableWithDOM(),this.getMethods("onNameChange")&&this.executeMethod("onNameChange",e,t)},descChangeCallBack:function(e,t){this.retreiveDescriptionData(e,t,!1),this.bindSortableWithDOM(),this.getMethods("onDescChange")&&this.executeMethod("onDescChange",e,t)},afterCropCallBack:function(e,t){this.retreiveCropData(e,t,!1),this.bindSortableWithDOM(),this.getMethods("onImageCrop")&&this.executeMethod("onImageCrop",e,t)},deleteImageFromPreview:function(e){this.removeThisImageComplete(e),this.bindSortableWithDOM()},onDeleteCallback:function(e){var t=this.getData("tempRemovedIds");isNaN(e)||t.push(e),this.setData("tempRemovedIds",t)}},removeThisImageComplete:function(e){if(!1===this.getData("readonly")){for(var t=[].concat(this.getData("imageData")),a=this.getData("tempRemovedIds"),i=t.length,o=0;o<i;o++)if(t[o].uploadid===e){if("edit"===this.getData("currentStatus")){for(var s=[].concat(this.getData("removedIds")),n=this.getData("existingData"),r=n.length,l=0;l<r;l++)if(n[l].uploadid===e){s.push(e);break}this.setData("removedIds",s)}else isNaN(e)||a.push(e);Lyte.arrayUtils(t,"removeAt",o,1);break}return this.setData("tempRemovedIds",a),this.setData("imageData",t),this.setData("storedCount",t.length),this.bindSortableWithDOM(),this.removeWrapContainer(t.length),this.getMethods("onImageDelete")&&this.executeMethod("onImageDelete"),!1}},bindSortableWithDOM:function(){var e=$L(this.$node).find(".uploadedImageListUL");this.rearrangeSequence(),e.hasClass("sortable-parent")&&e.sortable("destroy"),this.getData("storedCount")>1&&e.sortable({restrict:".addImageWrapContainer",cancel:".createImgThumnailManage",onDrop:function(e,t,a,i,o,s){i!==o&&$L(s).closest("crm-image-upload-create")[0].component.bindSortableWithDOM()}})},removeWrapContainer:function(e){var t=$L(this.$node.closest(".imgUploadCont"));e>0?t.removeClass("noImageWrapContainer"):t.hasClass("noImageWrapContainer")||t.addClass("noImageWrapContainer")},rearrangeSequence:function(){this.rearrangeSequenceComplete($L(this.$node).find(".uploadedImageListUL .uploadedImageListElem"))},imagesLoaded:function(){var e=$L(this.$node);e.find(".uploadedImageListUL").removeClass("contentLoading");var t=this.getData("imageData"),a=t.length;if(t.length>1){t=this.sortImagesComplete(t);for(var i=0;i<a;i++)Lyte.arrayUtils(this.getData("imageData"),"replaceAt",i,t[i]);this.getData("readonly")||this.bindSortableWithDOM(),e.closest(".imgUploadCont").removeClass("boxShadowNone")}},constructErrorDiv:function(e){this.removeErrorDiv();var t=$(this.$node.closest(".imageUploadHead")),a="<span id='errorMsg_"+this.getData("fieldid")+"' class='errMsg errorMsgDesc'>"+I18n.getMsg(e)+"</span>";t.append(a),t.parent().addClass("imageErrorMessage")},removeErrorDiv:function(){$L(this.$node.closest(".imgUploadCont")).removeClass("imageErrorMessage"),$("#errorMsg_"+this.getData("fieldid")).remove()},storedCountObserver:function(e){var t=$L(this.$node.closest(".imageUploadHead")).data();if(($L("#formRuleMandatoryFields").is(":visible")||$("#closedWon").is(":visible"))&&(this.removeErrorDiv(),0===e.newValue&&t.mandate)){var a=I18n.getMsg("crm.field.empty.check",$ESAPI.encoder().encodeForHTML(t.displaylabel));this.constructErrorDiv(a)}}.observes("storedCount"),extractComponentDataForReRender:function(){var e={};return e.imageData=this.getData("imageData"),e.existingData=this.getData("existingData"),e.previewPageChanges=this.getData("previewPageChanges"),e}},{mixins:["crm-image-mixin","crm-vision-create"]}),Lyte.Component.registerHelper("constructErrorClassesCreate",(function(e){if("Image_Validation"===this.getData("parentFeature")){if("processing"===e)return"uploadedImageListElem_visionError uploadedImageListElem_visionProcessing";if("system_rejected"===e||"waiting_for_approval"===e)return"uploadedImageListElem_visionError"}return""}));
