Lyte.Component.register("crm-image-upload-picker",{_template:'<template tag-name="crm-image-upload-picker"> <lyte-messagebox id="tempraryError" lt-prop-yield="true" lt-prop-show="{{lbind(globalObj.error)}}" lt-prop-duration="5000" lt-prop-type="error"> <template is="registerYield" yield-name="messageboxYield"> <span> {{customMessages}} </span> </template> </lyte-messagebox> <template is="if" value="{{expHandlers(showPreview,\'===\',true)}}"><template case="true"> <crm-image-preview show-preview="{{lbind(showPreview)}}" on-crop="{{method(&quot;afterCropCallBack&quot;)}}" on-name-change="{{method(&quot;nameChangeCallBack&quot;)}}" on-desc-change="{{method(&quot;descChangeCallBack&quot;)}}" on-close="{{method(&quot;afterPreviewClose&quot;)}}" image-data="{{imageDataPreview}}" is-editable="true" fieldid="{{fieldid}}" module="{{module}}" preview-configuration="{{previewConfiguration}}" entity-id="{{entityId}}" from-pop-up="true" on-delete="{{method(&quot;deleteImageFromPreview&quot;)}}"></crm-image-preview> </template></template> <lyte-modal lt-prop-bind-to-body="true" id="uploadPlatform" lt-prop="{ &quot;transition&quot; : { &quot;animation&quot; : &quot;slideFromTop&quot; , &quot;duration&quot; : &quot;0&quot;}}" lt-prop-offset="{&quot;top&quot;:&quot;0&quot;}" lt-prop-close-on-escape="{{globalObj.closeOnEscape}}" lt-prop-show="true" lt-prop-allow-multiple="true" lt-prop-wrapper-class="uploadPlatform" lt-prop-show-close-button="false" on-show="{{method(\'bindUploaderPlugin\')}}" on-close="{{method(\'filePickerClose\')}}"> <template is="registerYield" yield-name="modal"> <lyte-modal-content> <div class="uploadCommonComp"> <div class="uploadedImageArea"> <div class="uploadedImages"> <p class="crm-font-bold modalHeadingTextImg">{{getI18n("crm.attach.upload.image")}}</p> <div class="{{concat(\'imageDropAreaWrap \',if(ifEquals(storedCount,\'0\'),\'noSelection \',\'\'),if(ifEquals(storedCount,allowedSize),\'noSpaceToUpload \',\'\'))}}" lt-prop-title="{{globalObj.toolTipTitle}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;followcursor&quot;, &quot;margin&quot; : &quot;50px&quot;, &quot;maxdisplaytime&quot;:3000}"> <div style="height:{{uploadPopupDetails.finalHeight}}px" class="{{concat(\'imageDropArea \',\'pR \',\'aligncenter \',if(globalObj.showPickerTooltip,\'eventNone \',\' \'))}}" id="imageDropAttach" onclick="{{action(\'checkFileAttachRestrictions\',event)}}"> <div class="uploadPopTextDetails"> <span class="uploadIconDragAndDrop"></span> <p class="dragAndDropText crm-font-bold fs">{{getI18n("crm.image.filepicker.desc.draganddrop")}}</p> <p class="dragAndDropTextSeparation">-{{getI18n("crm.label.lowercase.or")}}-</p> <p class="dragAndDropTextPickerClick crm-font-bold" style="text-decoration: underline;">{{getI18n("crm.image.filepicker.desc.browse")}}</p> </div> <template is="if" value="{{expHandlers(storedCount,\'===\',0)}}"><template case="true"> <p class="totalFileSize">{{unescape(getI18n("crm.attach.upload.userinfo","20",allowedSize))}}</p> </template></template> <p class="totalSupportedSize">{{getI18n("crm.image.supported.formats")}}</p> <div class="sizeLimitReachedWrap"> <span class="warningInfoLimit"></span> <p class="sizeLimitReached f16 crm-font-bold">{{getI18n("crm.imageupload.allowed.field.length",allowedSize)}}</p> </div> </div> </div> <div class="{{concat(\'uploadedImageSec \',\'fL \',if(ifEquals(storedCount,\'0\'),\'dN \',\' \'))}}" style="height:{{uploadPopupDetails.finalHeight}}px" id="uploadedImageSec"> <p class="selectedImage crm-font-bold pR">{{getI18n("crm.field.label.selectedimages")}} <span class="totalStoreCountBadge">{{storedCount}} / {{allowedSize}}</span></p> <ul class="m0 p0 uploadedImageSecList" onscroll="{{action(\'viewhiddenThumb\',this)}}" id="uploadedImageSecList" style="height:{{uploadPopupDetails.contentScrollHgt}}px"> <template is="for" items="{{imageData}}" item="item" index="index"> <template is="if" value="{{expHandlers(expHandlers(expHandlers(parentFeature,\'===\',\'Image_Validation\'),\'&amp;&amp;\',expHandlers(item.state,\'!==\',undefined)),\'&amp;&amp;\',expHandlers(item.state,\'!==\',null))}}"><template case="true"> <li class="{{concat(\'selectedImageList pR \',constructErrorClassesPopup(item.state,\'head\'))}}" data-sel-image="{{index}}" id="{{item.uploadid}}"> <div class="selectedImageThumbWrap"><img class="selectedImageThumb" alt="{{item.src}}" src="{{item.src}}"></div> <template is="if" value="{{expHandlers(item.state,\'===\',\'system_rejected\')}}"><template case="true"> <span class="deleteUploadedImage" data-zcqa="removeThisUploadedImage_popup" onclick="{{action(\'removeThisUploadedImage\',item.uploadid)}}" lt-prop-title="{{getI18n(\'crm.button.delete\')}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"></span> </template></template> <div class="fL pL10 pR"> <div class="uploadedImageNameWrap pB1" lt-prop-title="{{renderNameToolTip(item.filename)}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;top&quot;, &quot;margin&quot; : &quot;7px&quot;, &quot;maxdisplaytime&quot;:3000}"> <span class="{{concat(\'uploadedImageName fL \',constructErrorClassesPopup(item.state,\'filename\'))}}">{{getNameHeadFromFileName(item.filename)}}</span> <span class="fL">{{getExtnFromFileName(item.filename)}}</span> <div class="clearB"></div> </div> <span class="uploadedImageSize color_7">{{item.size}}</span> </div> <div class="clearB"></div> </li> </template><template case="false"> <li class="{{concat(\'selectedImageList \',\'pR \',if(item.failed,\'restrictImage \',\'activeImage \'))}}" data-lytecbox-title="{{item.filename}}" data-lytecbox-href="{{item.original_src}}" data-sel-image="{{index}}" id="{{item.uploadid}}" data-img-name="{{item.enc_filename}}"> <div class="selectedImageThumbWrap"><img class="selectedImageThumb" alt="{{item.src}}" src="{{item.src}}"></div> <template is="if" value="{{expHandlers(expHandlers(item.completed,\'===\',undefined),\'||\',expHandlers(item.completed,\'===\',\'\'))}}"><template case="true"> <div class="bgImgFreeze"></div> </template><template case="false"> <template is="if" value="{{expHandlers(item.failed,\'===\',true)}}"><template case="true"> <span class="deleteUploadedImage" data-zcqa="removeThisUploadedImage_popup" onclick="{{action(\'removeThisUploadedImage\',item.filename)}}" lt-prop-tooltip-style="font-size: 1.2rem;" lt-prop-title="{{getI18n(\'crm.button.delete\')}}" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"></span> </template><template case="false"> <span class="{{concat(\'editUploadedImage \',if(globalObj.showPickerTooltip,\'eventNone \',\' \'))}}" data-zcqa="openEditAndPreview_popup" onclick="{{action(&quot;openEditAndPreview&quot;,item.uploadid)}}" lt-prop-title="{{getI18n(\'crm.button.edit\')}}" lt-prop-tooltip-style="font-size: 12px;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"></span> <span class="deleteUploadedImage" data-zcqa="removeThisUploadedImage_popup" onclick="{{action(\'removeThisUploadedImage\',item.uploadid)}}" lt-prop-title="{{getI18n(\'crm.button.delete\')}}" lt-prop-tooltip-style="font-size: 12px;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"></span> </template></template> </template></template> <div class="fL pL10 pR"> <div class="uploadedImageNameWrap pB1" lt-prop-title="{{renderNameToolTip(item.filename)}}" lt-prop-tooltip-style="font-size: 12px;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;top&quot;, &quot;margin&quot; : &quot;7px&quot;, &quot;maxdisplaytime&quot;:3000}"> <span class="uploadedImageName fL">{{getNameHeadFromFileName(item.filename)}}</span> <span class="fL">{{getExtnFromFileName(item.filename)}}</span> <div class="clearB"></div> </div> <template is="if" value="{{expHandlers(expHandlers(item.completed,\'===\',true),\'&amp;&amp;\',expHandlers(item.failed,\'!==\',true))}}"><template case="true"> <span class="uploadedImageSize color_7">{{item.size}}</span> </template><template case="false"> <div class="textLoad"> <template is="if" value="{{expHandlers(item.failed,\'===\',true)}}"><template case="true"> <span class="conveyText redText1" style="font-size: 12px;">{{getI18n(\'crm.fileuploader.message.responseerror\')}}</span> </template><template case="false"> <template is="if" value="{{expHandlers(item.size,\'!==\',undefined)}}"><template case="true"> <span class="conveyText actual">{{item.size}}</span> </template><template case="false"> <span class="conveyText actual loadingTxt">{{getI18n(\'crm.image.uploading\')}}</span> </template></template> </template></template> </div> </template></template> </div> <div class="clearB"></div> </li> </template></template> </template> </ul> <div class="remainingSpaceWrap"> <div class="remainingGalSpaceBar"><span class="remainingGalSpace" style="width:{{convertBytesToDecimal(barsize)}}% "></span></div> <p class="remainingSpace crm-font-bold f11 pR">{{getI18n("crm.attach.upload.sizelimit")}} : <span class="dIB">{{convertBytesToDecimal(maxUploadedSize)}} MB</span> / 20 MB</p> </div> </div> <div class="clearB"></div> </div> <div class="uploadActionArea alignright"> <lyte-button id="discardImageUpload" data-zcqa="onCancel_popup" onclick="{{action(\'onCancel\',fieldid)}}"> <template is="registerYield" yield-name="text"> {{getI18n("crm.button.cancel")}} </template> </lyte-button> <lyte-button id="saveImageUpload" lt-prop-disabled="{{globalObj.upload}}" lt-prop-appearance="primary" data-zcqa="onUpload_popup" onclick="{{action(\'onUpload\')}}"> <template is="registerYield" yield-name="text"> {{getI18n(globalObj.attachController)}} </template> </lyte-button> </div> <div class="clearB"></div> </div> <div class="clearB"></div> </div> </lyte-modal-content> </template> </lyte-modal> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"text",position:[1,1]}]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3]},{type:"if",position:[3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}},{type:"attr",position:[5]},{type:"registerYield",position:[5,1],dynamicNodes:[{type:"text",position:[1,1,1,1,1,0]},{type:"attr",position:[1,1,1,1,3]},{type:"attr",position:[1,1,1,1,3,1],attr:{style:{name:"style",helperInfo:{name:"concat",args:["'height:'","uploadPopupDetails.finalHeight","'px'"]}}}},{type:"text",position:[1,1,1,1,3,1,1,3,0]},{type:"text",position:[1,1,1,1,3,1,1,5,1]},{type:"text",position:[1,1,1,1,3,1,1,7,0]},{type:"attr",position:[1,1,1,1,3,1,3]},{type:"if",position:[1,1,1,1,3,1,3],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}},{type:"text",position:[1,1,1,1,3,1,5,0]},{type:"text",position:[1,1,1,1,3,1,7,3,0]},{type:"attr",position:[1,1,1,1,5],attr:{style:{name:"style",helperInfo:{name:"concat",args:["'height:'","uploadPopupDetails.finalHeight","'px'"]}}}},{type:"text",position:[1,1,1,1,5,1,0]},{type:"text",position:[1,1,1,1,5,1,2,0]},{type:"text",position:[1,1,1,1,5,1,2,2]},{type:"attr",position:[1,1,1,1,5,3],attr:{style:{name:"style",helperInfo:{name:"concat",args:["'height:'","uploadPopupDetails.contentScrollHgt","'px'"]}}}},{type:"attr",position:[1,1,1,1,5,3,1]},{type:"for",position:[1,1,1,1,5,3,1],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1,0]},{type:"attr",position:[1,3]},{type:"if",position:[1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}},{type:"attr",position:[1,5,1]},{type:"attr",position:[1,5,1,1]},{type:"text",position:[1,5,1,1,0]},{type:"text",position:[1,5,1,3,0]},{type:"text",position:[1,5,3,0]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1,0]},{type:"attr",position:[1,3]},{type:"if",position:[1,3],cases:{true:{dynamicNodes:[]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[3]}]}},default:{}}]}},default:{}},{type:"attr",position:[1,5,1]},{type:"text",position:[1,5,1,1,0]},{type:"text",position:[1,5,1,3,0]},{type:"attr",position:[1,5,3]},{type:"if",position:[1,5,3],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]},false:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]},false:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}}]}},default:{}}]}},default:{}}]}},default:{}}]},{type:"attr",position:[1,1,1,1,5,5,1,0],attr:{style:{name:"style",helperInfo:{name:"concat",args:["'width:'",{type:"helper",value:{name:"convertBytesToDecimal",args:["barsize"]}},"'% '"]}}}},{type:"text",position:[1,1,1,1,5,5,3,0]},{type:"text",position:[1,1,1,1,5,5,3,2,0]},{type:"attr",position:[1,1,1,3,1]},{type:"registerYield",position:[1,1,1,3,1,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[1,1,1,3,1]},{type:"attr",position:[1,1,1,3,3]},{type:"registerYield",position:[1,1,1,3,3,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[1,1,1,3,3]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[5]}],_observedAttributes:["imageData","imageDataExisting","usedNames","customMessages","fieldid","module","entityId","parentFeature","uploadCount","incommingCount","allowedSize","storedCount","maxUploadedSize","barsize","showPopup","showPreview","_pluginScope","globalObj","previewConfiguration","sequenceChanges","uploadPopupDetails","previewPageChanges","imageDataPreview"],data:function(){return{imageData:Lyte.attr("array",{default:[],hideAttr:!0}),imageDataExisting:Lyte.attr("array",{default:[],hideAttr:!0}),usedNames:Lyte.attr("array",{default:[],hideAttr:!0}),customMessages:Lyte.attr("string",{default:"Error",hideAttr:!0}),fieldid:Lyte.attr("string",{default:void 0,hideAttr:!0}),module:Lyte.attr("string",{default:void 0,hideAttr:!0}),entityId:Lyte.attr("string",{default:void 0,hideAttr:!0}),parentFeature:Lyte.attr("string",{default:void 0,hideAttr:!0}),uploadCount:Lyte.attr("number",{default:0,hideAttr:!0}),incommingCount:Lyte.attr("number",{default:0,hideAttr:!0}),allowedSize:Lyte.attr("number",{default:0,hideAttr:!0}),storedCount:Lyte.attr("number",{default:0,hideAttr:!0}),maxUploadedSize:Lyte.attr("number",{default:0,hideAttr:!0}),barsize:Lyte.attr("number",{default:0,hideAttr:!0}),showPopup:Lyte.attr("boolean",{default:!1,hideAttr:!0}),showPreview:Lyte.attr("boolean",{default:!1,hideAttr:!0}),_pluginScope:Lyte.attr("object",{default:{}}),globalObj:Lyte.attr("object",{default:{upload:!0,error:!1,closeOnEscape:!0,disableSelection:!1,attachController:"crm.button.attach"}}),previewConfiguration:Lyte.attr("object",{default:{},hideAttr:!0}),sequenceChanges:Lyte.attr("object",{default:{}}),uploadPopupDetails:Lyte.attr("object",{default:{}}),previewPageChanges:Lyte.attr("array",{default:[]}),imageDataPreview:Lyte.attr("array",{default:[],hideAttr:!0})}},didConnect:function(){for(var e=[].concat(this.getData("imageDataExisting")),t=(e=this.sortImagesComplete(e)).length,a=0,i=[],o=this.getData("imageData"),s=0;s<t;s++){i.push(e[s].filename);var n=this.convertStreamToActualSize(e[s].stream);a+=this.convertAllFormatsToMBCount(n);var r=JSON.parse(JSON.stringify(e[s]));r.completed=!0,r.size=n,Lyte.arrayUtils(o,"push",r)}e.length>0&&Lyte.objectUtils(this.getData("globalObj"),"add","attachController","crm.button.done"),this.setData({storedCount:e.length,maxUploadedSize:a,barsize:a/20*100,usedNames:i}),$L(".uploadedImageSecList").scroll({preventVertical:!1,preventHorizontal:!0}),this.bindSortableWithDOM(),Lyte.objectUtils(this.getData("globalObj"),"add","upload",!0)},actions:{checkFileAttachRestrictions:function(e){if(this.getData("storedCount")>=this.getData("allowedSize"))return e.preventDefault(),void e.stopPropagation()},onUpload:function(){this.data._pluginScope.files=[],thirdPartyUtils.removeDropzoneInstances(),this.getMethods("onUpload")&&(this.executeMethod("onUpload",this.getData("imageData"),this.getData("previewPageChanges"),this.getData("sequenceChanges")),this.setData("showPopup",!1))},onCancel:function(){thirdPartyUtils.removeDropzoneInstances(),this.closePicker()},openEditAndPreview:function(e){for(var t=[],a=this.getData("imageData"),i=a.length,o=0;o<i;o++)void 0===a[o].failed&&t.push(a[o]);var s={currentId:e,selector:"activeImage",crop:!0,downloadImage:!0,fileName:!0,description:!0,infoIcon:!0,deleteIcon:!0,zoom:!0};this.setData({imageDataPreview:t,previewConfiguration:s,showPreview:!0}),$L(".imagePreviewParent").focus(),Lyte.objectUtils(this.getData("globalObj"),"add","closeOnEscape",!1)},removeThisUploadedImage:function(e){this.removeThisUploadedImageComplete(e)},viewhiddenThumb:function(e){var t=document.querySelector(".selectedImage");e.scrollTop>0?t.classList.add("inscroll"):t.classList.remove("inscroll")}},methods:{filePickerClose:function(){this.closePicker()},bindUploaderPlugin:function(){var e=this;this.calculatePickUI(),$(".imageDropAreaWrap").FileUploader({autoProcessQueue:!1,acceptedFiles:".png,.jpg,.jpeg,.bmp,.gif",uploadLimit:this.getData("allowedSize"),previewsContainer:"#uploadedImageSec",needMultipleSelection:!0,pickerNotificationsNeeded:!1,previewTemplate:'<div class="dummyTemplate dN"></div>',uploadMultiple:!0,createImageThumbnails:!1,maxFileSize:20,notificationLimit:5e3,filesizeBase:1e3,uploadSizeLimit:20,totalFilesize:20971520,clickable:"#imageDropAttach",maxFiles:this.getData("allowedSize"),cancel:"#discardImageUpload",init:function(){var t=this;e.setData("_pluginScope",this),t.on("drop",(function(t){return this.options.proceedUploadOnDrop=!0,this.options.pickerNotificationsNeeded=!1,e.getData("storedCount")>=e.getData("allowedSize")||t.dataTransfer.files.length>e.getData("allowedSize")?(e.throwError(I18n.getMsg("crm.imageupload.allowed.field.length",e.getData("allowedSize"))),void(this.options.proceedUploadOnDrop=!1)):e.getData("uploadCount")!==e.getData("incommingCount")?(e.throwError(I18n.getMsg("crm.imageupload.wait.msg")),void(this.options.proceedUploadOnDrop=!1)):void document.querySelector(".imageDropAreaWrap").classList.remove("imageUploadDragging")})),t.on("rejectedallfiles",(function(t){this.options.pickerNotificationsNeeded=!1,e.getData("storedCount")>=e.getData("allowedSize")||t.length>e.getData("allowedSize")?e.throwError(I18n.getMsg("crm.imageupload.allowed.field.length",e.getData("allowedSize"))):1!==t.length||0!==t[0].size?this.options.pickerNotificationsNeeded=!0:e.throwError(I18n.getMsg("crm.image.unsupported.corrupted.single"))})),t.on("addedallfiles",(function(a){this.options.pickerNotificationsNeeded=!1;var i=[].concat(e.getData("imageData")),o=e.validateDetails(a);if(!0===o.proceed){var s=[],n=a.length;Lyte.objectUtils(e.getData("globalObj"),"add","showPickerTooltip",!0),Lyte.objectUtils(e.getData("globalObj"),"add","toolTipTitle",I18n.getMsg("crm.imageupload.wait.msg"));var r={};e.setData("incommingCount",n);for(var l=0===i.length?i.length+1:i.length,p=0;p<n;p++)s.push(e.fetchNewImageDetails(a[p],l,r));Promise.all(s).then((function(t){for(var i=e.getData("imageData"),o=0;o<n;o++)Lyte.arrayUtils(i,"push",t[o]);e.setData({uploadCount:0,storedCount:i.length}),e.calculateSelectedListUI(),$L(".uploadedImageSecList").scrollTop(1e4);var s=$L(this.$node);for(o=0;o<n;o++){var l=new FormData,p=r[a[o].name];l.append("file",a[o],encodeURIComponent(p)),Lyte.objectUtils(e.getData("globalObj"),"add","upload",!0);var d=Crm.getCrmBasePath()+"/fileattach.do?action=imageUFBlobAttach&fieldId="+e.getData("fieldid")+"&module="+e.getData("module")+"&type=image";d=Crm.getPortalURL(d);$L.ajax({url:d,type:"POST",data:l,enctype:"multipart/form-data",processData:!1,fileName:p,contentType:!1,headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},xhr:function(){var e=$.ajaxSettings.xhr();return e.upload.file=encodeURIComponent(p),e.upload.uploading=I18n.getMsg("crm.image.uploading"),e.upload.scanning=I18n.getMsg("crm.image.scanningforvirus"),e.upload.onprogress=function(t){if(t.lengthComputable){var a=Math.floor(t.loaded/t.total*100),i=$L('.selectedImageList[data-img-name="'+e.upload.file+'"] .textLoad .actual');void 0!==i&&(t.loaded!==t.total?(i.removeClass("scanningTxt"),i.addClass("loadingTxt"),i.text(e.upload.uploading+" "+a+"%")):(i.removeClass("loadingTxt"),i.addClass("scanningTxt"),i.text(e.upload.scanning)))}},e}(),success:function(t){try{var a=e.getData("globalObj");if(void 0!==t.uploadedImages){e.setData("uploadCount",e.getData("uploadCount")+1);var i=e.getData("imageData"),o=t.uploadedImages[0];o.size=e.convertStreamToActualSize(o.stream);for(var n=i.length,r=!0,l=0;l<n;l++)if(i[l].filename===this.fileName&&void 0===i[l].failed){if(e.addUsedImageNames(this.fileName),o.src=i[l].src,o.original_src=i[l].original_src,o.completed=!0,o.sequence=i[l].sequence,i[l]=o,void 0!==i[l].uploadedValues){var p=JSON.parse(i[l].uploadedValues);p.sequence=i[l].sequence,i[l].uploadedValues=JSON.stringify(p)}e.setData("storedCount",i.length),Lyte.arrayUtils(i,"replaceAt",l,i[l])}else!0===i[l].failed&&(r=!1);e.getData("uploadCount")===e.getData("incommingCount")&&r&&Lyte.objectUtils(a,"add","upload",!1);var d=e.getData("maxUploadedSize")+e.convertAllFormatsToMBCount(o.size);e.setData({maxUploadedSize:d,barsize:d/20*100}),Lyte.objectUtils(a,"add","initialReq",!1),Lyte.objectUtils(a,"add","attachController","crm.button.attach")}else e.ajaxError(this.fileName),e.throwError(I18n.getMsg("crm.image.unsupported.corrupted.single"))}catch(e){if(!s.is(":visible"))throw e}},error:function(){try{e.ajaxError(this.fileName)}catch(e){if(murphy.error(e),!s.is(":visible"))throw e}},complete:function(){e.getData("uploadCount")===e.getData("incommingCount")&&(Lyte.objectUtils(e.getData("globalObj"),"add","toolTipTitle",""),Lyte.objectUtils(e.getData("globalObj"),"add","showPickerTooltip",!1),e.setData({incommingCount:0,uploadCount:0}),e.bindSortableWithDOM())}})}}))}else{e.data._pluginScope.files=[],!1===o.proceed&&"count"===o.details?e.throwError(I18n.getMsg("crm.imageupload.allowed.field.length",e.getData("allowedSize"))):!1===o.proceed&&"size"===o.details?e.throwError(I18n.getMsg("crm.fileuploader.message.totalfilesizeexceeded",t.options.maxFileSize+"MB")):!1===o.proceed&&"name"===o.details?e.throwError(I18n.getMsg("crm.image.name.maxsize")):e.throwError(I18n.getMsg("crm.attach.internalErr.image"));var d=e.getData("maxUploadedSize");e.setData({maxUploadedSize:d,barsize:d/20*100})}})),t.on("dragover",(function(){document.querySelector(".imageDropAreaWrap").classList.add("imageUploadDragging")})),t.on("dragleave",(function(){document.querySelector(".imageDropAreaWrap").classList.remove("imageUploadDragging")})),t.on("error",(function(){this.options.pickerNotificationsNeeded=!1,e.data._pluginScope.files=[],e.throwError(I18n.getMsg("crm.attach.internalErr.image"))}))}})},nameChangeCallBack:function(e,t){this.retreiveNameData(e,t,!0),this.bindSortableWithDOM();var a=this.getData("globalObj");Lyte.objectUtils(a,"add","upload",!1),Lyte.objectUtils(a,"add","initialReq",!1)},descChangeCallBack:function(e,t){this.retreiveDescriptionData(e,t,!0),this.bindSortableWithDOM();var a=this.getData("globalObj");Lyte.objectUtils(a,"add","upload",!1),Lyte.objectUtils(a,"add","initialReq",!1)},afterCropCallBack:function(e,t){this.retreiveCropData(e,t,!0),this.bindSortableWithDOM();var a=this.getData("globalObj");Lyte.objectUtils(a,"add","upload",!1),Lyte.objectUtils(a,"add","initialReq",!1)},deleteImageFromPreview:function(e){this.removeThisUploadedImageComplete(e),this.bindSortableWithDOM();var t=this.getData("globalObj");Lyte.objectUtils(t,"add","upload",!1),Lyte.objectUtils(t,"add","initialReq",!1)},afterPreviewClose:function(){Lyte.objectUtils(this.getData("globalObj"),"add","closeOnEscape",!0)}},closePicker:function(){this.setData("showPopup",!1),thirdPartyUtils.unbindChildEvents($(".imageDropAreaWrap")),this.getMethods("onCancel")&&this.executeMethod("onCancel")},ajaxError:function(e){this.setData("uploadCount",this.getData("uploadCount")+1),this.data._pluginScope.files=[];for(var t=this.getData("maxUploadedSize"),a=this.getData("imageData"),i=a.length,o=0;o<i;o++)if(a[o].filename===e&&void 0===a[o].failed){var s={};s.filename=a[o].filename,s.failed=!0,s.completed=!0,Lyte.arrayUtils(a,"replaceAt",o,s);break}this.setData({maxUploadedSize:t,barsize:t/20*100,storedCount:a.length})},removeThisUploadedImageComplete:function(e){var t=this.getData("imageData"),a=this.getData("maxUploadedSize"),i=t.length,o=[].concat(this.getData("usedNames"));if(isNaN(e)){for(var s=0;s<i;s++)if(t[s].filename===e&&!0===t[s].failed){o.removeLastOccurenceOfElement(t[s].filename),Lyte.arrayUtils(t,"removeAt",s,1);break}}else{for(s=0;s<i;s++)if(t[s].uploadid===e){a-=this.convertAllFormatsToMBCount(t[s].size),o.removeLastOccurenceOfElement(t[s].filename),Lyte.arrayUtils(t,"removeAt",s,1);break}this.data._pluginScope.files=[]}this.setData({maxUploadedSize:a,barsize:a/20*100,storedCount:t.length,usedNames:o}),Lyte.objectUtils(this.getData("globalObj"),"add","upload",!1),this.bindSortableWithDOM(),(t.length<=0&&0===this.getData("imageDataExisting").length||this.checkForFailedUploads(t)||this.getData("uploadCount")!==this.getData("incommingCount"))&&Lyte.objectUtils(this.getData("globalObj"),"add","upload",!0),this.getMethods("onDelete")&&this.executeMethod("onDelete",e)},calculatePickUI:function(){var e=renderingUtils.windowHeight/100*85;e>=550&&(e=550);var t=e-($L(".modalHeadingTextImg").outerHeight()+$L(".uploadActionArea").outerHeight()+35);Lyte.objectUtils(this.getData("uploadPopupDetails"),"add","finalHeight",t),this.calculateSelectedListUI()},calculateSelectedListUI:function(){var e=$L(".selectedImage").outerHeight(),t=$L(".remainingSpaceWrap").outerHeight(),a=this.getData("uploadPopupDetails.finalHeight")-(e+t+2);Lyte.objectUtils(this.getData("uploadPopupDetails"),"add","contentScrollHgt",a)},bindSortableWithDOM:function(){var e=$L(".uploadedImageSecList");this.rearrangeSequence(),e.hasClass("sortable-parent")&&e.sortable("destroy"),this.getData("storedCount")>1&&e.sortable({restrict:".restrictImage",orientation:"vertical",cancel:".editUploadedImage,.deleteUploadedImage",onDrop:function(e,t,a,i,o){i!==o&&$L("crm-image-upload-picker")[0].component.bindSortableWithDOM()}})},rearrangeSequence:function(){this.rearrangeSequenceComplete($L(".uploadedImageSecList .selectedImageList"));var e=this.getData("globalObj");Lyte.objectUtils(e,"add","upload",!1),this.checkForFailedUploads(this.getData("imageData"))&&Lyte.objectUtils(e,"add","upload",!0)},validateDetails:function(e){for(var t={proceed:!0},a=this.getData("maxUploadedSize"),i=0,o=e.length,s=0;s<o;s++){if(e[s].name.substring(0,e[s].name.lastIndexOf(".")).length>100){t.proceed=!1,t.details="name";break}var n=e[s].size;a+=this.convertAllFormatsToMBCount(this.convertStreamToActualSize(n).toString()),i++}return Math.ceil(a)>20&&!0===t.proceed&&(t.proceed=!1,t.details="size"),this.getData("storedCount")+i>this.getData("allowedSize")&&!0===t.proceed&&(t.proceed=!1,t.details="count"),t},fetchNewImageDetails:function(e,t,a){var i=this;return new Promise((function(o){i.constructSizeMinimizedImage(URL.createObjectURL(e)).then((function(s){for(var n={},r=e.name;!0===i.checkNameAvailability(r);)r=i.changeUsedName(r,e.extn);i.addUsedImageNames(r),n.filename=r,n.enc_filename=encodeURIComponent(r);var l=URL.createObjectURL(e);n.src=s.url,n.sequence=t++,n.original_src=l,a[e.name]=r,o(n)}))}))},throwError:function(e){$("#crm-msg").remove(),this.setData("customMessages",e);var t=this.getData("globalObj");Lyte.objectUtils(t,"add","error",!0),void 0===t.initialReq||t.initialReq||Lyte.objectUtils(t,"add","upload",!1)},storedCountObserver:function(e){var t=this.getData("globalObj");e.newValue===this.getData("allowedSize")?Lyte.objectUtils(t,"add","disableSelection",!0):Lyte.objectUtils(t,"add","disableSelection",!1)}.observes("storedCount")},{mixins:["crm-image-mixin"]}),Lyte.Component.registerHelper("constructErrorClassesPopup",(function(e,t){if("Image_Validation"===this.getData("parentFeature"))if("head"===t){if("processing"===e)return"activeImage_visionError activeImage_visionProcessing";if("system_rejected"===e||"waiting_for_approval"===e)return"activeImage_visionError"}else if("filename"===t)return"system_rejected"===e?"uploadedImageName_Vision":"uploadedImageName_Vision_nodelete";return""})),Lyte.Component.registerHelper("convertBytesToDecimal",(function(e){return Math.round(100*e)/100})),Lyte.Component.register("crm-image-upload-detail",{_template:'<template tag-name="crm-image-upload-detail"> <template is="if" value="{{expHandlers(showpopup,\'===\',true)}}"><template case="true"> <crm-image-upload-picker allowed-size="{{allowedSize}}" show-uploads="true" show-popup="{{lbind(showpopup)}}" image-data-existing="{{imageData}}" fieldid="{{fieldid}}" entity-id="{{entityId}}" module="{{module}}" parent-feature="{{parentFeature}}" on-upload="{{method(&quot;finishUploadCallback&quot;)}}" on-delete="{{method(&quot;onDeleteCallback&quot;)}}"></crm-image-upload-picker> </template></template> <template is="if" value="{{expHandlers(showPreview,\'===\',true)}}"><template case="true"> <crm-image-preview show-preview="{{lbind(showPreview)}}" image-data="{{imageData}}" is-editable="{{isEditable}}" fieldid="{{fieldid}}" preview-configuration="{{previewConfiguration}}" module="{{module}}" entity-id="{{entityId}}" on-crop="{{method(&quot;afterCropCallBack&quot;)}}" on-name-change="{{method(&quot;nameChangeCallBack&quot;)}}" on-desc-change="{{method(&quot;descChangeCallBack&quot;)}}" on-delete="{{method(&quot;deleteImageFromPreview&quot;)}}"></crm-image-preview> </template></template> <img src="//:0" alt="//:0" class="temporaryImageOrientationCheck dN "> <div class="{{concat(\'detailsPageImagesList \',if(singleColumnLayout,\'singleLayout \',\'doublelayout \'),checkForImageLoading(configuration.imageLoaded,storedCount))}}"> <ul class="p0 m0 uploadedImageListDL"> <template is="for" items="{{imageData}}" item="item" index="index"> <template is="if" value="{{expHandlers(expHandlers(expHandlers(parentFeature,\'===\',\'Image_Validation\'),\'&amp;&amp;\',expHandlers(item.state,\'!==\',undefined)),\'&amp;&amp;\',expHandlers(item.state,\'!==\',null))}}"><template case="true"> <li class="{{concat(\'imageGalleryListWrap \',constructErrorClassesDetail(item.state))}}" onclick="{{action(\'openPopupHandler\',item.uploadid,item.state)}}" data-zcqa="openPreview_view_{{item.state}}_{{index}}" data-sel-image="{{index}}" id="{{item.uploadid}}" lt-prop-title="{{renderNameToolTip(item.filename)}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;top&quot;, &quot;margin&quot; : &quot;2px&quot;, &quot;maxdisplaytime&quot;:3000}"> <template is="if" value="{{expHandlers(expHandlers(item.state,\'===\',\'processing\'),\'!\')}}"><template case="true"> <div class="individualAjaxEdit"> <span class="individualPreviewIcon"></span> <template is="if" value="{{expHandlers(expHandlers(readonly,\'!\'),\'&amp;&amp;\',expHandlers(item.state,\'===\',\'system_rejected\'))}}"><template case="true"> <span class="individualDeleteIcon" data-zcqa="fieldView_delete" onclick="{{action(\'removeThisImage\',item.uploadid)}}"></span> </template></template> </div> </template></template> <img src="{{item.src}}" alt="{{item.src}}" class="imageGalleryList"> </li> </template><template case="false"> <li class="imageGalleryListWrap imageRendered_{{configuration.componentCount}}" data-zcqa="openPreview_view_{{index}}" onclick="{{action(\'openPreview\',item.uploadid)}}" data-lytecbox-title="{{item.filename}}" data-lytecbox-dlink="{{constructDownloadUrl(item.original_src)}}" data-lytecbox-href="{{item.original_src}}" data-sel-image="{{index}}" id="{{item.uploadid}}" lt-prop-title="{{renderNameToolTip(item.filename)}}" lt-prop-tooltip-style="font-size: 1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;top&quot;, &quot;margin&quot; : &quot;2px&quot;, &quot;maxdisplaytime&quot;:3000}"> <div class="individualAjaxEdit"> <span class="individualPreviewIcon"></span> <template is="if" value="{{expHandlers(readonly,\'!\')}}"><template case="true"> <span class="individualDeleteIcon" data-zcqa="fieldView_delete" onclick="{{action(\'removeThisImage\',item.uploadid)}}"></span> </template></template> </div> <img src="{{item.src}}" alt="{{item.src}}" class="imageGalleryList"> </li> </template></template> </template> <template is="if" value="{{expHandlers(expHandlers(expHandlers(configuration.showImageIcon,\'===\',true),\'&amp;&amp;\',expHandlers(readonly,\'!\')),\'&amp;&amp;\',expHandlers(fromPrintPreview,\'!\'))}}"><template case="true"> <template is="if" value="{{expHandlers(storedCount,\'>=\',allowedSize)}}"><template case="true"> <li class="addNewImageInAjax readonlyF op5" data-zcqa="fieldView_openPopup" lt-prop-title="{{getI18n(\'crm.imageupload.allowed.field.length\',allowedSize)}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"> <span class="dB crm-font-regular mT10 plusIcon f20">+</span> <span>{{getI18n(\'crm.image.header\')}}</span> </li> </template><template case="false"> <li class="addNewImageInAjax" data-zcqa="fieldView_openPopup" onclick="{{action(\'openUploadPopup\')}}"> <span class="dB crm-font-regular mT10 plusIcon f20">+</span> <span>{{getI18n(\'crm.image.header\')}}</span> </li> </template></template> </template></template> <template is="if" value="{{expHandlers(expHandlers(expHandlers(emptyValue,\'!==\',undefined),\'&amp;&amp;\',expHandlers(storedCount,\'===\',0)),\'&amp;&amp;\',expHandlers(configuration.showImageIcon,\'===\',false))}}"><template case="true"> <li class="clearB p0 emptyValue">{{emptyValue}}</li> </template><template case="false"> <li class="clearB p0"></li> </template></template> </ul> <template is="if" value="{{expHandlers(fromPrintPreview,\'!\')}}"><template case="true"> <div class=" {{concat(\'openAjaxEdit \',if(readonly,\'imageFieldReadOnly \',\' \'),if(configuration.showLockScreen,\'\',\'NoEditPermission\'))}}"> <span class="ajaxActionIcon" lt-prop-title="{{if(readonly,getI18n(\'crm.label.readonly\'),getI18n(\'crm.label.edit\'))}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"></span> </div> </template></template> <template is="if" value="{{expHandlers(expHandlers(readonly,\'!\'),\'&amp;&amp;\',expHandlers(fromPrintPreview,\'!\'))}}"><template case="true"> <template is="if" value="{{configuration.showSave}}"><template case="true"> <span class="saveImageEdit" data-zcqa="fieldView_ajaxsave" onclick="{{action(\'saveImageEdit\')}}"></span> </template></template> <template is="if" value="{{configuration.showCancel}}"><template case="true"> <span class="cancelImageEdit" data-zcqa="fieldView_ajaxcancel" onclick="{{action(\'cancelImageEdit\')}}"></span> </template></template> </template></template> </div> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}},{type:"attr",position:[3]},{type:"if",position:[3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}},{type:"attr",position:[7]},{type:"attr",position:[7,1,1]},{type:"for",position:[7,1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,3]},{type:"if",position:[1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}}]}},default:{}},{type:"attr",position:[1,3]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1,3]},{type:"if",position:[1,1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}},{type:"attr",position:[1,3]}]}},default:{}}]},{type:"attr",position:[7,1,3]},{type:"if",position:[7,1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,3,0]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,3,0]}]}},default:{}}]}},default:{}},{type:"attr",position:[7,1,5]},{type:"if",position:[7,1,5],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]},false:{dynamicNodes:[]}},default:{}},{type:"attr",position:[7,3]},{type:"if",position:[7,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]}]}},default:{}},{type:"attr",position:[7,5]},{type:"if",position:[7,5],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}},{type:"attr",position:[3]},{type:"if",position:[3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}}]}},default:{}}],_observedAttributes:["imageData","existingData","modifiedIds","removedIds","tempRemovedIds","fieldid","entityId","module","columnName","apiName","parentFeature","emptyValue","componentRenderingElement","componentRenderingType","fromPrintPreview","showpopup","showPreview","readonly","isEditable","singleColumnLayout","isDetailPage","thumbnailRequest","dataModified","storedCount","allowedSize","previewUrlVsUploadIdMap","previewConfiguration","configuration","previewPageChanges","sequenceChanges","cxPropField"],data:function(){return{imageData:Lyte.attr("array",{default:[],hideAttr:!0}),existingData:Lyte.attr("array",{default:[],hideAttr:!0}),modifiedIds:Lyte.attr("array",{default:[]}),removedIds:Lyte.attr("array",{default:[]}),tempRemovedIds:Lyte.attr("array",{default:[]}),fieldid:Lyte.attr("string",{default:void 0,hideAttr:!0}),entityId:Lyte.attr("string",{default:void 0,hideAttr:!0}),module:Lyte.attr("string",{default:void 0,hideAttr:!0}),columnName:Lyte.attr("string",{default:void 0,hideAttr:!0}),apiName:Lyte.attr("string",{default:void 0,hideAttr:!0}),parentFeature:Lyte.attr("string",{default:void 0,hideAttr:!0}),emptyValue:Lyte.attr("string",{default:void 0,hideAttr:!0}),componentRenderingElement:Lyte.attr("string",{default:"dvinner",hideAttr:!0}),componentRenderingType:Lyte.attr("string",{default:"id",hideAttr:!0}),fromPrintPreview:Lyte.attr("boolean",{default:!1,hideAttr:!0}),showpopup:Lyte.attr("boolean",{default:!1,hideAttr:!0}),showPreview:Lyte.attr("boolean",{default:!1,hideAttr:!0}),readonly:Lyte.attr("boolean",{default:!1,hideAttr:!0}),isEditable:Lyte.attr("boolean",{default:!1,hideAttr:!0}),singleColumnLayout:Lyte.attr("boolean",{default:!1,hideAttr:!0}),isDetailPage:Lyte.attr("boolean",{default:!0,hideAttr:!0}),thumbnailRequest:Lyte.attr("boolean",{default:!0,hideAttr:!0}),dataModified:Lyte.attr("boolean",{default:!1,hideAttr:!0}),storedCount:Lyte.attr("number",{default:0,hideAttr:!0}),allowedSize:Lyte.attr("number",{default:0,hideAttr:!0}),previewUrlVsUploadIdMap:Lyte.attr("object",{default:{}}),previewConfiguration:Lyte.attr("object",{default:{}}),configuration:Lyte.attr("object",{default:{showImageIcon:!1,showSave:!1,showCancel:!1,DOMConstructed:!1,showLockScreen:!0}}),previewPageChanges:Lyte.attr("array",{default:[]}),sequenceChanges:Lyte.attr("object",{default:{}}),cxPropField:Lyte.attr("object")}},init:function(){var e=$L(this.$node).closest("#value_"+this.getData("columnName"));if(this.getData("fromPrintPreview")&&(void 0!==$L("#valueTD_"+this.getData("columnName"))[0]&&(e=$L("#valueTD_"+this.getData("columnName"))).addClass("printImage eventNone"),this.setData("isEditable",!1)),e.addClass("imageDetailWrap cP"),e.closest(".tabdiv").addClass("imageUploadDetailPage"),this.getData("singleColumnLayout")||e.addClass("imageDoubleLayout"),null==this.getData("parentFeature")){var t,a=store.peekRecord(moduleRecordMapping[this.getData("module")].id,this.getData("entityId"));if(a&&a.$zia_visions)for(var i=a.$zia_visions,o=i.length,s=0;s<o;s++){var n=i[s];n.field&&n.field.api_name===this.getData("apiName")&&(t="Image_Validation")}this.setData("parentFeature",t)}this.getData("existingData").length>0&&e.addClass(" contentLoading"),this.getData("fromPrintPreview")?this.setData("isEditable",!1):this.constructImageDataInitial(),0===this.getData("existingData").length&&!1===this.getData("isDetailPage")&&this.imagesLoaded()},constructImageDataInitial:function(){setTimeout(function(){var e=$L("#value_"+this.getData("columnName"));if(this.getData("isDetailPage")){var t=$("#mouseArea__"+this.getData("columnName")).data("params");handleMouseOver(t.uitype,t.colname,t.readonly,!1,"",t.maxlength,void 0,t.isExternalField)}if(this.getData("readonly"))this.setData("isEditable",!1),Lyte.objectUtils(this.getData("configuration"),"add","showLockScreen",!0);else if(detailView.readOnlyField||detailView.recordLocked)this.setData("isEditable",!1),Lyte.objectUtils(this.getData("configuration"),"add","showLockScreen",!1);else{this.setData("isEditable",!0);var a=this;e.on("click",(function(e){var t=$L(e.target);(t.hasClass("imageDetailWrap")||t.hasClass("uploadedImageListDL")||t.hasClass("openAjaxEdit")||t.hasClass("ajaxActionIcon")||t.hasClass("detailsPageImagesList")||t.hasClass("emptyValue"))&&a.openAjaxEditButtons()}))}}.bind(this),50)},didConnect:function(){this.renderDataForComponent(!1,this.getData("existingData"));var e=$L("#value_"+this.getData("columnName"));if(!1===this.getData("fromPrintPreview")&&Lyte.objectUtils(this.getData("configuration"),"add","componentCount",detailView.imageUploadFieldRenderedCount++),this.getData("imageData").length>0){if(!0===this.getData("fromPrintPreview")||!1===this.getData("isDetailPage"))this.constructImageData();else{var t;"id"===this.getData("componentRenderingType")?t=document.getElementById(this.getData("componentRenderingElement")):"class"===this.getData("componentRenderingType")&&(t=document.getElementsByClassName(this.getData("componentRenderingElement"))[0]);var a=_.debounce(function(){var e;this.isInViewport(this.$node)&&("id"===this.getData("componentRenderingType")?e=document.getElementById(this.getData("componentRenderingElement")):"class"===this.getData("componentRenderingType")&&(e=document.getElementsByClassName(this.getData("componentRenderingElement"))[0]),e.removeEventListener("scroll",a),e.removeEventListener("resize",a),e.removeEventListener("orientationchange",a),this.constructImageData())}.bind(this),300);t.addEventListener("scroll",a),t.addEventListener("resize",a),t.addEventListener("orientationchange",a),a()}e.removeClass("emptyImageField")}else e.addClass("emptyImageField"),Lyte.objectUtils(this.getData("configuration"),"add","imageLoaded",!0)},renderDataForComponent:function(e,t){e&&this.setData("existingData",t);for(var a=t.length,i=[],o=0;o<a;o++){var s=this.constructImageUrl(t[o].File_Id,this.getData("module"),this.getData("entityId"),t[o].id,t[o].File_Name,t[o].State);i.push({uploadid:t[o].id,filename:t[o].File_Name,fileId:t[o].File_Id,original_src:s,src:this.getData("previewUrlVsUploadIdMap")[t[o].File_Id]?this.getData("previewUrlVsUploadIdMap")[t[o].File_Id]:void 0,extn:t[o].File_Name.substring(t[o].File_Name.lastIndexOf("."),t[o].File_Name.length),stream:t[o].Size,description:t[o].Description,state:t[o].State,sequence:t[o].Sequence_Number})}i=this.sortImagesComplete(i),this.setData({existingData:i,imageData:[],storedCount:i.length});for(o=0;o<a;o++)Lyte.arrayUtils(this.getData("imageData"),"push",JSON.parse(JSON.stringify(i[o])));this.setData("dataModified",!1)},constructImageData:function(){!1===this.getData("configuration").DOMConstructed&&this.makeRequestForThumbnail()},actions:{openPopupHandler:function(e,t){this.openFeaturePopup(this,e,t,!1,!0)},openPreview:function(e){if(!0===this.getData("configuration").imageLoaded){var t={currentId:e,selector:"imageRendered_"+this.getData("configuration").componentCount,crop:!0,downloadImage:!0,fileName:!0,description:!0,infoIcon:!0,deleteIcon:!0,zoom:!0};return this.setData({previewConfiguration:t,showPreview:!0}),$L(".imagePreviewParent").focus(),!1}},openAjaxEdit:function(){this.openAjaxEditButtons()},saveImageEdit:function(){if(!this.getData("readonly"))if(this.getData("isDetailPage")){$L("#value_"+this.getData("columnName")).removeClass("newmandatory imageErrorMessage"),$("#errorMsg_"+this.getData("fieldid")).remove(),Callonclickofbutton("/crm/v2.2/","Crm_"+this.getData("module")+"_"+this.getData("columnName"),"value_"+this.getData("columnName"),"textarea_"+this.getData("columnName"),this.getData("columnName"),this.getData("module"),"subvalue_"+this.getData("columnName"),"556",void 0,this.getData("columnName"),this.getData("entityId"),"false",void 0,this.getData("fieldid"),"false")}else{var e=store.peekRecord(moduleRecordMapping[this.getData("module")].id,this.getData("entityId")),t=this.getData("apiName"),a=this;Lyte.Component.set(e,t,this.constructAPIRequestBody()),a.getMethods("onBeforeSave")&&(a.executeMethod("onBeforeSave",this.getData("dataModified"))?e.$.save({},{affected_data:"true"}).then((function(e){var i=e[moduleRecordMapping[a.data.module].id][t];void 0!==i&&a.renderDataForComponent(!0,i),a.setData("removedIds",[]),a.setData("previewPageChanges",[]),a.setData("sequenceChanges",{}),a.saveImageEditButtons(),a.getMethods("onSave")&&a.executeMethod("onSave",e)}),(function(){e.$.rollBack(),a.getMethods("onSave")&&a.executeMethod("onSave")})):this.getData("dataModified")||(this.setData("removedIds",[]),this.setData("previewPageChanges",[]),this.setData("sequenceChanges",{}),this.saveImageEditButtons()))}},cancelImageEdit:function(){if(!this.getData("readonly")){this.getMethods("onBeforeCancel")&&this.executeMethod("onBeforeCancel");var e=$L(this.$node);e.closest(".imageUploadDetailPage").removeClass("eventNone");var t=e.closest("#value_"+this.getData("columnName"));this.getData("isDetailPage")&&t.removeClass("imageEditState"),t.removeClass("newmandatory imageErrorMessage"),$("#errorMsg_"+this.getData("fieldid")).remove(),itsonview=!1,this.isInEditMode(!1),this.constructIconsForDetailPage(!1,!1,!1);var a=$L(this.$node).find(".uploadedImageListDL");a.hasClass("sortable-parent")&&a.sortable("destroy");var i=this.getData("existingData"),o=i.length;this.setData("imageData",[]);for(var s=0;s<o;s++){var n=this.getData("previewUrlVsUploadIdMap")[i[s].fileId];i[s].src=n||i[s].original_src,Lyte.arrayUtils(this.getData("imageData"),"push",JSON.parse(JSON.stringify(i[s])))}this.setData({storedCount:o,removedIds:[],previewPageChanges:[],sequenceChanges:{}}),this.rearrangeSequence(),this.setData("dataModified",!1),this.getMethods("onCancel")&&this.executeMethod("onCancel")}},openUploadPopup:function(){this.getData("isEditable")&&!this.getData("readonly")&&this.setData("showpopup",!0)},removeThisImage:function(e){return this.removeThisImageComplete(e),!1}},methods:{finishUploadCallback:function(e,t){this.fetchDeletedImageIdsPopup([].concat(this.getData("imageData")));for(var a=[],i=e.length,o=0;o<i;o++)Lyte.objectUtils(this.getData("previewUrlVsUploadIdMap"),"add",e[o].fileId,e[o].src),a.push(JSON.parse(JSON.stringify(e[o])));this.fetchPreviewPageChangesPopup(t),this.setData({imageData:a,storedCount:a.length}),this.bindSortableWithDOM(!0),this.setData("dataModified",!0)},nameChangeCallBack:function(e,t){this.retreiveNameData(e,t,!1),this.openAjaxEditButtons(),this.setData("dataModified",!0)},descChangeCallBack:function(e,t){this.retreiveDescriptionData(e,t,!1),this.openAjaxEditButtons(),this.setData("dataModified",!0)},afterCropCallBack:function(e,t){this.retreiveCropData(e,t,!1),Lyte.objectUtils(this.getData("previewUrlVsUploadIdMap"),"add",t.fileId,t.src),this.openAjaxEditButtons(),this.setData("dataModified",!0)},deleteImageFromPreview:function(e){this.removeThisImageComplete(e),this.openAjaxEditButtons(),this.setData("dataModified",!0)},onDeleteCallback:function(e){var t=this.getData("tempRemovedIds");isNaN(e)||t.push(e),this.setData("dataModified",!0),this.setData("tempRemovedIds",t)}},constructIconsForDetailPage:function(e,t,a){void 0!==e&&Lyte.objectUtils(this.getData("configuration"),"add","showImageIcon",e),void 0!==t&&Lyte.objectUtils(this.getData("configuration"),"add","showSave",t),void 0!==a&&Lyte.objectUtils(this.getData("configuration"),"add","showCancel",a)},removeThisImageComplete:function(e){if(this.getData("isEditable")&&!this.getData("readonly")){for(var t=[].concat(this.getData("imageData")),a=t.length,i=[].concat(this.getData("removedIds")),o=this.getData("existingData"),s=0;s<a;s++)if(t[s].uploadid===e){for(var n=o.length,r=0;r<n;r++)if(o[r].uploadid===e){i.push(e);break}Lyte.arrayUtils(t,"removeAt",s,1);break}this.setData({removedIds:i,imageData:t,storedCount:t.length}),this.bindSortableWithDOM(!0),this.setData("dataModified",!0)}},bindSortableWithDOM:function(e){e&&this.rearrangeSequence();var t=$L(this.$node).find(".uploadedImageListDL");t.hasClass("sortable-parent")&&t.sortable("destroy"),this.getData("storedCount")>1&&t.sortable({restrict:".addNewImageInAjax",cancel:".individualEditIcon,.individualDeleteIcon",onDrop:function(e,t,a,i,o,s){i!==o&&$L(s).closest("crm-image-upload-detail")[0].component.bindSortableWithDOM(!0)}})},rearrangeSequence:function(){this.rearrangeSequenceComplete($L(this.$node).find(".uploadedImageListDL .imageGalleryListWrap")),this.setData("dataModified",!0)},imagesLoaded:function(){Lyte.objectUtils(this.getData("configuration"),"add","imageLoaded",!0);var e=this.getData("imageData"),t=e.length;e=this.sortImagesComplete(e);for(var a=0;a<t;a++)Lyte.objectUtils(this.getData("previewUrlVsUploadIdMap"),"add",e[a].fileId,e[a].src),Lyte.arrayUtils(this.getData("imageData"),"replaceAt",a,e[a]);$L(this.$node).closest(".imageDetailWrap").removeClass("contentLoading"),this.getMethods("onImagesLoad")&&this.executeMethod("onImagesLoad")},isInEditMode:function(e){e?($L(".detailViewContainer").addClass("editModeEnable"),$L(".newBusinessCardView").addClass("editModeEnable")):($L(".detailViewContainer").removeClass("editModeEnable"),$L(".newBusinessCardView").removeClass("editModeEnable"))},openAjaxEditButtons:function(){if(!this.getData("readonly")&&!0===this.getData("configuration").imageLoaded&&!itsonview){var e=$L(this.$node),t=e.closest("#value_"+this.getData("columnName"));t.hasClass("imageEditState")||(this.getData("isDetailPage")&&"true"===e.closest("#mouseArea__"+this.getData("columnName")).data("params").mandate&&t.addClass("newmandatory"),t.addClass("imageEditState"),e.closest(".imageDetailWrap").hasClass("imageEditState")||e.closest(".imageUploadDetailPage").addClass("eventNone"),itsonview=!0,this.constructIconsForDetailPage(!0,!0,!0),this.bindSortableWithDOM(),this.isInEditMode(!0),this.getMethods("onEdit")&&this.executeMethod("onEdit"))}},saveImageEditButtons:function(){var e=$L(this.$node);this.getData("isDetailPage")&&(e.closest("#value_"+this.getData("columnName")).removeClass("imageEditState newmandatory"),e.closest(".imageUploadDetailPage").removeClass("eventNone")),itsonview=!1,this.isInEditMode(!1),this.constructIconsForDetailPage(!1,!1,!1);var t=$L(this.$node).find(".uploadedImageListDL");t.hasClass("sortable-parent")&&t.sortable("destroy")},constructErrorDiv:function(e){var t="<span id='errorMsg_"+this.getData("fieldid")+"' class='errMsg errorMsgDesc'>"+I18n.getMsg(e)+"</span>",a=$("#value_"+this.getData("columnName"));a.append(t),"true"===$("#mouseArea__"+this.getData("columnName")).data("params").mandate&&a.addClass("newmandatory"),a.addClass("imageErrorMessage")},removeErrorDiv:function(){$L("#value_"+this.getData("columnName")).removeClass("imageErrorMessage"),$("#errorMsg_"+this.getData("fieldid")).remove()},storedCountObserver:function(e){var t=$L("#value_"+this.getData("columnName"));0===e.newValue?t.removeClass("imageValueWrap imageElementsFull"):e.newValue>=this.getData("allowedSize")?t.addClass("imageElementsFull imageValueWrap"):(t.addClass("imageValueWrap"),t.removeClass("imageElementsFull"))}.observes("storedCount")},{mixins:["crm-image-mixin","crm-vision-create"]}),Lyte.Component.registerHelper("checkForImageLoading",(function(e,t){return t>0?!0===e?"":"eventNone":""})),Lyte.Component.registerHelper("constructDownloadUrl",(function(e){return void 0===e?"":e.replace("&downLoadMode=inline","")})),Lyte.Component.registerHelper("constructErrorClassesDetail",(function(e){if("Image_Validation"===this.getData("parentFeature")){if("processing"===e)return"imageGalleryListWrap_visionError imageGalleryListWrap_visionProcessing";if("system_rejected"===e||"waiting_for_approval"===e)return"imageGalleryListWrap_visionError"}return""})),Lyte.Component.register("crm-image-cropper",{_template:'<template tag-name="crm-image-cropper"> <lyte-modal lt-prop-show="{{if(showCropper,\'true\',\'false\')}}" lt-prop-width="100%" lt-prop-height="100%" lt-prop-wrapper-class="imageEditorWrap" lt-prop-transition-animation="fadeIn" lt-prop-transition-duration="0.5" lt-prop-close-on-escape="false"> <template is="registerYield" yield-name="modal"> <div class="{{concat(\'imageEditParent \',if(isCrmPlus,\'cropperFromCrmPlus \',\'\'))}}"> <div class="editorToolsBox"> <ul class="editorToolsWrap fL"> <li class="{{concat(\'editorToolsList fL \',if(ifEquals(cropperConfiguration.ratio,\'n:n\'),\'sel \',\' \'))}}" lt-prop-title="{{getI18n(\'crm.image.n.n\')}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"> <span class="customRatioIco cP" data-zcqa="cropper_n_n" onclick="{{action(\'resizeCropperSelector\',\'n:n\')}}"></span> </li> <li class="{{concat(\'editorToolsList fL \',if(ifEquals(cropperConfiguration.ratio,\'1:1\'),\'sel \',\' \'))}}" lt-prop-title="{{getI18n(\'crm.image.2.2\')}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"> <span class="squareRatioIco cP" data-zcqa="cropper_1_1" onclick="{{action(\'resizeCropperSelector\',\'1:1\')}}"></span> </li> <li class="{{concat(\'editorToolsList fL \',if(ifEquals(cropperConfiguration.ratio,\'4:3\'),\'sel \',\' \'))}}" lt-prop-title="{{getI18n(\'crm.image.4.3\')}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"> <span class="fourThreeRatioIco cP" data-zcqa="cropper_4_3" onclick="{{action(\'resizeCropperSelector\',\'4:3\')}}"></span> </li> <li class="{{concat(\'editorToolsList fL \',if(ifEquals(cropperConfiguration.ratio,\'16:9\'),\'sel \',\' \'))}}" lt-prop-title="{{getI18n(\'crm.image.16.9\')}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"> <span class="landscapeRatioIco cP" data-zcqa="cropper_16_9" onclick="{{action(\'resizeCropperSelector\',\'16:9\')}}"></span> </li> <li class="clearB"></li> </ul> <span class="toolsSeparation fL"></span> <div class="customInputsWrap fL"> <div class="customWidthInput"> <span class="customInputLabel f11">{{getI18n(\'zc.editor.width\')}}</span> <lyte-input lt-prop-appearance="box" lt-prop-class="cropperInput" class="customInputBox" lt-prop-maxlength="8" lt-prop-value="{{lbind(cropperConfiguration.cropperWidth)}}" on-blur="{{method(\'changeWidthValue\',cropperConfiguration.cropperWidth)}}" onkeydown="{{action(\'resizeCropperPosition\',event,\'width\')}}" lt-prop-type="number" data-zcqa="cropper_widthBox"></lyte-input> <span class="integerType">{{getI18n(\'crm.image.width.px\')}}</span> </div> <span class="valInterChangeIcon cP" data-zcqa="cropper_swapDimensions" onclick="{{action(\'swapAltitudesCropper\')}}" lt-prop-title="{{getI18n(\'crm.image.height.width.swap\')}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"></span> <div class="customHeightInput"> <span class="customInputLabel f11">{{getI18n(\'ze.editor.height\')}}</span> <lyte-input lt-prop-appearance="box" lt-prop-class="cropperInput" class="customInputBox" lt-prop-maxlength="8" lt-prop-value="{{lbind(cropperConfiguration.cropperHeight)}}" on-blur="{{method(\'changeHeightValue\',cropperConfiguration.cropperHeight)}}" onkeydown="{{action(\'resizeCropperPosition\',event,\'height\')}}" lt-prop-type="number" data-zcqa="cropper_HeightBox"></lyte-input> <span class="integerType">{{getI18n(\'crm.image.width.px\')}}</span> </div> </div> <span class="toolsSeparation fL"></span> <span class="imageRotateIcon fL cP" data-zcqa="rotateWhileEdit_preview" onclick="{{action(\'rotateWhileEdit\')}}" lt-prop-title="{{getI18n(\'crm.image.rotate.image\')}}" lt-prop-tooltip-style="font-size:1.2rem;" lt-prop-tooltip-config="{&quot;position&quot; : &quot;default&quot;}"></span> <div class="editorActionArea fR"> <lyte-button lt-prop-size="small" data-zcqa="closeCropArea_preview_empty" class="editCancelBtn" onclick="{{action(\'closeCropArea\')}}"> <template is="registerYield" yield-name="text"> {{getI18n(\'crm.button.cancel\')}} </template> </lyte-button> <lyte-button lt-prop-appearance="primary" lt-prop-size="small" class="mL10" lt-prop-disabled="{{cropSaveObserver}}" lt-prop-class="imageEditActionBtn" data-zcqa="closeCropArea_preview_value" onclick="{{action(\'closeCropArea\',true)}}"> <template is="registerYield" yield-name="text"> {{getI18n(\'crm.button.done\')}} </template> </lyte-button> </div> <div class="clearB"></div> </div> <div class="editContent" style="height:{{cropperConfiguration.editContent_height}}px;width:{{cropperConfiguration.editContent_width}}px;margin-top:{{cropperConfiguration.editContent_marginHgt}}px;"> <img class="editImageContent" src="{{imageUrl}}" style="max-height:{{cropperConfiguration.editImageContent_newHgt}}px;max-width:{{cropperConfiguration.editImageContent_winWidth}}px;" onload="{{action(\'cropperImageLoad\')}}"> </div> </div> </template> </lyte-modal> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1,1,1]},{type:"attr",position:[1,1,1,1,1]},{type:"attr",position:[1,1,1,3]},{type:"attr",position:[1,1,1,3,1]},{type:"attr",position:[1,1,1,5]},{type:"attr",position:[1,1,1,5,1]},{type:"attr",position:[1,1,1,7]},{type:"attr",position:[1,1,1,7,1]},{type:"text",position:[1,1,5,1,1,0]},{type:"attr",position:[1,1,5,1,3]},{type:"componentDynamic",position:[1,1,5,1,3]},{type:"text",position:[1,1,5,1,5,0]},{type:"attr",position:[1,1,5,3]},{type:"text",position:[1,1,5,5,1,0]},{type:"attr",position:[1,1,5,5,3]},{type:"componentDynamic",position:[1,1,5,5,3]},{type:"text",position:[1,1,5,5,5,0]},{type:"attr",position:[1,1,9]},{type:"attr",position:[1,1,11,1]},{type:"registerYield",position:[1,1,11,1,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[1,1,11,1]},{type:"attr",position:[1,1,11,3]},{type:"registerYield",position:[1,1,11,3,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[1,1,11,3]},{type:"attr",position:[1,3],attr:{style:{name:"style",helperInfo:{name:"concat",args:["'height:'","cropperConfiguration.editContent_height","'px;width:'","cropperConfiguration.editContent_width","'px;margin-top:'","cropperConfiguration.editContent_marginHgt","'px;'"]}}}},{type:"attr",position:[1,3,1],attr:{style:{name:"style",helperInfo:{name:"concat",args:["'max-height:'","cropperConfiguration.editImageContent_newHgt","'px;max-width:'","cropperConfiguration.editImageContent_winWidth","'px;'"]}}}}]},{type:"componentDynamic",position:[1]}],_observedAttributes:["imageUrl","showCropper","isCrmPlus","cropperConfiguration","cropSaveObserver","exifValue"],data:function(){return{imageUrl:Lyte.attr("string",{default:void 0}),showCropper:Lyte.attr("boolean",{default:!0}),isCrmPlus:Lyte.attr("boolean",{default:!1}),cropperConfiguration:Lyte.attr("object",{default:{}}),cropSaveObserver:Lyte.attr("boolean",{default:!0}),exifValue:Lyte.attr("number",{default:void 0})}},didConnect:function(){"undefined"!=typeof CrmPlusImpl&&CrmPlusImpl.isLoadedInCrmplus()&&this.setData("isCrmPlus",!0)},methods:{resizeCropperSelectorBlur:function(){this.saveCropperDimensions()},changeHeightValue:function(e){$L(".editImageContent").data("cropper").changeByHeight(e/this.getData("cropperConfiguration.cropper_actualHeight_diff")),this.setData("cropSaveObserver",!1),this.updateInputBoxData()},changeWidthValue:function(e){$L(".editImageContent").data("cropper").changeByWidth(e/this.getData("cropperConfiguration.cropper_actualWidth_diff")),this.setData("cropSaveObserver",!1),this.updateInputBoxData()}},actions:{cropperImageLoad:function(){this.editUiCalculationComplete(),this.bindCropperWithPreview("n:n")},rotateWhileEdit:function(e){this.rotateWhileEditComplete(e)},resizeCropperPosition:function(e,t){var a=e.which,i=this.getData("cropperConfiguration");40===a?(e.preventDefault(),e.stopPropagation(),"width"===t?this.saveCropperDimensions(t,i.cropperWidth-1):"height"===t&&this.saveCropperDimensions(t,i.cropperHeight-1)):38===a&&(e.preventDefault(),e.stopPropagation(),"width"===t?this.saveCropperDimensions(t,i.cropperWidth+1):"height"===t&&this.saveCropperDimensions(t,i.cropperHeight+1)),13===a&&(e.preventDefault(),e.stopPropagation(),"width"===t?this.saveCropperDimensions(t,i.cropperWidth):"height"===t&&this.saveCropperDimensions(t,i.cropperHeight))},swapAltitudesCropper:function(){$L(".editImageContent").data("cropper").swapAspectRatio(),this.setData("cropSaveObserver",!1),this.updateInputBoxData()},resizeCropperSelector:function(e){this.editUiCalculationComplete(),this.bindCropperWithPreview(e)},closeCropArea:function(e){!0===e?this.getMethods("onSave")&&this.executeMethod("onSave",$L(".editImageContent").data("cropper").getCroppedImage()):this.getMethods("onCancel")&&this.executeMethod("onCancel"),this.setData("cropSaveObserver",!0),this.setData("showCropper",!1)}},editUiCalculationComplete:function(e){var t=$L(".editImageContent"),a=$L(".editorToolsBox").outerHeight(),i=0,o=(i=this.getData("isCrmPlus")?document.children[0].clientHeight-28:renderingUtils.windowHeight)/100*85,s=renderingUtils.windowWidth/100*76;if(6===e||8===e)var n=t.width(),r=t.height();else n=t.height(),r=t.width();n>r?Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editImageContent_newHgt",o):n/100-r/100<=2.5||r/100-n/100<=2.5?(Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editImageContent_newHgt",o),Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editImageContent_winWidth",s)):Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editImageContent_winWidth",s);var l=t.height(),p=t.width(),d=(i-l)/2-a/2,c=i-a;if(6===e||8===e){var m=0;t.height()>t.width()?(m=l,d=(i-l)/2-a/2,Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editContent_height",m),Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editContent_width",s)):(m=p,d=(i-p)/2-a/2),c<=m&&(d=(i-(m=c-30))/2-a/2)}else Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editContent_height",l),Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editContent_width",p);Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editContent_marginHgt",d)},rotateWhileEditComplete:function(){var e=$L(".editImageContent"),t=e.data("cropper").angle,a=$L(".editorToolsBox").outerHeight(),i=0,o=this.getData("exifValue"),s=renderingUtils.windowWidth/100*76;i=this.getData("isCrmPlus")?document.children[0].clientHeight-28:renderingUtils.windowHeight;var n=e.height(),r=e.width(),l=i-a,p=(i-n)/2-a/2;if(0===t||180===t){var d=0;e.height()>e.width()?(d=n,p=(i-n)/2-a/2):(d=r,p=(i-r)/2-a/2),void 0===o||6!==o&&8!==o?(p=l<=d?(i-(d=l-30))/2-a/2:(l-d)/2+a,Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editContent_width",d)):(e.height()>e.width()?(d=n,p=(i-n)/2-a/2,Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editContent_height",d),Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editContent_width",s)):(d=r,p=(i-r)/2-a/2),l<=d&&(p=(i-(d=l-30))/2-a/2)),Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editContent_height",d)}else Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editContent_height",n),Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editContent_width",r);Lyte.objectUtils(this.getData("cropperConfiguration"),"add","editContent_marginHgt",p),e.data("cropper").rotate(),this.setData("cropSaveObserver",!1),this.fetchImageActualRatios(),this.updateInputBoxData()},bindCropperWithPreview:function(e){var t=$L(".editImageContent"),a=this,i=this.getData("cropperConfiguration");if(void 0!==e){if(Lyte.objectUtils(i,"add","ratio",e),void 0!==t.data("cropper")){var o=t.data("cropper").angle;if(90===o||270===o){var s=e.split(":");e=s.reverse().join(":")}}t.cropper({aspectRatio:e,cropDrag:function(){a.setData("cropSaveObserver",!1),a.updateInputBoxData()},beforeRender:function(e){void 0!==e&&(this.setData("exifValue",e),this.editUiCalculationComplete(e))}.bind(this),afterRender:function(){this.fetchImageActualRatios(),this.updateInputBoxData(),"n:n"!==i.ratio&&this.setData("cropSaveObserver",!1)}.bind(this),useExif:!0})}},fetchImageActualRatios:function(){var e=$L(".lyteCropCropper"),t=$L(".editImageContent").data("cropper").getCroppedImage();Lyte.objectUtils(this.getData("cropperConfiguration"),"add","cropper_actualHeight_diff",t.height/e.height()),Lyte.objectUtils(this.getData("cropperConfiguration"),"add","cropper_actualWidth_diff",t.width/e.width())},saveCropperDimensions:function(e,t){var a=$L(".editImageContent").data("cropper");"width"===e?a.changeByWidth(t/this.getData("cropperConfiguration.cropper_actualWidth_diff")):"height"===e&&a.changeByHeight(t/this.getData("cropperConfiguration.cropper_actualHeight_diff")),this.setData("cropSaveObserver",!1),this.updateInputBoxData()},updateInputBoxData:function(){var e=this.getData("cropperConfiguration"),t=$L(".editImageContent").data("cropper").resolution;Lyte.objectUtils(e,"add","cropperWidth",Math.round(t.width)),Lyte.objectUtils(e,"add","cropperHeight",Math.round(t.height))},bindTabClosePopup:function(e){e.newValue?window.onbeforeunload=function(){}:window.onbeforeunload=function(e){return(e=e||window.event)&&(e.returnValue="Sure?"),"Sure?"}}.observes("cropSaveObserver")});
