Lyte.Component.register("crm-entityscores-view",{_template:'<template tag-name="crm-entityscores-view"> <div class="bodyContainerDummy"> <div class="sRcontInner whiteBg"> <div class="sRcont"> <template is="if" value="{{expHandlers(entity_scoresTemp.length,\'>\',0)}}"><template case="true"> <lyte-table data-zcqa="sRRelatedTbl" lt-prop-scrollbar-option="{&quot;preventOnEnd&quot; : false}" class="srListView pR bT2 {{if(showTable,\'\',\'dN\')}} {{if(ifAllMatch(entity_scoresTemp.length,\'>\',5),\'h300\',\'\')}}" lt-prop-yield="true" id="srListView" lt-prop-scroll="{&quot;horizontal&quot;: false, &quot;vertical&quot;: true}"> <template is="registerYield" yield-name="yield"> <lyte-table-structure> <lyte-thead> <lyte-tr> <lyte-th class="bbd1 w20per">{{getI18n(\'crm.workflow.rule.name\')}}</lyte-th> <lyte-th class="bbd1 aligncenter">{{getI18n(\'crm.scoring.rule.Positive\')}}</lyte-th> <lyte-th class="bbd1 aligncenter">{{getI18n(\'crm.scoring.rule.Negative\')}}</lyte-th> <template is="if" value="{{isTPScoreSupport}}"><template case="true"> <lyte-th class="bbd1 aligncenter">{{getI18n(\'positive.touch.points\')}}</lyte-th> <lyte-th class="bbd1 aligncenter">{{getI18n(\'negative.touch.points\')}}</lyte-th> <lyte-th class="bbd1 aligncenter">{{getI18n(\'total.touch.points\')}}</lyte-th> </template></template> <lyte-th class="bbd1 aligncenter">{{getI18n(\'crm.segmentation.score\')}}</lyte-th> </lyte-tr> </lyte-thead> <lyte-tbody> <template is="for" items="{{entity_scoresTemp}}" item="innerJo" index="index"> <lyte-tr id="{{innerJo.Scoring_Rule.id}}" onmouseover="{{action(\'addFocusClass\',index)}}" onmouseout="{{action(\'removeFocusClass\')}}"> <lyte-td class="pT15 pB15 srOnboardBg"> <p data-zcqa="ruleName_{{index}}" class="pL10">{{innerJo.Scoring_Rule.name}}</p> </lyte-td> <lyte-td class="pT15 pB15 srOnboardBg"> <p data-zcqa="pos_Col_{{index}}" class="aligncenter">{{if(ifAllMatch(innerJo.Positive_Score,"!=",null),innerJo.Positive_Score,\'0\')}}</p> </lyte-td> <lyte-td class="pT15 pB15 srOnboardBg"> <p data-zcqa="neg_Col_{{index}}" class="aligncenter">{{if(ifAllMatch(innerJo.Negative_Score,"!=",null),innerJo.Negative_Score,\'0\')}}</p> </lyte-td> <template is="if" value="{{isTPScoreSupport}}"><template case="true"> <lyte-td class="pT15 pB15 srOnboardBg"> <p data-zcqa="tpp_Col_{{index}}" class="aligncenter">{{if(ifAllMatch(innerJo.Touch_Point_Positive_Score,"!=",null),innerJo.Touch_Point_Positive_Score,\'0\')}}</p> </lyte-td> <lyte-td class="pT15 pB15 srOnboardBg"> <p data-zcqa="Tpn_Col_{{index}}" class="aligncenter">{{if(ifAllMatch(innerJo.Touch_Point_Negative_Score,"!=",null),innerJo.Touch_Point_Negative_Score,\'0\')}}</p> </lyte-td> <lyte-td class="pT15 pB15 srOnboardBg"> <p data-zcqa="tp_COl_{{index}}" class="aligncenter">{{if(ifAllMatch(innerJo.Touch_Point_Score,"!=",null),innerJo.Touch_Point_Score,\'0\')}}</p> </lyte-td> </template></template> <lyte-td class="pT15 pB15 srOnboardBg"> <p data-zcqa="score_Col_{{index}}" class="aligncenter">{{if(ifAllMatch(innerJo.Score,"!=",null),innerJo.Score,\'0\')}}</p> </lyte-td> </lyte-tr> </template> </lyte-tbody> </lyte-table-structure> </template> </lyte-table> <div data-zcqa="sRchartDiv" class="srChart pL10 {{if(showNoData,\'\',300)}} {{if(showTable,\'dN\',\'\')}}"> <template is="if" value="{{showNoData}}"><template case="true"> <p class="aligncenter pT20">{{getI18n(\'crm.data.not.available\')}}</p> </template></template> </div> </template></template> </div> </div> </div> </template>',_dynamicNodes:[{type:"attr",position:[1,1,1,1]},{type:"if",position:[1,1,1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"text",position:[1,1,1,1,0]},{type:"componentDynamic",position:[1,1,1,1]},{type:"text",position:[1,1,1,3,0]},{type:"componentDynamic",position:[1,1,1,3]},{type:"text",position:[1,1,1,5,0]},{type:"componentDynamic",position:[1,1,1,5]},{type:"attr",position:[1,1,1,7]},{type:"if",position:[1,1,1,7],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]},{type:"componentDynamic",position:[1]},{type:"text",position:[3,0]},{type:"componentDynamic",position:[3]},{type:"text",position:[5,0]},{type:"componentDynamic",position:[5]}]}},default:{}},{type:"text",position:[1,1,1,9,0]},{type:"componentDynamic",position:[1,1,1,9]},{type:"componentDynamic",position:[1,1,1]},{type:"componentDynamic",position:[1,1]},{type:"attr",position:[1,3,1]},{type:"for",position:[1,3,1],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1,1]},{type:"text",position:[1,1,1,0]},{type:"componentDynamic",position:[1,1]},{type:"attr",position:[1,3,1]},{type:"text",position:[1,3,1,0]},{type:"componentDynamic",position:[1,3]},{type:"attr",position:[1,5,1]},{type:"text",position:[1,5,1,0]},{type:"componentDynamic",position:[1,5]},{type:"attr",position:[1,7]},{type:"if",position:[1,7],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"text",position:[1,1,0]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3,1]},{type:"text",position:[3,1,0]},{type:"componentDynamic",position:[3]},{type:"attr",position:[5,1]},{type:"text",position:[5,1,0]},{type:"componentDynamic",position:[5]}]}},default:{}},{type:"attr",position:[1,9,1]},{type:"text",position:[1,9,1,0]},{type:"componentDynamic",position:[1,9]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1,3]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3]},{type:"attr",position:[3,1]},{type:"if",position:[3,1],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}}]}},default:{}}],_observedAttributes:["entity_scores","entity_scoresTemp","recordId","relatedListId","showTable","module","layout_id","hideChart","showNoData","isTPScoreSupport","forOnboarding"],data:function(){return{entity_scores:Lyte.attr("array",{default:[]}),entity_scoresTemp:Lyte.attr("array",{default:[]}),recordId:Lyte.attr("string"),relatedListId:Lyte.attr("string"),showTable:Lyte.attr("boolean",{default:!0}),module:Lyte.attr("string"),layout_id:Lyte.attr("string"),hideChart:Lyte.attr("boolean",{default:!0}),showNoData:Lyte.attr("boolean",{default:!1}),isTPScoreSupport:Lyte.attr("boolean",{default:!1}),forOnboarding:Lyte.attr("boolean",{default:!1})}},keyVsStack:{},reqInitiated:!1,categories:[],series:[],chartData:[],stackGroup:[],zchartSeries:{},resetData:function(){this.reqInitiated=!1,this.categories=[],this.series=[],this.chartData=[],this.stackGroup=[],this.zchartSeries={Positive_Score:{seriesname:"Positive Score",color:"#6fa341",_legendColor:"#6fa341",fillopacity:.2,plotoptions:{border:{color:"#6fa341"}},disabled:!1},Negative_Score:{seriesname:"Negative Score",color:"#6fa341",_legendColor:"white",plotoptions:{border:{color:"#6fa341"},fillOpacity:0},disabled:!1},Touch_Point_Positive_Score:{seriesname:"Positive Touch Point Score",color:"#FFA500",_legendColor:"orange",plotoptions:{border:{color:"#FFA500"}}},Touch_Point_Negative_Score:{seriesname:"Negative Touch Point Score",color:"orange",_legendColor:"white",plotoptions:{border:{color:"orange"},fillOpacity:0}}},this.keyVsStack={Positive_Score:{name:I18n.getMsg("Positive Score"),stack:"s1",color:"#dbedc7",borderColor:"#6fa341",id:"id1",decimalDigits:null,dataLabels:{color:"#6fa341"},showInLegend:!0},Negative_Score:{name:I18n.getMsg("Negative Score"),stack:"s1",color:"#fff",borderColor:"#6fa341",id:"id2",decimalDigits:null,dataLabels:{color:"#6fa341"},showInLegend:!0},Touch_Point_Positive_Score:{name:I18n.getMsg("Positive Touch Point Score"),stack:"s2",color:"#ffdfb2",borderColor:"#f8a55c",id:"id3",decimalDigits:null,dataLabels:{color:"#f8a55c"},showInLegend:!0},Touch_Point_Negative_Score:{name:I18n.getMsg("Negative Touch Point Score"),stack:"s2",color:"#fff",borderColor:"#f8a55c",id:"id4",decimalDigits:null,dataLabels:{color:"#f8a55c"},showInLegend:!0}},$L("#srTopIconDiv").addClass("hide"),this.showSrList()},init:function(){if(this.getData("recordId")&&this.getData("relatedListId")){this.reqInitiated=!0;var t=this,e=moduleRecordMapping[this.getData("module")].id;app.store.makeRequest("findAll",e,{relatedId:this.getData("recordId"),relationId:this.getData("relatedListId"),approved:"both"},void 0,!1,{}).then((function(o){t.setData("entity_scores",o[e])}))}["Leads","Contacts"].contains(this.getData("module"))&&this.setData("isTPScoreSupport",!0)},actions:{addFocusClass:function(t){this.getData("entity_scoresTemp").length-1===t&&$L("#scorigRulesTable").addClass("srLastRowhover")},removeFocusClass:function(){$L("#scorigRulesTable").removeClass("srLastRowhover")}},processData:function(t){this.resetData(),t?this.megerEntityScoreArr():this.fetchAllScoringRule()}.observes("entity_scores").on("init"),fetchAllScoringRule:function(){var t=this,e=objectUtils.cloneObject_new(this.getData("entity_scores")),o=e.length>0;this.getData("forOnboarding")&&o?t.setData("entity_scoresTemp",e):store.findAll("scoring_rule",{module:moduleApiMapping[this.getData("module")],fields:"name"}).then((function(i){if(commonUtils.showHideLoadingDiv(),i.length>0&&(i.forEach((function(i){t.isScoreAvailForRule(e,i.id)||i.layout&&i.layout.id!==t.getData("layout_id")||(o=!0,e.push(t.getDummyObj(i.id,i.name)))})),t.setData("entity_scoresTemp",e),o)){$L(".scorigRulesTable").removeClass("hide");var a=$L("crm-scoringrule-onboarding");if(a.length>0){a.e[0].component.setData("showFirstPop",!0),Crm.userDetails.MSR_ONBOARD_STARTED=!0;var n=$("#dvinner");n.scrollTop(0),n.addClass("oHImp")}}}),(function(){commonUtils.showHideLoadingDiv()}))},megerEntityScoreArr:function(){var t=this.getData("entity_scoresTemp"),e=this.getData("entity_scores"),o=this;t.forEach((function(i,a){var n=o.getMainArrIndex(e,i.Scoring_Rule.id);-1!==n?Lyte.arrayUtils(t,"replaceAt",a,e[n]):Lyte.arrayUtils(t,"replaceAt",a,o.getDummyObj(i.Scoring_Rule.id,i.Scoring_Rule.name))}))},getDummyObj:function(t,e){return{Positive_Score:null,Positive_Touch_Point_Score:null,Touch_Point_Score:null,Score:null,Scoring_Rule:{name:e,id:t}}},getMainArrIndex:function(t,e){return t.findIndex((function(t){return t.Scoring_Rule.id===e}))},anyRulesAvailInData:function(){return this.getData("entity_scores").some(this.isValidScoreJo)},isScoreAvailForRule:function(t,e){return t.some((function(t){return t.Scoring_Rule.id===e}))},constructDataArr:function(t,e){var o=new Array(e).fill(null);return o[e]=t,o},constructZohoChartData:function(t){var e=this,o={},i=[],a=[],n=[],s=[],r=!1,l=!1,c=!1,p=!1;t.forEach((function(t){var o=t.Scoring_Rule.name;e.categories.push(o);var r=[];r[0]=t.Negative_Score,r[1]=t.Positive_Score,r[2]=t.Touch_Point_Negative_Score,r[3]=t.Touch_Point_Positive_Score,r[4]=t.Score,r[5]=t.Touch_Point_Score,0!==r[0]&&null!==r[0]&&i.push(new Array(o,r[0],r[4])),0!==r[1]&&null!==r[1]&&a.push(new Array(o,r[1],r[4])),0!==r[2]&&null!==r[2]&&n.push(new Array(o,r[2],r[5])),0!==r[3]&&null!==r[3]&&s.push(new Array(o,r[3],r[5]))})),i.length>0&&(o.negative=e.zchartSeries.Negative_Score,o.negative.data=i,e.chartData.push(o.negative),r=!0),a.length>0&&(o.positive=e.zchartSeries.Positive_Score,o.positive.data=a,e.chartData.push(o.positive),l=!0),n.length>0&&(o.negativeTP=e.zchartSeries.Touch_Point_Negative_Score,o.negativeTP.data=n,e.chartData.push(o.negativeTP),c=!0),s.length>0&&(o.positiveTP=e.zchartSeries.Touch_Point_Positive_Score,o.positiveTP.data=s,e.chartData.push(o.positiveTP),p=!0);var d=[];l&&r&&(d=[0,1],e.tpScoreStackGroup(p,c,d,2)),(l&&!r||!l&&r)&&(d=[0],e.tpScoreStackGroup(p,c,d,1)),l||r||e.tpScoreStackGroup(p,c,d,0)},tpScoreStackGroup:function(t,e,o,i){var a=[],n=this;t&&!e||!t&&e?a=[i]:t&&e?a=[i,i+1]:t||e||(a=[]),a.length>0?0===i?n.stackGroup.push(a):n.stackGroup.push(o,a):0!==i&&n.stackGroup.push(o)},constructChartData:function(){if(this.anyRulesAvailInData()){var t=this.getData("entity_scores"),e=this;t.length>0&&($L("#srTopIconDiv").removeClass("hide"),$L("#tableViewElm").addClass("sRIconHolderActiveList"));var o=t.filter(e.isValidScoreJo);Crm.isZohoChartsEnabled?e.constructZohoChartData(o):o.forEach((function(t,o){e.categories.push(t.Scoring_Rule.name),Object.keys(t).forEach((function(i){var a=e.keyVsStack[i];if(a){var n=t[i];if(n){n&&i.indexOf("Negative")>=0&&n>=0&&(n*=-1);var s=objectUtils.cloneObject(a);s.showInLegend&&(a.showInLegend=!1),s.data=e.constructDataArr(n,o),s.Totalscore=t.Score,a.id&&(a.linkedTo=a.id,delete a.id),e.series.push(s)}}}))}))}}.observes("entity_scores").on("init"),isValidScoreJo:function(t){return null!==t.Score},showSrList:function(){$L("#tableViewElm").addClass("sRIconHolderActiveList"),$L("#chartViewElm").removeClass("sRIconHolderActiveChart"),this.setData("showTable",!0)},showSrChart:function(){$L("#tableViewElm").removeClass("sRIconHolderActiveList"),$L("#chartViewElm").addClass("sRIconHolderActiveChart");var t=this;if(this.setData("showTable",!1),this.getData("hideChart")||0!==this.series.length||0!==this.chartData.length)if(Crm.isZohoChartsEnabled){var e={seriesdata:{stackGroup:t.stackGroup,type:10,chartdata:t.chartData},metadata:{axes:{x:[0],y:[[1]],clr:[2],tooltip:["<span style='font-weight:bold;'>{{val(0)}}</span>","<span>{{val(2)}}: {{val(1)}}</span>","Total: {{val(3)}}"]},columns:[{dataindex:0,columnname:"",datatype:"ordinal"},{dataindex:1,columnname:"",datatype:"numeric"},{columnname:"Type"},{dataindex:2,columnname:"",datatype:"numeric"}]},chart:{axes:{xaxis:{label:{text:""},categories:t.categories,tickmark:{align:"between",color:"#BFBEBE",size:7},grid:{show:!0},ticklabel:{events:{cursor:"default"}}},yaxis:[{label:{text:""},axisline:{show:!1},grid:{show:!1},baseline:{show:!0,color:"#CCC9C9"},ticklabel:{events:{cursor:"default"}}}]},plot:{events:{init:function(t,e){var o=e.plotarea,i=e.container.selectAll("g.chartgroup"),a=e.axes.x.scale,n={mark:"g",selector:".plot-band",data:[1],order:":first-child",properties:{attrs:{transform:"translate("+o.left+","+o.top+")"}},children:[{mark:"rect",data:a.domain(),properties:{attrs:{id:function(t,e){return"plot-band-"+e},x:function(t){return Math.max(a(t)+a.bandwidth()/2-a.step()/2,0)},y:0,height:o.height,width:function(t){return a.step()+Math.min(o.width-(a(t)+a.bandwidth()/2+a.step()/2),0)}},styles:{fillColor:function(t,e){return e%2==0?"transparent":"#F5F5F5"}}}}]};$ZC.get("mark.render")(n,i),setTimeout((function(){e.container.selectAll("div.legendfilterbox").style("background-color",(function(t){return t.disabled?"#D1D1D1":t._legendColor}))}),0)},mousemove:function(t,e,o){t.allowDefault=!0;var i=o.axes.x.scale.domain().indexOf(e.point[0]);o.container.selectAll("g.chartgroup").selectAll("#plot-band-"+i).style("fill","#ededef")},mouseout:function(t,e,o){var i=o.axes.x.scale.domain().indexOf(e.point[0]);o.container.selectAll("g.chartgroup").selectAll("#plot-band-"+i).style("fill",i%2==0?"transparent":"#F5F5F5")}},plotoptions:{bar:{interPadding:.2,datalabels:{stackLabels:{show:!0,showZeros:!1,fontColor:null,fontSize:11},show:!1},border:{show:!0},fillOpacity:.2441860465116279,outerPadding:.06,padding:.3,maxBandWidth:200}}},effects:{choice:"auto"}},legend:{layout:"vertical",colorPallete:{type:"monochrome",options:{monochrome:{baseColor:"#3C4CA4"}}},colorBox:{shape:"square",size:10,strokeWidth:1},events:{click:function(t,e,o,i){var a=i.legendarea.element.selectAll("li.series").nodes();i.legend.component.toggleItemNUpdateChart(a[o],e,o,i.systemConf.legend),i.container.selectAll("div.legendfilterbox").style("background-color",(function(t){return t.disabled?"#D1D1D1":t._legendColor}))}},fontSize:12,vAlign:"center",itemHeight:30,fontColor:"#150101"},tooltip:{backgroundColor:"white",fontColor:"black",opacity:1,shadow:"2px 2px 2px rgba(0,0,0,0.3)",lineHeight:20,borderWidth:"3 3 3 3",borderRadius:4,fontSize:11},canvas:{title:{show:!1},subtitle:{show:!1},border:{show:!1}}},o=$(".srChart");o.css("height","400px"),o=o[0],$ZC.charts(o,e)}else{var i={chart:{type:"column"},title:{text:""},xAxis:{categories:t.categories,crosshair:!0,alternateGridColor:"#f5f5f5"},yAxis:{allowDecimals:!1,title:{text:""},plotLines:[{color:"#C1C1C1",width:1,value:0,zIndex:2}]},plotOptions:{column:{stacking:"normal"},series:{dataLabels:{enabled:!0,inside:!1,style:{fontSize:"11px"},formatter:function(){return this.y}}}},legend:{layout:"vertical",align:"right",verticalAlign:"middle",itemMarginTop:10,itemMarginBottom:10,symbolHeight:9,symbolWidth:9,symbolRadius:0,useHTML:!0,rtl:Crm.userDetails.RTL_ENABLED},series:t.series,tooltip:{formatter:function(){return"<b>"+$ESAPI.encoder().encodeForHTML(this.x)+"</b><br/>"+this.series.name+": "+this.y+"<br/>"+I18n.getMsg("Total")+": "+this.series.userOptions.Totalscore}}};$(".srChart").highcharts(i,(function(t){t.series.forEach((function(t){"#fff"===t.color&&t.legendSymbol&&t.legendSymbol.css({"stroke-width":1,stroke:t.options.borderColor})}))}))}else this.setData("showNoData",!0)}});
