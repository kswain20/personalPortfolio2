var crmExportWMSMsg={userDetails:Crm.userDetails,newkey:0,export:"EXPORT",closeAll:null,init:function(){if(crmExportWMSMsg.newkey=0,crmExportWMSMsg.MODIFIEDTIME="MODIFIEDTIME",crmExportWMSMsg.ACTION="ACTION",crmExportWMSMsg.MODULE="MODULE",crmExportWMSMsg.FILENAME="FILENAME",crmExportWMSMsg.UNIQUEID="UNIQUEID",crmExportWMSMsg.USERID="USERID",crmExportWMSMsg.STATUS="STATUS",crmExportWMSMsg.CUSTOMID="CUSTOMID",crmExportWMSMsg.LINK="LINK","undefined"!=typeof Storage){var e=localStorage.getItem(crmExportWMSMsg.export);"true"===isSandboxAcc?networkUtils.loadFeatureScripts(["crmTranslation.js"],(function(){var o;crmTranslation.doAjaxCall("GET",crmTranslation.translationBaseUrl+"/sandbox/status",null,(function(t){null!==t&&(o=t.responseText),e&&"Refreshing"!=o&&crmExportWMSMsg.scheduledFiles(e)}))})):e&&crmExportWMSMsg.scheduledFiles(e);try{for(var o in localStorage)o&&0==o.indexOf(crmExportWMSMsg.export)&&0==!o.indexOf(crmExportWMSMsg.export)&&localStorage.removeItem(o)}catch(e){}}},checkExportAlreadyScheduled:function(e,o){var t=localStorage.getItem(crmExportWMSMsg.export);if(t){t=JSON.parse(t);var r=!1;for(var n in t){var s=t[n],a=s[crmExportWMSMsg.MODULE],i=s[crmExportWMSMsg.CUSTOMID],c=s[crmExportWMSMsg.STATUS];(a&&e&&a===e||i&&o&&i==o)&&(r=4!=c&&crmExportWMSMsg.showScheduledMsg(n,s))}return r}return!1},showScheduledMsg:function(e,o){var t=(new Date).getTime()-o[crmExportWMSMsg.MODIFIEDTIME],r=$("#"+("chatcontain"+e));return t<=18e6&&r.length>0?($("#EXPORTPOP1 #callTitleSpan").css("color","#f7f7f7"),$("#EXPORTPOP1 .chatPopTitle").effect("highlight",{color:"#3b8ace"},500),setTimeout((function(){$("#EXPORTPOP1 #callTitleSpan").css("color","#000")}),500),!0):(crmExportWMSMsg.removeFun(e),r.length>0&&r.remove(),!1)},removeFun:function(e){if("undefined"!=typeof Storage)for(var o in localStorage){var t=localStorage.getItem(o);if(t){if(t=JSON.parse(t),o===crmExportWMSMsg.export)for(var r in t)e==r&&delete t[r];localStorage.setItem(o,JSON.stringify(t))}}},showMessageBasedResult:function(e,o){if("string"==typeof e&&(e=JSON.parse(e)),o)e&&-1==e[crmExportWMSMsg.UNIQUEID]&&!e[crmExportWMSMsg.STATUS]&&crmExportWMSMsg();else{var t=e[crmExportWMSMsg.UNIQUEID];crmExportWMSMsg.updateLocalStorage(e),crmExportWMSMsg.showCommonMsg(t,e)}},showCommonMsg:function(e,o){var t="chatcontain"+e,r=o[crmExportWMSMsg.FILENAME],n=o[crmExportWMSMsg.MODULE],s=o[crmExportWMSMsg.STATUS],a=$("#"+t);if((void 0===r&&void 0!==n&&void 0!==moduleRecordMapping[n]||void 0!==n&&n.startsWith("LinkingModule"))&&(r=moduleRecordMapping[n].plural_label),0===s||1===s){if(a.length>0)return;crmExportWMSMsg.showExportProcess(t,r),$(".cancellink").attr("onclick","crmExportWMSMsg.callCancel(this,'"+n+"')")}else if(2===s)0===a.length&&crmExportWMSMsg.showExportProcess(t,r),crmExportWMSMsg.processingImage(t);else if(5===s){var i;0===a.length&&(crmExportWMSMsg.showExportProcess(t,r),crmExportWMSMsg.processingImage(t));var c=Crm.getCrmBasePath()+"/Export.do?action=Download&module="+n+"&uniqueID="+e;"Reports"===n&&newReportsEnabled&&(c=o[crmExportWMSMsg.LINK]+"?job_id="+e,i="report_download"),crmExportWMSMsg.showDownloadlink(t,c,i)}else 4===s?(0===a.length&&(crmExportWMSMsg.showExportProcess(t,r),crmExportWMSMsg.processingImage(t)),crmExportWMSMsg.showFailedIcon(t,n)):6===s&&crmExportWMSMsg.clearAPopupDiv(e)},showExportProcess:function(e,o){var t=$(".sumplusdiv").css("display");if(crmExportWMSMsg.newkey++,1!=crmExportWMSMsg.newkey){(a=$(Handlebars.templates.ExportPopUp()).find(".chatContainer").clone()).attr("id",e),a.find(".ExportFileName").html(o);var r=(i=$("#EXPORTPOP1")).find(".ChatContains .chatDiv");r.append(a);var n=r.outerHeight(),s=i.find(".ChatContains");n>s.outerHeight()&&s.scrollTop(n)}else{var a,i;(a=$(Handlebars.templates.ExportPopUp())).find(".chatContainer").attr("id",e),a.css("bottom","0px"),a.attr("id","EXPORTPOP"+crmExportWMSMsg.newkey),a.find(".ExportFileName").html(o),$("body").append(a),(i=$("#EXPORTPOP1")).slideToggle({direction:"up"})}"block"==t&&i.find(".chatContainer").show()},processingImage:function(e){var o=$("#"+e),t=o.find(".Downstatus");t.find("span").text(I18n.getMsg("crm.report.export.alert.h1")),t.find("img").remove(),o.find(".cancellink").hide(),o.find(".slidercontainer").show();var r=0;!function e(){setTimeout((function(){o.find(".cancellink").text()!=n&&o.find(".cancellink").text()!=s?(o.find(".slidercolor").css({width:"30px",left:r+"px"}),e(),160==r&&(r=0,1),r+=10):o.find(".slidercolor").css({width:"inherit",left:"0px"})}),100)}();var n=I18n.getMsg("crm.view.attachment.download"),s=I18n.getMsg("crm.view.attachment.retry")},exportPopup:function(e){"none"==$(e).parent().find(".chatContainer").css("display")?($("#EXPORTPOP1").find(".chatContainer").show(),$(".summinusdiv").show(),$("#EXPORTPOP1 .ChatContains").css("overflow-y","scroll"),$(".sumplusdiv").hide()):($("#EXPORTPOP1").find(".chatContainer").hide(),$(".sumplusdiv").show(),$(".summinusdiv").hide(),$("#EXPORTPOP1 .ChatContains").css("overflow-y","hidden"))},callHide:function(e){$(e).parent().parent().find(".chatContainer").hide(),$(e).hide(),$(e).find("img").css("transform","rotate(360deg)"),$(e).siblings(".sumplusdiv").show()},callShow:function(e){$(e).parent().parent().find(".chatContainer").show(),$(e).hide(),$(e).find("img").css("transform","rotate(180deg)"),$(e).siblings(".summinusdiv").show(),$("#EXPORTPOP1 .ChatContains").css("overflow-y","scroll")},callCancel:function(e,o){if($(e).text()===I18n.getMsg("crm.button.cancel")){var t=$(e).closest(".chatContainer").attr("id");if(t){var r=t.replace("chatcontain","");if("undefined"!=typeof Storage){var n=localStorage.getItem(crmExportWMSMsg.export);n&&((n=JSON.parse(n))[r]="",localStorage.setItem(crmExportWMSMsg.export,JSON.stringify(n)))}var s={};s.module=o,s.action="cancel",s.uniqueID=r;var a,i=Crm.getCrmBasePath()+"/Export.do";"Reports"===o&&newReportsEnabled&&(s=void 0,i="/crm/v2/Reports/actions/export_jobs?ids="+r,a="DELETE"),crmExportWMSMsg.ajaxCall(i,s,a,(function(){crmExportWMSMsg.clearAPopupDiv(r)}))}}},ajaxCall:function(e,o,t,r){(new crmRequestPool).initiate({action:e,data:o,headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},type:t||"POST",success:function(e){r&&r(e)}})},showDownloadlink:function(e,o,t){var r,n=I18n.getMsg("crm.view.attachment.download"),s=$("#"+e),a=s.find(".cancellink"),i=s.find(".Downstatus");"block"==$(".sumplusdiv").css("display")?((r=$("#EXPORTPOP1")).find(".chatContainer").show(),r.find(".sumplusdiv").hide(),r.find(".summinusdiv").show(),$("#EXPORTPOP1 .ChatContains").css("overflow-y","scroll"),setTimeout((function(){s.find(".slidercontainer").show("slow",(function(){$(this).find(".slidercolor").css({width:"inherit",left:"0"})})),a.text(n).show(),a.attr("href",o),a.attr("data-zcqa","DownloadAuditLog"),a.removeAttr("onclick"),a.addClass("downloadlink_report"),a.on("click",(function(){var o=$("#"+e);o.find(".downloadlink_report").hide(),o.find(".downloadingLink").show();var t=e.replace("chatcontain","");crmExportWMSMsg.clearAPopupDiv(t)})),a.removeClass("cancellink"),i.find(".slidercontainer").remove(),i.find("span").remove()}),200)):((r=i).find("span").text(I18n.getMsg("crm.report.export.alert.h1")),r.find("img").remove(),setTimeout((function(){s.find(".slidercontainer").show("slow",(function(){$(this).find(".slidercolor").css({width:"inherit",left:"0"})})),a.text(n).show(),a.removeAttr("onclick"),a.addClass("downloadlink_report"),"report_download"!==t&&a.attr("href",o),a.on("click",(function(){"report_download"===t&&crmExportWMSMsg.download_report(o);var r=$("#"+e);r.find(".downloadlink_report").hide(),r.find(".downloadingLink").show();var n=e.replace("chatcontain","");"report_download"!==t&&crmExportWMSMsg.clearAPopupDiv(n)})),a.removeClass("cancellink"),r.find(".slidercontainer").remove(),r.find("span").remove()}),200))},showFailedIcon:function(e,o){var t,r=I18n.getMsg("crm.import.status.failed"),n=$("#"+e),s=n.find(".exportCloseIcon"),a=n.find(".cancellink");"block"==$(".sumplusdiv").css("display")?((t=$("#EXPORTPOP1")).find(".chatContainer").show(),t.find(".sumplusdiv").hide(),t.find(".summinusdiv").show(),$("#EXPORTPOP1 .ChatContains").css("overflow-y","scroll"),setTimeout((function(){n.find(".slidercontainer").show("slow",(function(){$(this).find(".slidercolor").css({width:"inherit",left:"0"})})),s.show(),a.text(r).show().css("pointer-events","none"),a.css("color","red"),s.on("click",(function(){var t=e.replace("chatcontain",""),r={};r.module=o,r.action="cancel",r.uniqueID=t;var n,s=Crm.getCrmBasePath()+"/Export.do";"Reports"===o&&newReportsEnabled&&(r=void 0,s="/crm/v2/Reports/actions/export_jobs?ids="+t,n="DELETE"),crmExportWMSMsg.ajaxCall(s,r,n,(function(){crmExportWMSMsg.clearAPopupDiv(t)}))})),a.addClass("retrylink"),a.removeClass("cancellink");var t=n.find(".Downstatus");t.find(".slidercontainer").remove(),t.find("span").remove()}),200)):((t=n.find(".Downstatus")).find("span").text(I18n.getMsg("crm.report.export.alert.h1")),t.find("img").remove(),setTimeout((function(){n.find(".slidercontainer").show("slow",(function(){$(this).find(".slidercolor").css({width:"inherit",left:"0"})})),s.show(),a.text(r).show().css("pointer-events","none"),a.css("color","red"),s.on("click",(function(){var t=e.replace("chatcontain",""),r={};r.module=o,r.action="cancel",r.uniqueID=t;var n,s=Crm.getCrmBasePath()+"/Export.do";"Reports"===o&&newReportsEnabled&&(r=void 0,s="/crm/v2/Reports/actions/export_jobs?ids="+t,n="DELETE"),crmExportWMSMsg.ajaxCall(s,r,n,(function(){crmExportWMSMsg.clearAPopupDiv(t)}))})),a.addClass("retrylink"),a.removeClass("cancellink"),t.find(".slidercontainer").remove(),t.find("span").remove()}),200))},clearAPopupDiv:function(e){var o=$("#EXPORTPOP1");if(crmExportWMSMsg.newkey>0?crmExportWMSMsg.newkey--:crmExportWMSMsg.newkey=0,"undefined"!=typeof Storage){var t=localStorage.getItem(crmExportWMSMsg.export);t&&(delete(t=JSON.parse(t))[e],localStorage.setItem(crmExportWMSMsg.export,JSON.stringify(t)))}1==o.find(".chatContainer").length?(crmExportWMSMsg.newkey=0,o.remove()):$("#chatcontain"+e).remove()},updateLocalStorage:function(e){if("undefined"!=typeof Storage){var o=e[crmExportWMSMsg.UNIQUEID],t=localStorage.getItem(crmExportWMSMsg.export);t||(t="{}"),t=JSON.parse(t),e[crmExportWMSMsg.MODIFIEDTIME]=(new Date).getTime(),delete e[crmExportWMSMsg.ACTION],delete e[crmExportWMSMsg.UNIQUEID],delete e[crmExportWMSMsg.USERID],delete e.date,t[o]=e,localStorage.setItem(crmExportWMSMsg.export,JSON.stringify(t))}},showHidePicklistSchedulerDiv:function(){var e=$("#rls-contSharStaLoad-pop");e.hasClass("schedularOpen")?(e.removeClass("schedularOpen"),clearTimeout(crmExportWMSMsg.closeAll),crmExportWMSMsg.clearAllreplace()):(e.addClass("schedularOpen"),setTimeout((function(){e.removeClass("schedularOpen")}),5e3))},showPicklistinfo:function(e){$(".viewInfoTbl").removeClass("dN"),$(".viewInfoData").slideUp(300),$(e).addClass("dN"),$(e).siblings(".viewInfoData").slideDown(300),clearTimeout(crmExportWMSMsg.closeAll),crmExportWMSMsg.clearAllreplace()},clearAllreplace:function(){crmExportWMSMsg.closeAll=setTimeout((function(){var e=$("#rls-contSharStaLoad-pop");e.removeClass("schedularOpen"),e.remove(),$("#wmsstatusbar .crm-chatBarIcons").find(".schedularProgress-icon").remove()}),15e3)},showHideSchedulerNotificationModal:function(){var e=document.querySelector("crm-scheduler-notification-modal");e&&e.getData("showModal")?e.setData("showModal",!1):e&&!e.getData("showModal")&&e.setData("showModal",!0)},scheduledFiles:function(e){var o=JSON.parse("{}");e=JSON.parse(e);var t=$L.moment().toDate().getTime();for(var r in e){var n=e[r];t-n[crmExportWMSMsg.MODIFIEDTIME]<=18e6&&(o[r]=n,crmExportWMSMsg.showCommonMsg(r,n,crmExportWMSMsg.export))}localStorage.setItem(crmExportWMSMsg.export,JSON.stringify(o))},download_report:function(e){var o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState){var e=window.URL.createObjectURL(o.response),t=document.createElement("a");t.href=e;var r="",n=o.getResponseHeader("Content-Disposition");if(n&&-1!==n.indexOf("attachment")){var s=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(n);null!==s&&s[1]&&(r=s[1].replace(/['"]/g,""))}t.download=decodeURIComponent(r),t.click()}2===o.readyState&&(200===o.status?o.responseType="blob":o.responseType="text")},o.open("GET",e,!0),o.setRequestHeader("Content-type","application/json");var t={"X-CRM-ORG":crmZgid,"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken};for(var r in t)o.setRequestHeader(r,t[r]);o.responseType="blob",o.send()}};