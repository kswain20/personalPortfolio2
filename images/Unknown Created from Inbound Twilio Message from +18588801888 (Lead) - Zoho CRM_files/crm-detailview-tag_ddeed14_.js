Lyte.Component.register("crm-detailview-tag",{_template:'<template tag-name="crm-detailview-tag"> <template is="if" value="{{expHandlers(from,\'==\',&quot;import&quot;)}}"><template case="true"> <crux-tag id="importtag" cx-prop-scope="#ITF-container .itb-body-class" cx-prop-class="hello" cx-prop-box-class="tag_dropdown" cx-prop-tag-options="{{tagarray}}" cx-prop-tags="{{selectedtags}}" cx-prop-allow-dropdown="true" cx-prop-comma-seperation="true" cx-prop-prevent-key-list="[&quot;<&quot;,&quot;>&quot;,&quot;,&quot;]" on-error="{{method(\'onError\')}}" on-before-add-tag="{{method(&quot;validate_tags&quot;)}}" on-before-remove-tag="{{method(&quot;beforeremove&quot;)}}" on-color-tag-palette-hide="{{method(&quot;hideColor2&quot;)}}"> </crux-tag> </template><template case="false"> <template is="if" value="{{expHandlers(sandboxAccount,\'!\')}}"><template case="true"> <div class="crm-detailview-tag"> <template is="if" value="{{expHandlers(displaytags.length,\'>\',0)}}"><template case="true"> <lyte-nav class="detailview-tag-view pL20 pR"> <template is="if" value="{{add_tag}}"><template case="true"> <span class="zcrm_svgIcons dIB tagged_icon mR7 vam pA left0 top2"></span> </template></template> <template is="for" items="{{displaytags}}" item="tag" index="ind"> <template is="if" value="{{expHandlers(ind,\'<\',3)}}"><template case="true"> <template is="if" value="{{expHandlers(expHandlers(expHandlers(expHandlers(expHandlers(module,\'===\',&quot;Tasks&quot;),\'||\',expHandlers(module,\'===\',&quot;Calls&quot;)),\'||\',expHandlers(module,\'===\',&quot;Events&quot;)),\'||\',expHandlers(module,\'===\',&quot;Meetings&quot;)),\'&amp;&amp;\',expHandlers(isActivitySplitDone,\'!\'))}}"><template case="true"> <lyte-nav-item class="detailview-tag-view-items cD"><link-to lt-prop-class="linktoTagA cP cxTagBgSpan cxTagCol{{color_value(tag.color_code)}}" lt-prop-route="crm.tab.module.custom-view.list" lt-prop-target="_blank" lt-prop-dp="[&quot;Activities&quot;,&quot;{{cvid}}&quot;]" lt-prop-qp="{{tagLink(tag.id,tag.name,module,tag.color_code)}}" lt-prop-rel="noopener noreferrer"> {{tag.name}}</link-to></lyte-nav-item> </template><template case="false"> <lyte-nav-item class="detailview-tag-view-items cD"><link-to lt-prop-class="linktoTagA cP cxTagBgSpan cxTagCol{{color_value(tag.color_code)}}" lt-prop-route="crm.tab.module.custom-view.list" lt-prop-target="_blank" lt-prop-dp="[&quot;{{module}}&quot;,&quot;{{cvid}}&quot;]" lt-prop-qp="{{tagLink(tag.id,tag.name,module,tag.color_code)}}" lt-prop-rel="noopener noreferrer">{{tag.name}}</link-to></lyte-nav-item> </template></template> </template></template></template> <template is="if" value="{{expHandlers(displaytags.length,\'>\',3)}}"><template case="true"> <span class="dIB more_options_txt">{{getI18n(\'crm.reminder.week.and\')}}</span> <lyte-dropdown class="noAnim tags_moreoptions"> <template is="registerYield" yield-name="yield"> <lyte-drop-button class="dropButtonClass"> <span class="dropdown_span"> {{count}} {{getI18n(\'crm.login.more\')}} </span> </lyte-drop-button> <lyte-drop-box class="cyanNavBody tags_list_body"> <lyte-drop-body class="dropBodyClass"> <template is="for" items="{{displaytags}}" item="tag" index="ind"> <template is="if" value="{{expHandlers(ind,\'>=\',3)}}"><template case="true"> <template is="if" value="{{expHandlers(expHandlers(expHandlers(expHandlers(expHandlers(module,\'===\',&quot;Tasks&quot;),\'||\',expHandlers(module,\'===\',&quot;Calls&quot;)),\'||\',expHandlers(module,\'===\',&quot;Events&quot;)),\'||\',expHandlers(module,\'===\',&quot;Meetings&quot;)),\'&amp;&amp;\',expHandlers(isActivitySplitDone,\'!\'))}}"><template case="true"> <lyte-drop-item class="dropItemClass dvMoreTags" data-value="{{tag.name}}"><link-to lt-prop-class="linktoTagA cP cxTagBgSpan cxTagCol{{color_value(tag.color_code)}}" lt-prop-route="crm.tab.module.custom-view.list" lt-prop-target="_blank" lt-prop-dp="[&quot;Activities&quot;,&quot;{{cvid}}&quot;]" lt-prop-qp="{{tagLink(tag.id,tag.name,module,tag.color_code)}}" lt-prop-rel="noopener noreferrer">{{tag.name}}</link-to></lyte-drop-item> </template><template case="false"> <lyte-drop-item class="dropItemClass dvMoreTags" data-value="{{tag.name}}"><link-to lt-prop-class="linktoTagA cP cxTagBgSpan cxTagCol{{color_value(tag.color_code)}}" lt-prop-route="crm.tab.module.custom-view.list" lt-prop-target="_blank" lt-prop-dp="[&quot;{{module}}&quot;,&quot;{{cvid}}&quot;]" lt-prop-qp="{{tagLink(tag.id,tag.name,module,tag.color_code)}}" lt-prop-rel="noopener noreferrer">{{tag.name}}</link-to></lyte-drop-item> </template></template> </template></template> </template> </lyte-drop-body> </lyte-drop-box> </template> </lyte-dropdown> </template></template> <span class="zcrm_svgIcons dIB tag_edit_icon cP vam mL5 {{if(ifEquals(CrmTags.clientJSON.isRecLocUnGDPR,false),\'noEventTag\',\'\')}}{{if(ifEquals(cursor,true),\'defcursor\',\'\')}} {{if(ifNotEquals(tooltip,\'Add Tags\'),\'cD addPermissionDenied\',\'\')}}" onclick="{{action(\'showAddTag\')}}" lt-prop-tooltip-config=" { &quot;showdelay&quot;:500,&quot;appearance&quot;:&quot;box&quot;,&quot;position&quot;:&quot;bottomright&quot;,&quot;margin&quot;:10} " lt-prop-title="{{tooltip}}"></span> </lyte-nav> </template><template case="false"> <div class="mT4"> <span class="zcrm_svgIcons dIB tagged_icon mR5 vam"></span> <template is="if" value="{{add_tag}}"><template case="true"> <span class="dIB vam f14 cP add_tag col555 {{if(ifEquals(CrmTags.clientJSON.isRecLocUnGDPR,false),\'noEventTag\',\'\')}} {{if(ifEquals(cursor,true),\'defcursor\',\'\')}}" lt-prop-tooltip-config=" { &quot;showdelay&quot;:500,&quot;appearance&quot;:&quot;box&quot;,&quot;position&quot;:&quot;bottomright&quot;,&quot;margin&quot;:10} " lt-prop-title="{{tooltip}}" onclick="{{action(\'showAddTag\')}}">{{getI18n(\'crm.label.add.tags\')}}</span> </template></template> </div> </template></template> </div> </template></template> <lyte-popover id="detailview_add_tag" lt-prop-width="570px" lt-prop-origin-elem=".crm-detailview-tag .tagged_icon" lt-prop-placement="bottom right" lt-prop-freeze="false" lt-prop-show-close-button="false" lt-prop-show="false" lt-prop-wrapper-class="detailview_add_tag" lt-prop-type="box" lt-prop-boundary="{&quot;left&quot;:&quot;100&quot;,&quot;top&quot;:&quot;0&quot;}" lt-prop-content-padding="13px 35px" lt-prop-footer-padding="5px 35px 25px" lt-prop-close-on-body-click="true" lt-prop-allow-multiple="true" on-before-close="{{method(&quot;open_pop&quot;)}}"> <template is="registerYield" yield-name="popover"> <lyte-popover-content> <span class="zcrm_svgIcons pA tagged_icon_popover mR7"></span> <crux-tag id="defaulttag" cx-prop-id="view" cx-prop-box-class="tag_dropdown" cx-prop-tag-options="{{tagarray}}" cx-prop-tags="{{selectedtags}}" cx-prop-allow-dropdown="true" cx-prop-comma-seperation="true" cx-prop-prevent-key-list="[&quot;<&quot;,&quot;>&quot;,&quot;,&quot;]" on-before-add-tag="{{method(&quot;validate_tags&quot;)}}" on-before-remove-tag="{{method(&quot;beforeremove&quot;)}}" on-error="{{method(\'onError\')}}" on-color-tag-palette-hide="{{method(&quot;hideColor&quot;)}}"> </crux-tag> </lyte-popover-content> <lyte-popover-footer class="alignright"> <lyte-button lt-prop-size="small" onclick="{{action(\'hideAddTag\')}}" lt-prop-appearance="default" data-zcqa="canceltag_btn"> <template is="registerYield" yield-name="text"> {{getI18n(\'crm.button.cancel\')}} </template> </lyte-button> <lyte-button lt-prop-appearance="primary" lt-prop-size="small" onclick="{{action(\'savetags\')}}" lt-prop-disabled="{{lbind(saveEnabled)}}" data-zcqa="savetag_btn"> <template is="registerYield" yield-name="text"> {{getI18n(\'crm.button.save\')}} </template> </lyte-button> </lyte-popover-footer> </template> </lyte-popover> </template></template> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[]}},default:{}},{type:"attr",position:[1,3]},{type:"for",position:[1,3],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,0]},{type:"text",position:[1,0,1]},{type:"componentDynamic",position:[1,0]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1,0]},{type:"text",position:[1,0,0]},{type:"componentDynamic",position:[1,0]},{type:"componentDynamic",position:[1]}]}},default:{}}]}},default:{}}]},{type:"attr",position:[1,5]},{type:"if",position:[1,5],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]},{type:"registerYield",position:[3,1],dynamicNodes:[{type:"text",position:[1,1,1]},{type:"text",position:[1,1,3]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3,1,1]},{type:"for",position:[3,1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,0]},{type:"text",position:[1,0,0]},{type:"componentDynamic",position:[1,0]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,0]},{type:"text",position:[1,0,0]},{type:"componentDynamic",position:[1,0]},{type:"componentDynamic",position:[1]}]}},default:{}}]}},default:{}}]},{type:"componentDynamic",position:[3,1]},{type:"componentDynamic",position:[3]}]},{type:"componentDynamic",position:[3]}]}},default:{}},{type:"attr",position:[1,7]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1,3]},{type:"if",position:[1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]}]}},default:{}}]}},default:{}}]}},default:{}},{type:"attr",position:[3]},{type:"registerYield",position:[3,1],dynamicNodes:[{type:"attr",position:[1,3]},{type:"componentDynamic",position:[1,3]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3,1]},{type:"registerYield",position:[3,1,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[3,1]},{type:"attr",position:[3,3]},{type:"registerYield",position:[3,3,1],dynamicNodes:[{type:"text",position:[1]}]},{type:"componentDynamic",position:[3,3]},{type:"componentDynamic",position:[3]}]},{type:"componentDynamic",position:[3]}]}},default:{}}],_observedAttributes:["tagarray","selectedtags","idvsname","module","removedtags","displaytags","cvid","tagnamevstagid","tagidvstagname","tag","tagnamevsmodrefid","added_count","saveEnabled","tagnames","tooltip","from","add_tag","tagged_icon","isActivitySplitDone","sandboxAccount","cursor"],data:function(){return{tagarray:Lyte.attr("array",{default:[]}),selectedtags:Lyte.attr("array",{default:[]}),idvsname:Lyte.attr("object",{default:{}}),module:Lyte.attr("string",{default:""}),removedtags:Lyte.attr("string",{default:""}),displaytags:Lyte.attr("array",{default:[]}),cvid:Lyte.attr("string",{default:""}),tagnamevstagid:Lyte.attr("object",{default:{}}),tagidvstagname:Lyte.attr("object",{default:{}}),tag:Lyte.attr("array",{default:[]}),tagnamevsmodrefid:Lyte.attr("object",{default:{}}),added_count:Lyte.attr("number",{default:0}),saveEnabled:Lyte.attr("boolean",{default:!0}),tagnames:Lyte.attr("array",{default:[]}),tooltip:Lyte.attr("string",{default:""}),added_count:Lyte.attr("number",{default:0}),from:Lyte.attr("string",{default:"detailview"}),add_tag:Lyte.attr("boolean",{default:!0}),tagged_icon:Lyte.attr("boolean",{default:!0}),isActivitySplitDone:Lyte.attr("boolean"),sandboxAccount:Lyte.attr("boolean",{default:!1}),cursor:Lyte.attr("boolean",{default:!1})}},tagnamevscolor:[],init:function(){if("import"!==this.getData("from")){var t=this.getData("module");this.setData("isActivitySplitDone",Crm.isActivitySplitDone),"Tasks"!==t&&"Calls"!==t&&"Events"!==t||this.getData("isActivitySplitDone")?this.setData("cvid",moduleRecordMapping[t].custom_view.id):this.setData("cvid",moduleRecordMapping.Activities.custom_view.id)}if(!0!==isSandboxAcc&&"true"!==isSandboxAcc||this.setData("sandboxAccount",!0),void 0!==moduleRecordMapping[t]&&void 0!==store.peekRecord(moduleRecordMapping[t].id,detailView.entityId)){var e=store.peekRecord(moduleRecordMapping[t].id,detailView.entityId).Tag;if(this.setData("displaytags",e),void 0!==e){var a=e.length;a>3&&this.setData("count",a-3)}}},didConnect:function(){var t=this,e=t.getData("module");"Activities"===e&&(e=$("#module").val()),$L("#detailviewTags").empty(),$L("#detailviewInfo").empty(),t.setData("module",e);var a=moduleRecordMapping[e].api_name,o=CrmTags.clientJSON.value;if(isSandboxAcc&&"true"==isSandboxAcc||"Free"===Crm.userDetails.EDITION_NAME||"Starter"==Crm.userDetails.EDITION_NAME)isSandboxAcc&&"true"==isSandboxAcc?t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.sandbox.not.supported")):"Free"===Crm.userDetails.EDITION_NAME?t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.records.downgrade.free.edition")):(this.setData("tagged_icon",!1),this.setData("add_tag",!1)),t.disablecursor("default");else{var i=moduleRecordMapping[e].module_name;"linking"==Crm.userDetails.MODULE_LIST[i].generated_type?(this.setData("tagged_icon",!1),this.setData("add_tag",!1),$(".tagged_icon").hide(),t.disablecursor("default")):(store.unloadAll("tag"),store.findAll("tag",{module:a,fromPage:"view"}).then((function(e){void 0===t.getData("tag")&&(t=$L("crm-detailview-tag")[0].component),t.setData("tag",e);var a=0;CrmTags.clientJSON.value&&(a=CrmTags.clientJSON.value.length),a>3&&t.setData("count",a-3);var i=e.length,s={},r={},n={},l={};for(c=0;c<i;c++)Lyte.objectUtils(t.getData("idvsname"),"add",e[c].modRefId,e[c].name),s[e[c].name]=e[c].id,n[e[c].name]=e[c].modRefId,l[e[c].name]=e[c].color_code,r[e[c].id]=[e[c].name],name=e[c].name,"detailview"!==t.getData("from")||CrmTags.clientJSON.value.includes(e[c].modRefId)||Lyte.arrayUtils(t.getData("tagarray"),"push",{name:name,id:e[c].id,color_code:e[c].color_code}),Lyte.arrayUtils(t.getData("tagnames"),"push",name);if(t.setData("tagnamevstagid",s),t.setData("tagnamevsmodrefid",n),t.setData("tagnamevscolor",l),t.setData("tagidvstagname",r),void 0!==(o=CrmTags.clientJSON.value))var d=o.length;var p=t.getData("idvsname");t.setData("selectedtags",[]);for(var c=0;c<d;c++){var g=p[o[c]],m={name:g,id:s[g],color_code:l[g]};Lyte.arrayUtils(t.getData("selectedtags"),"push",m)}if(void 0===t.getData("displaytags")||0===t.getData("displaytags").length){var u=t.getData("selectedtags").slice();t.setData("displaytags",u)}var v=$L("#ApprovalProcess").children().length,y=$L(".rpHeaders").length;if(Crm.userDetails.ISROMODE||v>0||y>0||CrmTags.clientJSON.isRecLocUnGDPR||!CrmTags.clientJSON.permission||null==CrmTags.clientJSON.permission)if(y>0?t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.reviewprocess.detailview.create.no.permission.msg")):null==CrmTags.clientJSON.permission?(t.setData("tagged_icon",!1),$(".tagged_icon").hide(),t.setData("add_tag",!1)):(o.length>0||0==t.getData("selectedtags").length&&v||!v)&&t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg")),"import"!==t.getData("from")){t.disablecursor();l=this.tagnamevscolor}else $("#importTagFieldId").empty();else CrmTags.clientJSON.hasOwnProperty("permission")?t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.label.add.tags")):(t.setData("add_tag",!1),t.setData("tagged_icon",!1),t.disablecursor("default"),$(".tagged_icon").hide())}),(function(){t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg"));var e=$L(".add_tag"),a=$L(".tag_edit_icon");(e.length>0||a.length>0)&&this.setData("cursor",!0)})))}},disablecursor:function(t){var e=$L(".add_tag"),a=$L(".tag_edit_icon");e.length>0?(e[0].setAttribute("click",""),void 0!==t&&e.css("cursor",t)):a.length>0&&(a[0].setAttribute("click",""),a.css("cursor",t))},addTags:function(){var t=this,e=t.getData("module");e="Activities"===e?store.peekRecord(moduleRecordMapping.Activities.id,selectedIds[0]).$activity_type:e;var a=t.getData("selectedtags"),o=[];if(0===a.length){var i=t.getData("removedtags"),s=0;if(1===(s=i.includes(",")?(i=i.split(",")).length:1)){var r={name:i};o.push(r)}else for(var n=0;n<s;n++){r={name:i[n]};o.push(r)}var l={tags:o,ids:detailView.entityId.toString()};t.addtagstoRec(t,l,detailView.entityId,!1,e,"detailview","remove")}else{var d=a.length;for(n=0;n<d;n++){var p=a[n].color_code;"#noFill"!==p&&"noFill"!==p||(p=null);r={name:a[n].name};o.push(r)}l={tags:o,ids:detailView.entityId.toString(),over_write:!0};t.addtagstoRec(this,l,detailView.entityId,!0,moduleRecordMapping[e].api_name,"detailview","add")}},afteradd_detailview:function(t,e){t.setData("tag",e);var a=t.getData("tagnamevsmodrefid"),o=e.data[0].details.tags,i=o.length,s=[],r="";t.setData("selectedtags",[]),t.setData("displaytags",[]);for(var n=this.getData("tagnamevscolor"),l=0;l<i;l++){var d=o[l].name;r=a[d],s.push(r);var p={name:d,color_code:o[l].color_code};Lyte.arrayUtils(t.getData("selectedtags"),"push",p),Lyte.arrayUtils(t.getData("displaytags"),"push",p),void 0===n[d]&&(n.tag_name=o[l].color_code)}t.setData("tagnamevscolor",n),CrmTags.clientJSON.value=s;var c=s.length,g=t.getData("selectedtags");c>3&&t.setData("count",g.length-3),t.setData("removedtags","");var m=t.getData("tagarray"),u=t.getData("tagnamevsmodrefid");t.setData("tagarray",[]);var v=m.length;for(l=0;l<v;l++){var y=m[l].name;if(!CrmTags.clientJSON.value.includes(u[y])){p={name:y,color_code:n[y]};Lyte.arrayUtils(t.getData("tagarray"),"push",p)}}store.peekRecord(moduleRecordMapping[t.getData("module")].id,detailView.entityId)&&(store.peekRecord(moduleRecordMapping[t.getData("module")].id,detailView.entityId).Tag=t.getData("selectedtags")),CrmTags.edited=!0,commonUtils.showHideLoadingDiv(!1),crmTab.deleteFromCache(t.getData("module"))},aftercreate_dv:function(t,e){for(var a=e.length,o=t.getData("tagnamevstagid"),i=t.getData("tagnamevsmodrefid"),s=t.getData("tagnamevscolor"),r=t.getData("tagnames"),n=0;n<a;n++){var l=e[n],d=l.modRefId,p=l.name;Lyte.objectUtils(t.getData("idvsname"),"add",d,p),o[p]=l.id,i[p]=d,s[p]=l.color_code,Lyte.objectUtils(t.getData("tagidvstagname"),"add",l.id,p);p=e[n].name;t.getData("tagnames").indexOf(p)&&Lyte.arrayUtils(t.getData("tagarray"),"push",{name:p,id:l.id,color_code:l.color_code}),r.push(p)}t.setData("tagnamevstagid",o),t.setData("tagnamevsmodrefid",i),t.setData("tagnamevscolor",s),t.setData("tagnames",r),t.addTags()},methods:{onError:function(t,e){1===e.errorCode&&renderingUtils.showAlertMsg(I18n.getMsg("crm.tag.splChar"))},validate_tags:function(t){var e;if(!(e=this.getData("tagnames").contains(t)?this.validatetags(t,CrmTags.clientJSON.recordTagCount,this.getData("selectedtags").length+1,0,0,"add","dv"):this.validatetags(t,CrmTags.clientJSON.recordTagCount,this.getData("selectedtags").length+1,CrmTags.clientJSON.editionCount,this.getData("tag").length+this.getData("added_count")+1,"add","dv"))){var a=document.querySelector("#defaulttag");return null!==a&&(a.blur(),a.toggle("close")),!1}if(!this.getData("tagnames").contains(t)){var o=this.getData("added_count");this.setData("added_count",o+1)}if(!e)return e;if(this.setData("saveEnabled",!1),"import"===this.getData("from")){var i=$L("#tagConfig");this.getData("tagnames").contains(t)||$("<input>",{type:"hidden",id:"newTags",name:"newTags",val:t}).appendTo(i)}return CrmTags.checkCharacter(t,!0)?void 0:(renderingUtils.showAlertMsg(I18n.getMsg("crm.tag.splChar")),a.blur(),a.toggle("close"),!1)},beforeremove:function(t){if(!this.data.tagnames.contains(t)){var e=this.getData("added_count");e--,this.setData("added_count",e)}var a=this.getData("removedtags"),o=null,i=null;a=""!==a?a+","+t:t;var s=this.getData("selectedtags"),r=s.length;for(c=0;c<r;c++){var n=s[c];if(n.name!==t||n.hasOwnProperty("isNewTag")){if(n.name===t&&n.hasOwnProperty("isNewTag")){e=this.getData("added_count");return this.setData("added_count",e),this.setData("removedtags",a),void this.setData("saveEnabled",!1)}}else o=n.color_code,n.hasOwnProperty("id")&&(i=n.id)}this.setData("removedtags",a),this.setData("saveEnabled",!1);for(var l=this.getData("tagarray"),d=l.length,p=!1,c=0;c<d;c++)l[c].name===t&&(p=!0);p||Lyte.arrayUtils(this.getData("tagarray"),"push",{name:t,color_code:o,id:i})},open_pop:function(){if(null!=document.querySelector(".alertPopup"))return!1},hideColor:function(t,e){var a=this.$node.querySelector("lyte-popover"),o=a.component.childComp.querySelector("crux-tag"),i=o.component.bodyDrop.querySelector("crux-color-palette lyte-popover");!e||!e.target||a.component.childComp.contains(e.target)||o.component.bodyDrop.contains(e.target)||i.component.childComp.contains(e.target)||(o.toggle("close"),document.getElementById("detailview_add_tag").ltProp("show",!1))},hideColor2:function(t,e){var a=this.$node.querySelector("crux-tag"),o=a.component.bodyDrop.querySelector("crux-color-palette lyte-popover");e&&e.target&&!a.component.bodyDrop.contains(e.target)&&!o.component.childComp.contains(e.target)&&a.toggle("close")}},actions:{showAddTag:function(){this.getData("tooltip")==Lyte.Component.registeredHelpers.getI18n("crm.label.add.tags")&&0==$L("#ApprovalProcess").children().length&&document.getElementById("detailview_add_tag").ltProp("show",!0)},hideAddTag:function(){this.setData("saveEnabled",!0);var t=$("#defaulttag")[0];""!==t.cxProp("inputValue")&&t.resetSearch();var e,a=this.getData("displaytags").slice(),o=this.getData("tagnamevscolor"),i=this.getData("tagnamevstagid"),s=[],r=a.length;for(e=0;e<r;e++)s[e]=a[e].name;i=this.getData("tagnamevstagid");var n=a.slice();r=n.length;for(e=0;e<r;e++){var l=n[e];if(!s.includes(l.name)){var d=l.name,p=o[d],c=i[d];l.id=c,l.color_code=p,Lyte.arrayUtils(this.getData("tagarray"),"push",l)}}this.setData("selectedtags",a),t.toggle("close"),document.getElementById("detailview_add_tag").ltProp("show",!1)},savetags:function(){var t=this.getData("selectedtags"),e=$L("#defaulttag")[0].cxProp("inputValue");if(t.length===CrmTags.clientJSON.recordTagCount&&""!==e){var a=I18n.getMsg("crm.tags.records.limit.reached",CrmTags.clientJSON.recordTagCount);return _cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:a,ltPropContentAlign:"center"}}),!1}if(""===e){this.setData("saveEnabled",!0),document.getElementById("detailview_add_tag").ltProp("show",!1);var o=JSON.stringify(t);if(commonUtils.showHideLoadingDiv(!0),null!==t&&t.length>0&&o.includes('"isNewTag":true')){for(var i=this,s=moduleRecordMapping[i.getData("module")].api_name,r=t.length,n=[],l=0;l<r;l++)if(t[l].isNewTag){var d=t[l].color_code;"#noFill"!==d&&"noFill"!==d||(d=null);var p={name:t[l].name,color_code:d};n.push(p)}i.createtagRec(n,i.getData("tagnames")),i.createtags(s,"dv","dv")}else this.addTags()}else renderingUtils.showAlertMsg(I18n.getMsg("crm.tag.splChar"))}}},{mixins:["crm-tag-mixin"]}),Lyte.Component.registerHelper("tagLink",(function(t,e,a,o){a=$("#module").val();if(null==t){var i=store.peekAll("tag",{module:a}).filterBy({name:e});void 0!==i[0]&&(t=i[0].id)}var s={field:{}};s.field.id="",s.field.api_name="Tag",s.comparator="equal",s.value=[{id:t,name:e,color_code:o}];var r=a;return!r||"Tasks"!==r&&"Calls"!==r&&"Events"!==r||Crm.isActivitySplitDone||(s={group_operator:"AND",group:[s,{comparator:"equal",field:{api_name:"Activity_Type"},value:r}]},r="Activities"),{filters:JSON.stringify(s)}})),Lyte.Mixin.register("crm-tag-mixin",{validatetags:function(t,e,a,o,i,s,r){if("add"===s){var n=this.editionlimit(o,i),l=this.recordlimit(e,a,s,r),d=this.validate_spl_char(t);return!(l||n||d)}return!(l=this.recordlimit(e,a,s,r))},recordlimit:function(t,e,a,o){if(e>t){var i=I18n.getMsg("crm.tags.records.limit.reached",t);return"remove"!==a||"list"!==o&&"bp"!==o&&"wf"!==o||(i=I18n.getMsg("crm.tags.remove.limit.reached",t)),_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:i,ltPropContentAlign:"center"}}),$(".lyteAlertBtn").focus(),!0}return!1},editionlimit:function(t,e){if(e>t){_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.tag.edition.limit.exceeded"),ltPropContentAlign:"center"}});var a=$("crux-tag")[0];return a.toggle("off"),a.resetSearch(),!0}return!1},validate_spl_char:function(t){var e=!1;if(t.match(/[/\\!@#$%^&*()[\].?":{}~`;'|]/)||t.indexOf("+")>-1||t.indexOf("-")>-1){for(var a=t.length,o=0;o<a&&(e=!(!t[o].match(/[/\\!@#$%^&*()[\].?":{}~`;'|]/)&&"+"!==t[o]&&"-"!==t[o]));o++);if(e)return document.querySelector("crux-tag").toggle("close"),_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.tag.splChar"),ltPropContentAlign:"center"}}),$(".lyteAlertBtn").focus(),!0}return!1},notagselected:function(t){if(0===t)return _cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.no.tag.selected"),ltPropContentAlign:"center"}}),!0},createtagRec:function(t,e){for(var a=t.length,o=0;o<a;o++){var i=t[o].name;e.contains(i)||store.createRecord("tag",{name:i,color_code:t[o].color_code})}},createtags:function(t,e,a){var o,i=this;o=void 0===e||"dv"===e||"list-view"===e?"view":"wf"===e?"workflow":e,store.create("tag",void 0,!1,{module:t,fromPage:o}).then((function(o){var s=o,r=i.check_emoji(o,i,t),n=s?s.tag:s;if("blueprint"===e&&i.populatemapping(n),!r)if("list-view"!==e)if("workflow"!==e&&"wf"!==e){if("dv"!==e)return o;i.aftercreate_dv(i,n)}else i.aftercreate_wf(i,n,a);else i.aftercreate_list(i,n,a,t)}),(function(a){if(void 0!==a&&void 0!==a.response&&(-1!==a.response.indexOf("symbols are not allowed")||-1!==a.response.indexOf("tags edition limit exceeded")))return i.check_emoji(JSON.parse(a.response),i,t),void("blueprint"===e&&(i.setData("disableDone",!0),i.setData("disableCancel",!0),i.populatemapping(JSON.parse(a.response))));if("dv"===e){var o={};a&&a.response&&(o=JSON.parse(a.response)),"NO_PERMISSION"===o.code&&"permission denied"===o.message&&(CrmTags.clientJSON.permission=void 0,i.setData("tagged_icon",!1),$(".tagged_icon").hide(),i.setData("add_tag",!1),i.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg")))}else if("list-view"===e)return i.ShowTagErrorMsg(a),commonUtils.showHideLoadingDiv(!1),void i.closeModal();commonUtils.showHideLoadingDiv(!1),renderingUtils.showCustomAlert(I18n.getMsg("crm.tag.unable.to.process"),I18n.getMsg("crm.label.small.tags"),!1)}))},addtagstoRec:function(t,e,a,o,i,s,r,n,l,d){t=this;var p='["'+a.toString()+'"]';e.ids=p,"add"===r?store.triggerAction("entity","add_tags",{tag_names:e,ids:p,over_write:o,type:"POST",fromPage:"view",module:i,from:"detailvew"}).then((function(e){if("detailview"===s&&t.afteradd_detailview(t,e),"canvas"===s){var a=t,o=e.data;if(o&&o.length>0&&-1!==o[0].message.indexOf("tags updated successfully")){a.validatingCanvasRule(a.getData("module"),a.getData("recordId"));var r=a.processTagStrings(o[0].details.tags);if(a.setData("tags",r.slice()),a.addToExistingTags(),a.fetchAllTags(),a.setData("showDropDown",!1),store.peekRecord(moduleRecordMapping[i].id,detailView.entityId).Tag=$("crm-tag")[0].component.data.tags,n&&n.resolvefn&&n.resolvefn(),CScriptLib&&(!n||n.trigger)){var p=d||[],c=l||[],g=c.diff(p)||[],m=p.diff(c)||[];c=c.map((function(t){return{name:t}})),g=g.map((function(t){return{name:t}})),m=m.map((function(t){return{name:t}})),CScript.dispatchEvent("onTagChanged",void 0,g,m)}}else n&&n.resolvefn&&n.rejectfn(),crmui.showMsgBand("info",I18n.getMsg("crm.tags.add.unsuccessful"),1e3,"")}}),(function(e){if("detailview"===s){var a={};e&&e.response&&(a=JSON.parse(e.response)),"NO_PERMISSION"===a.code&&"permission denied"===a.message&&(CrmTags.clientJSON.permission=void 0,t.setData("tagged_icon",!1),$(".tagged_icon").hide(),t.setData("add_tag",!1),t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg"))),renderingUtils.showCustomAlert(I18n.getMsg("crm.tag.unable.to.process"),I18n.getMsg("crm.label.small.tags"),!1),t.setData("saveEnabled",!1),commonUtils.showHideLoadingDiv(!1)}})):store.triggerAction("entity","remove_tags",{tag_names:e,ids:"["+a+"]",over_write:o,type:"POST",fromPage:"view",module:i,from:"detailvew"}).then((function(e){"detailview"===s&&t.afteradd_detailview(t,e)}),(function(e){if("detailview"===s){var a={};if(e&&e.response&&(a=JSON.parse(e.response)),commonUtils.showHideLoadingDiv(!1),"NO_PERMISSION"===a.code&&"permission denied"===a.message)CrmTags.clientJSON.permission=void 0,t.setData("tagged_icon",!1),$(".tagged_icon").hide(),t.setData("add_tag",!1),t.setData("tooltip",Lyte.Component.registeredHelpers.getI18n("crm.tags.detailview.create.no.permission.msg"));else if("INVALID_DATA"===a.code&&"tags not found"===a.message)return void t.setData("saveEnabled",!0);t.setData("saveEnabled",!1),renderingUtils.showCustomAlert(I18n.getMsg("crm.tag.unable.to.process"),I18n.getMsg("crm.label.small.tags"),!1)}}))},check_emoji:function(t,e,a){var o=!1;if(void 0!==t){var i=t.tag;void 0===i&&(i=t.tags);var s=JSON.stringify(i);if(-1!==s.indexOf("tags edition limit exceeded"))return _cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.tag.edition.limit.exceeded"),ltPropContentAlign:"center"}}),void commonUtils.showHideLoadingDiv(!1);if(-1!==s.indexOf("symbols are not allowed")){o=!0,e.tagnames=[],e.setData("tagarray",[]);var r=e.getData("selectedtags"),n=[];if(r)for(var l=r.length,d=0;d<l;d++){var p=r[d].name;n.push(p)}return e.setData("selectedtags",[]),store.findAll("tag",{module:a}).then((function(t){for(var a=t.length,o=0;o<a;o++){var i=t[o].name;void 0!==i&&(Lyte.arrayUtils(e.tagnames,"push",i),Lyte.arrayUtils(e.getData("tagarray"),"push",{name:i,color_code:t[o].color_code}),n.contains(i)&&Lyte.arrayUtils(e.getData("selectedtags"),"push",{name:i,color_code:t[o].color_code}))}})),commonUtils.showHideLoadingDiv(!1),_cruxUtils.showCustomAlert({params:{ltPropSecondaryMessage:I18n.getMsg("crm.tag.name.invalid.emoji"),ltPropContentAlign:"center"}}),o}}}}),Lyte.Component.registerHelper("color_value",(function(t){return null===t?0:CrmTags.color_number(t)})),Lyte.Component.registerHelper("split_tagnames",(function(t,e){if(!Array.isArray(t)){for(var a=[],o=(t=t.split(e)).length,i=0;i<o;i++)"null"!==t[i]&&" null"!==t[i]&&a.push(t[i]);return a}return t})),Lyte.Component.registerHelper("get_tagname",(function(t,e){return CrmTags.gettagname(t,e)})),Lyte.Component.registerHelper("gettag_length",(function(t,e){Array.isArray(t)||(t=t.split(e));var a=t.length;return 2===a||1===a?0:a-2})),Lyte.Component.registerHelper("tooltip_tagcc",(function(t){return CrmTags.tooltip_tagcc(t)}));
