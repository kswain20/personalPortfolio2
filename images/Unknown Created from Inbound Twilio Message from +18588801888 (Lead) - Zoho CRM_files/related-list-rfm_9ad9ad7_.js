Lyte.Component.register("rfm-segment-history",{_template:'<template tag-name="rfm-segment-history"> <template is="if" value="{{segmentHistory.length}}"><template case="true"> <div class="rfm-entityListCont pB30 robotoRegular"> <template is="for" items="{{segmentHistory}}" item="segment" index="index"> <div class="rfm-entityListItem"> <div class="alignright dIB mR30 rfm-entityDateCont robotoRegular vat w150"> <span class="dIB f14px mT6 rfm-entityDate">{{getDateTime(segment.label.assigned_time,24,\'-\')}}</span> </div> <div class="bdrLe9e9 dIB pR rfm-entityTransCont pL30 minW500"> <span id="rfm-entityLabel_{{index}}" class="bgFFF curv3px pA rfm-entityLabel t0 {{if(index,\'\',\'curnt\')}}" onmouseenter="{{action(&quot;rfm_historylabelhover&quot;,this)}}" onmouseout="{{action(&quot;rfm_historylabelhoverLeave&quot;)}}">{{segment.label.name}}</span> <template is="if" value="{{expHandlers(expHandlers(segmentHistory.length,\'-\',1),\'!=\',index)}}"><template case="true"> <div class="boder1 curv3px mB30 mT60 pR rfm-entityTrans dIB"> <template is="for" items="{{rfmArray}}" item="obj" index="index"> <template is="if" value="{{segment[obj.val]}}"><template case="true"> <div class="rfm-entityTransField dIB"> <div class="dIB vam mR20" style="max-width: 190px;"> <span class="dB ellipsistext f14px mB8 robotoBold" onmouseenter="{{action(\'tool_tip\',this,segment[obj.val].field.field_label)}}">{{segment[obj.val].field.field_label}}</span> <div class="color_5 f13px robotoRegular"> <span class="dIB vam">{{if(ifNotEquals(segment[obj.val].prevValue,null),segment[obj.val].prevValue,\'-\')}} </span> <span class="dIB mL7 mR3 op05 rfm-rangeTransit vam"></span> <span class="dIB vam"> {{if(ifNotEquals(segment[obj.val].value,null),segment[obj.val].value,\'-\')}} </span> </div> </div> <div class="dIB robotoBold vam"> <span class="dIB vam">{{obj.char}}</span> <template is="if" value="{{expHandlers(segment[obj.val].isEqual,\'!\')}}"><template case="true"> <span class="dIB vam {{if(segment[obj.val].isIncreased,\'rfm-labelIncrease\',\'rfm-labelDecrease\')}}"></span> <span class="dIB vam">{{segment[obj.val].scoreDiff}}</span> </template></template> </div> </div> </template></template> </template> </div> <template is="if" value="{{expHandlers(expHandlers(segment.recency.isEqual,\'&amp;&amp;\',segment.frequency.isEqual),\'&amp;&amp;\',segment.monetary.isEqual)}}"><template case="true"> <span class="rfm_slider_info op3 dIB cP vam mL5" lt-prop-title="{{getI18n(\'crm.segmentation.scores.nochange\')}}" lt-prop-tooltip-config="{&quot;position&quot; : &quot;top&quot;}"></span> </template></template> </template></template> </div> </div>  </template> </div></template><template case="false"> <div class="aligncenter pB30">{{getI18n(\'crm.segmentation.nohistoryfound\')}}</div> </template></template> <lyte-popover id="historyPopup" lt-prop-show="{{popoverShow}}" lt-prop-duration="1" lt-prop-origin-elem=".popoverEleOrgin" lt-prop-height="auto" lt-prop-show-close-button="false" lt-prop-freeze="false" lt-prop-content-padding="15px" lt-prop-scrollable="true"> <template is="registerYield" yield-name="popover"> <lyte-popover-content class="rfm-history-popCont"> <template is="for" items="{{rfmArray}}" item="obj" index="index"> <p class="clearAfterB mB5"> <span class="dIB gray6 mR5 vam"> {{obj.name}} </span> <span class="dIB robotoBold vam"> {{popoverRecord[obj.val].score}} </span> <template is="if" value="{{expHandlers(obj.val,\'===\',recency_const)}}"><template case="true"><span class="fR gray2 mL20 aaa"> {{expHandlers(popoverRecord[obj.val].value,\'?:\',popoverRecord[obj.val].value,\'-\')}} </span></template><template case="false"><template is="if" value="{{expHandlers(obj.val,\'===\',frequency_const)}}"><template case="true"><span class="fR gray2 mL20 bbb"> {{if(ifNotEquals(popoverRecord[obj.val].value,null),popoverRecord[obj.val].value,\'-\')}} </span></template><template case="false"><span class="fR gray2 mL20 ccc"> {{popoverRecord[obj.val].value}} </span></template></template></template></template> </p> </template> </lyte-popover-content> </template> </lyte-popover> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"for",position:[1,1],dynamicNodes:[{type:"text",position:[1,1,1,0]},{type:"attr",position:[1,3,1]},{type:"text",position:[1,3,1,0]},{type:"attr",position:[1,3,3]},{type:"if",position:[1,3,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"for",position:[1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1,1]},{type:"text",position:[1,1,1,0]},{type:"text",position:[1,1,3,1,0]},{type:"text",position:[1,1,3,5,1]},{type:"text",position:[1,3,1,0]},{type:"attr",position:[1,3,3]},{type:"if",position:[1,3,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[3,0]}]}},default:{}}]}},default:{}}]},{type:"attr",position:[3]},{type:"if",position:[3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}}]}},default:{}}]}]},false:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}},{type:"attr",position:[3]},{type:"registerYield",position:[3,1],dynamicNodes:[{type:"attr",position:[1,1]},{type:"for",position:[1,1],dynamicNodes:[{type:"text",position:[1,1,1]},{type:"text",position:[1,3,1]},{type:"attr",position:[1,5]},{type:"if",position:[1,5],cases:{true:{dynamicNodes:[{type:"text",position:[0,1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[0,1]}]},false:{dynamicNodes:[{type:"text",position:[0,1]}]}},default:{}}]}},default:{}}]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[3]}],_observedAttributes:["segmentHistory","rfmArray","popoverShow","popoverRecord","popoverShow_id","popoverDuration","recency_const","frequency_const","monetary_const"],data:function(){return{segmentHistory:Lyte.attr("array"),rfmArray:Lyte.attr("array"),popoverShow:Lyte.attr("boolean",{default:!1}),popoverRecord:Lyte.attr("object"),popoverShow_id:Lyte.attr("string"),popoverDuration:Lyte.attr("string",{default:"undifined"}),recency_const:Lyte.attr("string",{default:"recency"}),frequency_const:Lyte.attr("string",{default:"frequency"}),monetary_const:Lyte.attr("string",{default:"monetary"})}},didConnect:function(){var e=document.getElementsByClassName("rfm_segmentTbl"),t=e[0].scrollHeight,o=e[0].clientHeight;e[0].style.boxShadow=t>o?"inset 0 -7px 10px -12px rgba(0, 0, 0, 0.6)":null},init:function(){var e=this.getData("segmentHistory");if(e&&e.length){for(var t=e.length,o=0;o<t-1;o++){var a=e[o],s=e[o+1];if(a.recency.prevValue=s.recency.value,a.recency.isEqual=a.recency.score===s.recency.score,a.recency.value){var r=a.recency.value;a.recency.value=Utils.getDateInUserDatePattern(new Date(r),!1)}if(a.recency.prevValue){r=a.recency.prevValue;a.recency.prevValue=Utils.getDateInUserDatePattern(new Date(r),!1)}a.recency.isEqual||(a.recency.isIncreased=a.recency.score>s.recency.score,a.recency.isIncreased?a.recency.scoreDiff=a.recency.score-s.recency.score:a.recency.scoreDiff=s.recency.score-a.recency.score),a.frequency.prevValue=s.frequency.value,a.frequency.isEqual=a.frequency.score===s.frequency.score,a.frequency.isEqual||(a.frequency.isIncreased=a.frequency.score>s.frequency.score,a.frequency.isIncreased?a.frequency.scoreDiff=a.frequency.score-s.frequency.score:a.frequency.scoreDiff=s.frequency.score-a.frequency.score),a.monetary.prevValue=s.monetary.value,a.monetary.isEqual=a.monetary.score===s.monetary.score,null!=a.monetary.value&&(a.monetary.value=currencyUtils.returnValueInDefaultCurrency(null,a.monetary.value)),null!=a.monetary.prevValue&&(a.monetary.prevValue=currencyUtils.returnValueInDefaultCurrency(null,a.monetary.prevValue)),a.monetary.isEqual||(a.monetary.isIncreased=a.monetary.score>s.monetary.score,a.monetary.isIncreased?a.monetary.scoreDiff=a.monetary.score-s.monetary.score:a.monetary.scoreDiff=s.monetary.score-a.monetary.score)}(a=e[t-1]).recency.value&&(a.recency.value=Utils.getDateInUserDatePattern(new Date(a.recency.value),!1)),a.monetary.value=currencyUtils.returnValueInDefaultCurrency(null,a.monetary.value),this.setData("segmentHistory",e);var n=[{val:"recency",name:I18n.getMsg("crm.segmentation.recency"),char:"R"},{val:"frequency",name:I18n.getMsg("crm.segmentation.frequency"),char:"F"},{val:"monetary",name:I18n.getMsg("crm.segmentation.monetary"),char:"M"}];this.setData("rfmArray",n)}},actions:{rfm_historylabelhover:function(e){$L(".popoverEleOrgin").removeClass("popoverEleOrgin"),$L(e).addClass("popoverEleOrgin"),$L("#historyPopup")[0].ltProp("duration",void 0);var t=parseInt(e.id.slice(-1)),o=store.peekAll("rfm_history")[t];this.setData("popoverRecord",o),this.setData("popoverShow",!0)},rfm_historylabelhoverLeave:function(){$L(".popoverEleOrgin").removeClass("popoverEleOrgin"),this.setData("popoverShow",!1)},tool_tip:function(e,t){e.offsetWidth<Math.floor(e.scrollWidth)&&e.offsetWidth!==Math.floor(e.scrollWidth)&&$L(e).attr({"lt-prop-title":t,"lt-prop-tooltip-config":'{"appearance":"callout","position" : "top"}'})}}}),Lyte.Component.register("related-list-segment",{_template:'<template tag-name="related-list-segment"> <h2 class="dvcompHeader relListHead f16 col222">{{getI18n(\'crm.segmentation\')}}</h2> <div class="sementalInfo_detPage pR zI1"> <div class="dIB mR30 vam mW30per pB5 pT5"> <template is="if" value="{{label.name}}"><template case="true"> <div class="ellipsistext f18 crm-font-semibold mB7 lh25 segmentation_subtitle" onmouseenter="{{action(\'tool_tip\',this,label.name)}}">{{label.name}}</div> </template><template case="false"> <div class="txt-ctr mB7 f18 lh25">-</div> </template></template> <div class="col888 robotoRegular">{{getI18n(\'crm.segmentation.segment.label\')}}</div> </div> <ul class="dIB segmentScore_detPage vam clearAfterB"> <li> <span class="f18 crm-font-semibold mB5 dIB lh25 segmentation_subtitle">{{if(recency.value,getDateTime(recency.value,24,\'-\'),\'-\')}}</span> <div class="f14px robotoRegular"><span class="col888 dIB vam segmentation_content">{{getI18n(\'crm.segmentation.recency\')}}</span><span class="segmentScore_part boldFont mL8 vam {{if(recency.score,\'dIB\',\'dN\')}}">{{recency.score}}</span></div> </li> <li> <span class="f18 crm-font-semibold mB5 dIB lh25 segmentation_subtitle">{{if(ifNotEquals(frequency.value,null),frequency.value,\'-\')}}</span> <div class="f14px robotoRegular"><span class="col888 dIB vam segmentation_content">{{getI18n(\'crm.segmentation.frequency\')}}</span><span class="segmentScore_part boldFont mL8 vam {{if(frequency.score,\'dIB\',\'dN\')}}">{{frequency.score}}</span></div> </li> <li> <span class="f18 crm-font-semibold mB5 dIB lh25 segmentation_subtitle">{{formatCurrencyValue(monetary.value,baseCurrency)}}</span> <div class="f14px robotoRegular"><span class="col888 dIB vam segmentation_content">{{getI18n(\'crm.segmentation.monetary\')}}</span><span class="segmentScore_part boldFont mL8 vam {{if(monetary.score,\'dIB\',\'dN\')}}">{{monetary.score}}</span></div> </li> </ul> <span class="fR mT20 cP robotoRegular {{if(showHistory,\'dN\',\'\')}}" data-zcqa="segment_viewhistory" onclick="{{action(\'viewHistory\')}}"><span class="col2c7bd0 dIB f14px mR5 vam">{{getI18n(\'crm.segmentation.viewhistory\')}}</span> <span class="dIB vam svgIcons rfm_HistoryLink"></span></span> <span class="fR mT20 cP robotoRegular {{if(showHistory,\'\',\'dN\')}}" data-zcqa="segment_hidehistory" onclick="{{action(\'hideHistory\')}}"><span class="col2c7bd0 dIB f14px mR5 vam">{{getI18n(\'crm.segmentation.hidehistory\')}}</span> <span class="dIB vam svgIcons rfm_HistoryLink" style="transform: rotate(180deg);"></span></span> </div> <div class="bgFFF borderTop"> <div class="rfm_segmentTbl pT30 {{if(showHistory,\'\',\'dN\')}} bdrBe9e9" onscroll="{{action(\'shawdowEnable\',this)}}"> <div id="segmentHistory"></div> </div> </div> </template>',_dynamicNodes:[{type:"text",position:[1,0]},{type:"attr",position:[3,1,1]},{type:"if",position:[3,1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]}]},false:{dynamicNodes:[]}},default:{}},{type:"text",position:[3,1,3,0]},{type:"text",position:[3,3,1,1,0]},{type:"text",position:[3,3,1,3,0,0]},{type:"attr",position:[3,3,1,3,1]},{type:"text",position:[3,3,1,3,1,0]},{type:"text",position:[3,3,3,1,0]},{type:"text",position:[3,3,3,3,0,0]},{type:"attr",position:[3,3,3,3,1]},{type:"text",position:[3,3,3,3,1,0]},{type:"text",position:[3,3,5,1,0]},{type:"text",position:[3,3,5,3,0,0]},{type:"attr",position:[3,3,5,3,1]},{type:"text",position:[3,3,5,3,1,0]},{type:"attr",position:[3,5]},{type:"text",position:[3,5,0,0]},{type:"attr",position:[3,7]},{type:"text",position:[3,7,0,0]},{type:"attr",position:[5,1]}],_observedAttributes:["showHistory","eventNne","baseCurrency"],data:function(){return{showHistory:Lyte.attr("boolean",{default:!1}),eventNne:Lyte.attr("boolean",{default:!1}),baseCurrency:Lyte.attr("string",{default:Crm.userDetails.BASE_CURRENCY})}},actions:{viewHistory:function(){var e=this;store.unloadAll("rfm_history"),this.setData("eventNne","true"),store.findAll("rfm_history",null,null,null,{module:this.getData("module"),entityId:this.getData("record").id}).then((function(){var t=store.peekAll("rfm_history"),o={segmentHistory:[]};t.length>0&&(o.segmentHistory=t),Lyte.Component.render("rfm-segment-history",o,"#segmentHistory"),e.setData("showHistory",!0),e.setData("eventNne",!1)}),(function(t){var o=JSON.parse(t.response).__segmentations_history.message;e.showAlertBox("error",I18n.getMsg(o))})),$L(".rfm_segmentTbl").scroll({preventOnEnd:!1})},hideHistory:function(){document.getElementById("segmentHistory").innerHTML="",this.setData("showHistory",!1)},shawdowEnable:function(e){var t=e.scrollHeight,o=e.clientHeight,a=e.scrollTop;a>0?$L(".sementalInfo_detPage").css("box-shadow","0 8px 7px -5px rgba(0, 0, 0, 0.1)"):$L(".sementalInfo_detPage").css("box-shadow","none"),t<=Math.round(o+a)?$L(".rfm_segmentTbl").css("box-shadow","none"):$L(".rfm_segmentTbl").css("box-shadow","inset 0 -7px 10px -12px rgba(0, 0, 0, 0.6)")},tool_tip:function(e,t){e.offsetWidth<Math.floor(e.scrollWidth)&&e.offsetWidth!==Math.floor(e.scrollWidth)&&$L(e).attr({"lt-prop-title":t,"lt-prop-tooltip-config":'{"appearance":"callout","position" : "top"}'})}}},{mixins:["segmentation-utils"]}),store.registerModel("rfm_history",{label:Lyte.attr("object",{primaryKey:!0}),recency:Lyte.attr("object"),frequency:Lyte.attr("object"),monetary:Lyte.attr("object")}),store.registerAdapter("rfm_history",{namespace:"crm/v2/",buildURL:function(e,t,o,a,s,r,n){return"findAll"===t&&(s=s.replace("rfm_history",n.module).concat("/"+n.entityId).concat("/__segmentations_history")),s}}),store.registerSerializer("rfm_history",{normalizeResponse:function(e,t,o){return o.rfm_history=o.__segmentations_history,o},payloadKey:function(e){return e}}),store.registerModel("rfm_entity",{record:Lyte.attr("object",{primaryKey:!0}),recency:Lyte.attr("object"),frequency:Lyte.attr("object"),monetary:Lyte.attr("object"),label:Lyte.attr("object")}),store.registerAdapter("rfm_entity",{namespace:"crm/v2/",buildURL:function(e,t,o,a,s,r,n){return"findRecord"===t&&(s=s.replace("rfm_entity",n).concat("/__segmentations_details")),s}}),store.registerSerializer("rfm_entity",{normalizeResponse:function(e,t,o){if("findRecord"===t){var a={};return a.rfm_entity=o.__segmentations_details,a}return o},payloadKey:function(e){return e}});
