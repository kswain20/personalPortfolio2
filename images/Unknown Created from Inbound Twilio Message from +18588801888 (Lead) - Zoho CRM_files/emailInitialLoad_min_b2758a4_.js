function EmailSendingUtil(){}var dotAnimate;EmailSendingUtil.action="",EmailSendingUtil.defaultEditorHeight="",EmailSendingUtil.tempHeight=0,EmailSendingUtil.metaDetailHeight=0,EmailSendingUtil.summaryHeight=0,EmailSendingUtil.editorHeight=0,EmailSendingUtil.totalHeight=0,EmailSendingUtil.attachmentContainerHeight=0,EmailSendingUtil.fileCount=0,EmailSendingUtil.acResultIndex=0,EmailSendingUtil.statusArray={},EmailSendingUtil.moreResults={},EmailSendingUtil.toAddr="",EmailSendingUtil.toAddress="",EmailSendingUtil.ccAddr="",EmailSendingUtil.bccAddr="",EmailSendingUtil.replyToAddr="",EmailSendingUtil.subject="",EmailSendingUtil.mailBody="",EmailSendingUtil.signContent="",EmailSendingUtil.selectedEntityEmail="",EmailSendingUtil.ColleaugeImgURL="",EmailSendingUtil.numberOfEmailAddr=50,EmailSendingUtil.maxLimitExceedsMsg={},EmailSendingUtil.templateIdVsDetail={},EmailSendingUtil.moduleVsTempList={},EmailSendingUtil.numberOfAttachmentsAllowed=20,EmailSendingUtil.filesAttached=0,EmailSendingUtil.filesFlag=0,EmailSendingUtil.templatesFetched=!1,EmailSendingUtil.composeActive=!1,EmailSendingUtil.isEntityWindow=!1,EmailSendingUtil.isEmailProgressing=!1,EmailSendingUtil.mailSentStatus=!1,EmailSendingUtil.zohoDocsAttachIncluded=!1,EmailSendingUtil.displayName="",EmailSendingUtil.isSurvey=!1,EmailSendingUtil.activeModule="",EmailSendingUtil.URL=Crm.getCrmBasePath()+"/mailer/EmailSending.do",EmailSendingUtil.removeFileReq="removeFileFromZFS",EmailSendingUtil.LOAD_MORE_DRAFTS="loadMoreDrafts",EmailSendingUtil.attachDocuments="attachDocuments",EmailSendingUtil.attachIMAPDocuments="attachIMAPDoc",EmailSendingUtil.autoCompleteResultsReceived=!0,EmailSendingUtil.autoCompleteAjaxReceived=!0,EmailSendingUtil.isCrtlKeyPressed=!1,EmailSendingUtil.GET_ENTITIES_FOR_AUTO_COMPLETE="getEntitiesForAutoComplete",EmailSendingUtil.LEADS="Leads",EmailSendingUtil.CONTACTS="Contacts",EmailSendingUtil.POTENTIALS="Potentials",EmailSendingUtil.COLLEAGUES="Colleagues",EmailSendingUtil.USERS="Users",EmailSendingUtil.CUSTOMODULE="",EmailSendingUtil.AutoCompleteModulesArray=[EmailSendingUtil.LEADS,EmailSendingUtil.CONTACTS,EmailSendingUtil.POTENTIALS,EmailSendingUtil.COLLEAGUES,EmailSendingUtil.USERS],EmailSendingUtil.docsAttachmentArray=[],EmailSendingUtil.preLoadedAutoCompleteData={},EmailSendingUtil.AutoCompleteData={},EmailSendingUtil.bestTimeInterval=void 0,EmailSendingUtil.addTemplateHandlebar=null,EmailSendingUtil.templateValues={},EmailSendingUtil.hoverStatus=0,EmailSendingUtil.attachFileType="",EmailSendingUtil.attachZMAILDocuments="attachZmailDoc",EmailSendingUtil.attachGMAILDocuments="attachGmailDoc",EmailSendingUtil.mailType="",EmailSendingUtil.attachSentMailDocuments="",EmailSendingUtil.userDetails={},EmailSendingUtil.searchNotFoundStrings=[],EmailSendingUtil.ScheduledTime="",EmailSendingUtil.ScheduledDay="",EmailSendingUtil.bestTimeData=null,EmailSendingUtil.isConsentEmail=!1,EmailSendingUtil.isTemplateDumped=!1,EmailSendingUtil.consentEmail=!1,EmailSendingUtil.formsPage=1,EmailSendingUtil.formsPer_page=100,EmailSendingUtil.besttimeReqflag=!0,EmailSendingUtil.besttimeSetflag=!0,EmailSendingUtil.besttimedate="Today",EmailSendingUtil.singularMod="",EmailSendingUtil.switchedToOldEditor=!1,EmailSendingUtil.entityId="",EmailSendingUtil.view="",EmailSendingUtil.tempEditor="",EmailSendingUtil.tempContent="",EmailSendingUtil.attachArray=[],EmailSendingUtil.inventObj=void 0,EmailSendingUtil.dataReqObj=void 0,EmailSendingUtil.showFeedBack=!1,EmailSendingUtil.draftId="",EmailSendingUtil.ScheduleText="",EmailSendingUtil.SwitchedFromOldToNew=!1,EmailSendingUtil.OrgEmailArray=[],EmailSendingUtil.isReplyClicked=!1,EmailSendingUtil.isPrivacyEnabled=!1,EmailSendingUtil.isOrgEmailFlow=!1,EmailSendingUtil.oldScheduleText=void 0,EmailSendingUtil.oldScheduleval=void 0,EmailSendingUtil.signDetails="",EmailSendingUtil.fromAddr="",EmailSendingUtil.templatecontentStyle=void 0,EmailSendingUtil.replyTo="",EmailSendingUtil.module="",EmailSendingUtil.switchPlaineditor=!1,EmailSendingUtil.isOrgEmail=[],EmailSendingUtil.relayEnabledDomains=[],EmailSendingUtil.isLoadTemplate=!1,EmailSendingUtil.isFromCscript=null,EmailSendingUtil.templateData="",EmailSendingUtil.isSignatureForOldFlow=!1,EmailSendingUtil.isSendMailActionCalled=!1,EmailSendingUtil.openTabALertPopup=!1,EmailSendingUtil.removeFocus=!1,EmailSendingUtil.other_emails_array=[],EmailSendingUtil.pMailContent=[],EmailSendingUtil.showHideEditorTools=function(e){var i=$(".ceVariousTextFormattingOptionContainer");"plaintext"===e?(i.addClass("plainTextFormat"),i.hide(),$("#plainTextBtn").hide(),$("#emailEditorFormattingIcon").show()):(i.show(),i.removeClass("plainTextFormat"),$("#emailEditorFormattingIcon").hide(),$("#plainTextBtn").show())},EmailSendingUtil.initialize=function(e){EmailSendingUtil.showHideEditorTools(e),EmailSendingUtil.zeCreate(e),setTimeout(EmailSendingUtil.doBindings,300),EmailSendingUtil.HideEmptyfields(),EmailSendingUtil.templatesFetched=!1,EmailSendingUtil.activeModule="",EmailSendingUtil.populateWindowElementsHeight(),window.addEventListener("resize",(function(){EmailSendingUtil.defaultEditorHeight=$(document).height()-218,$("#ecDisplayAttachmentNames").outerHeight()>0&&(EmailSendingUtil.defaultEditorHeight=EmailSendingUtil.defaultEditorHeight-40),EmailSendingUtil.populateWindowElementsHeight()})),EmailSendingUtil.besttimeReqflag&&EmailSendingUtil.setBestTime(new Date),setTimeout(EmailSendingUtil.initiateAttachment,200),EmailSendingUtil.action!==EmailTabHomeUtil.FORWARD&&EmailSendingUtil.action!==EmailTabHomeUtil.COMPOSE||$("#ceToAddr").focus(),$("#emailTempModule").val(""),EmailSendingUtil.featureSpecificHandling()},EmailSendingUtil.zeCreate=function(e){var i={id:"emailEditor",editorheight:EmailSendingUtil.defaultEditorHeight};editor=ZE.create(i),editor.setMode(e),editor.afterEditorLoad((function(){EmailSendingUtil.populateContentsOnReply(),EmailSendingUtil.enableSendMailButton(),EmailSendingUtil.isEntityWindow&&afterEditorLoad(),CustomizeEditor.init("emailEditor"),$(".ceVariousTextFormattingOptionContainer").find("li").mousedown((function(e){e.preventDefault()}))}))},EmailSendingUtil.enableSendMailButton=function(){$("#emcSendMailBtn").removeClass("hide")},EmailSendingUtil.populateContentsOnReply=function(){EmailSendingUtil.action===EmailTabHomeUtil.REPLY?$("#ceTitle").html("Reply"):EmailSendingUtil.action===EmailTabHomeUtil.REPLYALL&&$("#ceTitle").html("Reply All"),"editInCompose"===EmailSendingUtil.action&&($(window).on("beforeunload",(function(e){return"You have some unsaved changes"})),$(window).on("unload",(function(e){})));var e=EmailSendingUtil.toAddr;"null"!==e&&EmailSendingUtil.action!==EmailTabHomeUtil.FORWARD&&e.length>5&&(EmailSendingUtil.populateAddrForReply(e,"ceToAddr",EmailSendingUtil.action),EmailSendingUtil.selectedEntityEmail=e);var i=EmailSendingUtil.ccAddr;"null"!=i&&i.length>5&&(EmailSendingUtil.newshowHideoptions($("#ceCcLink"),"cc"),EmailSendingUtil.populateAddrForReply(i,"ceCCAddr",EmailSendingUtil.action),EmailSendingUtil.resizeEditorHeight());var t=EmailSendingUtil.bccAddr;"null"!=t&&t.length>5&&(EmailSendingUtil.newshowHideoptions($("#ceBccLink"),"bcc"),EmailSendingUtil.populateAddrForReply(t,"ceBCCAddr",EmailSendingUtil.action),EmailSendingUtil.resizeEditorHeight());var a=EmailSendingUtil.replyToAddr;"null"!=a&&a.length>5&&($("#ceReplyToAddr").val(a),$("#ceOption_replyto").removeClass("hide"),$("#ceReplyToAddrSpan").attr("selectedval",a).text(a),EmailSendingUtil.resizeEditorHeight());var l=EmailSendingUtil.subject;"null"!=l&&l.length>0&&($("#ceSubject").val(l),$("#ceSubject1").val(l));var o=EmailSendingUtil.mailBody,n=o;EmailSendingUtil.signContent&&""!=EmailSendingUtil.signContent&&0==window.opener.$("#openInNewComposeWindow").length&&(o=EmailSendingUtil.signContent+o),EmailSendingUtil.isSurvey&&(ZSurvey.insertTextMail(),o=ZSurvey.getSurveyLinkForMail()+o),"null"!=o&&(editor.setContent(o),EmailSendingUtil.action!==EmailTabHomeUtil.FORWARD&&EmailSendingUtil.action!==EmailTabHomeUtil.REPLY&&EmailSendingUtil.action!==EmailTabHomeUtil.REPLYALL||($("#previousMailContent").val(o),$("#previousMailContentWithOutSign").val(n))),EmailSendingUtil.action===EmailActionHandling.LOAD_DRAFT&&EmailActionHandling.setDraftDetails()},EmailSendingUtil.populateAddrForReply=function(e,i,t){if(t===EmailActionHandling.LOAD_DRAFT)EmailSendingUtil.populateAddrForDrafts(e,i);else{EmailSendingUtil.isEntityWindow&&"ceToAddr"===i&&"editInCompose"!==t&&t!==EmailTabHomeUtil.REPLYALL&&(e=e.split(",")[0]);for(var a=e.split(","),l=a.length,o=0;o<l;o++){var n=null,s=a[o],m=s.lastIndexOf("<"),r=s.lastIndexOf(">");m>0&&r>m&&(n=s.substring(0,m),s=s.substring(m+1,r)),EmailSendingUtil.setUnameAndEmail(s,n,null,$("#"+i).closest("li"))}}},EmailSendingUtil.populateAddrForDrafts=function(e,i){for(var t=JSON.parse(e),a=0;a<t.length;a++){var l=t[a],o="",n=l.MODULE?l.MODULE:"";l.PHOTOID&&("Contacts"===n||"Leads"===n||"Potentials"===n?o=Crm.getCrmBasePath()+"/EntityImageAttach.do?action_module="+("Potentials"===n?"Contacts":n)+"&entityId="+l.ENTITYID+"&actionName=readImage&fileId="+l.PHOTOID:"Colleagues"===l.MODULE&&(o=window.location.protocol+"//"+EmailSendingUtil.ColleaugeImgURL+"/file?ID="+l.PHOTOID+"&fs=thumb")),EmailSendingUtil.setUnameAndEmail(l.EMAIL,l.NAME,o,$("#"+i).closest("li"),l.ENTITYID,l.MODULE,l.PHOTOID)}},EmailSendingUtil.validateMailData=function(){var e=editor.getContent();if(EmailSendingUtil.templatecontentStyle&&(e="<html><head>"+EmailSendingUtil.templatecontentStyle+"</head><body>"+e+"</body></html>"),e.length>16e6)return Crm.showAlertMsg(I18n.getMsg("crm.email.char.max.msg")),!1;if("Script tags found"==e)return!1;if(null!=(i=$("#jsonForMergefields").data("mergeFieldsData"))&&null!=i&&(e=this.convertMergeFieldstoFieldIds(e,i)),$("#editorMode").val(editor.mode),"plaintext"==editor.mode?$("#descriptionInPlainText").val(e):$("#description").val(e),!EmailSendingUtil.validateEmailFieldsOfToCcBcc("ceToAddr","ceCCAddr","ceBCCAddr",EmailSendingUtil.maxLimitExceedsMsg.toCcBcc))return!1;if(!EmailSendingUtil.validateAllEmailFields("ceToAddr",!0,EmailSendingUtil.numberOfEmailAddr,I18n.getMsg("crm.email.toaddr.empty"),I18n.getMsg("crm.email.toaddr.provide.valid")))return!1;if(!EmailSendingUtil.missedAttachmentInBody())return!1;if(!EmailSendingUtil.validateAllEmailFields("ceCCAddr",!1,EmailSendingUtil.numberOfEmailAddr,null,I18n.getMsg("crm.email.ccaddr.provide.valid")))return!1;if(!EmailSendingUtil.validateAllEmailFields("ceBCCAddr",!1,EmailSendingUtil.numberOfEmailAddr,null,I18n.getMsg("crm.email.bccaddr.provide.valid")))return!1;if(!EmailSendingUtil.validateAllEmailFields("ceReplyToAddr",!1,1,null,I18n.getMsg("crm.email.replyaddr.provide.valid")))return!1;if($("#ceReplyToAddrDetails .selectedEmail").length>1)return Crm.showAlertMsg(maxLimitExceedMsg),!1;EmailSendingUtil.selectedEmailMatches()||EmailSendingUtil.isEntityWindow||($("#moduleName").val(""),$("#ecEntityId").val(""));var i,t=$("#ceSubject1").val();t&&t.length>250&&(t=t.substring(0,250),$("#ceSubject1").val(t),$("#ceSubject").val(t));if(t&&commonUtils.showHideLoadingDiv(!0),null!=(i=$("#jsonForMergefields").data("mergeFieldsData"))&&null!=i&&(t=this.convertMergeFieldstoFieldIds(t,i),$("#ceSubject").val(t)),EmailSendingUtil.filesFlag>0)return Crm.showAlertMsg(I18n.getMsg("crm.email.attach.inprogess")),!1;var a=EmailSendingUtil.calculateFileSize();if(a>10485760)return Crm.showAlertMsg(I18n.getMsg("crm.mail.attach.restriction.individual.error1")),!1;if(a>0&&EmailSendingUtil.zohoDocsAttachIncluded)for(var l=$("#ecDisplayAttachmentNames").find(".ecAttachmentDispPattern").length,o=0;o<l;o++){var n=$("#ecDisplayAttachmentNames").find(".ecAttachmentDispPattern")[o];$(n).find("span").text($(n).attr("filename"))}return EmailSendingUtil.composeActive=!1,!0},EmailSendingUtil.missedAttachmentInBody=function(){var e=$(".ze_area").contents().find(".ze_body").contents().filter((function(e,i){return!$(i).hasClass("mcPreviousMailContent")}));return 0===(e=$(e).text()).length||(!((e.toLowerCase().indexOf("I have attached".toLowerCase())>-1||e.toLowerCase().indexOf("I have an attachment".toLowerCase())>-1||e.toLowerCase().indexOf("I've attached".toLowerCase())>-1||e.toLowerCase().indexOf("I have included".toLowerCase())>-1||e.toLowerCase().indexOf("I've included".toLowerCase())>-1||e.toLowerCase().indexOf("see the attached".toLowerCase())>-1||e.toLowerCase().indexOf("see the attachment".toLowerCase())>-1||e.toLowerCase().indexOf("attached file".toLowerCase())>-1||e.toLowerCase().indexOf("I attached a file".toLowerCase())>-1)&&!($("#ecDisplayAttachmentNames").is(":visible")&&$("#ecDisplayAttachmentNames").height()>0||confirm("It seems that you might have forgotten to attach files.Send this message without attachments?")))||($(".ze_area").contents().find("body").focus(),!1))},EmailSendingUtil.validateAllEmailFields=function(e,i,t,a,l){var o=$("#"+e);if(0===o.length)return!0;var n=o.val().trim();return""!==n&&EmailSendingUtil.setUnameAndEmail(n,"",null,o.closest("li")),$("#"+e+"Details .invalidEmail").length>0?(Crm.showAlertMsg(l),!1):"ceToAddr"!=e||0!=$("#"+e+"Details .selectedEmail").length||(Crm.showAlertMsg(a),!1)},EmailSendingUtil.validateEmailFieldsOfToCcBcc=function(e,i,t,a){var l=$("#"+e+"Details .selectedEmail").length,o=$("#"+i+"Details .selectedEmail").length,n=$("#"+t+"Details .selectedEmail").length;if(l+o+n>EmailSendingUtil.numberOfEmailAddr)return Crm.showAlertMsg(a),!1;var s=editor.getContent();if(-1!==s.indexOf("${Unsubscribe")&&s.indexOf("${Unsubscribe")!==s.lastIndexOf("${Unsubscribe"))return Crm.showAlertMsg(I18n.getMsg("crm.unsubscription.linklimit")),!1;var m="IMAP"!=$("#mailConfigType").val()||EmailSendingUtil.isOrgEmailFlow?1:10;return!(-1!==s.search(/\$\{Unsubscribe\.(.*?)\}/)&&l+o+n>m)||(Crm.showAlertMsg(I18n.getMsg("crm.email.toaddr.provide.nomore",m)),!1)},EmailSendingUtil.validate=function(e){if($("#ceFromAddr").val($("#addrsVal").attr("selectedval")),$("#ceReplyToAddr").val($("#ceReplyToAddrSpan").attr("selectedVal")),!EmailSendingUtil.isEmailProgressing&&EmailSendingUtil.validateMailData()){if(!e){if(""==$("#ceSubject1").val().trim()){var i=prompt(I18n.getMsg("crm.email.specify.subject"));if(i&&i.length>250)i=i.substring(0,250);else if(null==i||""==i)return Crm.showAlertMsg(I18n.getMsg("crm.field.empty.check",I18n.getMsg("crm.label.subject"))),!1;$("#ceSubject1").val(i);var t=$("#jsonForMergefields").data("mergeFieldsData");null!=t&&null!=t&&(i=this.convertMergeFieldstoFieldIds(i,t)),$("#ceSubject").val(i),commonUtils.showHideLoadingDiv(!0)}var a=!0;if(-1===editor.getContent().search(/\$\{ConsentForm\.[a-zA-Z0-9_]+\}/))if(EmailSendingUtil.isTemplateDumped){if(EmailSendingUtil.isTemplateDumped){-1===editor.getContent().search(/\/crm\/MyConsentPortal\?id=([a-z0-9A-z]*)/)&&(a=!1)}}else a=!1;if(!0===a)EmailSendingUtil.isConsentEmail||$(getOpenerObj("dataPrivacyContainerDiv")).html(""),$(sendMailForm).find('input[name="isConsentEmail"]').val("true");else if(EmailSendingUtil.isConsentEmail)return crmui.showMsgBand("error",I18n.getMsg("crm.send.consent.link.missing.message"),5e3),CustomizeEditor.mapClicks($(".ceSvgEmbedLink").closest("li")),!1;EmailSendingUtil.setEmailAddresses();var l=$("#moduleName").val(),o=$("#emailTempModule").val();if(l&&o&&l!=o){var n={};return n.info=I18n.getMsg("crm.email.module.differ.alert"),EmailTabHomeUtil.customConfirmation(n,(function(){EmailSendingUtil.validate(!0)})),!1}}if(EmailSendingUtil.isEntityWindow)EmailSendingUtil.sendingPopup(),EmailSendingUtil.setEntityAttachDetails();else{var s=$("#emc_msg_Tab");s.css("left",(EmailTabHomeUtil.ViewPortWidth-s.outerWidth())/2).show(),s.attr("data-zcqa","emc_SendTab_SendingMail"),s.css({"z-index":"102"}),s.html("Sending Mail")}return EmailSendingUtil.isEmailProgressing=!0,$("#editorMode").val(editor.mode),e&&document.sendMailForm.submit(),Macro.autoSuggest(l,!1),!0}return commonUtils.showHideLoadingDiv(!1),!1},EmailSendingUtil.showError=function(){var e=$("#emc_msg_Tab");e.css("left",($(document).outerWidth()-e.outerWidth())/2).show(),emc_msg_Tab.css({"z-index":"100"})},EmailSendingUtil.setEmailAddresses=function(){if($("#ceToAddrDetails .selectedEmail").length>0&&($("#ceToAddrDetails").parent().find("#toAddress").val(EmailSendingUtil.getCommaSeparatedEmails("ceToAddrDetails")),$("#ceToAddrDetails").parent().find("#toAddrUname").val(EmailSendingUtil.getCommaSeparatedUsernames("ceToAddrDetails"))),$("#ceCCAddrDetails .selectedEmail").length>0&&($("#ceCCAddrDetails").parent().find("#ccAddress").val(EmailSendingUtil.getCommaSeparatedEmails("ceCCAddrDetails")),$("#ceCCAddrDetails").parent().find("#ccAddrUname").val(EmailSendingUtil.getCommaSeparatedUsernames("ceCCAddrDetails"))),$("#ceBCCAddrDetails .selectedEmail").length>0&&($("#ceBCCAddrDetails").parent().find("#bccAddress").val(EmailSendingUtil.getCommaSeparatedEmails("ceBCCAddrDetails")),$("#ceBCCAddrDetails").parent().find("#bccAddrUname").val(EmailSendingUtil.getCommaSeparatedUsernames("ceBCCAddrDetails"))),!EmailSendingUtil.isEntityWindow){var e=$("#ceToAddrDetails li")[0];""!=$(e).attr("module")&&"null"!=$(e).attr("module")&&""!=$(e).attr("entityid")&&"null"!=$(e).attr("entityid")&&($("#moduleName").val($(e).attr("module")),$("#ecEntityId").val($(e).attr("entityid")))}},EmailSendingUtil.resetEmailAddresses=function(){$("#ceToAddrDetails").parent(),$("#ceCCAddrDetails").parent(),$("#ceBCCAddrDetails").parent();var e=$("#toAddress"),i=$("#toAddrUname");$("#ceToAddrDetails .selectedEmail").length>=0?(e.val(EmailSendingUtil.getCommaSeparatedEmails("ceToAddrDetails")),i.val(EmailSendingUtil.getCommaSeparatedUsernames("ceToAddrDetails"))):(e.val(""),i.val(""));var t=$("#ccAddress"),a=$("#ccAddrUname");$("#ceCCAddrDetails .selectedEmail").length>=0?(t.val(EmailSendingUtil.getCommaSeparatedEmails("ceCCAddrDetails")),a.val(EmailSendingUtil.getCommaSeparatedUsernames("ceCCAddrDetails"))):(t.val(""),a.val(""));var l=$("#bccAddress"),o=$("#bccAddrUname");$("#ceBCCAddrDetails .selectedEmail").length>=0?(l.val(EmailSendingUtil.getCommaSeparatedEmails("ceBCCAddrDetails")),o.val(EmailSendingUtil.getCommaSeparatedUsernames("ceBCCAddrDetails"))):(l.val(""),o.val(""))},EmailSendingUtil.getCommaSeparatedEmails=function(e){var i=[];return $("#"+e+" .selectedEmail").each((function(){!1===i.contains($(this).attr("email"))&&i.push($(this).attr("email"))})),i.toString()},EmailSendingUtil.getCommaSeparatedUsernames=function(e){var i="",t=[];return $("#"+e+" .selectedEmail").each((function(){-1===t.indexOf($(this).attr("email"))&&(t.push($(this).attr("email")),""!=$(this).attr("username")?i+=""==i?$(this).attr("username"):","+$(this).attr("username"):i+=""==i?$(this).attr("email"):","+$(this).attr("email"))})),i},EmailSendingUtil.getUserNameWithEmail=function(e){var i="[]";if($("#"+e+"Details li").length>0){var t=[];$("#"+e+"Details li").each((function(){if(!$(this).hasClass("ecAddrEditor")){var e={};e.NAME=$(this).attr("username"),e.EMAIL=$(this).attr("email"),e.ENTITYID=$(this).attr("entityid"),e.PHOTOID=$(this).attr("phid"),e.MODULE=$(this).attr("module"),t.push(e)}})),i=JSON.stringify(t)}return i},EmailSendingUtil.getUserNameWithEmailForSwitch=function(e){var i="[]";if($("#"+e+"Details_"+EmailComposeUtil.CURRENT_TAB+" li").length>0){var t=[];$("#"+e+"Details_"+EmailComposeUtil.CURRENT_TAB+" li").each((function(){if(!$(this).hasClass("ecAddrEditor")){var e={};e.NAME=$(this).attr("username"),e.EMAIL=$(this).attr("email"),e.ENTITYID=$(this).attr("entityid"),e.PHOTOID=$(this).attr("phid"),e.MODULE=$(this).attr("module"),t.push(e)}})),i=JSON.stringify(t)}return i},EmailSendingUtil.selectedEmailMatches=function(){var e=$("#ceToAddr").val();return EmailSendingUtil.isNewEditor()&&(e=$("#ceToAddr_"+EmailComposeUtil.CURRENT_TAB).val()),e||(e=""),e=(e=e.replace(/\s+/g,"")).substring(0,e.indexOf(",")),EmailSendingUtil.selectedEntityEmail===e},EmailSendingUtil.doBindings=function(){var e=$(".ze_area"),i=e.height();e.css("height",i),e.contents().find("body").css("height",i-30),e.attr("data-zcqa","emc_ze_area"),EmailSendingUtil.toggleClickEventForEditor("bind"),$(".ceComposeSummary").on("click",EmailSendingUtil.displayComposeMetaFields),$(".attachFile").click((function(e){renderingUtils.triggerEvent("click",$(".smFile"))}));var t=$(window).height();$(window).resize((function(){var a=t>$(window).height()?t-$(window).height():$(window).height()-t;e.outerHeight()>30?(i=t>$(window).height()?e.outerHeight()-a:e.outerHeight()+a,e.css("height",i),$("#emailEditor").css("height",i),e.contents().find("body").css("height",i-30),t=$(window).height()):($("#emailEditor").css("height","31px"),e.css("height","31px"),e.contents().find("body").css("height","1px"),t=$(window).height())}))},EmailSendingUtil.toggleClickEventForEditor=function(e){"bind"==e?$(".ze_area").contents().find("body").on("click",(function(){EmailSendingUtil.showComposeMetaSummary(),EmailSendingUtil.hideEditorPopups()})):"unbind"==e&&($(".ze_area").contents().find("body").off("click"),EmailSendingUtil.hideEditorPopups())},EmailSendingUtil.hideEditorPopups=function(){$("#ceVariousAttachmentOptionContainer ,.ceToolBarPopupActions").hide(),$("#etSchedulePopId").addClass("hide")},EmailSendingUtil.summarizeUserNameandEmail=function(e){e||(e=["ceToAddr","ceCCAddr","ceBCCAddr"],EmailSendingUtil.isNewEditor()&&((e=[])[0]="ceToAddr_"+EmailComposeUtil.CURRENT_TAB,e[1]="ceCCAddr_"+EmailComposeUtil.CURRENT_TAB,e[2]="ceBCCAddr_"+EmailComposeUtil.CURRENT_TAB)),$.each(e,(function(e,i){var t=$("#"+i).closest("ul").find("li:not(.ecAddrEditor)").find('input[type="text"]:not(.hide)');t.length>0&&$.each(t,(function(e,i){EmailSendingUtil.rectifyEmail(i)}))}))},EmailSendingUtil.showComposeMetaSummary=function(){EmailSendingUtil.summarizeUserNameandEmail(),""!=$("#ceToAddr").val()&&$("#ceToAddr").val().length>5&&EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail($("#ceToAddr").val()),EmailSendingUtil.formattedUsernameFromEmail($("#ceToAddr").val()),null,$("#ceToAddr").closest("li")),""!=$("#ceCCAddr").val()&&$("#ceCCAddr").val().length>5&&EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail($("#ceCCAddr").val()),EmailSendingUtil.formattedUsernameFromEmail($("#ceCCAddr").val()),null,$("#ceCCAddr").closest("li")),""!=$("#ceBCCAddr").val()&&$("#ceBCCAddr").val().length>5&&EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail($("#ceBCCAddr").val()),EmailSendingUtil.formattedUsernameFromEmail($("#ceBCCAddr").val()),null,$("#ceBCCAddr").closest("li"));var e="";$("#ceOption_replyto").is(":visible")&&$("#ceReplyToAddrSpan").attr("selectedval").replace(/\s/g,"").length>5&&(e+=" <b>"+I18n.getMsg("crm.label.reply.to")+"</b> "+$ESAPI.encoder().encodeForHTML($("#ceReplyToAddrSpan").attr("selectedval")));var i="<span class='dB lH21 fL'><span class='etsColumnLabel f15  mR5 mT1 fL'>"+I18n.getMsg("crm.label.to.email")+"</span>"+$ESAPI.encoder().encodeForHTML(EmailSendingUtil.getDisplayAddresses("ceToAddr"))+"</span>";0==$("#ceToAddrDetails li").length&&(i="<span class='etsColumnLabel f15 mR5'>"+I18n.getMsg("crm.label.to.email")+"</span> <span style='color:#5c5c5c;'></span>"),$("#ceCCAddrDetails li").length>1&&(i+="<span class='dB lH21 fL'><span class='etsColumnLabel f15 mR5 mL10 mT1 fL'>"+I18n.getMsg("crm.label.cc.email")+"</span>"+$ESAPI.encoder().encodeForHTML(EmailSendingUtil.getDisplayAddresses("ceCCAddr"))+"</span>"),$("#ceBCCAddrDetails li").length>1&&(i+="<span class='dB lH21 fL'><span class='etsColumnLabel f15 mR5 mL10 mT1 fL'>"+I18n.getMsg("crm.label.bcc.email")+"</span> "+$ESAPI.encoder().encodeForHTML(EmailSendingUtil.getDisplayAddresses("ceBCCAddr"))+"</span>"),i=i.replace(/,/g,", ");var t=$(".ceSenderInfo"),a=$(".ceReceiverInfo");""!=e?(t.find(".posRel").html(e),t.show()):t.hide(),a.find(".posRel").html(i),$("#ceReplyToLink").length>0&&!$("#ceOption_replyto").is(":visible")||$("#ceReplyToLink").addClass("hide"),$(".ceComposeMeta").hide(),a.show();$("#ecDisplayAttachmentNames").is(":visible")&&$("#ecDisplayAttachmentNames").height();var l=$("#emailComposeContainer").height();l<=0&&(l=EmailTabHomeUtil.ViewPortHeight-60),$("#ecAutoCompleteContainer").addClass("hide"),EmailSendingUtil.toggleClickEventForEditor("unbind"),EmailSendingUtil.resizeEditorHeight()},EmailSendingUtil.getDisplayAddresses=function(e){var i="";return $("#"+e+"Details li").length>1&&$("#"+e+"Details li").each((function(){$(this).hasClass("ecAddrEditor")||(""!=$(this).attr("username")?i+=""==i?$(this).attr("username"):","+$(this).attr("username"):i+=""==i?$(this).attr("email"):","+$(this).attr("email"))})),i},EmailSendingUtil.getFormattedEmailAndUserName=function(e){var i=[],t=e.lastIndexOf("<"),a=e.lastIndexOf(">");if(t>0&&a>t){var l=e.substring(0,t);e=e.substring(t+1,a),i.push(e),l=l.replace(/;/g,"").replace(/:/g,"").replace(/>/g,"").replace(/</g,""),i.push(l)}else i.push(e),i.push(e);return i},EmailSendingUtil.removeHTMLTags=function(e){var i=e.replace(/</g,"&lt;");return i=i.replace(/>/g,"&gt;")},EmailSendingUtil.populateAddnEmail=function(e,i){$("#addSecondaryEmail").hide();var t="",a="",l="",o=networkUtils.getImageUrl("nophoto_80ea3af_.png",ResourceConstants.CRM),n="selectedEmail",s="selectedEmail";if(i.indexOf(",")>-1){t=i.substr(i.indexOf(",")+1),i=i.substr(0,i.indexOf(","));var m=this.getFormattedEmailAndUserName(i),r=this.getFormattedEmailAndUserName(t);i=m[0],a=m[1],t=r[0],l=r[1]}if(validationUtils.isValidEmail(i)||(s="invalidEmail"),validationUtils.isValidEmail(t)||(n="invalidEmail"),i=$ESAPI.encoder().encodeForHTMLAttribute(i),a=$ESAPI.encoder().encodeForHTMLAttribute(a),t=$ESAPI.encoder().encodeForHTMLAttribute(t),l=$ESAPI.encoder().encodeForHTMLAttribute(l),"EA"==e){var d="<li class='fL "+s+"' username='"+a+"' email='"+i+"' >";d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+a+"</span>",d=(d+="</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_'+$ESAPI.encoder().encodeForHTMLAttribute(email)+' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>")+"<li class='fL "+n+"' username='"+l+"' email='"+t+"' >",d=(d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+l+"</span>")+"</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_"+$ESAPI.encoder().encodeForHTMLAttribute(i)+"' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>"}else if("AO"==e){d="<li class='fL "+n+"' username='"+l+"' email='"+t+"' >";d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+l+"</span>",d+="</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_'+$ESAPI.encoder().encodeForHTMLAttribute(email)+' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>"}else{d="<li class='fL "+s+"' username='"+a+"' email='"+i+"' >";d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+a+"</span>",d+="</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_'+$ESAPI.encoder().encodeForHTMLAttribute(email)+' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>"}$("#ceToAddrDetails").html(""),d+="<li class='fL ecAddrEditor' id='liToAddresDetails' style='background:#fff;'><input data-zcqa='emc_ceToAddr' initialliselection='true' autocomplete='off' class='fL ecTxtboxes mT2' type='text' onkeydown='EmailSendingUtil.handleKeyDownEventsForAutoComplete(this,event);sE(event);' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete(this,event);sE(event);' onpaste='EmailSendingUtil.handlePasteEventForAutoComplete(this);sE(event);' onfocus='EmailSendingUtil.isCrtlKeyPressed = false;sE(event);' placeholder='' id='ceToAddr' onclick='sE(event)' value='' style='width: 54px;'></li>",$("#ceToAddrDetails").html(d),$(".liToAddresDetails").html("")},EmailSendingUtil.displayComposeMetaFields=function(){if($(".ceComposeSummary").hide(),$(".ceComposeMeta").show(),$("#ceToAddr").focus(),$("#ecDisplayAttachmentNames").is(":visible")&&$("#ecDisplayAttachmentNames").height()>0)$("#ecDisplayAttachmentNames").height();$("#ceReplyToLink").length>0&&!$("#ceOption_replyto").is(":visible")&&$("#ceReplyToLink").removeClass("hide"),EmailSendingUtil.resizeEditorHeight(),EmailSendingUtil.toggleClickEventForEditor("bind")},EmailSendingUtil.postFormSubmission=function(e,i,t,a,l,o,n,s,m){var r=$("#emc_msg_Tab");if(r.css("left",(EmailTabHomeUtil.ViewPortWidth-r.outerWidth())/2).show(),r.css({"z-index":"100"}),commonUtils.showHideLoadingDiv(!1),"SUCCESS"==e)r.attr("data-zcqa","emc_SendTab_Success"),EmailSendingUtil.isEntityWindow?($(window).off("beforeunload"),$(window).off("unload"),$("#emc_msg_Tab").hide(),$("#bestTime").length>0&&$("#bestTime").is(":checked")&&""!==$("#bestTime").val()?$("#emailEntityComposepopup").html(I18n.getMsg("crm.case.schedule.message")):$("#emailEntityComposepopup").html(I18n.getMsg("crm.case.sent.message")),$("#cmpKanbanView").length>0&&"true"==$("#cmpKanbanView").val()&&$("#cmpCloseWindowOptn").length?renderingUtils.triggerEvent("click",$("#cmpCloseWindowOptn")):((getOpenerObj("relatedPageContent")||opener.document.querySelector("crm-emailsrl-canvas-view")||opener.document.querySelector("crm-zsurvey-rl-label"))&&(getOpenerObj("navigationRefreshKey")&&$(getOpenerObj("emailDetailIframeContent")).is(":visible")?$(getOpenerObj("navigationRefreshKey")).html("true"):(EmailSendingUtil.refreshEmailRelList(),EmailSendingUtil.isConsentEmail&&opener.DataPrivacy.loadDataPrivacy($("#newleft_DataPrivacy")),"null"!==m&&void 0!==m&&$(getOpenerObj("dataRequestMailLink_"+m)).removeClass("dataRequestMailLink cP").text(I18n.getMsg("crm.data.subject.mail.sent")).unbind("click").addClass("eventNone"))),EmailSendingUtil.showFeedBack?showSwitchReasonSurvey():setTimeout((function(){window.self.close()}),4e3))):(r.hide(),r.removeAttr("data-zcqa"),EmailActionHandling.closeCompose(EmailSendingUtil.action,!0,i,t,a,n,s),EmailSendingUtil.constructDivElements(i,o,t,l,"CRM_EMAIL"),EmailSendingUtil.fetchMailsFromFolder("Sent")),EmailSendingUtil.mailSentStatus=!0;else{if(r.hide(),e.indexOf(I18n.getMsg("crm.email.spam"))>-1){var d=e.split("::");e=d[0];var c=d[1];if(r.html(e+" "),null!=c&&""!==c&&"null"!==c){var E=document.createElement("a");E.setAttribute("id","EditTemplate"),E.setAttribute("href",Crm.getCrmBasePath()+"/settings/templates?type=email&step=edit&templateId="+c);var p=$("#ecTemplateId").val();void 0!==EmailSendingUtil.templateIdVsDetail[p]&&delete EmailSendingUtil.templateIdVsDetail[p],E.setAttribute("target","_blank"),E.text=" "+I18n.getMsg("crm.templates.edit.template"),document.getElementById("emc_msg_Tab").append(E)}}else e.includes("Mail Sending Failed! Your SMTP server does not allow sending emails to addresses which contain special and/or foreign characters")||e.includes("Error while processing the request! javax.mail.MessagingException: 5.5.2 Syntax error")?r.html(I18n.getMsg("chatacters_not_allowed_by_smtp_server")):r.html(e);r.attr("data-zcqa","emc_SendTab_Error"),EmailSendingUtil.isEntityWindow?($("#emailEntityComposeOverlay").hide(),$("#emailEntityComposepopup").hide(),setTimeout((function(){r.show().css("left",($(document).outerWidth()-r.outerWidth())/2)}),100)):setTimeout((function(){r.show().css("left",(EmailTabHomeUtil.ViewPortWidth-r.outerWidth())/2)}),100),setTimeout((function(){$("#emc_msg_Tab").hide(),r.removeAttr("data-zcqa"),$("#emc_msg_Tab").html("Loading...")}),8e3)}EmailSendingUtil.isEmailProgressing=!1},EmailSendingUtil.fetchMailsFromFolder=function(e){setTimeout((function(){var i="action=fetchMails&folder="+e;i+="&"+csrfParamName+"="+csrfToken,$.ajax({type:EmailTabHomeUtil.POST_REQUEST_TYPE,url:EmailSendingUtil.URL,data:i})}),2e3)},EmailSendingUtil.refreshEmailRelList=function(){var e=getOpenerObj("module").value,i=getOpenerObj("id").value;if(getOpenerObj("emailId")){var t=getOpenerObj("emailId").value,a=getOpenerObj("fullname").value,l=getOpenerObj("mailListRelId").value,o="";o="Potentials"==e?getOpenerObj("id").value:getOpenerObj("entityId").value,null!=getOpenerObj("isFromNewAPI")||$("#isFromNewAPI").length>0?"Schedule"==$("#emcSendBtn").val()?showMailsListViaAPI("","-10","next",null,"scheduledMails"):showMailsListViaAPI("","-10","next",null,"mails"):showMailsList(o,t,a,l,"-10","next","","false",e)}else opener.document.querySelector("crm-zsurvey-rl-label")&&opener.ZSurvey.refreshSurveyPersonality(e,i)},EmailSendingUtil.constructDivElements=function(e,i,t,a,l){var o='<input type="button" onclick="return addNote(\''+e+"','"+i+"', '"+t+"','"+a+"', '"+l+'\');" value="save" class="button hideNs" style="margin-top:2px; border:1px solid #999;" id="save_comment">';o+='<a href="javascript:;" onclick="$(\'#noteCreation\').hide()" class="pL5 sl hideNs">close</a>',$("#addRMButton").html(o)},EmailSendingUtil.resizeEditorHeight=function(e){e="number"==typeof e?e:35,EmailSendingUtil.setWindowElementsHeight()},EmailSendingUtil.showAttachmentNFormattingOptions=function(e,i){var t=$("#ceVariousAttachmentOptionContainer")[0];if(t&&""===t.style.display)t.style.display="none";else{$(".ceAttachmentAndFormatterImg span").css("color","#888"),$(e).find("span").css("color","#222");var a=$(e).offset(),l=200;"-180px"==$("#etleftNavContainer").css("left")&&(l=20),EmailSendingUtil.isEntityWindow&&(l=0);var o=a.left-($("#ceVariousAttachmentOptionContainer").outerWidth()/2+l);Crm.userDetails.RTL_ENABLED&&(o=a.right-($("#ceVariousAttachmentOptionContainer").outerWidth()/2+l)),"formatting"===i?($("#emailEditorFormattingIcon").hide(),$(".selectedBtn").removeClass("selectedBtn"),$("#emcSaveandSendBtn").hide(),$("#ceVariousAttachmentOptionContainer").fadeOut(200),$(".ceVariousTextFormattingOptionContainer").css({left:$("#ecMailOptions").outerWidth()}).show(),CustomizeEditor.toogleRichTextAndPlainText(e)):"attachments"===i&&($("#emcSaveandSendBtn").hide(),$(".selectedBtn").removeClass("selectedBtn"),Crm.userDetails.RTL_ENABLED?($("#ceVariousAttachmentOptionContainer").css({top:"-"+($("#ceVariousAttachmentOptionContainer").height()+10)+"px","min-width":"150px","max-width":"500px",right:o+20}),setTimeout((function(){$("#ceVariousAttachmentOptionContainer").css({top:"-"+($("#ceVariousAttachmentOptionContainer").height()+10)+"px"}),$("#ceVariousAttachmentOptionContainer").fadeIn(200)}),200)):$("#ceVariousAttachmentOptionContainer").fadeIn(200).css({top:"-"+($("#ceVariousAttachmentOptionContainer").height()+10)+"px",width:"150px",left:o+20}))}},EmailSendingUtil.process=function(e){var i=$(e).val(),t=$(e).attr("name")+"_"+EmailSendingUtil.filesAttached;EmailSendingUtil.createFileInputTag(e,t),EmailSendingUtil.displayAttachmentName(i);var a=$("#ecDisplayAttachmentNames").outerHeight(!0);if(EmailSendingUtil.attachmentContainerHeight!=a&&60!=EmailSendingUtil.attachmentContainerHeight){var l=a-EmailSendingUtil.attachmentContainerHeight;a>60&&($("#ecDisplayAttachmentNames").css({height:"72px",overflow:"auto"}),l=72-EmailSendingUtil.attachmentContainerHeight,a=72),EmailSendingUtil.attachmentContainerHeight=a}EmailSendingUtil.resizeEditorHeight(l),EmailSendingUtil.filesAttached++},EmailSendingUtil.docsHandling=function(){Crm.userDetails.isNewEditor?EmailUtil.docsHandling():(document.getElementById("attachdialogdiv")&&(document.getElementById("attachdialogdiv").style.display="none"),document.getElementById("zohodocsframe")&&(document.getElementById("zohodocsframe").style.display="none"),EmailSendingUtil.uploadDocsAttachments())},EmailSendingUtil.createFileInputTag=function(e,i){$('<input type="file" class="ecFileInput" style="display: none;" name="ecAttachments"  onchange="EmailSendingUtil.process(this)">').appendTo(e.closest("li")),e.removeAttr("onchange"),e.removeAttr("class"),e.attr("id",i),e.detach().appendTo("#ecDisplayAttachmentNames")},EmailSendingUtil.displayAttachmentName=function(e,i,t,a){var l,o=e;(l=a?$("#ecAttachmentTempDispPattern").clone():$("#ecAttachmentDispPattern").clone()).removeAttr("id"),l.attr("fileName",$ESAPI.encoder().encodeForHTML(e)),i&&null!=i&&null!=i?l.find("span").html($ESAPI.encoder().encodeForHTML(i)):l.find("span").html($ESAPI.encoder().encodeForHTML(o)),l.find("span").attr("id","ecAttachDetails"+EmailSendingUtil.fileCount),l.find("img").attr("data-zcqa","emc_removeAttachment_"+o),t&&null!=t&&""!=t&&(l.attr("fileSize",t),l.find("p").html(EmailSendingUtil.bytesToSize(t))),l.appendTo("#ecDisplayAttachmentNames"),l.show(),EmailSendingUtil.fileCount++},EmailSendingUtil.removeAttachment=function(e){var i=$(e).closest("div"),t=i.attr("name"),a=i.attr("fileId");$("#massMailId").length>0&&(a=i.attr("massMailFileId")),null!=a&&-1!=a&&""!=a&&EmailSendingUtil.removeFileFromZFS(a),i.remove(),$("#"+t).remove();var l=$("#ecDisplayAttachmentNames");l.css({height:"",overflow:""});var o=l.height();if(o<=60&&EmailSendingUtil.attachmentContainerHeight!=o){var n=o-EmailSendingUtil.attachmentContainerHeight;EmailSendingUtil.attachmentContainerHeight=o,EmailSendingUtil.resizeEditorHeight(n)}else o>60&&l.css({height:"60px",overflow:"auto"})},EmailSendingUtil.newshowHideoptions=function(e,i){$(e).addClass("hide");var t=$("#ceOption_"+i);if(Crm.userDetails.isNewEditor&&(t=$("#ceOption_"+i+"_"+EmailComposeUtil.CURRENT_TAB)),t.removeClass("hide"),t.find("input").val(""),t.find("input").focus(),Crm.userDetails.isNewEditor&&($("#ecAutoCompleteContainer, #etSchedulePopId").addClass("hide"),t.addClass("ceComposeMeta")),"replyto"===i){var a=$("#ceReplyToAddrSpan").parent().find("ul li:first").attr("lival"),l=$("#ceReplyToAddrSpan");l.attr("selectedval",a),l.html(a)}EmailSendingUtil.resizeEditorHeight()},EmailSendingUtil.HideEmptyfields=function(){$("#ceOption_cc").is(":visible")&&(0===$("#ceOption_cc").find("input").val().length&&1==$("#ceCCAddrDetails li").length&&($("#ceOption_cc").addClass("hide"),$("#ceCcLink").removeClass("hide")));$("#ceOption_bcc").is(":visible")&&(0===$("#ceOption_bcc").find("input").val().length&&1==$("#ceBCCAddrDetails li").length&&($("#ceOption_bcc").addClass("hide"),$("#ceBccLink").removeClass("hide")));EmailSendingUtil.resizeEditorHeight()},EmailSendingUtil.setTextareaHeight=function(){var e=$("#emailComposeContainer").outerHeight()-($(".ceContenteditOptions").outerHeight()+$("#ceRecipents").outerHeight()+$("#etUserDetails").outerHeight()+$("#emailDraftContainer").outerHeight()+170),i=$(".ceComposeinfo:visible");if($(".ceComposeinfo").is(":visible")){var t=i.length;if(e)e-=t*i.height(),$(".ze_area").contents().find("body").css("height",e)}},EmailSendingUtil.addTemplate=function(){if(Crm.userDetails.isNewEditor&&($("#emcInsertOption_"+EmailComposeUtil.CURRENT_TAB).hide(),$("#"+EmailComposeUtil.activeContentId+" .etInsertSurvey").hide()),EmailSendingUtil.isEntityWindow){var e=EmailSendingUtil.getModuleName();template.showTemplateList("sendMail","ecTemplateId","EmailSendingUtil.dumpTemplateBody()","",e,EmailSendingUtil.isConsentEmail)}else EmailSendingUtil.templatesFetched?EmailSendingUtil.postGetTemplatesForModule():EmailSendingUtil.getTemplatesForModule()},EmailSendingUtil.getModuleName=function(){var e=$("#moduleName").val(),i=Crm.userDetails.isNewEditor||EmailSendingUtil.composeActive&&!$("#oldtoNewDiv")[0],t=$("#customModuleName").val();return i&&(e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),(t=$("#customModuleName_"+EmailComposeUtil.CURRENT_TAB).val())&&(e=t)),e},EmailSendingUtil.searchModule=function(e){for(var i=$.trim($(e).val()).toLowerCase(),t=($("#ecModules_"+EmailSendingUtil.activeModule).find("div"),EmailSendingUtil.activeModule),a={},l=[],o=EmailSendingUtil.templateValues[t],n=0;n<o[0].length;n++){var s={},m=[];s.folder=o[0][n].folder;for(var r=0;r<o[0][n].folderValue.length;r++)if(o[0][n].folderValue[r].name.toLowerCase().indexOf(i)>-1){var d={};d.name=o[0][n].folderValue[r].name,d.Id=o[0][n].folderValue[r].Id,d.openPerc=o[0][n].folderValue[r].openPerc,d.openCount=o[0][n].folderValue[r].openCount,d.deliveredCount=o[0][n].folderValue[r].deliveredCount,d.tempIdEncrypt=o[0][n].folderValue[r].tempIdEncrypt,m.push(d)}s.folderValue=m,s.folderValue.length>0&&l.push(s)}a.module=t,a.size=o[1].size,a.data=l,$("#ecModules_"+t).html(EmailSendingUtil.addTemplateHandlebar(a)),EmailSendingUtil.bindTemplateScroll()},EmailSendingUtil.setActiveModule=function(e,i){EmailSendingUtil.activeModule=i,$(".ecModulesSet").addClass("hide");var t=$("#ecModules_"+EmailSendingUtil.activeModule);t.find("li").removeClass("hide"),t.removeClass("hide"),$("#ecTemplateSearchBox").val(""),$('div[id^="ecRecentTemplates_"]').hide();var a=$(e).position().left,l=$(e).width();$(e).closest(".etsTab").find(".animatedBorder").animate({left:a,width:l},300),EmailSendingUtil.populateEmailTemplates(i),$("#ecRecentTemplates_"+i).show(),thirdPartyUtils.unbindPerfectScroll(".ecvTemplateListOuter"),$(".ecvTemplateListInner").css({height:""}),$(".ecSearchModules").addClass("hide");var o=$(".ecvTemplateListInner").outerHeight();$(".ecSearchModules").removeClass("settingsBottomshadow"),o>280&&EmailSendingUtil.bindTemplateScroll()},EmailSendingUtil.bindTemplateScroll=function(){var e=$(".ecvTemplateListOuter"),i=$(".ecvTemplateListInner");thirdPartyUtils.unbindPerfectScroll(".ecvTemplateListOuter"),i.css({height:"0px"});var t=$(".ecvTemplateListOuter")[0].scrollHeight;i.css({height:t}),e.css({height:"300px",overflow:"hidden"}),thirdPartyUtils.bindPerfectScroll(".ecvTemplateListOuter",{wheelSpeed:1,wheelPropagation:!0,suppressScrollX:!1}),$(".ecSearchModules").removeClass("hide"),EmailSendingUtil.setTemplateShadow()},EmailSendingUtil.populateEmailTemplates=function(e){if(EmailSendingUtil.moduleVsTempList[e]&&null!=EmailSendingUtil.moduleVsTempList[e]&&""!=EmailSendingUtil.moduleVsTempList[e])$("#ecModules_"+e).html(EmailSendingUtil.moduleVsTempList[e]);else{var i="action=getTemplatesForModule&module="+e;$(EmailTabHomeUtil.Loading).show(),$(EmailTabHomeUtil.Loading).attr("data-zcqa","emc_etLoading"),$.ajax({type:EmailTabHomeUtil.GET_REQUEST_TYPE,url:EmailTabHomeUtil.URL,data:i,dataType:"json",success:function(i){var t;EmailSendingUtil.templateValues[i.module]=[i.data,{size:i.size}];var a=I18n.getMsg("crm.template.openrate.lastversion"),l=I18n.getMsg("crm.no.templates");EmailSendingUtil.addTemplateHandlebar||(EmailSendingUtil.addTemplateHandlebar=Handlebars.compile("{{#if data}}{{#each data}}<div class=\"cB\"><span class='fL pT5 pL30 f14 mT10 crm-font-xbold'>{{this.folder}}</span><ul class=\"m0 mT5 cB fL pL30\" onclick=\"EmailSendingUtil.getTemplateContentById(event,'{{../module}}')\">{{#each this.folderValue}}<li class='ecTemplatesList' templateId=\"{{this.Id}}\"><a href=\"javascript:;\" data-zcqa=\"emc_{{../../module}}Module_{{../this.folder}}_{{this.name}}\">{{this.name}}</a>{{#ifCondLogic this.deliveredCount '!=' '0' '&&' this.deliveredCount '!=' undefined}}<span  onclick='sE(event)'  onmouseenter='zctt.showtt(\""+a+'")\'   onmouseout=\'zctt.hidett()\' data-zcqa=\'eA_CW_openRate_{{this.Id}}\' class=\'mL10  crm-font-regular f12 col888 fL mT1 etOpenrate\'>{{this.openPerc}}  ({{this.openCount}}/{{this.deliveredCount}})</span> <a class=\'fL newTabIcon mT1 mL5\'  data-zcqa=\'eA_CW_newTabIcon_{{this.Id}}\' href=\'javascript:;\' onclick=\'crmTemplateStats.getTemplateStats(event, this, undefined, 1); sE(event);\' data-params=\'{"templateid" : "{{this.tempIdEncrypt}}", "source" : "description", "viewtype" : "viewEmailTemplate", "category" : "versionView"}\'></a>{{/ifCondLogic}}</li>{{/each}}</ul></div>{{/each}}{{else}}<span class="centerTemplateMsg">'+l+"</span>{{/if}}")),t=EmailSendingUtil.addTemplateHandlebar(i),$("#ecModules_"+e).html(t),EmailSendingUtil.moduleVsTempList[e]=t,$(EmailTabHomeUtil.Loading).hide(),$(EmailTabHomeUtil.Loading).removeAttr("data-zcqa"),thirdPartyUtils.unbindPerfectScroll(".ecvTemplateListOuter"),$(".ecvTemplateListInner").css({height:""}),$(".ecSearchModules").addClass("hide"),$(".ecvTemplateListInner").outerHeight()>280&&EmailSendingUtil.bindTemplateScroll();var o=$(".ecvTemplateListInner").outerWidth()-40;$(".ecTemplatesList").each((function(){if($(this).find(".etOpenrate").length){var e=$(this).find(".etOpenrate").outerWidth(),i=$(this).find(".newTabIcon").outerWidth();$(this).find(".ecTemplateName").css("max-width",o-(e+i+20))}else $(this).find(".ecTemplateName").css("max-width",o-(i+20))}))},error:EmailTabHomeUtil.handleAjaxAbort})}},EmailSendingUtil.getTemplatesForModule=function(){var e="action="+EmailTabHomeUtil.GET_ALL_TEMPLATES_FOR_MODULE+"&isEntityMail="+EmailSendingUtil.isEntityWindow;$(EmailTabHomeUtil.Loading).show(),$(EmailTabHomeUtil.Loading).attr("data-zcqa","emc_etLoading"),$.ajax({type:EmailTabHomeUtil.GET_REQUEST_TYPE,url:EmailTabHomeUtil.URL,data:e,success:function(e){$(EmailTabHomeUtil.Loading).hide(),$(EmailTabHomeUtil.Loading).removeAttr("data-zcqa"),EmailSendingUtil.templatesFetched=!0,$("#ecAddTemplate").html(e),EmailSendingUtil.postGetTemplatesForModule()},error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.postGetTemplatesForModule=function(){Crm.userDetails.isNewEditor&&EmailSendingUtil.composeActive?EmailComposeUtil.showCustomFreezeLayer():(freezeBackground(),$("#FreezeLayer").css({opacity:.5,"background-color":"#000"}));var e=$("#ecAddTemplate");e.animate({top:"0px"},"200","easeOutCubic");var i=null;$(".ecPermittedTemplateModuels").hide(),EmailSendingUtil.isEntityWindow?(i=$("#moduleName").val(),e.removeClass("hide").css("left",($("#ecAddTemplate").width()+200)/2),$("#ecPermittedModulesLi_"+i).show()):(e.removeClass("hide").css("left",(EmailTabHomeUtil.ViewPortWidth-$("#ecAddTemplate").width())/2),$("#ecPermittedModulesLi_Leads,#ecPermittedModulesLi_Contacts,#ecPermittedModulesLi_Potentials").show(),i=$("#popupUl").find("li:visible").first().attr("module")),$("#ecAddTemplate li:visible:last").css("margin-right","0"),EmailSendingUtil.isEntityWindow&&$("#chooseTemplateLi").length>0?EmailSendingUtil.setActiveModule($("#chooseTemplateLi"),i):""===EmailSendingUtil.activeModule&&(EmailSendingUtil.activeModule=i,renderingUtils.triggerEvent("click",$("#ecPermittedModulesLi_"+i).find("a")),$('div[id^="ecRecentTemplates_"]').hide(),$("#ecRecentTemplates_"+i).show())},EmailSendingUtil.closeTemplatesDiv=function(){$("#ecAddTemplate").animate({top:"-420px"},200,(function(){$("#ecAddTemplate").addClass("hide")})),removeFreezeLayer(),$("#freezeBackGround_gdocs").remove()},EmailSendingUtil.getTemplateContentById=function(e,i,t){var a=$("#moduleName").val();a&&a!==i&&$("#ceToAddr").val("");var l=$($("#ceToAddrDetails").children()[0]).attr("email"),o=$("#addrsVal").attr("selectedval"),n=$("#ecEntityId").val(),s=$("#editorMode").val();if(EmailSendingUtil.isNewEditor()&&(a=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),l=$($("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB).children().eq(0)).attr("email"),n=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val(),o=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).select2("data")[0].element.value,s=$("#editorMode_"+EmailComposeUtil.CURRENT_TAB).val()),!t){var m=$(e.target).closest("li");t=m.attr("templateId")}if(-1!==parseInt(t)){var r="action="+EmailTabHomeUtil.GET_TEMPLATE_DETAIL_BY_ID+"&templateId="+t+"&module="+a+"&toAddr="+encodeURIComponent(l)+"&fromAddr="+encodeURIComponent(o)+"&entId="+n+"&editorMode="+s;$(EmailTabHomeUtil.Loading).show(),$.ajax({type:EmailTabHomeUtil.GET_REQUEST_TYPE,url:EmailTabHomeUtil.URL,data:r,dataType:"json",success:function(e){$(EmailTabHomeUtil.Loading).hide(),$(EmailTabHomeUtil.Loading).removeAttr("data-zcqa"),EmailSendingUtil.templateIdVsDetail[t]=e,EmailSendingUtil.postGetTemplateContentById(e,i)},error:EmailTabHomeUtil.handleAjaxAbort})}},EmailSendingUtil.postGetTemplateContentById=function(e,i){if(null!=e.result){var t=$("#emc_msg_Tab");t.css("left",(EmailTabHomeUtil.ViewPortWidth-t.outerWidth())/2).show(),t.css({"z-index":"100"}),t.hide(),t.html(e.result),t.attr("data-zcqa","emc_SendTab_Error"),Crm.userDetails.isNewEditor&&EmailSendingUtil.composeActive&&"Sorry, there seems to be a problem in attaching the template. Please try after some time."==e.result&&crmui.showMsgBand("error",I18n.getMsg("crm.email.label.error.template.attach"),3e3),EmailSendingUtil.isEntityWindow?($("#emailEntityComposeOverlay").hide(),$("#emailEntityComposepopup").hide(),setTimeout((function(){t.show().css("left",($(document).outerWidth()-t.outerWidth())/2)}),100)):setTimeout((function(){t.show().css("left",(EmailTabHomeUtil.ViewPortWidth-t.outerWidth())/2)}),100),setTimeout((function(){t.hide(),t.removeAttr("data-zcqa"),t.html("Loading...")}),8e3)}else void 0!==e.id&&EmailSendingUtil.populateEditorWithTemplate(e,i)},EmailSendingUtil.populateEditorWithTemplate=function(e,i){Crm.userDetails.isNewEditor?EmailSendingUtil.populateNewEditorWithTemplate(e,i):EmailSendingUtil.populateOldEditorWithTemplate(e,i)},EmailSendingUtil.populateNewEditorWithTemplate=function(e,i){EmailComposeUtil.clearTemplate();var t=2===e.editorMode?"plainEditor":"richEditor",a=editor.zEditor;a.setEditorMode=t;var l=e.body;if("plainEditor"===t){a.showPlainEditor(!0),a.plainEditor.value=l}else{a.showRichEditor();try{var o=l;l.indexOf("<body>")>-1&&l.indexOf("</body>")>-1&&(o=l.substring(l.indexOf("<body>")+6,l.indexOf("</body>")));var n=document.createElement("div");n.innerHTML=o;var s=n.getElementsByTagName("pre");if(s&&s.length>0||o.includes("pre-wrap")){for(var m=n.getElementsByTagName("*"),r=0,d=m.length;r<d;r++)m[r].style&&"pre-wrap"===m[r].style.whiteSpace&&(m[r].innerHTML=m[r].innerHTML.replaceAll("\n","<br>"));Array.from(s).forEach((e=>{e.innerHTML=e.innerHTML.replace(/\n/g,"<br>")}));var c=n.outerHTML.substring(n.outerHTML.indexOf("<div>")+5,n.outerHTML.length-6),E=new RegExp(o),p=l.replace(E,c);if(-1===l.indexOf(c)||p.length-l.length>1e3){var u=l.replace(o,c);u.length-l.length>1e3||(l=u)}else l=p}}catch(e){l+=""}editor.setContent(l,!0);var g=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).val(),C=editor.zEditor.z_doc.getElementById("ecw_signature");if(g&&C){var U=EmailUtil.getSignaturebyEmail(g);U||(U=""),C.innerHTML=U,EmailUtil.tempSignature[EmailComposeUtil.CURRENT_TAB]=C.innerHTML,EmailUtil.tempFrom[EmailComposeUtil.CURRENT_TAB]=g}EmailComposeUtil.replyOrForWardMail[EmailComposeUtil.CURRENT_TAB]&&EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB]&&(editor.zEditor.editorDiv.innerHTML=editor.zEditor.editorDiv.innerHTML+EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB])}var h=$("#ceAddtemplate_"+EmailComposeUtil.CURRENT_TAB),v=$("#emcTemplateNameHolder_"+EmailComposeUtil.CURRENT_TAB);EmailSendingUtil.IsReplyOrForwardMail()||EmailComposeUtil.setSubject(e.subject),h.html($ESAPI.encoder().encodeForHTML(e.name)).attr("title",e.name),h.attr("templateid",e.id),Crm.userDetails.isNewEditor?(v.removeClass("hide"),$("#emcTemplateOptions_"+EmailComposeUtil.CURRENT_TAB).addClass("hide")):(v.addClass("emcTemplateNameHolder"),$("#ceCleartemplate").parent().removeClass("hide")),e.isMergFieldReplaced&&$("#cePreviewMergeFields_"+EmailComposeUtil.CURRENT_TAB).removeClass("hide"),!EmailSendingUtil.isEntityWindow||"PurchaseOrders"!==i&&"SalesOrders"!==i&&"Quotes"!==i&&"Invoices"!==i?$("#ecDisplayAttachmentNames_"+EmailComposeUtil.CURRENT_TAB).html(""):$("#"+EmailComposeUtil.activeContentId+" .ecMailAttachment").each((function(){$(this).hasClass("ecInventoryAttachment")||"ecAttachmentDispPattern"===$(this).attr("id")||$(this).remove()})),$("#emailTempModule_"+EmailComposeUtil.CURRENT_TAB).val(i);var f=$("#mailConfigType_"+EmailComposeUtil.CURRENT_TAB);EmailSendingUtil.isEntityWindow&&f.length>0&&"NORMAL"===f.val()&&(e.fromId&&"null"!==e.fromId&&EmailSendingUtil.setTemplateFromAddress(e.fromId),e.replyTo&&"null"!==e.replyTo&&EmailSendingUtil.setTemplateReplytoAddress(e.replyTo)),e.rawFileNames&&EmailComposeUtil.handleTemplateAttachments(e.rawFileNames,e.fileSizes,e.fileNames),EmailSendingUtil.closeTemplatesDiv(),EmailSendingUtil.composeActive=!1;EmailCompose.deleteDraft(!0),$("#emcTemplateId_"+EmailComposeUtil.CURRENT_TAB).val(e.id),EmailUtil.saveTempDraftDetails(),EmailSendingUtil.composeActive=!0},EmailSendingUtil.IsReplyOrForwardMail=function(){if(Crm.userDetails.isNewEditor){var e=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val();return!(!EmailComposeUtil.replyOrForWardMail[EmailComposeUtil.CURRENT_TAB]||!e||!e.startsWith("Re:")&&!e.startsWith("Fwd:"))}var i=$("#ceSubject1").val(),t=$("#msgid"),a=t?t.val():void 0,l=$("#sendMailType").val();return!("reply"!==l&&"forward"!==l&&"replyAll"!==l&&!a||!i||!i.startsWith("Re:")&&!i.startsWith("Fwd:"))},EmailSendingUtil.populateOldEditorWithTemplate=function(e,i){EmailSendingUtil.clearTemplate(),editorMode=e.editorMode,2===editorMode?(editor.setMode("plaintext"),EmailSendingUtil.showHideEditorTools("plaintext")):(editor.setMode("richtext"),EmailSendingUtil.showHideEditorTools("richtext"));var t=$("#previousMailContentWithOutSign").val();if(null!=t&&null!=t&&""!=t)editor.setContent(e.body+"<br>"+t);else if(EmailSendingUtil.templatecontentStyle=void 0,1===editorMode){var a=e.body;if(a.indexOf("<head>")>-1&&a.indexOf("</head>")>-1){var l=a.substring(a.indexOf("<head>"),a.indexOf("</head>")+7);a=a.replace(l,""),l=(l=l.replace("<head>","")).replace("</head>",""),EmailSendingUtil.templatecontentStyle=l}editor.setContent(a),EmailSendingUtil.templatecontentStyle&&(editor.doc.head.innerHTML='<style type="text/css">.ze_body{font-family:Verdana,arial,Helvetica,sans-serif;font-size:13px;} table{font-size:100%}</style>'+EmailSendingUtil.templatecontentStyle)}else editor.setContent(e.body);EmailSendingUtil.IsReplyOrForwardMail()||($("#ceSubject1").val(e.subject),$("#ceSubject").val(e.subject)),$("#ceAddtemplate").html($ESAPI.encoder().encodeForHTML(e.name)).attr("title",e.name),$("#emcTemplateNameHolder").addClass("emcTemplateNameHolder"),$("#ceAddtemplate").attr("templateid",e.id),$("#ceCleartemplate").parent().removeClass("hide"),e.isMergFieldReplaced&&$("#cePreviewMergeFields").removeClass("hide"),!EmailSendingUtil.isEntityWindow||"PurchaseOrders"!==i&&"SalesOrders"!==i&&"Quotes"!==i&&"Invoices"!==i?$("#ecDisplayAttachmentNames").html(""):$(".ecMailAttachment").each((function(){$(this).hasClass("ecInventoryAttachment")||"ecAttachmentDispPattern"===$(this).attr("id")||$(this).remove()})),$("#emailTempModule").val(i),EmailSendingUtil.isEntityWindow&&$("#mailConfigType").length>0&&"NORMAL"==$("#mailConfigType").val()&&(null!=e.fromId&&"null"!=e.fromId&&""!=e.fromId&&EmailSendingUtil.setTemplateFromAddress(e.fromId),null!=e.replyTo&&"null"!=e.replyTo&&""!=e.replyTo&&EmailSendingUtil.setTemplateReplytoAddress(e.replyTo)),null!=e.rawFileNames&&""!=e.rawFileNames&&EmailSendingUtil.handleTemplateAttachments(e.rawFileNames,e.fileSizes),$("#ecTemplateId").val(e.id),EmailSendingUtil.closeTemplatesDiv(),EmailActionHandling.deleteDraft(),$("#draftId").val("")},EmailSendingUtil.handleTemplateAttachments=function(e,i){var t=e.split(";"),a=i.split(";"),l=0,o=t.length;for(l=0;l<o&&""!=t[l];l++)EmailSendingUtil.displayAttachmentName(t[l],null,a[l],!0),EmailSendingUtil.resizeEditorHeight()},EmailSendingUtil.clearTemplate=function(){var e=$("#emcTemplateNameHolder");if(EmailSendingUtil.IsReplyOrForwardMail()||($("#ceSubject1").val(""),$("#ceSubject").val("")),$("#ceAddtemplate").html(I18n.getMsg("crm.email.add.template")),e.removeClass("emcTemplateNameHolder"),Crm.userDetails.isNewEditor?(e.addClass("hide"),$("#emcTemplateOptions").removeClass("hide"),EmailComposeUtil.updateTheEmailTabNameWithTheSubjectName(),EmailUtil.clearEditorAttachments(),$("#deleteDraft").hide()):$("#ceCleartemplate").parent().addClass("hide"),0==$("#moduleName").length||"Quotes"!==$("#moduleName").val()&&"Invoices"!==$("#moduleName").val()&&"PurchaseOrders"!==$("#moduleName").val()&&"SalesOrders"!==$("#moduleName").val())$("#ecDisplayAttachmentNames").html("");else for(var i=$(".ecMailAttachment"),t=0;t<$(i).length;t++){var a=$(i)[t];$(a).hasClass("pdfAttachment")||"ecAttachmentDispPattern"===$(a).attr("id")||"ecAttachmentTempDispPattern"===$(a).attr("id")||$(a).remove()}$("#ecForwardAttachments").html(""),$("#ecTemplateId").val(""),$("#emailTempModule").val("");var l=$("#previousMailContent").val();null!=l&&null!=l&&""!=l?editor.setContent(l):(Crm.userDetails.isNewEditor&&(EmailComposeUtil.editorContent="",editor.zEditor.plainEditor&&(editor.zEditor.plainEditor.value="")),editor.setContent("<br>"))},EmailSendingUtil.isKeyCodeAllowedForGetData=function(e){return e&&(e>=64&&e<=90||e>=97&&e<=122||e>=48&&e<=57||8==e||46==e||190==e)},EmailSendingUtil.isKeyCodeForA=function(e){return e&&65==e},EmailSendingUtil.isKeyCodeForCmdOrCtrl=function(e){return e&&(224==e||17==e||91==e||93==e)},EmailSendingUtil.isKeyCodeForLeftArrow=function(e){return e&&37==e},EmailSendingUtil.isKeyCodeForBksp=function(e){return e&&8==e},EmailSendingUtil.isKeyCodeForTab=function(e){return e&&9==e},EmailSendingUtil.isKeyCodeForUpArrow=function(e){return e&&38==e},EmailSendingUtil.isKeyCodeForRightArrow=function(e){return e&&39==e},EmailSendingUtil.isKeyCodeForDownArrow=function(e){return e&&40==e},EmailSendingUtil.isKeyCodeForEnter=function(e){return e&&13==e},EmailSendingUtil.isKeyCodeForComma=function(e){return e&&188==e},EmailSendingUtil.isKeyCodeForShift=function(e){return e&&16==e},EmailSendingUtil.getTheCurrentAutoCompleteText=function(e){return e?$.trim(e.slice(e.lastIndexOf(",")+1)):""},EmailSendingUtil.limitExceedAlert=function(e){var i=$(e).closest("ul.mailToAddrUL");i&&"ceToAddrDetails"===$(i).attr("id")?Crm.showAlertMsg(EmailSendingUtil.maxLimitExceedsMsg.to):i&&"ceBCCAddrDetails"===$(i).attr("id")?Crm.showAlertMsg(EmailSendingUtil.maxLimitExceedsMsg.bcc):i&&"ceCCAddrDetails"===$(i).attr("id")&&Crm.showAlertMsg(EmailSendingUtil.maxLimitExceedsMsg.cc)},EmailSendingUtil.limitExceedAlertFor50Mails=function(){EmailSendingUtil.isNewEditor()?EmailUtil.showMsg("error",EmailSendingUtil.maxLimitExceedsMsg.toCcBcc,5e3):Crm.showAlertMsg(EmailSendingUtil.maxLimitExceedsMsg.toCcBcc)},EmailSendingUtil.handlePasteEventForAutoComplete=function(e){var t=$("#ceRecipents").find("ul.mailToAddrUL").children("li:not(.ecAddrEditor)");if(t.removeClass("ecHighlightSelection"),t.length>49)return EmailSendingUtil.limitExceedAlertFor50Mails(),void setTimeout((function(){$(e).val("")}),100);var a=$(e).closest("li");setTimeout((function(){var t=$(e).val();if(t&&""!=t){var l=t.split(",");for(i=0;i<l.length-1;i++){if($("#ceRecipents").find("ul.mailToAddrUL").children("li:not(.ecAddrEditor)").length>49)return EmailSendingUtil.limitExceedAlertFor50Mails(),void $(e).val("");EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail($.trim(l[i])),EmailSendingUtil.formattedUsernameFromEmail($.trim(l[i])),null,a)}$(e).val(l[l.length-1])}setTimeout((function(){EmailSendingUtil.isCrtlKeyPressed=!1}),100)}),100)},EmailSendingUtil.handleBlurOnEmailTextBoxes=function(e){EmailSendingUtil.isClickOnAutoCompleteDiv||EmailSendingUtil.rectifyEmail(e)},EmailSendingUtil.handleKeyDownEventsForAutoComplete=function(e,i){var t=commonUtils.getCharacterCode(i);if(EmailSendingUtil.isKeyCodeForCmdOrCtrl(t))EmailSendingUtil.isCrtlKeyPressed=!0;else if(EmailSendingUtil.isKeyCodeForBksp(t)){var a=$(e).closest("ul").children("li:not(.ecAddrEditor)");if(""===$(e).val()&&a.length>=1)if(a.hasClass("ecHighlightSelection")){var l=a.filter(".ecHighlightSelection"),o=l.prev();l.remove(),EmailSendingUtil.isEntityWindow||EmailSendingUtil.checkEntityAndAlert(),o.length>0&&o.addClass("ecHighlightSelection")}else elem=a[a.length-1],a.removeClass("ecHighlightSelection"),$(elem).addClass("ecHighlightSelection")}else if(EmailSendingUtil.isKeyCodeForTab(t)){var n=$(e).closest("li"),s=$.trim($(e).val());s&&(s=s.replace(/,/g,""),EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail(s),EmailSendingUtil.formattedUsernameFromEmail(s),null,n),event.preventDefault(),$(e).focus(),$("#ecAutoCompleteContainer").addClass("hide").html(""))}else $L(".ecHighlightSelection").removeClass("ecHighlightSelection")},EmailSendingUtil.handleKeyUpEventsForAutoComplete=function(e,i,t){var a=$(e).closest("li"),l=$.trim($(e).val());if("etSearchBox"===$(e).attr("id")||$(e).hasClass("evCriteriaValue")||$(e).width(9*$(e).val().length),$(e).hasClass("evCriteriaValue")){var o=$(e).closest(".evFieldCriteriaVal").find("span.evCriteriaFieldVal").attr("foName");if(!o||"FROM"!==o&&"TO"!==o&&"CC"!==o&&"TO_CC"!==o)return}var n=commonUtils.getCharacterCode(i);if(EmailSendingUtil.isKeyCodeForCmdOrCtrl(n))setTimeout((function(){EmailSendingUtil.isCrtlKeyPressed=!1}),100);else{if(1==EmailSendingUtil.isCrtlKeyPressed){if(EmailSendingUtil.isKeyCodeForA(n)&&""==l)(u=$(e).closest("ul").children("li:not(.ecAddrEditor)")).addClass("ecHighlightSelection");return}if(EmailSendingUtil.isKeyCodeAllowedForGetData(n)&&EmailSendingUtil.autoCompleteResultsReceived&&l&&""!=l){var s;(s=Crm.userDetails.isNewEditor?$("#ceRecipents_"+EmailComposeUtil.CURRENT_TAB).find("ul.mailToAddrUL").children("li:not(.ecAddrEditor)"):$("#ceRecipents").find("ul.mailToAddrUL").children("li:not(.ecAddrEditor)")).removeClass("ecHighlightSelection");var m=s.filter(".selectedEmail"),r=EmailSendingUtil.getEmailsArrayFromSelectedElements(m),d=EmailSendingUtil.getUserNamesArrayFromSelectedElements(m);null!=t&&t||(s.length<50?EmailSendingUtil.getAutoCompleteEntities(e,l,r,d):($(e).closest("ul.mailToAddrUL").children(".ecAddrEditor input").val(""),EmailSendingUtil.limitExceedAlertFor50Mails(),$(e).val(""),$(e).focus()))}else if(EmailSendingUtil.isKeyCodeForDownArrow(n))EmailSendingUtil.moveToAdjLi(e,"next");else if(EmailSendingUtil.isKeyCodeForUpArrow(n))EmailSendingUtil.moveToAdjLi(e,"prev");else if(EmailSendingUtil.isKeyCodeForLeftArrow(n))$("#ecAutoCompleteContainer").is(":visible")?EmailSendingUtil.moveToAdjUl(e,"prev"):""==l&&EmailSendingUtil.selectAdjacentLi(e,"prev");else if(EmailSendingUtil.isKeyCodeForRightArrow(n))$("#ecAutoCompleteContainer").is(":visible")?EmailSendingUtil.moveToAdjUl(e,"next"):""==l&&EmailSendingUtil.selectAdjacentLi(e,"next");else if(EmailSendingUtil.isKeyCodeForEnter(n))if($(e).hasClass("evCriteriaValue")){var c=$("#ecAutoCompleteContainer").find("li.autoCompleteSelectedLi");c.length>0&&EmailSendingUtil.populateSearchValue(null,c)}else if($("#ecAutoCompleteContainer").is(":visible")){var E=$("#ecAutoCompleteContainer").find("li.autoCompleteSelectedLi"),p=E.parent().attr("module");EmailSendingUtil.populateOrClearEntityId(null,p,E)}else if(""!==l)a.hasClass("ecAddrEditor")?EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail(l),EmailSendingUtil.formattedUsernameFromEmail(l),null,a):EmailSendingUtil.rectifyEmail(e);else if(a.hasClass("ecAddrEditor")){var u;if((u=$(e).closest("ul").children("li:not(.ecAddrEditor)")).hasClass("ecHighlightSelection")&&1==u.filter(".ecHighlightSelection").length){var g=u.filter(".ecHighlightSelection");g.removeClass("ecHighlightSelection"),renderingUtils.triggerEvent("click",g.find(".selUserDetails"))}}else $(a).siblings(".ecAddrEditor").find("input").focus();else if(EmailSendingUtil.isKeyCodeForComma(n)&&l)""!==l?(l=l.replace(/,/g,""),a.hasClass("ecAddrEditor")?EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail(l),EmailSendingUtil.formattedUsernameFromEmail(l),null,a):($(e).val(l),EmailSendingUtil.rectifyEmail(e))):a.hasClass("ecAddrEditor")||$(a).siblings(".ecAddrEditor").find("input").focus();else if(!EmailSendingUtil.isKeyCodeForShift(n)){var C=$("#ecAutoCompleteContainer");C.addClass("hide"),C.html(""),0!=l.length||EmailSendingUtil.isEntityWindow||EmailSendingUtil.populateOrClearEntityId()}}},EmailSendingUtil.getUserNamesArrayFromSelectedElements=function(e){var i=[];return e&&e.length>0&&$.each(e,(function(e,t){i.push($(t).attr("username").toLowerCase())})),i},EmailSendingUtil.getEmailsArrayFromSelectedElements=function(e){var i=[];return e&&e.length>0&&$.each(e,(function(e,t){i.push($(t).attr("email").toLowerCase())})),i},EmailSendingUtil.selectAdjacentLi=function(e,i){var t,a=$(e).closest("ul").children("li:not(.ecAddrEditor)"),l=a.filter(".ecHighlightSelection");1==l.length?("prev"==i?t=l.prev():"next"==i&&(t=l.next("li:not(.ecAddrEditor)")),t.length>0?(l.removeClass("ecHighlightSelection"),t.addClass("ecHighlightSelection")):"next"==i&&l.removeClass("ecHighlightSelection")):l.length>1&&"next"==i?l.removeClass("ecHighlightSelection"):"prev"===i&&a.last().addClass("ecHighlightSelection")},EmailSendingUtil.moveToAdjLi=function(e,i){var t=$("#ecAutoCompleteContainer").find("li.autoCompleteSelectedLi");if(t.length<1)"prev"==i?$("#ecAutoCompleteContainer").find("li").last().addClass("autoCompleteSelectedLi"):$("#ecAutoCompleteContainer").find("li").first().addClass("autoCompleteSelectedLi");else{if(currentLiIndex=parseInt(t.attr("index")),"prev"==i)var a=currentLiIndex-1;else a=currentLiIndex+1;var l=t.siblings("li[index="+a+"]");l.length>0?(t.removeClass("autoCompleteSelectedLi"),l.addClass("autoCompleteSelectedLi")):"prev"==i?EmailSendingUtil.moveToAdjUl(e,i,!0):EmailSendingUtil.moveToAdjUl(e,i)}},EmailSendingUtil.moveToAdjUl=function(e,i,t){var a=$("#ecAutoCompleteContainer").find("li.autoCompleteSelectedLi");if(a.length<1)"prev"==i?$("#ecAutoCompleteContainer").find("li").last().addClass("autoCompleteSelectedLi"):$("#ecAutoCompleteContainer").find("li").first().addClass("autoCompleteSelectedLi");else{var l=a.parent(),o=parseInt(l.attr("index")),n=o,s=l;if("prev"==i&&l.find("li").eq(0).attr("index")==a.attr("index")?(n=o-1,s=l.siblings("ul[index="+n+"]")):"next"==i&&(n=o+1,s=l.siblings("ul[index="+n+"]")),s.length>0){a.removeClass("autoCompleteSelectedLi");var m=0;t&&(m=s.find("li").length-1),s.find("li").eq(m).addClass("autoCompleteSelectedLi")}else"true"!==$(e).attr("initialLiSelection")&&$("#ecAutoCompleteContainer").find("li").removeClass("autoCompleteSelectedLi")}},EmailSendingUtil.getAutoCompleteEntities=function(e,i,t,a){EmailSendingUtil.autoCompleteResultsReceived=!1;var l=i;if(EmailSendingUtil.AutoCompleteData.searchValue&&l.startsWith(Object.keys(EmailSendingUtil.AutoCompleteData.searchValue)[0])){var o=EmailSendingUtil.AutoCompleteData.searchValue,n=EmailSendingUtil.getFilteredValuesForAutoComplete(t,a,i,o[Object.keys(o)],5);EmailSendingUtil.isObjEmpty(n)&&!EmailSendingUtil.isNoMatchFoundAlready(i)?EmailSendingUtil.ReSearchForAutoComplete(t,a,o[Object.keys(o)],i,5,e):EmailSendingUtil.postGetAutoCompleteEntities(n,e,i)}else{var s=EmailSendingUtil.getFilteredValuesForAutoComplete(t,a,i,EmailSendingUtil.preLoadedAutoCompleteData,5);EmailSendingUtil.postGetAutoCompleteEntities(s,e,i),$(EmailTabHomeUtil.Loading).hide(),$(EmailTabHomeUtil.Loading).removeAttr("data-zcqa");var m="",r=$("#emailTempModule").val();if(r&&"Potentials"==r)m=EmailTabHomeUtil.ACTION+"="+EmailSendingUtil.GET_ENTITIES_FOR_AUTO_COMPLETE+"&module=Potentials&searchFor="+encodeURIComponent(l);else{if(EmailSendingUtil.isEntityWindow){var d=$("#moduleName").val();d||void 0===EmailComposeUtil||(d=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val());c="&module="+d;EmailSendingUtil.isAutoCompleteSupportedModule(d)||(c+="&isPreLoad=true")}else var c="&module="+EmailSendingUtil.AutoCompleteModulesArray.toString();m=EmailTabHomeUtil.ACTION+"="+EmailSendingUtil.GET_ENTITIES_FOR_AUTO_COMPLETE+c+"&searchFor="+encodeURIComponent(l)}if(!EmailSendingUtil.autoCompleteAjaxReceived)return;EmailSendingUtil.autoCompleteAjaxReceived=!1,$.ajax({type:EmailTabHomeUtil.GET_REQUEST_TYPE,url:EmailSendingUtil.URL,data:m,dataType:"json",success:function(o){var n={};if($.each(EmailSendingUtil.AutoCompleteModulesArray,(function(e,i){o[i]?n[i]=o[i].length:n[i]=0})),EmailSendingUtil.statusArray[l]=n,o.Colleagues){o.Colleagues.length;EmailSendingUtil.removeDuplicateColleagues(o),searchCharDatum=EmailSendingUtil.getFilteredValuesForAutoComplete([],[],l,EmailSendingUtil.preLoadedAutoCompleteData),searchCharDatum.Colleagues&&(o.Colleagues=searchCharDatum.Colleagues.concat(o.Colleagues))}else searchCharDatum=EmailSendingUtil.getFilteredValuesForAutoComplete([],a,l,EmailSendingUtil.preLoadedAutoCompleteData),searchCharDatum.Colleagues&&(o.Colleagues=searchCharDatum.Colleagues);(o.custommodule&&""!==o.custommodule&&!EmailSendingUtil.AutoCompleteModulesArray.contains(o.custommodule)&&(EmailSendingUtil.AutoCompleteModulesArray.push(o.custommodule),EmailSendingUtil.CUSTOMODULE=o.custommodule),o[Object.keys(o)[1]])&&(o[Object.keys(o)[1]].length<1001&&(EmailSendingUtil.AutoCompleteData.searchValue={},EmailSendingUtil.AutoCompleteData.searchValue[l]=o));(i=l).length>0&&(o=EmailSendingUtil.getFilteredValuesForAutoComplete(t,a,i,o,5),EmailSendingUtil.postGetAutoCompleteEntities(o,e,i)),EmailSendingUtil.autoCompleteAjaxReceived=!0,EmailSendingUtil.autoCompleteResultsReceived=!0,$(EmailTabHomeUtil.Loading).hide(),$(EmailTabHomeUtil.Loading).removeAttr("data-zcqa")},error:EmailTabHomeUtil.handleAjaxAbort})}},EmailSendingUtil.isObjEmpty=function(e){for(var i in e)if(e.hasOwnProperty(i))return!1;return!0},EmailSendingUtil.ReSearchForAutoComplete=function(e,i,t,a,l,o){var n="",s=$("#emailTempModule").val();if(s&&"Potentials"==s)n=EmailTabHomeUtil.ACTION+"="+EmailSendingUtil.GET_ENTITIES_FOR_AUTO_COMPLETE+"&module=Potentials&searchFor="+encodeURIComponent(a);else{if(EmailSendingUtil.isEntityWindow){var m=$("#moduleName").val();m||void 0===EmailComposeUtil||(m=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val());r="&module="+m;EmailSendingUtil.isAutoCompleteSupportedModule(m)||(r+="&isPreLoad=true")}else var r="&module="+EmailSendingUtil.AutoCompleteModulesArray.toString();n=EmailTabHomeUtil.ACTION+"="+EmailSendingUtil.GET_ENTITIES_FOR_AUTO_COMPLETE+r+"&searchFor="+encodeURIComponent(a)}if(EmailSendingUtil.autoCompleteAjaxReceived)return EmailSendingUtil.autoCompleteAjaxReceived=!1,$.ajax({type:EmailTabHomeUtil.GET_REQUEST_TYPE,url:EmailSendingUtil.URL,data:n,dataType:"json",success:function(n){var s,m;EmailSendingUtil.checkIfResponseObjIsEmpty(n)&&EmailSendingUtil.searchNotFoundStrings.push(a),$.each(n,(function(e,i){if("custommodule"!==e){var a=i.length;for(s=0;s<a;s++){var l=i[s];EmailSendingUtil.checkIfRecordExists(t[e],l)||t[e].push(l)}}})),m=EmailSendingUtil.getFilteredValuesForAutoComplete(e,i,a,t,l),EmailSendingUtil.postGetAutoCompleteEntities(m,o,a),EmailSendingUtil.AutoCompleteData.searchValue[Object.keys(EmailSendingUtil.AutoCompleteData.searchValue)]=t,EmailSendingUtil.autoCompleteAjaxReceived=!0},error:function(){EmailSendingUtil.postGetAutoCompleteEntities({},o,a)}}),t},EmailSendingUtil.checkIfRecordExists=function(e,i){if(!e||!i)return!1;for(var t=e.length,a=0;a<t;a++){var l=e[a].FULLNAME,o=i.FULLNAME,n=e[a].EMAIL,s=i.EMAIL;if(l===o&&n===s)return!0}return!1},EmailSendingUtil.isNoMatchFoundAlready=function(e){var i,t,a=EmailSendingUtil.searchNotFoundStrings.length;for(i=0;i<a;i++)if(t=EmailSendingUtil.searchNotFoundStrings[i],e.startsWith(t))return!0;return!1},EmailSendingUtil.checkIfResponseObjIsEmpty=function(e){var i,t=Object.keys(e),a=t.length;for(i=0;i<a;i++)if(e[t[i]].length>0)return!1,!1;return!0},EmailSendingUtil.removeDuplicateColleagues=function(e){EmailSendingUtil.preLoadedAutoCompleteData.Colleagues&&(e.Colleagues=e.Colleagues.filter(EmailSendingUtil.removingExistingContacts))},EmailSendingUtil.removingExistingContacts=function(e){if(EmailSendingUtil.preLoadedAutoCompleteData.Colleagues.filterWithLimit(EmailSendingUtil.isSameContact(e),1).length<1)return!0},EmailSendingUtil.isSameContact=function(e){return function(i){if(i.CONTACT_PRIMARY_EMAIL===e.CONTACT_PRIMARY_EMAIL)return!0}},EmailSendingUtil.getFilteredValuesForAutoComplete=function(e,i,t,a,l){var o,n={};return $.each(EmailSendingUtil.AutoCompleteModulesArray,(function(s,m){"Users"===m&&EmailSendingUtil.userDetails[m]?o=EmailSendingUtil.userDetails[m].filterWithLimit(EmailSendingUtil.filterValuesForAutoComplete(e,i,t.toLowerCase(),m),l):a[m]&&(o=a[m].filterWithLimit(EmailSendingUtil.filterValuesForAutoComplete(e,i,t.toLowerCase(),m),l)),o&&0!=o.length&&(n[m]=o,o=null)})),n},EmailSendingUtil.filterValuesForAutoComplete=function(e,i,t,a){return function(l){var o=l.FULLNAME?l.FULLNAME:l.FIRSTNAME?l.FIRSTNAME+(l.LASTNAME?" "+l.LASTNAME:""):l.LASTNAME?l.LASTNAME:l.NAME?l.NAME:"";return!(a!==EmailSendingUtil.POTENTIALS||!l.POTENTIALNAME.toLowerCase().startsWith(t)&&!l.EMAIL.toLowerCase().startsWith(t)||-1!=e.indexOf(l.EMAIL.toLowerCase()))||(!(a!==EmailSendingUtil.COLLEAGUES||!l.CONTACT_PRIMARY_EMAIL||!(l.CONTACT_FIRSTNAME&&l.CONTACT_FIRSTNAME.toLowerCase().startsWith(t)||l.CONTACT_LASTNAME&&l.CONTACT_LASTNAME.toLowerCase().startsWith(t)||l.CONTACT_FIRSTNAME&&l.CONTACT_LASTNAME&&(l.CONTACT_FIRSTNAME+" "+l.CONTACT_LASTNAME).toLowerCase().startsWith(t)||l.CONTACT_PRIMARY_EMAIL.toLowerCase().startsWith(t))||-1!=e.indexOf(l.CONTACT_PRIMARY_EMAIL.toLowerCase()))||(!(a!==EmailSendingUtil.LEADS&&a!==EmailSendingUtil.CONTACTS||!(l.FULLNAME.toLowerCase().startsWith(t)||l.FIRSTNAME&&l.FIRSTNAME.toLowerCase().startsWith(t)||l.LASTNAME&&l.LASTNAME.toLowerCase().startsWith(t)||l.EMAIL.toLowerCase().startsWith(t)||l.ADDN_EMAIL&&l.ADDN_EMAIL.toLowerCase().startsWith(t))||!l.EMAILOPTOUT||"false"!==l.EMAILOPTOUT||-1!=e.indexOf(l.EMAIL.toLowerCase())&&-1!=i.indexOf(o.toLowerCase()))||(!(a!==EmailSendingUtil.CUSTOMODULE||!(l.NAME.toLowerCase().startsWith(t)||l.EMAIL.toLowerCase().startsWith(t)||l.ADDN_EMAIL&&l.ADDN_EMAIL.toLowerCase().startsWith(t))||!l.EMAILOPTOUT||"false"!==l.EMAILOPTOUT||-1!=e.indexOf(l.EMAIL.toLowerCase())&&-1!=i.indexOf(o.toLowerCase()))||!("Users"!==a||!(l.FULLNAME.toLowerCase().startsWith(t)||l.FIRSTNAME&&l.FISRTNAME.toLowerCase().startsWith(t)||l.LASTNAME&&l.LASTNAME.toLowerCase().startsWith(t)||l.EMAIL.toLowerCase().startsWith(t))||-1!=e.indexOf(l.EMAIL.toLowerCase())&&-1!=i.indexOf(o.toLowerCase().trim())))))}},EmailSendingUtil.postGetAutoCompleteEntities=function(e,i,t){var a=$.trim($(i).val());if($.isEmptyObject(e))a&&a.split(",").length<2&&EmailSendingUtil.populateOrClearEntityId();else{var l='<div id="ecAutoCompleteContainerOuter"><div id="ecAutoCompleteContainerInner">',o=0,n="true"===$(i).attr("initialLiSelection"),s=0;$(i).hasClass("evCriteriaValue")&&(s=1),$.each(EmailSendingUtil.AutoCompleteModulesArray,(function(i,a){var m=e[a];if(null!=m&&m.length>0){var r;if(a===EmailSendingUtil.COLLEAGUES)l+='<h3 class="crm-font-regular f16 mB5 mL10 cB fL mT10" style="color:#5c5c5c;">Address Book/Colleagues</h3>',l+=1==s?'<ul data-zcqa="emc_AutoComplete'+a+'" module='+a+" index="+o+' onclick="EmailSendingUtil.populateSearchValue(event)">':'<ul data-zcqa="emc_AutoComplete'+a+'" module='+a+" index="+o+" onclick=\"EmailSendingUtil.populateOrClearEntityId(event, '"+a+"')\">",$.each(m,(function(e,i){l+=EmailSendingUtil.constructLiForColleaguesResult(i,t,a,e,n)}));else r=a===EmailSendingUtil.USERS?a:Crm.moduleInfo[a]?Crm.moduleInfo[a].translatedPluralLabel:a,l+='<h3 class="crm-font-regular f16 mB5 mL10 cB fL mT10" style="color:#5c5c5c;">'+r+"</h3>",l+=1==s?'<ul class="cBafter" data-zcqa="emc_AutoComplete'+a+'" module='+a+" index="+o+' onclick="EmailSendingUtil.populateSearchValue(event)">':'<ul class="cBafter" data-zcqa="emc_AutoComplete'+a+'"  module='+a+" index="+o+" onclick=\"EmailSendingUtil.populateOrClearEntityId(event, '"+a+"')\">",EmailSendingUtil.acResultIndex=0,$.each(m,(function(e,i){l+=EmailSendingUtil.constructLiForACResult(i,t,a,e,n)}));l+="</ul>",o++,n=!1}})),l+="</div></div>";var m=$("#ecAutoCompleteContainer");m.html(l),m.removeClass("hide"),$("#ecAutoCompleteContainerOuter").addClass("pR");var r=$(i).offset(),d=($(i).width(),21);"ceToAddr"==$(i).attr("id")&&(d=22),m.css({left:r.left,top:r.top+1+d}),0==s&&EmailSendingUtil.isEntityWindow&&$("#ecAutoCompleteContainer").offset().left+$("#ecAutoCompleteContainer").outerWidth()+30>$(window).outerWidth()&&(m.removeAttr("style"),m.css({right:30,top:r.top-1+d})),1==s?m.attr("inputId",$(i).attr("id")):m.attr("inputId",$(i).closest("ul").find('li.ecAddrEditor input[type="text"]').attr("id")),EmailSendingUtil.bindAutoCompleteScroll()}EmailSendingUtil.autoCompleteResultsReceived=!0},EmailSendingUtil.populateOrClearEntityId=function(e,i,t){if(void 0!==i){if(!t)t=$(e.target).closest("li");var a=t.closest("#ecAutoCompleteContainer").attr("inputId"),l=$("#"+a),o=l.closest("li"),n=l.val();n=-1!==n.lastIndexOf(",")?n.substring(0,n.lastIndexOf(",")+1)+t.attr("email"):t.attr("email");var s=l.closest("ul").find("li:not(.ecAddrEditor)").find('input[type="text"]:not(.hide)');1===s.length?(s.val(n),EmailSendingUtil.rectifyEmail(s)):EmailSendingUtil.setUnameAndEmail(n,t.attr("username"),t.attr("photoUrl"),o,t.attr("entityId"),i,t.attr("phid")),EmailSendingUtil.selectedEntityEmail=t.attr("email")}else EmailSendingUtil.isEntityWindow||(EmailSendingUtil.isNewEditor()?($("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val(""),$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val("")):($("#ecEntityId").val(""),$("#moduleName").val("")));$("#ecAutoCompleteContainer").addClass("hide")},EmailSendingUtil.setUnameAndEmail=function(e,i,t,a,l,o,n){e=$.trim(e);var s=a.closest("ul.mailToAddrUL"),m="";n=n||"",validationUtils.isValidEmail(e)?m+="<li class='fL selectedEmail'":($("#ecAutoCompleteContainer").addClass("hide").html(""),m+="<li class='fL invalidEmail'"),m+=" phid='"+n+"'",l&&(m+=" entityid='"+$ESAPI.encoder().encodeForHTMLAttribute(l)+"' "),o&&(m+=" module='"+$ESAPI.encoder().encodeForHTMLAttribute(o)+"' ");var r=$ESAPI.encoder().encodeForHTMLAttribute(e);m+='data-zcqa="emc_selected_'+$ESAPI.encoder().encodeForHTMLAttribute(e)+'"',i&&""!=i?(m+="username='"+$ESAPI.encoder().encodeForHTMLAttribute(i)+"' email='"+r+"' title='"+r+"' > <div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>",m+=t&&null!=t?"<span class='ecUserImage'><img src='"+t+"'  alt=''/></span>":"<span class='ecUserImage'><img src='"+(t=networkUtils.getImageUrl("nophoto_80ea3af_.png",ResourceConstants.CRM))+"'  alt=''/></span>",m+="<span class='fL ecSelectedUserName'>"+$ESAPI.encoder().encodeForHTML(i)):(m+="username='"+(i=e.substring(0,e.indexOf("@")))+"' email='"+r+"' title='"+r+"'> <div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>",m+=t&&null!=t?"<span class='ecUserImage'><img src='"+$ESAPI.encoder().encodeForHTMLAttribute(t)+"'  alt=''/></span>":"<span class='ecUserImage'><img src='"+(t=networkUtils.getImageUrl("nophoto_80ea3af_.png",ResourceConstants.CRM))+"'  alt=''/></span>",m+="<span class='fL ecSelectedUserName'>"+$ESAPI.encoder().encodeForHTML(i)),m+="</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_"+$ESAPI.encoder().encodeForHTMLAttribute(e)+"' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>",a.filter(".ecAddrEditor").length>0?$(m).insertBefore($(s).find(".ecAddrEditor")):$(a).replaceWith(m),$(s).find('li.ecAddrEditor input[type="text"]').val("").focus(),EmailSendingUtil.isEntityWindow||EmailSendingUtil.checkEntityAndAlert(),$("#ecAutoCompleteContainer").addClass("hide")},EmailSendingUtil.removeEmail=function(e){$(e).parent("li").remove(),EmailSendingUtil.checkEntityAndAlert(),EmailSendingUtil.isNewEditor()?(EmailComposeUtil.setEmailAddresses(),EmailComposeUtil.closeZiaEmotionBand()):EmailSendingUtil.setEmailAddresses()},EmailSendingUtil.constructLiForColleaguesResult=function(e,i,t,a,l){var o="";l&&0==a&&(o=" class=autoCompleteSelectedLi");var n,s="",m="",r="",d="",c="",E="",p="",u="",g=networkUtils.getImageUrl("nophoto_80ea3af_.png",ResourceConstants.CRM);return e.CONTACT_FIRSTNAME&&(s=$.trim(e.CONTACT_FIRSTNAME)).length>0&&(r=s,s=EmailSendingUtil.highlightSearchFor(s,i)),e.CONTACT_LASTNAME&&(m=$.trim(e.CONTACT_LASTNAME)).length>0&&(d=m,m=EmailSendingUtil.highlightSearchFor(m,i)),n=p=r+" "+d,e.CONTACT_FIRSTNAME&&e.CONTACT_LASTNAME&&(s=$.trim(e.CONTACT_FIRSTNAME)).length>0&&(m=$.trim(e.CONTACT_LASTNAME)).length>0&&(p=EmailSendingUtil.highlightSearchFor(s+" "+m,i)),e.CONTACT_PRIMARY_EMAIL&&(c=$.trim(e.CONTACT_PRIMARY_EMAIL)).length>0&&(E=c,c=EmailSendingUtil.highlightSearchFor(c,i),u=$.trim(e.CONTACT_ZUID)),str="<li index="+a+" entityid='' phid='"+(u&&null!=u&&""!=u?u:"")+"' email='"+E+"' username='"+n+"'",null!=u&&""!=u&&(g="https://"+RebrandLinkUtil.getProperty("CONTACTS_URL")+"/file?ID="+u+"&fs=thumb",str+="' photoUrl='"+g),str+="' "+o+"><div class='fL'> <span class='fL mR10' style='width:35px; height:35px'><img style='width:100%;' src='"+g+"' alt=''/></span><div class='fL' style='padding:1px 0px'><span class='fL'>"+p+" </span><span class='cB fL'>"+c+"</span></div> </div>",str+="</li>",str},EmailSendingUtil.constructLiForACResult=function(e,i,t,a,l){var o="",n="",s=!1,m=!1,r=!1,d=0;1==l&&0==a&&(n=' class="autoCompleteSelectedLi"',l=!1),o=t&&"Potentials"==t?$.trim(e.POTENTIALNAME):t&&t==EmailSendingUtil.CUSTOMODULE?$.trim(e.NAME):$.trim(e.FULLNAME);var c=$.trim(e.EMAIL),E="";o.length>0&&(s=o.toLowerCase().indexOf(i.toLowerCase())>-1),c.length>0&&(m=c.toLowerCase().indexOf(i.toLowerCase())>-1),null!=e.ADDN_EMAIL&&(r=(E=$.trim(e.ADDN_EMAIL)).toLowerCase().indexOf(i.toLowerCase())>-1),s?d=3:m?d=2:r&&(d=1);var p=null!=e.PHOTO_FILEID?e.PHOTO_FILEID:"";return EmailSendingUtil.constructAndGetMatchedLi(a,e.SEID,p,c,o,E,d,n,i,t)},EmailSendingUtil.constructAndGetMatchedLi=function(e,i,t,a,l,o,n,s,m,r){var d="";if(3===n){var c=l;l=EmailSendingUtil.highlightSearchFor(l,m),d="<li index="+(e+EmailSendingUtil.acResultIndex)+" entityId='"+i;var E="//img.zohocdn.com/crm/images/nophoto_80ea3af_.png";t&&(d+="' photoUrl='"+(E=Crm.getCrmBasePath()+"/EntityImageAttach.do?action_module="+r+"&entityId="+i+"&actionName=readImage&fileId="+t)),r===EmailSendingUtil.USERS&&i&&(d+="' photoUrl='"+(E="https://"+RebrandLinkUtil.getProperty("CONTACTS_URL")+"/file?ID="+i+"&fs=thumb")),d+="' phid='"+t+"' email='"+$ESAPI.encoder().encodeForHTMLAttribute(a)+"' username='"+$ESAPI.encoder().encodeForHTMLAttribute(c)+"' "+s+"><div class='fL'> <span class='fL mR15' style='width:35px; height:35px'><img style='width:100%;' src='"+E+"' alt=''/></span><div class='fL' style='padding:1px 0px'><span class='fL'>"+l+" </span>",d+="<span class='cB fL f13'>"+$ESAPI.encoder().encodeForHTMLAttribute(a)+"</span></div> </div></li>",o&&(EmailSendingUtil.acResultIndex++,d+="<li index="+(e+EmailSendingUtil.acResultIndex)+" entityId='"+i,""!==E&&(d+="' photoUrl='"+E),d+="' phid='"+t+"' email='"+$ESAPI.encoder().encodeForHTMLAttribute(o)+"' username='"+$ESAPI.encoder().encodeForHTMLAttribute(c)+"'><div class='pR' style='left:-20px; top:2px;'><i class='eacStraightLine'></i><i class='eacCrossLine'></i></div> <div class='fL'> <span class='fL mR10 hide' style='width:35px; height:35px'><img style='width:100%;' src='"+E+"' alt=''/></span><div class='fL' style='padding:1px 0px'><span class='fL hide'>"+l+" </span>",d+="<span class='cB fL f14 pL50'>"+I18n.getMsg("crm.email.autocomplete.label.secondaryemail")+"</span></div> <div class='' style='padding:1px 0px'><span class='f13 pL50'>"+$ESAPI.encoder().encodeForHTMLAttribute(o)+"</span></div></li>")}else if(2===n){var p=a;a=EmailSendingUtil.highlightSearchFor(a,m),d="<li index="+e+" entityId='"+i;E="//img.zohocdn.com/crm/images/nophoto_80ea3af_.png";t&&(d+="' photoUrl='"+(E=Crm.getCrmBasePath()+"/EntityImageAttach.do?action_module="+r+"&entityId="+i+"&actionName=readImage&fileId="+t)),r===EmailSendingUtil.USERS&&i&&(d+="' photoUrl='"+(E="https://"+RebrandLinkUtil.getProperty("CONTACTS_URL")+"/file?ID="+i+"&fs=thumb")),d+="' phid='"+t+"' email='"+$ESAPI.encoder().encodeForHTMLAttribute(p)+"' username='"+$ESAPI.encoder().encodeForHTMLAttribute(l)+"' "+s+"><div class='fL'> <span class='fL mR10' style='width:35px; height:35px'><img style='width:100%;' src='"+E+"' alt=''/></span><div class='fL' style='padding:1px 0px'><span class='fL'>"+$ESAPI.encoder().encodeForHTML(l)+" </span>",d+="<span class='cB fL'>"+a+"</span></div> </div></li>"}else if(1===n){var u=o;o=EmailSendingUtil.highlightSearchFor(o,m),d="<li  index="+e+" entityId='"+i;E="//img.zohocdn.com/crm/images/nophoto_80ea3af_.png";t&&(d+="' photoUrl='"+(E=Crm.getCrmBasePath()+"/EntityImageAttach.do?action_module="+r+"&entityId="+i+"&actionName=readImage&fileId="+t)),r===EmailSendingUtil.USERS&&i&&(d+="' photoUrl='"+(E="https://"+RebrandLinkUtil.getProperty("CONTACTS_URL")+"/file?ID="+i+"&fs=thumb")),d+="' phid='"+t+"' email='"+$ESAPI.encoder().encodeForHTMLAttribute(u)+"' username='"+$ESAPI.encoder().encodeForHTMLAttribute(l)+"' "+s+"><div class='fL'> <span class='fL mR10' style='width:35px; height:35px'><img style='width:100%;' src='"+E+"' alt=''/></span><div class='fL' style='padding:1px 0px'><span class='fL'>"+$ESAPI.encoder().encodeForHTML(l)+" </span>",d+="<span class='cB fL'>"+o+"</span></div> </div></li>"}return d},EmailSendingUtil.highlightSearchFor=function(e,i){var t=e.toLowerCase().indexOf(i.toLowerCase());if(t>-1){var a=$ESAPI.encoder().encodeForHTML(e.substring(0,t)),l=$ESAPI.encoder().encodeForHTML(e.substring(t,t+i.length)),o=$ESAPI.encoder().encodeForHTML(e.substring(t+i.length));e=a+"<strong>"+l+"</strong>"+o}else e=$ESAPI.encoder().encodeForHTML(e);return e},EmailSendingUtil.populateWindowElementsHeight=function(){EmailSendingUtil.metaDetailHeight=0,EmailSendingUtil.summaryHeight=0,$(".ceComposeinfo").each((function(){$(this).is(":visible")&&(EmailSendingUtil.metaDetailHeight=EmailSendingUtil.metaDetailHeight+$(this).outerHeight())})),($(".ceSenderInfo").is(":visible")||$(".ceReceiverInfo").is(":visible"))&&(EmailSendingUtil.summaryHeight=EmailSendingUtil.summaryHeight+$("#ceRecipents").outerHeight()),EmailSendingUtil.editorHeight=EmailSendingUtil.defaultEditorHeight,EmailSendingUtil.totalHeight=EmailSendingUtil.metaDetailHeight+EmailSendingUtil.summaryHeight+EmailSendingUtil.editorHeight+$("#ecDisplayAttachmentNames").outerHeight()},EmailSendingUtil.setWindowElementsHeight=function(){var e=$("#emc_bestTime").length>0?$("#emc_bestTime").outerHeight()+10:0;if(EmailSendingUtil.totalHeight>0){EmailSendingUtil.metaDetailHeight=0,EmailSendingUtil.summaryHeight=0,$(".ceComposeinfo").each((function(){$(this).is(":visible")&&(EmailSendingUtil.metaDetailHeight=EmailSendingUtil.metaDetailHeight+$(this).outerHeight())})),($(".ceSenderInfo").is(":visible")||$(".ceReceiverInfo").is(":visible"))&&(EmailSendingUtil.summaryHeight=EmailSendingUtil.summaryHeight+$("#ceRecipents").outerHeight()),EmailSendingUtil.editorHeight=EmailSendingUtil.totalHeight-(EmailSendingUtil.metaDetailHeight+EmailSendingUtil.summaryHeight+$("#ecDisplayAttachmentNames").outerHeight()+e+20);var i=$(".ze_area");i.css("height",EmailSendingUtil.editorHeight),i.contents().find("body").css("height",EmailSendingUtil.editorHeight-20),$("#emailEditor").css("height",EmailSendingUtil.editorHeight)}},EmailSendingUtil.processAttachment=function(){for(var e=EmailSendingUtil.calculateFileSize(),i=document.getElementById("ecFileInput"),t=0;t<i.files.length;t++)e+=i.files[t].size;if(e<10485760)if(EmailSendingUtil.isEntityWindow)EmailSendingUtil.fillUploadData($(a).val());else{var a=$("#draftId");$(a).length>0&&""!==$(a).val()&&"null"!==$(a).val()?EmailSendingUtil.fillUploadData($(a).val()):EmailActionHandling.formDraft(!0)}else Crm.showAlertMsg(I18n.getMsg("crm.mail.attach.restriction.individual.error1"))},EmailSendingUtil.fillUploadData=function(e){for(var i=document.getElementById("ecFileInput"),t=0;t<i.files.length;t++){EmailSendingUtil.displayAttachmentName(i.files[t].name,null,i.files[t].size);var a=new FormData;a.append("theFile",i.files[t]),e&&null!=e&&a.append("draftId",e),a.append(csrfParamName,csrfToken),EmailSendingUtil.startUpload(a,EmailSendingUtil.fileCount-1)}var l=$("#ecDisplayAttachmentNames").outerHeight(!0);if(EmailSendingUtil.attachmentContainerHeight!=l&&60!=EmailSendingUtil.attachmentContainerHeight){var o=l-EmailSendingUtil.attachmentContainerHeight;l>60&&($("#ecDisplayAttachmentNames").css({"max-height":"72px",overflow:"auto"}),o=72-EmailSendingUtil.attachmentContainerHeight,l=72),EmailSendingUtil.attachmentContainerHeight=l}EmailSendingUtil.resizeEditorHeight(o),EmailSendingUtil.filesAttached++;var n=document.getElementById("ecFileInput");n.value=n.defaultValue},EmailSendingUtil.startUpload=function(e,i,t){t=t||0;var a=new XMLHttpRequest,l=$("#ecAttachDetails"+i);EmailSendingUtil.filesFlag++,a.upload.onprogress=function(e){var i=e.loaded/e.total*100;l.parent().find(".ecAttachmentProgress").css("background","#1B6BCC"),l.parent().find(".ecAttachmentProgress").css("width",i+"%")},a.onload=function(){200==a.status?a&&"File Storage not available"===a.response?(Crm.showAlertMsg(I18n.getMsg("crm.view.attachment.add.nostorage")),EmailSendingUtil.removeAttachment(l.parent().find(".abortAttc"))):(l.parent().addClass("ecMailAttachment"),l.parent().attr("fileId",a.responseText),l.parent().find(".removeAttc").removeClass("hide"),l.parent().find(".abortAttc").addClass("hide"),EmailSendingUtil.filesFlag--):t<2?(EmailSendingUtil.filesFlag--,l.parent().find(".ecAttachmentProgress").css("width","100%"),l.parent().find(".ecAttachmentProgress").css("background","#CC1B1B"),setTimeout((function(){EmailSendingUtil.startUpload(e,i,t+1)}),1e3)):(Crm.showAlertMsg(I18n.getMsg("crm.email.attach.error")),EmailSendingUtil.removeAttachment(l.parent().find(".abortAttc")),EmailSendingUtil.filesFlag--)},l.parent().find(".abortAttc").on("click",(function(){a.abort(),EmailSendingUtil.removeAttachment(l.parent().find(".abortAttc")),EmailSendingUtil.filesFlag--})),a.onerror=function(){Crm.showAlertMsg(I18n.getMsg("crm.email.attach.error")),EmailSendingUtil.removeAttachment(l.parent().find(".abortAttc")),EmailSendingUtil.filesFlag--},l.value=0,a.open(EmailTabHomeUtil.POST_REQUEST_TYPE,EmailSendingUtil.URL+"?action=upload",!0),a.send(e)},EmailSendingUtil.removeFileFromZFS=function(e){var i=EmailTabHomeUtil.ACTION+"="+EmailSendingUtil.removeFileReq;$("#massMailId").length>0&&(i+="&massMailId="+$("#massMailId").val()),i+="&fileId="+e,i+="&"+csrfParamName+"="+csrfToken,$.ajax({type:EmailTabHomeUtil.POST_REQUEST_TYPE,url:EmailSendingUtil.URL,data:i,error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.uploadDocsAttachments=function(){var e=$("#draftId").val();EmailSendingUtil.isEntityWindow||e&&null!==e&&"null"!==e&&""!==e?EmailSendingUtil.processDocsAttachments():EmailActionHandling.formDraftAndUploadDocs()},EmailSendingUtil.processDocsAttachments=function(){for(i=0;i<EmailSendingUtil.docsAttachmentArray.length;i++){var e=EmailSendingUtil.docsAttachmentArray[i].split(":::")[0],t=EmailSendingUtil.docsAttachmentArray[i].split(":::")[1];t=e+":::"+(t=(t=t.replace(e+",","")).replace(",",":::"));EmailSendingUtil.filesAttached;EmailSendingUtil.saveAndUploadDocs(t,e);var a=$("#ecDisplayAttachmentNames").outerHeight(!0);if(EmailSendingUtil.attachmentContainerHeight!=a&&60!=EmailSendingUtil.attachmentContainerHeight){var l=a-EmailSendingUtil.attachmentContainerHeight;a>60&&($("#ecDisplayAttachmentNames").css({height:"60px",overflow:"auto"}),l=60-EmailSendingUtil.attachmentContainerHeight,a=60),EmailSendingUtil.attachmentContainerHeight=a,EmailSendingUtil.resizeEditorHeight(l)}EmailSendingUtil.filesAttached++}EmailSendingUtil.docsAttachmentArray=[]},EmailSendingUtil.saveAndUploadDocs=function(e,i){var t=EmailTabHomeUtil.ACTION+"="+EmailSendingUtil.attachDocuments;EmailSendingUtil.isEntityWindow?t+="&attachDoc="+encodeURIComponent(e):t+="&draftId="+$("#draftId").val()+"&attachDoc="+encodeURIComponent(e),t+="&"+csrfParamName+"="+csrfToken,EmailSendingUtil.filesFlag++,$.ajax({type:EmailTabHomeUtil.POST_REQUEST_TYPE,url:EmailSendingUtil.URL,data:t,success:function(e){if(!e)return EmailSendingUtil.filesFlag--,void Crm.showAlertMsg(I18n.getMsg("crm.mail.attach.file.error"));if(Crm.userDetails.isNewEditor){var t={SZ:e.SZ,FILEID:e.FILEID,FILE_NAME:e.FILE_NAME};editor.zEditor.showAttachment(t)}else{EmailSendingUtil.displayAttachmentName(i,e.FILE_NAME);var a=EmailSendingUtil.fileCount-1,l=$("#ecAttachDetails"+a),o=EmailSendingUtil.calculateFileSize();EmailSendingUtil.zohoDocsAttachIncluded=!0,isNaN(parseInt(e.SZ))||(o+=parseInt(e.SZ)),o<10485760&&o>0?(l.parent().attr("fileId",e.FILEID),l.parent().addClass("ecMailAttachment"),l.parent().attr("fileSize",e.SZ),l.parent().find("p").html(EmailSendingUtil.bytesToSize(e.SZ)),l.parent().find(".removeAttc").removeClass("hide"),l.parent().find(".abortAttc").addClass("hide"),l.parent().find(".ecAttachmentProgress").css("width","100%"),setTimeout((function(){EmailSendingUtil.adjustAttachHeight()}))):o<=0?(EmailSendingUtil.removeAttachment(l),Crm.showAlertMsg(I18n.getMsg("errors.zeroByteFile"))):(EmailSendingUtil.removeAttachment(l),Crm.showAlertMsg(I18n.getMsg("crm.mail.attach.restriction.individual.error1"))),EmailSendingUtil.filesFlag--}},error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.adjustAttachHeight=function(){var e=$("#ecDisplayAttachmentNames").outerHeight(!0);if(EmailSendingUtil.attachmentContainerHeight!=e&&60!=EmailSendingUtil.attachmentContainerHeight){var i=e-EmailSendingUtil.attachmentContainerHeight;e>60&&($("#ecDisplayAttachmentNames").css({height:"60px",overflow:"auto"}),i=60-EmailSendingUtil.attachmentContainerHeight,e=60),EmailSendingUtil.attachmentContainerHeight=e,EmailSendingUtil.resizeEditorHeight(i)}},EmailSendingUtil.calculateFileSize=function(){var e=0;return $(".ecMailAttachment").each((function(){$(this).attr("fileSize")&&""!=$(this).attr("fileSize")&&(e+=parseInt($(this).attr("fileSize")))})),e},EmailSendingUtil.bytesToSize=function(e){if(isNaN(e)||0==e||-1==e)return"0 B";var i=Math.floor(Math.log(e)/Math.log(1e3));return(e/Math.pow(1e3,i)).toPrecision(3)+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][i]},EmailSendingUtil.initiateAttachment=function(){$("#ecDisplayAttachmentNames").removeClass("hide"),EmailSendingUtil.setWindowElementsHeight(),$(".ecForwardAttachment").each((function(){EmailSendingUtil.triggerAttachment($(this))}))},EmailSendingUtil.triggerAttachment=function(e){var i=$(e).find("span");EmailSendingUtil.attachFileType="IMAP"===EmailSendingUtil.mailType?EmailSendingUtil.attachIMAPDocuments:"GMail"===EmailSendingUtil.mailType?EmailSendingUtil.attachGMAILDocuments:"ZMAIL"===EmailSendingUtil.mailType?EmailSendingUtil.attachZMAILDocuments:EmailSendingUtil.attachSentMailDocuments;var t=EmailTabHomeUtil.ACTION+"="+EmailSendingUtil.attachFileType;EmailSendingUtil.attachFileType!==EmailSendingUtil.attachZMAILDocuments&&EmailSendingUtil.attachFileType!==EmailSendingUtil.attachGMAILDocuments||(t+="&msgid="+$("#msgid").val()),EmailSendingUtil.attachFileType===EmailSendingUtil.attachSentMailDocuments?t+="&aid="+$(e).attr("fileId"):t+="&aid="+$(e).attr("fileIndex"),EmailSendingUtil.isEntityWindow?t+="&userId="+i.attr("userId")+"&fileName="+encodeURIComponent(i.html()):t+="&draftId="+$("#draftId").val()+"&userId="+i.attr("userId")+"&fileName="+i.html(),t+="&uid="+i.attr("uid"),t+="&"+csrfParamName+"="+csrfToken,EmailSendingUtil.filesFlag++,(new crmRequestPool).initiate({action:EmailSendingUtil.URL,type:EmailTabHomeUtil.POST_REQUEST_TYPE,data:t,success:function(e){i.parent().attr("fileId",e.FILEID),i.parent().addClass("ecMailAttachment"),i.parent().attr("fileSize",e.SZ),i.parent().find("p").html(EmailSendingUtil.bytesToSize(e.SZ)),i.parent().find(".removeAttc").removeClass("hide"),i.parent().find(".ecAttachmentProgress").css("width","100%"),EmailSendingUtil.filesFlag--},error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.triggerIMAPAttachment=function(e){var i=$(e).find("span"),t=EmailTabHomeUtil.ACTION+"="+EmailSendingUtil.attachIMAPDocuments;EmailSendingUtil.isEntityWindow?t+="&userId="+i.attr("userId")+"&fileName="+i.html():t+="&draftId="+$("#draftId").val()+"&userId="+i.attr("userId")+"&fileName="+i.html(),t+="&aid="+$(e).attr("fileIndex")+"&uid="+i.attr("uid"),t+="&"+csrfParamName+"="+csrfToken,EmailSendingUtil.filesFlag++,$.ajax({type:EmailTabHomeUtil.POST_REQUEST_TYPE,url:EmailSendingUtil.URL,data:t,success:function(e){i.parent().attr("fileId",e.FILEID),i.parent().addClass("ecMailAttachment"),i.parent().find("p").html(EmailSendingUtil.bytesToSize(e.SZ)),i.parent().find(".removeAttc").removeClass("hide"),i.parent().find(".ecAttachmentProgress").css("width","100%"),EmailSendingUtil.filesFlag--},error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.checkEntityAndAlert=function(){var e=EmailSendingUtil.getCommaSeparatedEmails("ceToAddrDetails");""!==e&&""!==$("#ceToAddr").val()?e+=","+$("#ceToAddr").val():""===e&&""!==$("#ceToAddr").val()&&(e=$("#ceToAddr").val());var i=!0;if(e){var t=e.split(","),a=$("#ceToAddrDetails li.selectedEmail")[0],l=$(a).attr("module"),o=$(a).attr("entityid");l&&""!==l&&("Potentials"===l||"Leads"===l||"Contacts"===l)&&o&&""!==o?(t.length>1?$("#ceOptionToAlert").text(I18n.getMsg("crm.email.entity.store")):$("#ceOptionToAlert").text(""),i=!1):l||null!==t[0]&&validationUtils.isValidEmail(t[0])&&EmailSendingUtil.findAndSetEntity(t[0])}i&&$("#ceOptionToAlert").hide(),EmailSendingUtil.handleSaveAndSend()},EmailSendingUtil.handleSaveAndSend=function(){var e=$("#ceToAddrDetails li")[0],i=$(e).attr("module"),t=$(e).attr("entityid");i&&""!=i&&("Potentials"==i||"Leads"==i||"Contacts"==i)&&t&&""!=t?($(".emcSaveandSend").removeClass("hide"),$("#toSave").val("true"),$("#emcSendBtn").val(I18n.getMsg("crm.button.save")+" & "+I18n.getMsg("crm.button.send"))):($(".emcSaveandSend").addClass("hide"),$("#toSave").val("false"),$("#emcSendBtn").val(I18n.getMsg("crm.button.send"))),$(".ceVariousTextFormattingOptionContainer").css("left",$("#ecMailOptions").outerWidth())},EmailSendingUtil.findAndSetEntity=function(e){if(!EmailSendingUtil.isEntityWindow){var i=EmailTabHomeUtil.ACTION+"=findEntity";i+="&email="+encodeURIComponent(e),$.ajax({type:EmailTabHomeUtil.GET_REQUEST_TYPE,url:EmailSendingUtil.URL,data:i,success:function(e){var i=$("#ceToAddrDetails li.selectedEmail")[0];null!=e?($(i).attr("module",e.module),$(i).attr("entityid",e.entityId),$(i).attr("username",e.username),$(i).find(".ecSelectedUserName").text(e.username),e.photoUrl&&"null"!=e.photoUrl&&""!=e.photoUrl?($(i).find(".ecUserImage img").attr("src",e.photoUrl),$(i).find(".ecUserImage").removeClass("hide")):($(i).find(".ecUserImage img").attr("src",networkUtils.getImageUrl("nophoto_80ea3af_.png",ResourceConstants.CRM)),$(i).find(".ecUserImage").removeClass("hide"))):$(i).attr("module","UnMatched"),EmailSendingUtil.checkEntityAndAlert()},error:EmailTabHomeUtil.handleAjaxAbort})}},EmailSendingUtil.editUnameAndEmail=function(e){var i="";i=e.attr("username")==e.attr("email")?e.attr("email"):e.attr("username")+"<"+e.attr("email")+">",e.css("background","#fff"),e.find(".selUserDetails").addClass("hide"),e.append('<span class="userEmailDetailsTxt fL">'+EmailSendingUtil.removeHTMLTags(i)+"</span>");var t=e.find(".userEmailDetailsTxt").outerWidth();e.find(".userEmailDetailsTxt").hide(),e.find("input").removeClass("hide").css("width",t).val(i).focus()},EmailSendingUtil.rectifyEmail=function(e){var i=$(e).val(),t=$(e).parent();if(t.css("background",""),t.removeClass("selectedEmail"),t.removeClass("invalidEmail"),""!=i){t.find(".selUserDetails").removeClass("hide"),t.find("input").addClass("hide");var a=null,l="";-1!=i.indexOf("<")&&-1!=i.indexOf(">")?(a=i.substring(0,i.indexOf("<")),l=i.substring(i.indexOf("<")+1,i.indexOf(">")),$.trim(a).length<1&&(a=l)):(a=i,l=i),validationUtils.isValidEmail(l)?t.addClass("selectedEmail"):t.addClass("invalidEmail"),t.attr("username",a),t.attr("email")!=l&&(t.attr("email",l),t.attr("entityId",""),t.attr("module","")),t.attr("title",l),t.find(".ecSelectedUserName").text(EmailSendingUtil.removeHTMLTags(a)),t.attr("data-zcqa","emc_selected_"+EmailSendingUtil.removeHTMLTags(a)),t.find(".selUserDetails.closeIconB").attr("data-zcqa","emc_remove_"+EmailSendingUtil.removeHTMLTags(a))}else t.remove();$(e).closest("ul").find('li.ecAddrEditor input[type="text"]').focus()},EmailSendingUtil.bindAutoCompleteScroll=function(){var e=$("#ecAutoCompleteContainerOuter");e.find("#ecAutoCompleteContainerInner").css({height:"0px"});var i=$("#ecAutoCompleteContainer").outerHeight();i>400&&(i=400),e.css({height:i+"px"}),scrollHeight1=e[0].scrollHeight,e.css({overflow:"hidden"}),thirdPartyUtils.bindPerfectScroll("#ecAutoCompleteContainerOuter",{wheelSpeed:1,wheelPropagation:!0})},EmailSendingUtil.sendWithoutSaving=function(){EmailSendingUtil.validate()&&($("#toSave").val("false"),document.sendMailForm.submit())},EmailSendingUtil.setEntityAttachDetails=function(){var e="",i="",t="";$(".ecMailAttachment").each((function(){null!=$(this).attr("fileId")&&""!=$(this).attr("fileId")&&(""===e?(e=$(this).attr("fileId"),i=$(this).attr("fileName"),t=$(this).attr("fileSize")):(e+="####"+$(this).attr("fileId"),i+="####"+$(this).attr("fileName"),t+="####"+$(this).attr("fileSize")))})),$("#entAttachId").val(e),$("#entAttachName").val(i),$("#entAttachSize").val(t)},EmailSendingUtil.setTemplateShadow=function(){$(".ecvTemplateListOuter").on("wheel",(function(){$(".ecvTemplateListOuter").scrollTop()>10?$(".ecSearchModules").addClass("settingsBottomshadow"):$(".ecSearchModules").removeClass("settingsBottomshadow")}))},EmailSendingUtil.setTemplateFromAddress=function(e){var i=$("[name='folderListDropdown']").find(".orgEmailsPart").clone();if(e&&null!=e&&"$(Record.Owner.Email)"==e){var t=$("#defaultFromAddr").val(),a='<span id="addrsVal" class="fL dropdownOptionSpan pL10 cP" selectedval="'+$ESAPI.encoder().encodeForHTMLAttribute(t)+'">'+$ESAPI.encoder().encodeForHTML(t)+'</span><span class="customSelectArrow fL"></span>';if(a+='<ul data-zcqa="emc_fromDropDown" name="folderListDropdown" class="dropdownOptionsList" style="top: 33px; display: none; min-width: 210px;" onclick="sE(event)">',a+='<li data-zcqa="emc_frm_0" lival="'+$ESAPI.encoder().encodeForHTMLAttribute(t)+'" class="customDropdownSelFieldLi" onclick="EmailSendingUtil.selectDropdownVal(this);sE(event)">'+$ESAPI.encoder().encodeForHTML(t)+"</li>",a+='<li data-zcqa="emc_frm_0" lival="'+e+'" onclick="EmailSendingUtil.selectDropdownVal(this);sE(event)">'+I18n.getMsg("crm.template.record.owner.email")+"</li></ul>",$("#addrsVal").parent().html(a),i.hasClass("customDropdownSelFieldLi")){var l=i.filter(".customDropdownSelFieldLi");$("[name='folderListDropdown']").find("li").removeClass("customDropdownSelFieldLi"),$("#addrsVal").attr("selectedval",l.attr("lival")),$("#addrsVal").text(l.text())}$("[name='folderListDropdown']").append(i)}else if(e&&null!=e&&"$(Current.User.Email)"!=e&&e!=t){t=$("#defaultFromAddr").val(),a='<span id="addrsVal" class="fL dropdownOptionSpan pL10 cP" selectedval="'+$ESAPI.encoder().encodeForHTMLAttribute(t)+'">'+$ESAPI.encoder().encodeForHTML(t)+'</span><span class="customSelectArrow fL"></span>';if(a+='<ul data-zcqa="emc_fromDropDown" name="folderListDropdown" class="dropdownOptionsList" style="top: 33px; display: none; min-width: 210px;" onclick="sE(event)">',a+='<li data-zcqa="emc_frm_0" lival="'+$ESAPI.encoder().encodeForHTMLAttribute(t)+'" class="customDropdownSelFieldLi" onclick="EmailSendingUtil.selectDropdownVal(this);sE(event)">'+$ESAPI.encoder().encodeForHTML(t)+"</li>",a+='<li data-zcqa="emc_frm_0" lival="'+e+'" onclick="EmailSendingUtil.selectDropdownVal(this);sE(event)">'+e+"</li></ul>",$("#addrsVal").parent().html(a),i.hasClass("customDropdownSelFieldLi")){l=i.filter(".customDropdownSelFieldLi");$("[name='folderListDropdown']").find("li").removeClass("customDropdownSelFieldLi"),$("#addrsVal").attr("selectedval",l.attr("lival")),$("#addrsVal").text(l.text())}$("[name='folderListDropdown']").append(i)}},EmailSendingUtil.setTemplateReplytoAddress=function(e){e&&null!=e&&($("#ceReplyToAddrSpan").attr("selectedval",e),$("#ceReplyToAddrSpan").html(e),$("#ceOption_replyto").removeClass("hide"))},EmailSendingUtil.removeFromAndReplytoAddress=function(){var e=$("[name='folderListDropdown']").find(".orgEmailsPart").clone();if(e.length<=0){var i=$("#defaultFromAddr").val(),t='<span id="addrsVal" class="fL dropdownOptionSpan pL10 " selectedval="'+$ESAPI.encoder().encodeForHTMLAttribute(i)+'">'+$ESAPI.encoder().encodeForHTML(i)+"</span>";$("#addrsVal").parent().html(t)}else{i=$("#defaultFromAddr").val(),t='<span id="addrsVal" class="fL dropdownOptionSpan pL10 cP" selectedval="'+$ESAPI.encoder().encodeForHTMLAttribute(i)+'">'+$ESAPI.encoder().encodeForHTML(i)+'</span><span class="customSelectArrow fL"></span>';if(t+='<ul data-zcqa="emc_fromDropDown" name="folderListDropdown" class="dropdownOptionsList" style="top: 33px; display: none; min-width: 210px;" onclick="sE(event)">',t+='<li data-zcqa="emc_frm_0" lival="'+$ESAPI.encoder().encodeForHTMLAttribute(i)+'" class="customDropdownSelFieldLi" onclick="EmailSendingUtil.selectDropdownVal(this);sE(event)">'+$ESAPI.encoder().encodeForHTML(i)+"</li></ul>",$("#addrsVal").parent().html(t),e.hasClass("customDropdownSelFieldLi")){var a=e.filter(".customDropdownSelFieldLi");$("[name='folderListDropdown']").find("li").removeClass("customDropdownSelFieldLi"),$("#addrsVal").attr("selectedval",a.attr("lival")),$("#addrsVal").text(a.text())}$("[name='folderListDropdown']").append(e)}$("#ceReplyToAddrSpan").attr("selectedval",""),$("#ceReplyToAddrSpan").html(""),$("#ceOption_replyto").addClass("hide")};var dots=0;EmailSendingUtil.sendingPopup=function(){$("#emc_msg_Tab").hide(),$("#emc_msg_Tab").removeAttr("data-zcqa"),$("#emailEntityComposeOverlay").show();var e=$("#bestTime");e.length>0&&(e.is(":checked")?$("#emailEntityComposepopup").html(I18n.getMsg("scheduling")+'<span id="eECDots"></span>'):$("#emailEntityComposepopup").html(I18n.getMsg("sending")+'<span id="eECDots"></span>')),mailsetCenter("emailEntityComposepopup"),dotAnimate=setInterval(EmailSendingUtil.animateDots,200)},EmailSendingUtil.animateDots=function(){dots<3?($("#eECDots").append("."),dots++):($("#eECDots").text(""),dots=0)},EmailSendingUtil.formatEmail=function(e){return-1!=e.indexOf("<")&&-1!=e.indexOf(">")&&(e=e.substring(e.indexOf("<")+1,e.indexOf(">"))),e},EmailSendingUtil.formattedUsernameFromEmail=function(e){var i=null;return-1!=e.indexOf("<")&&-1!=e.indexOf(">")&&(i=""!=e.substring(0,e.indexOf("<"))&&null!=e.substring(0,e.indexOf("<"))?e.substring(0,e.indexOf("<")):null),i},EmailSendingUtil.bindSalesIqLinkEvents=function(){$(".salesIqLink").click((function(){var e=$("#ze_lnkurl");e.val(""),$("#siq_Url").text(""),$("#siq_trackingParam").text("");var i,t,a,l=$("#addLinkDiv");if(""===l.html()){var o=inSplnk.getDataReqTypeJson("","","addLinkPop");"undefined"!=typeof CrmPlusLib&&CrmPlusLib.isLoadedInCrmplusFrame?(Handlebars.registerPartial("DataRequestLinkTypes",Handlebars.templates.DataRequestLinkTypes),l.html(Handlebars.templates.AddLinkForEmailCompose(o))):(parent.Handlebars.registerPartial("DataRequestLinkTypes",parent.Handlebars.templates.DataRequestLinkTypes),l.html(parent.Handlebars.templates.AddLinkForEmailCompose(o)))}CustomizeEditor.initialize();var n="";EmailSendingUtil.isNewEditor()?(editor.zEditor.editorDiv.focus(),editor.zEditor.focusEditor(),a=(i=editor.zEditor.z_win.getSelection()).toString(),CustomizeEditor.selectedText=a,t=editor.zEditor.getParentNode(),window.document.documentMode?(CustomizeEditor.selectedArea=editor.zEditor.getRange(i),null===t.parentNode&&(t=editor.zEditor.editorDiv)):CustomizeEditor.selectedArea=i.getRangeAt(0)):((i=editor._getSelection()).rangeCount>0&&(CustomizeEditor.selectedText=editor._getSelectedText(),CustomizeEditor.selectedArea=i.getRangeAt(0)),t=editor.getParentElement()),null!==t&&"BODY"!==t.nodeName?(n=t.getAttribute("href"),CustomizeEditor.parentEle=t):CustomizeEditor.parentEle="",$("#addLinkPop").attr("value","zp_salesIqLink"),$(".removeForSalesIqLink").hide();EmailSendingUtil.isNewEditor()?($("#addLinkPop, #zp_SalesIqLink").add(l).show(),$("#emcInsertOption_"+EmailComposeUtil.CURRENT_TAB).hide(),EmailComposeUtil.showCustomFreezeLayer()):$("#custom_freeze, #addLinkPop, #zp_SalesIqLink").add(l).show(),n&&-1===n.search(/\$\{ConsentForm\.[a-zA-Z0-9_]+\}/)&&-1===n.search(/\$\{Datarequest\.[a-zA-Z0-9_]+\}/)&&e.val(n),EmailSendingUtil.fnUpdateSIQTracking()}))},EmailSendingUtil.fnUpdateSIQTracking=function(){var e=$("#ze_lnkurl").val().trim(),i=$("#siq_trackingParam"),t=CustomizeEditor.getPrimaryUserNameAndEmail(),a=t.username,l=t.emailAdd,o=!1,n=!1,s=e.split("?"),m=null;if((-1!==e.indexOf("siq_name=")||-1!==e.indexOf("siq_email="))&&s.length>1&&(m=s[1].split("&")).forEach((function(e){var i="siq_name="+encodeURIComponent(a),t="siq_email="+encodeURIComponent(l);!e.startsWith("siq_name=")||i!==e&&"siq_name="+a!=e?e.startsWith("siq_email=")&&t===e&&(n=!0):o=!0})),i.text(""),""==e)$("#siq_Url").text("");else if(""===e||-1===e.indexOf("siq_name=")&&-1===e.indexOf("siq_email=")||o&&n){if(""!==e&&-1===e.indexOf("siq_name=")){var r="";-1===e.indexOf("siq_name=")&&(r="siq_name="+a+"&siq_email="+encodeURIComponent(l));var d=e.length-1===e.lastIndexOf("?");e=-1===e.indexOf("?")||d?d?e:e+"?":e+"&",$("#siq_Url").text(e),i.text(r)}else if(o&&n&&null!=m){var c=s[0]+"?";r="siq_name="+a+"&siq_email="+encodeURIComponent(l);m.forEach((function(e){e.startsWith("siq_name=")||e.startsWith("siq_email=")||(c+=e+"&")})),$("#siq_Url").text(c),i.text(r)}}else $("#siq_Url").text(e)},EmailSendingUtil.bindInsertSurvey=function(){$(".surveyLink").click((function(){var e=$("input[id=ecEntityId]").val();$(this).attr("data-params",'{"action":"surveyDetails","from":"email","entityId":"'+e+'"}'),ZSurvey.showSurveyDetails(this);var i="";EmailSendingUtil.isNewEditor()?"undefined"!=typeof editor&&editor&&editor.zEditor&&(i=editor.zEditor.z_win.getSelection()):"undefined"!=typeof editor&&editor&&editor._getSelectedText&&(i=editor._getSelectedText());var t=i?i.toString():"";$("#textDispField").val(t)}))},EmailSendingUtil.bindSurveyEvents=function(){$(".surveyLink").click((function(e){event.stopPropagation();var i=$(this).offset(),t=i.top+35,a=i.left-274,l=t-10,o=$(".ppContSlide");if(Crm.userDetails.isNewEditor){var n=i.left-o.innerWidth(),s=i.top-10;$(".setDDPopupAbGzs").addClass("hide"),o.css({left:n,top:s}),setTimeout((function(){$(".ppContSlide").show()}),10)}else o.css({top:l+"px",left:a+"px",opacity:"1"}).show()})),$(".ppContSlide").click((function(e){e.stopPropagation()})),$(".goRight").click((function(){var e=$(".activeSlide").next(),i=$(".tSNum").text(),t=parseInt($(".cSNum").text());(t+=1)<=i&&($(".activeSlide").css({left:"-370px"}),$(".activeSlide").next().css({left:"0px"}),$(".activeSlide").removeClass("activeSlide"),$(e).addClass("activeSlide"),$(".cSNum").text(t),$(".goLeft").removeClass("disable")),t==i&&($(".goRight").hide(),$(".slideNumber").hide(),$(".fSlideBut").fadeIn())})),$(".goLeft").click((function(){$(".goRight ").show(),$(".fSlideBut").hide(),$(".slideNumber").show();var e=$(".activeSlide").prev(),i=($(".tSNum").text(),$(".cSNum").text());(i-=1)>0&&($(".activeSlide").css({left:"370px"}),$(e).css({left:"0px"}),$(".secSlide").removeClass("activeSlide"),$(e).addClass("activeSlide"),$(".cSNum").text(i)),1==i&&$(".goLeft").addClass("disable")})),$("body").click((function(){$(".ppContSlide").hide();var e=document.querySelector("lyte-search");null!==e&&e.setValue(""),$("#calenDiv, #sdiv").hide()}))},EmailSendingUtil.removeAttachments=function(){if(!EmailSendingUtil.isEmailProgressing&&!EmailSendingUtil.mailSentStatus){var e="";$(".ecMailAttachment").each((function(){null!=$(this).attr("fileId")&&""!=$(this).attr("fileId")&&(""===e?e=$(this).attr("fileId"):e+=","+$(this).attr("fileId"))})),""!=e&&EmailSendingUtil.removeFileFromZFS(e)}},EmailSendingUtil.dumpTemplateBody=function(){var e=$("#moduleName").val(),i=$("#ecTemplateId").val();EmailSendingUtil.isNewEditor()&&(e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val()),EmailSendingUtil.getTemplateContentById(void 0,e,i),EmailSendingUtil.isTemplateDumped=!0},EmailSendingUtil.convertMergeFieldstoFieldIds=function(e,i){return CrmConvertMergeFields.convertMergeFieldsAsRequiredFormat(e,mergeFieldsConstants.fromlabel_to_id,i,!1,!1)},EmailSendingUtil.populateSearchValue=function(e,i){if(!i)i=$(e.target).closest("li");var t=i.closest("#ecAutoCompleteContainer").attr("inputId");email=i.attr("email"),$("#"+t).val(email),$("#ecAutoCompleteContainer").addClass("hide")},EmailSendingUtil.showDropDown=function(e){var i=$(e),t=i.find(".dropdownOptionSpan").attr("selectedVal");i.find(".dropdownOptionsList li").removeClass("customDropdownSelFieldLi");var a=i.find('.dropdownOptionsList li[liVal="'+t+'"]');a.length>1?"true"==$("#isOrgEmail").val()?a.filter(".orgEmailsPart").addClass("customDropdownSelFieldLi"):a.not(".orgEmailsPart").addClass("customDropdownSelFieldLi"):a.addClass("customDropdownSelFieldLi"),$(".dropdownOptionsList").length&&($(".dropdownOptionsList").hide(),$(".selectedCustomSpan").removeClass("selectedCustomSpan")),i.addClass("selectedCustomSpan"),i.find(".dropdownOptionsList").css("min-width",i.outerWidth()).show(),EmailSendingUtil.bindCreateCriteriaScroll()},EmailSendingUtil.bindCreateCriteriaScroll=function(e){var i=$("#etsCriteriaCreatorOuter"),t=$(e);if(i.is(":visible")){var a=$("#etMailSettings").outerHeight()-($("#etTabShadow").height()+$("#evSuggestedTitle").outerHeight())-30,l=i[0].scrollHeight,o=$("#evSuggestedViewsInner").is(":visible");$("#etsCriteriaCreator").css({height:l}),i.css({height:a,overflow:"hidden"}),thirdPartyUtils.bindPerfectScroll("#etsCriteriaCreatorOuter",{wheelSpeed:1,wheelPropagation:!0}),o||EmailTabSettings.setHeadingShadow("etsCriteriaCreatorOuter"),EmailTabSettings.criteriaEditorBlurEffect()}if("criteriaDiv"===t.closest("table.newFormContBlk").parent().attr("id")||"eiwfFolderDropDown"===t.attr("id")){t.find(".dropDownDiv ul").css({height:""});var n=t.find(".dropDownDiv")[0].scrollHeight;t.find(".dropDownDiv ul").css({height:n}),t.find(".dropDownDiv").css({overflow:"hidden"}),t.find(".dropDownDiv").perfectScrollbar({wheelSpeed:50,wheelPropagation:!0})}else if("ewfMultiselectSearch"===t.attr("id")){var s=t.closest("div").find("#iewfLabelsListUl");s.css({height:""}).find("ul").css({height:""}),(n=s[0].scrollHeight)>200&&(s.find("ul").css({height:n-20}),s.css({height:"200px",overflow:"hidden"}),s.perfectScrollbar({wheelSpeed:50,wheelPropagation:!0}))}},EmailSendingUtil.showOrgMailInfo=function(e){var i=$("#emc_msg_Tab");i.css({"z-index":"100"}),i.html(e),i.attr("data-zcqa","emc_SendTab_Error"),i.show().css("left",($(document).outerWidth()-i.outerWidth())/2)},EmailSendingUtil.selectDropdownVal=function(e,i){var t=$(e),a=t.closest("ul"),l=t.text(),o=t.attr("liVal");t.siblings().removeClass("selectedText customDropdownSelFieldLi"),t.addClass("selectedText customDropdownSelFieldLi"),t.closest("div").find(".dropdownOptionSpan").text(l).attr("selectedVal",o),a.hide(),$(".selectedCustomSpan").removeClass("selectedCustomSpan");var n=$("#emc_msg_Tab"),s=$("#isOrgEmail");if(EmailSendingUtil.isOrgEmailFlow=!1,i&&"replyTo"===i)n.is(":visible")?n.show:n.hide;else if(s.val("false"),n.hide(),i){s.val("true");var m=I18n.getMsg("crm.email.orgemail.message",[o]),r="",d=o.lastIndexOf("<"),c=o.lastIndexOf(">");r=-1!==d&&-1!==c&&c>d?o.slice(o.lastIndexOf("@")+1,c):o.slice(o.lastIndexOf("@")+1,o.length),JSON.parse(EmailSendingUtil.relayEnabledDomains).contains(r)||EmailSendingUtil.showOrgMailInfo(m),EmailSendingUtil.isOrgEmailFlow=!0}EmailSendingUtil.isSignatureForOldFlow&&EmailSendingUtil.setSignature(o)},EmailSendingUtil.setBestTime=function(e){var i=$("#emc_bestTime"),t=$("#bestTime"),a=$("#moduleName").val(),l=null,o=$("#ecRelEntityId");if("Leads"===a||"Contacts"===a?l=$("#ecEntityId").val()+"":o.length>0&&null!==o.val()&&""!==o.val()&&(l=o.val()+"",a="Contacts"),Crm.userDetails.isNewEditor&&(t=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB),o=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB),i=$("#emc_bestTime_"+EmailComposeUtil.CURRENT_TAB),a=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),l=o.val()),i.length>0&&null!==l&&""!==l&&Crm.userDetails.isBestTimeEnabledMail){"editInCompose"===EmailSendingUtil.action&&t.length>0&&""!==t.val()&&(i.removeClass("hide"),EmailSendingUtil.setWindowElementsHeight(),$("#ecSchduleTrigger").addClass("ecSchedulerBlueIcon"));var n=new crmRequestPool,s="hh:mm a"===Crm.userDetails.TIME_FORMAT,m={seId:l,seModule:a,reqTime:e.getTime(),is12HourFormat:s,bestTimeFor:"TEXT"};n.initiate({action:"/crm/di/getBestTime",type:"GET",data:m,success:function(i){if(void 0===i.data.user_time){var t=new Date;i.data.user_time={},i.data.user_time.hour=t.getHours(),i.data.user_time.minute=t.getMinutes()}EmailSendingUtil.bestTimeData=i,"editInCompose"!==EmailSendingUtil.action&&(EmailSendingUtil.besttimeSetflag?(EmailSendingUtil.processAndSetUpcomingBestTime(i,l),EmailSendingUtil.processAndSetBestTime(EmailSendingUtil.bestTimeData,l,e),EmailSendingUtil.besttimeSetflag=!1):EmailSendingUtil.processAndSetBestTime(EmailSendingUtil.bestTimeData,l,e))}})}i.mouseenter((function(){EmailSendingUtil.hoverStatus=1,setTimeout((function(){1==EmailSendingUtil.hoverStatus&&"bestTime"===$("#timeSource").val()&&i.find(".userTimeInfo").show()}),100)})),i.mouseleave((function(){EmailSendingUtil.hoverStatus=0,$(this).find(".userTimeInfo").hide()}))},EmailSendingUtil.processAndSetUpcomingBestTime=function(e,i){if(e[i]&&null!=e.data&&null!=e.data.user_time){var t=crmBstTime.getBestTimeByDay(e[i],7),a=(crmBstTime.getBestTimeByDay(e[i],(new Date).getDay()),e.data.user_time.hour),l=e.data.user_time.minute,o=null,n=null;t.length>0&&(o="tomorrow##"+t[0].bestTime.replace(" ","##"),n=EmailSendingUtil.getProperMsg(t[0].bestTime,"tomorrow"));for(var s=!0,m=0;m<t.length&&s;m++)if("hh:mm a"===Crm.userDetails.TIME_FORMAT){var r=t[m].bestTime.split(" ")[1],d=t[m].bestTime.split(" ")[0],c=d.split(":")[0],E=d.split(":")[1],p="12"===c||"pm"!==r&&"PM"!==r?0:12;(parseInt(c)+p>a||parseInt(c)+p===a&&parseInt(l)+10<E)&&(o="today##"+t[m].bestTime.replace(" ","##"),n=EmailSendingUtil.getProperMsg(t[m].bestTime,"today"),s=!1)}else{c=t[m].bestTime.split(":")[0],E=t[m].bestTime.split(":")[1];(parseInt(c)>a||parseInt(c)===a&&parseInt(E)>l+10)&&(o="today##"+t[m].bestTime.replace(" ","##"),n=EmailSendingUtil.getProperMsg(t[m].bestTime,"today"),s=!1)}null!=o&&EmailSendingUtil.suggestBestTime(o,n)}},EmailSendingUtil.suggestBestTime=function(e,i){var t=$("#emc_bestTime");t.find("label").html('<span class="fL mR10 mT1" data-zcqa=""></span>'+$ESAPI.encoder().encodeForHTML(i)),t.removeClass("hide"),$("#timeSource").val("bestTime"),$("#bestTime").val(e),EmailSendingUtil.setWindowElementsHeight()},EmailSendingUtil.processAndSetBestTime=function(e,i,t,a,l){if(e&&e[i]){for(var o=crmBstTime.getBestTimeByDay(e[i],7),n=(crmBstTime.getBestTimeByDay(e[i],a||(new Date).getDay()),e.data.user_time.hour),s=e.data.user_time.minute,m="",r=0;r<o.length;r++){var d=o[r].level?"lev"+o[r].level:void 0;if("hh:mm a"===Crm.userDetails.TIME_FORMAT){var c=o[r].bestTime.split(" ")[1],E=o[r].bestTime.split(" ")[0],p=E.split(":")[0],u=E.split(":")[1],g="12"===p||"pm"!==c&&"PM"!==c?0:12;(t||parseInt(p)+g>n||parseInt(p)+g===n&&parseInt(u)>s+10)&&(""===m?m='<div class="ecSelectedBestTime ecwBestTimeOptions" onclick="EmailSendingUtil.chooseBestTime(this);sE(event)" time="'+o[r].bestTime+'"  ampm="'+(""===c?"hrs":c)+'"  timeVal="'+o[r].bestTime+'">'+(d?' <i class="'+d+'"></i>':"")+o[r].bestTime+"</div>":m+='<div onclick="EmailSendingUtil.chooseBestTime(this);sE(event)" time="'+o[r].bestTime+'"  ampm="'+(""===c?"hrs":c)+'" timeVal="'+o[r].bestTime+'">'+(d?' <i class=ecwBestTimeOptions"'+d+'"></i>':"")+o[r].bestTime+"</div>")}else{p=o[r].bestTime.split(":")[0],u=o[r].bestTime.split(":")[1];(t||parseInt(p)>n||parseInt(p)===n&&parseInt(u)>s+10)&&(""===m?m='<div class="ecSelectedBestTime" onclick="EmailSendingUtil.chooseBestTime(this);sE(event)" time="'+o[r].bestTime+'"  ampm="hrs"  timeVal="'+o[r].bestTime+' hrs">'+(d?'<i class=ecwBestTimeOptions"'+d+'"></i>':"")+o[r].bestTime+" hrs</div>":m+='<div  onclick="EmailSendingUtil.chooseBestTime(this);sE(event)" time="'+o[r].bestTime+'"  ampm="hrs" timeVal="'+o[r].bestTime+' hrs">'+(d?' <i class=ecwBestTimeOptions"'+d+'"></i>':"")+o[r].bestTime+" hrs</div>")}}""!==m?$("#ecBestTimeListView").html(m):($("#ecBestTimeListView").html(I18n.getMsg("crm.besttime.mail.msg.none")),t||l||($("#ecSchduleTime").trigger("click"),EmailSendingUtil.isNewEditor()&&setTimeout(EmailCompose.resetSchedulePopupPosition,1e3)))}else t||l||($("#ecSelectedDate").addClass("hide"),$("#ecBestTimeListView").html(I18n.getMsg("crm.besttime.mail.record.none")),$("#ecSchduleTime").trigger("click"),EmailSendingUtil.isNewEditor()&&setTimeout(EmailCompose.resetSchedulePopupPosition,1e3))},EmailSendingUtil.getBestTimeForCompose=function(){var e=$("#bestTime");if(e.val()){EmailSendingUtil.besttimeReqflag=!1,EmailSendingUtil.besttimeSetflag=!1;var i=new Date(Number(e.val()));Utils.convertToUserTimezone(i);var t,a=new Date;Utils.convertToUserTimezone(a);var l,o=i.getHours(),n=i.getMinutes().toString(),s=(i.getFullYear(),(1+i.getMonth()).toString());s=("0"+s).slice(-2);var m=i.getDate().toString();m=("0"+m).slice(-2);var r=Utils.convertDateToUserPattern(i);if("hh:mm a"===Crm.userDetails.TIME_FORMAT){var d=o<12?"AM":"PM";t=r+"##"+(E=(E=(o>=12?o-12:o).toString()).length>1?E:"0"+E)+":"+(p=n.length>1?n:"0"+n)+"##"+d;var c=E+":"+p+" "+d}else{var E,p;t=r+"##"+(E=(E=o.toString()).length>1?E:"0"+E)+":"+(p=n.length>1?n:"0"+n);c=E+":"+p}var u=Math.abs(i.getTime()-a.getTime());l=1===Math.ceil(u/864e5)-1?I18n.getMsg("Tommorow"):I18n.getMsg(crmBstTime.getDayName(i))+", "+I18n.getMsg(crmBstTime.getMonthName(i))+" "+i.getDate();var g=EmailSendingUtil.getProperMsg(c,l);e.val(t),$("#timeSource").val("bestTime"),g=EmailSendingUtil.getProperMsg(c,l),EmailSendingUtil.suggestBestTime(t,g),EmailSendingUtil.checkButtonName(),i.setHours(0),i.setMinutes(0),i.setSeconds(0),EmailSendingUtil.setBestTime(i),EmailSendingUtil.besttimedate=l}},EmailSendingUtil.setCalendarBestTime=function(){var e=crmBstTime.constructDateObject($("#bstDate").val()),i=new Date,t="",a=$("#ecRelEntityId"),l=$("#moduleName").val();"Leads"===l||"Contacts"===l?$("#ecEntityId").val():a.length>0&&null!==a.val()&&""!==a.val()&&(a.val(),l="Contacts"),Utils.dateEquals(e,i)?(t=I18n.getMsg("Today"),EmailSendingUtil.setBestTime(e)):e-i<864e5&&i<e?(t=I18n.getMsg("Tommorow"),EmailSendingUtil.setBestTime(e)):(t=I18n.getMsg(crmBstTime.getDayName(e))+", "+I18n.getMsg(crmBstTime.getMonthName(e))+" "+e.getDate(),EmailSendingUtil.setBestTime(e)),$("#ecSelectedDate").text(t)},EmailSendingUtil.updateMailStatus=function(){var e="action=updateMailStatus&massMailId="+$("#massMailId").val()+"&"+csrfParamName+"="+csrfToken;(new crmRequestPool).initiate({action:EmailSendingUtil.URL,type:EmailTabHomeUtil.POST_REQUEST_TYPE,data:e,error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.checkButtonName=function(){var e=$("#bestTime");if(Crm.userDetails.isNewEditor){if((e=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB)).length>0){var i=$("#emcSendBtn_"+EmailComposeUtil.CURRENT_TAB);e.is(":checked")?(i.addClass("hide"),$("#emcScheduleMailBtn_"+EmailComposeUtil.CURRENT_TAB).removeClass("hide")):(i.removeClass("hide"),$("#emcScheduleMailBtn_"+EmailComposeUtil.CURRENT_TAB).addClass("hide"))}}else if(e.length>0){var t=$("#emcSendBtn");e.is(":checked")?($("#ecSchduleTrigger").addClass("ecSchedulerBlueIcon"),t.val(I18n.getMsg("crm.reportschedule"))):($("#ecSchduleTrigger").removeClass("ecSchedulerBlueIcon"),t.val(I18n.getMsg("crm.button.send"))),$(".ceVariousTextFormattingOptionContainer").css("left",$("#ecMailOptions").outerWidth())}},EmailSendingUtil.previewTemplateMergeFields=function(){var e=$("#ceAddtemplate").attr("templateid");Crm.userDetails.isNewEditor&&EmailSendingUtil.composeActive?0===$("#nTTemplateListDIV").length&&1===$("#emailEntityComposepopup").length&&(EmailUtil.showEditorFreezeLayer(),e=$("#ceAddtemplate_"+EmailComposeUtil.CURRENT_TAB).attr("templateid")):freezeBackground();var i=Crm.getCrmBasePath()+"/Template.do?step=previewTemplate",t=csrfParamName+"="+encodeURIComponent(csrfToken);t+="&templateId="+encodeURIComponent(e),t+="&from=templateComponent",t+="&inventory="+template.inventory,template.templatePostCall("comp_previewTemplate",i,t)},EmailSendingUtil.showSchedulePopup=function(){var e=$("#schedulerPopup");e.length>0&&(""!==e.html()?EmailSendingUtil.setUPSchedulePopup():EmailSendingUtil.loadAndSetScheduleOptions(!1))},EmailSendingUtil.setUPSchedulePopup=function(e){$("#newFreezeLayer").removeClass("hide").css({opacity:"0.15"});var i=$(window),t=$("#schedulerPopup"),a=(i.outerWidth()-t.outerWidth())/2,l=(i.outerHeight()-t.outerHeight())/2;if(t.css({top:l,left:a}).show(),thirdPartyUtils.bindSelect2($(".newSelect select")),e){var o=$("#moduleName").val();("Leads"!==o&&"Contacts"!==o&&"Potentials"!==o||"skyDesk"===Crm.brandName)&&$(".ecBestTimeScheduleli").addClass("hide"),"editInCompose"===EmailSendingUtil.action&&$("#ecSchduleTime").trigger("click"),EmailSendingUtil.timeInit()}},EmailSendingUtil.loadAndSetScheduleOptions=function(){var e=EmailTabHomeUtil.ACTION+"=loadScheduleOptions",i=$("#bestTime"),t=$("#timeSource"),a=$("#timeZoneSet");i.length>0&&null!==i.val()&&""!==i.val()&&"today"!==i.val()&&"tomorrow"!==i.val()&&t.length>0&&""==t.val()&&(e+="&timeVal="+i.val()),a.length>0&&""!==a.val()&&(e+="&timeZone="+a.val()),(new crmRequestPool).initiate({action:EmailSendingUtil.URL,type:EmailTabHomeUtil.GET_REQUEST_TYPE,data:e,success:function(e){var i=Handlebars.templates.TimeSchedule(e),t=$("#moduleName").val();$("#schedulerPopup").html(i),EmailSendingUtil.besttimeReqflag||$("#ecSelectedDate").text(EmailSendingUtil.besttimedate);var a=null;"Leads"===t||"Contacts"===t?a=$("#ecEntityId").val():"Potentials"===t&&(a=$("#ecRelEntityId").val()),EmailSendingUtil.processAndSetBestTime(EmailSendingUtil.bestTimeData,a),EmailSendingUtil.setUPSchedulePopup(!0)},error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.hideSchedulePopup=function(){$("#newFreezeLayer").addClass("hide"),$("#schedulerPopup,#Calendar").hide()},EmailSendingUtil.assignTimeSchedule=function(e){var i="";if($("#ecSchduleBestTime").is(":checked")){var t=$(".ecSelectedBestTime");t.length>0?(i=EmailSendingUtil.getProperMsg(t.attr("timeVal"),$("#ecSelectedDate").html()),$("#bestTime").val($("#bstDate").val()+"##"+t.attr("time").replace(" ","##")),$("#timeSource").val("bestTime"),Crm.client_tracking("BestTime - Usage",{Module:$("#moduleName").val(),viewType:"Schedule Mail",BestTimeTo:"Text"}),EmailSendingUtil.setTime(i,e)):alert(I18n.getMsg("crm.besttime.mail.msg.none"))}else if($("#ecSchduleSendTime").is(":checked")){var a=$("#upcomingTime"),l=(i=(i=a.val().replace("##",", ")).replace("##"," ")).split(",");i=EmailSendingUtil.getProperMsg(l[1].toUpperCase(),l[0]),$("#timeSource").val("upTime"),$("#bestTime").val(a.val()),EmailSendingUtil.setTime(i,e)}else if($("#ecSchduleTime").is(":checked")){var o=$("#startDate");""!==o.val()?dateTimeValidate("startDate","startDate","Date","G",void 0,void 0,!0)&&EmailSendingUtil.validateAndSetTime(o,e):(alert(I18n.getMsg("crm.besttime.mail.msg.date.empty")),o.focus())}},EmailSendingUtil.getProperMsg=function(e,i,t){i=i.trim();var a="",l=(e=e.toUpperCase().trim()).split(" ");return e="AM"===l[1]||"PM"===l[1]?l[0]+" "+I18n.getMsg(l[1]):l[0]+" "+I18n.getMsg("crm.workflow.scheduler.hours"),t&&(e+=" "+t),i?"today"===i||"Today"===i?(i=I18n.getMsg("Today"),a=I18n.getMsg("crm.besttime.mail.scheduleat")+" "+e+", "+i):"tomorrow"===i||"Tomorrow"===i?(i=I18n.getMsg("Tomorrow"),a=I18n.getMsg("crm.besttime.mail.scheduleat")+" "+e+", "+i):a=I18n.getMsg("crm.besttime.mail.scheduleon")+" "+i+" "+I18n.getMsg("crm.homepage.at")+" "+e:a=I18n.getMsg("crm.besttime.mail.scheduleat")+" "+e+" "+i,a},EmailSendingUtil.validateAndSetTime=function(e,i){var t=EmailTabHomeUtil.ACTION+"=validateTime",a=$("#schTimeMail"),l=$("#startDateampm"),o=$("#timeZone"),n=l.length>0&&""!==l.val()?l.val():"HRS";t+="&time="+e.val()+"##"+a.val()+"##"+n+"##"+encodeURIComponent(o.val()),t+="&"+csrfParamName+"="+csrfToken,(new crmRequestPool).initiate({action:EmailSendingUtil.URL,type:EmailTabHomeUtil.POST_REQUEST_TYPE,data:t,success:function(t){if(t.time&&"Future"===t.time){if($("#defaultTZ").val()!==o.val()){var l=$("#timeZone option[value='"+o.val()+"']").text();l=l.substring(0,l.indexOf(")")+1),time=EmailSendingUtil.getProperMsg(a.val()+" "+n.toUpperCase(),EmailSendingUtil.formattedDate(e.val()),l)}else time=EmailSendingUtil.getProperMsg(a.val()+" "+n.toUpperCase(),EmailSendingUtil.formattedDate(e.val()));$("#timeSource").val("schTime"),$("#bestTime").val(e.val()+"##"+a.val()+"##"+n+"##"+o.val()),Crm.userDetails.isNewEditor?($("#bestTime_"+EmailComposeUtil.CURRENT_TAB).val(e.val()+"##"+a.val()+"##"+n+"##"+o.val()),EmailComposeUtil.setTime(time,i)):EmailSendingUtil.setTime(time,i)}else Crm.userDetails.isNewEditor?crmui.showMsgBand("error",I18n.getMsg("crm.besttime.mail.msg.future"),5e3):alert(I18n.getMsg("crm.besttime.mail.msg.future"))},error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.validateScheduleTime=function(e,i){var t,a=EmailTabHomeUtil.ACTION+"=validateTime",l=$("#schTimeMail"),o=$("#startDateampm"),n=$("#timeZone"),s=o.length>0&&""!==o.val()?o.val():"HRS",m=$("#bestTime");if(EmailSendingUtil.isNewEditor()&&(m=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB)),m.length>0){var r,d=(t=m.val()).split("##"),c=d[0],E=d[1];s=d[2];"today"===c.toLowerCase()||"tomorrow"===c.toLowerCase()||c.toLowerCase().indexOf("to")>-1?(c=EmailDateTimeUtils.convertDateTodayTomorrow(c),r=Crm.userDetails.USER_TIME_ZONE):r=d[3],t=c+"##"+E+"##"+s+"##"+encodeURIComponent(r)}else t=e.val()+"##"+l.val()+"##"+s+"##"+encodeURIComponent(n.val());a+="&time="+t,(new crmRequestPool).initiate({headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},action:EmailSendingUtil.URL,type:EmailTabHomeUtil.POST_REQUEST_TYPE,data:a,success:function(e){e.time&&"Future"===e.time?i():Crm.userDetails.isNewEditor&&crmui.showMsgBand("error",I18n.getMsg("crm.besttime.mail.msg.future"),5e3)},error:EmailTabHomeUtil.handleAjaxAbort})},EmailSendingUtil.formattedDate=function(e){var i=new Date;Utils.convertToUserTimezone(i),newDate=crmBstTime.constructDateObject(e);return Utils.dateEquals(newDate,i)?I18n.getMsg("Today"):newDate-i<864e5&&i<newDate?I18n.getMsg("Tomorrow"):I18n.getMsg(crmBstTime.getDayName(newDate))+", "+I18n.getMsg(crmBstTime.getMonthName(newDate))+" "+newDate.getDate()},EmailSendingUtil.setTime=function(e,i){var t=$("#emc_bestTime");$("#bestTime").prop("checked",!0),t.find("label").html('<span class="fL mR10 mT1" data-zcqa=""></span>'+e),t.removeClass("hide"),EmailSendingUtil.setWindowElementsHeight(),$("#scheduledTime").removeClass("hide"),$("#ecSchduleTrigger").addClass("ecSchedulerBlueIcon"),EmailSendingUtil.hideSchedulePopup(),$("#ecScheduledTime").html(EmailSendingUtil.ScheduledTime+", "+EmailSendingUtil.ScheduledDay),$("#emcSendBtn").val(I18n.getMsg("crm.reportschedule")),$(".ceVariousTextFormattingOptionContainer").css("left",$("#ecMailOptions").outerWidth()),i&&EmailSendingUtil.validate()&&($("#editorMode").val(editor.mode),document.sendMailForm.submit())},EmailSendingUtil.selectCheckBox=function(e){var i=$(e),t=document.getElementById("ecBestTimeListView");if(!(Crm.userDetails.isNewEditor&&i.find(".ecBestTimeList")[0]&&t)||t.innerText!==I18n.getMsg("crm.besttime.mail.msg.none")&&t.innerText!==I18n.getMsg("crm.besttime.mail.record.none")){$("#sDiv").hide();var a=$("#ecUpComing").is(":checked");a||i.find("input[name=ecScheduleTime]").prop("checked",!0),$("#schedulerPopup").find("li").removeClass("ecSelectedSchedule"),i.addClass("ecSelectedSchedule"),i.find("#timeZone").length?a||$("#timeZone").parent().slideDown():$("#timeZone").parent().hide(),i.find("#ecSchduleBestTime").length?$(".ecBestTimeList").find("div:first").addClass("ecSelectedBestTime"):$(".ecSelectedBestTime").removeClass("ecSelectedBestTime"),EmailSendingUtil.isNewEditor()&&setTimeout(EmailCompose.resetSchedulePopupPosition,300)}},EmailSendingUtil.chooseBestTime=function(e){var i=$(e);i.closest("li").trigger("click"),$(".ecSelectedBestTime").removeClass("ecSelectedBestTime"),i.addClass("ecSelectedBestTime"),EmailSendingUtil.ScheduledTime=i.attr("timeVal"),EmailSendingUtil.ScheduledDay=$("#ecSelectedDate").text()},EmailSendingUtil.timeInit=function(){populateTimeVal();var e="h12",i=$(".newtimefrmt");"HH:mm"===Crm.userDetails.TIME_FORMAT&&(e="h24"),i.addClass(e),"HH:mm"!==Crm.userDetails.TIME_FORMAT&&$(".ampmSpan").show(),$(".newtimefrmt,.newtimefrmt input,#startDateampmSpan,#schTimeMail").click((function(){if($("#timesData").find("#sdiv").show().css({left:$(this).offset().left,top:$(this).offset().top+20}),$(this).attr("scrolltoElem")){var e=$("#schTimeMail").attr("time"),i=!1;cur=0,$("#times li").each((function(){if($(this).attr("time")==e){var t=$(this).position().top;$("#sdiv").scrollTop(t),$(this).addClass("li_hover"),i=!0}i||(cur+=1)}))}}))},EmailSendingUtil.featureSpecificHandling=function(){if(null!=window.opener&&window.opener.Crm.CurrentSendEmailSource&&"ChatBot"===window.opener.Crm.CurrentSendEmailSource){var e=window.opener.askZia.getDataFromOpener(),i=new Image(600,400);i.src=e;var t=$(".ze_area").contents().find(".ze_body");t.append("</br></br>"),t.append(i),t.append("<div></br></div>"),delete window.opener.Crm.CurrentSendEmailSource}},EmailSendingUtil.bindZohoFormsFunctions=function(){var e="#zforms_link";EmailSendingUtil.isNewEditor()&&(e=e+"_"+EmailComposeUtil.CURRENT_TAB),$(e).click((function(){var e=Crm.userDetails.LOCALE,i=networkUtils.returnDependencyFiles([e+".js"],crmConstants.jsStaticPathForLyte),t=networkUtils.returnDependencyFiles(["crux_"+e+".js"],crmConstants.jsStaticPathForLyte),a=networkUtils.returnDependencyFiles(["integration/crm-zforms-popup.js"],crmConstants.jsStaticPathForLyte),l=networkUtils.returnDependencyFiles(["integration/crm-zforms-popup.css"],crmConstants.cssStaticPathForLyte),o=i.concat(t).concat(a).concat(l);EmailSendingUtil.isNewEditor()&&$("#emcInsertOption_"+EmailComposeUtil.CURRENT_TAB).hide(),Lyte.injectResources(o,void 0,(function(){var e=$("#moduleName").val();e||void 0===EmailComposeUtil||(e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val());var i=moduleApiMapping&&moduleApiMapping[e]?moduleApiMapping[e]:e;store.findAll("form_links",{module:i,page:EmailSendingUtil.formsPage,per_page:EmailSendingUtil.formsPer_page}).then((function(t){var a={};a.module=e,a.form_links=t,a.entityId=$("#ecEntityId").val();var l="";EmailSendingUtil.isNewEditor()?"undefined"!=typeof editor&&editor&&editor.zEditor&&(l=editor.zEditor.z_win.getSelection()):"undefined"!=typeof editor&&editor&&editor._getSelectedText&&(l=editor._getSelectedText());var o=l?l.toString():"";if(a.title=o,a.formsPer_page=EmailSendingUtil.formsPer_page,a.apiName=i,a.hasNext=!(!t||!t.$.meta)&&t.$.meta.more_records,$L("#lookupdiv").html(""),Lyte.Component.render("crm-zforms-popup",a,"#lookupdiv"),document.getElementById("zforms_popup").ltProp("show",!0),EmailSendingUtil.isNewEditor()&&EmailSendingUtil.composeActive){var n=$L("#zforms_popup")[0],s=n.ltProp("wrapperClass");n.ltProp("wrapperClass",s+" emailComposeZindex")}}))})),window.opener&&window.opener.Crm&&window.opener.Crm.trackSpotLightAction("Forms Integ -EmailPop Insert Forms Link")}))},EmailSendingUtil.isNewEditor=function(){return Crm.userDetails.isNewEditor||EmailSendingUtil.composeActive&&!$("#oldtoNewDiv")[0]},EmailSendingUtil.setUnameAndEmailAddress=function(e){var i=$(e).closest("li"),t=$.trim($(e).val()),a=$("#ecAutoCompleteContainer");a.is(":visible")||t&&(t=t.replace(/,/g,""),EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail(t),EmailSendingUtil.formattedUsernameFromEmail(t),null,i),a.addClass("hide").html(""))},EmailSendingUtil.getAddressesForNewCompose=function(e,i){for(var t,a=[],l=(t=i?$("#"+e+" .selectedEmail,#"+e+" .invalidEmail"):$("#"+e+" .selectedEmail")).length,o=0;o<l;o++){var n={};n.user_name=t[o].getAttribute("username"),n.email=t[o].getAttribute("email"),a.push(n)}return a},EmailSendingUtil.getApiNameForModule=function(e){var i=Crm.userDetails.MODULE_LIST[e],t=e;return i&&(t=i.api_name),t},EmailSendingUtil.isInventoryModule=function(e){return e||(e=$("#moduleName").val()),e||void 0===EmailComposeUtil||(e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val()),"Invoices"===(e=EmailSendingUtil.getApiNameForModule(e))||"Sales_Orders"===e||"Purchase_Orders"===e||"Quotes"===e},EmailSendingUtil.isAutoCompleteSupportedModule=function(e){Crm.userDetails.isNewEditor&&!e&&(e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val());var i=e.startsWith("CustomModule"),t=EmailSendingUtil.isInventoryModule(e);return!!(EmailSendingUtil.AutoCompleteModulesArray.indexOf(e)>-1||i||t)},EmailSendingUtil.addAttachmentsFromCloudPicker=function(e){var i=document.querySelector("crm-cloud-picker").component;i.hidePicker.call(i),$.each(e,(function(e,i){if(Crm.userDetails.isNewEditor){var t={};t.file_name=i.File_Name,t.file_size=null,t.id=i.$doc_id,t.id=i.$cloud_account_id,t.file_path=i.$file_path,t.file_details=i,t.service_name="otherDrives::"+i.$type,editor.zEditor.showLoadingAttachment(),zEditor.prototype.uploadFiles(t)}else i.service_name="otherDrives::"+i.$type,EmailSendingUtil.saveAndUploadDocs(JSON.stringify(i))}))},EmailSendingUtil.openOtherDriveAttachment=function(e){var i={feature:"attachments",cloud_services:"gdrive,box,skydrive",callback:EmailSendingUtil.addAttachmentsFromCloudPicker,max_file_selection:5};e&&(i.cloud_services="gdrive,box,skydrive,dropbox,evernote"),Lyte.registeredMixins["crm-cloud-picker-mixin"].loadCloudPicker(i)},EmailSendingUtil.getFontList=function(){return{Arial:"Arial,Helvetica,sans-serif",Calibri:"Calibri,Candara,Segoe,Segoe UI,Optima,Arial,sans-serif","Comic Sans MS":"Comic Sans MS,cursive,sans-serif","Courier New":"Courier New,Courier,monospace",Georgia:"Georgia,Times New Roman,Times,serif","Lucida Console":"Lucida Console,Monaco,monospace","Lucida Sans Unicode":"Lucida Sans Unicode,Lucida Grande,sans-serif","MS Serif":"MS Serif,New York,serif",Tahoma:"Tahoma,Geneva,sans-serif","Times New Roman":"Times New Roman,Times,serif","Trebuchet MS":"Trebuchet MS,Arial,Helvetica,sans-serif",Verdana:"Verdana,Geneva,sans-serif"}},EmailSendingUtil.setDefaultValues=function(){var e=EmailSendingUtil.signDetails;e.font_size&&editor.doc.execCommand("fontsize",!1,{8:"1",10:"2",12:"3",14:"4",18:"5",24:"6",36:"7"}[e.font_size]),e.font_family&&editor.doc.execCommand("fontname",!1,EmailSendingUtil.getFontList()[e.font_family]);var i=EmailSendingUtil.signDetails.default_from_address.email,t=EmailSendingUtil.signDetails.default_from_address.type,a=$("#addrsVal");a.attr("selectedval",i),"org_email"===t&&($("#isOrgEmail").val(!0),EmailSendingUtil.signDetails.default_from_address.user_name&&(i=EmailSendingUtil.signDetails.default_from_address.user_name+"<"+i+">")),a.text(i)},EmailSendingUtil.setSignature=function(e){var i;if(!document.getElementById("editorSignatureContainer")&&$("#ceCleartemplate").parent().hasClass("hide")){if(e){var t=e.indexOf("<"),a=e.indexOf(">");-1!==t&&-1!==a&&t<a&&(e=e.slice(t+1,a))}var l=!1,o=EmailSendingUtil.signDetails.email_signatures;if(o)for(var n=o.length,s=0;s<n&&!l;s++)if(e&&o[s].from){for(var m=o[s].from.length,r=0;r<m;r++)if(e===o[s].from[r].email){i=o[s].content,l=!0;break}}else if(o[s].default){i=emailSignatures[s].content;break}var d=editor.mode,c=editor.doc.getElementById("ecw_signature"),E=$L(".ze_area").contents().find(".ze_body")[0];if("richtext"===d){if(e&&c)return i||(i=""),void(c.innerHTML=i);i=i?"<br><br><br><br><br><br><br><br><br><br><br><br><span data-zbluepencil-ignore='true' id='ecw_signature'><br><br>"+i+"</span>":"<br><br><br><br><br><br><br><br><br><br><br><br><span data-zbluepencil-ignore='true' id='ecw_signature'><br><br></span>",c||(E.innerHTML.includes("<div>")?editor.setContent(i):E.innerHTML=e?E.innerHTML+i.replace("<br><br><br><br><br><br><br><br><br><br><br><br><br>",""):E.innerHTML+i.replace("<br><br><br><br><br><br><br><br><br>",""))}else e&&i&&editor.getContent()?editor.setContent(editor.getContent()+"\n"+EmailSendingUtil.convertToPlainText(i)):i=i?"\n\n\n\n"+EmailSendingUtil.convertToPlainText(i):"\n\n\n\n"}},EmailSendingUtil.closeTabALertPopup=function(){if(!EmailSendingUtil.openTabALertPopup){var e=$L("#ecwTabPop")[0];e&&e.ltProp("show",!1)}},EmailSendingUtil.convertToPlainText=function(e){var i=document.createElement("div");i.innerHTML=e.replace(/<(p|div|h\\d|br)>/gi,"\n");var t=i.innerText;return i=void 0,t};var EmailComposeUtil={mailSentStatus:!1,APIBaseURL:"/crm/email/v2",InlineImageURL:"/Emails/inline_images",ComoposeMailData:void 0,resourcesLoaded:!1,editorLoaded:!1,hasDictionarySourceAdded:!1,editorContent:"",freezeLayerId:"z1_freezeLayer",DraftsAction:"Email_Drafts",Draft_Root_Element:"Email_Drafts",DraftAPIURL:"/crm/v2",draftInterval:null,sessionStoredDraftDetails:null,sessionStoredDraftId:null,isAutoCorrectionEnabled:!0,FILE_SIZE:"file_size",FILE_NAME:"file_name",FILE_ID:"id",SERVICE_NAME:"service_name",Attachment:{}};EmailComposeUtil.Attachment.Desktop="Desktop",EmailComposeUtil.Attachment.ZFS_ATTACHED="ZFSAttached",EmailComposeUtil.INVENTORY_DETAILS="inventory_details",EmailComposeUtil.GET_TEMPLATE_DETAIL_BY_ID="getTemplatesDetailById",EmailComposeUtil.EDIT_IN_COMPOSE="editInCompose",EmailComposeUtil.totalAttachmentSize="10 MB",EmailComposeUtil.INVENTORY_TEMPLATE_API_URL="/crm/v2/settings/inventory_templates",EmailComposeUtil.RL_Attachments={},EmailComposeUtil.RL_Attachments.ATTACHMENT_ID="id",EmailComposeUtil.RL_Attachments.ZFS_FILE_ID="$file_id",EmailComposeUtil.RL_Attachments.FILE_NAME="File_Name",EmailComposeUtil.RL_Attachments.FILE_SIZE="Size",EmailComposeUtil.RL_Attachments.CREATED_TIME="Created_Time",EmailComposeUtil.RL_Attachments.MODIFIED_TIME="Modified_Time",EmailComposeUtil.RL_Attachments.FILES_COUNT=10,EmailComposeUtil.MAX_TAB_COUNT=5,EmailComposeUtil.CURRENT_TAB=0,EmailComposeUtil.TAB_COUNT=0,EmailComposeUtil.OPEN_TAB_COUNT=0,EmailComposeUtil.tabIdPrefix="ecw_tab_",EmailComposeUtil.contentIdPrefix="composeContentPanel_",EmailComposeUtil.editorObj={},EmailComposeUtil.tabDetails={},EmailComposeUtil.composeSettingObj=null,EmailComposeUtil.TEMP_TAB=void 0,EmailComposeUtil.disableAttachSizeCalc=!1,EmailComposeUtil.isReplyMail=!1,EmailComposeUtil.isCloseAll=!1,EmailComposeUtil.isRefresh=!1,EmailComposeUtil.tempFontSize="",EmailComposeUtil.isConsentEmail=[],EmailComposeUtil.dataReqObj=[],EmailComposeUtil.lastDraftUpdatedTime=0,EmailComposeUtil.replyOrForWardMail=[],EmailComposeUtil.tempforwardAttach=[],EmailComposeUtil.handleTemplateAttachments=function(e,i,t){var a=e.split(";"),l=i.split(";"),o=t.split("&#x3b;"),n=0,s=a.length;for(n=0;n<s&&""!==a[n];n++){var m,r=l[n];o[n]&&(m=o[n].split("&#x3a;&#x3a;")[2]);var d=a[n],c=EmailComposeUtil.getFormattedAttachmentDetails(m,d,r,"RawZFSFile");editor.zEditor.displayAttachment(c)}},EmailComposeUtil.formatAttachmentSize=function(e){var i=parseInt(e)/1048576;return e=i>=1||i<=-1?(i=i.toPrecision(3))+" MB":(i=parseInt(e)/1024)>=1||i<=-1?(i=i.toFixed())+" KB":parseInt(e)+" Bytes"},EmailComposeUtil.setMessagesForAlerts=function(){EmailSendingUtil.maxLimitExceedsMsg.to=I18n.getMsg("crm.email.to.check"),EmailSendingUtil.maxLimitExceedsMsg.bcc=I18n.getMsg("crm.email.bcc.check"),EmailSendingUtil.maxLimitExceedsMsg.cc=I18n.getMsg("crm.email.cc.check"),EmailSendingUtil.maxLimitExceedsMsg.replyTo=I18n.getMsg("crm.email.inreplyto.check"),EmailSendingUtil.maxLimitExceedsMsg.toCcBcc=I18n.getMsg("crm.email.toccbcc.check")},EmailComposeUtil.assignTimeSchedule=function(e){var i="",t=$("#ecUpComing");if($("#ecSchduleBestTime").is(":checked")){var a=$(".ecSelectedBestTime");if(!(a.length>0))return crmui.showMsgBand("error",I18n.getMsg("crm.besttime.mail.msg.none"),5e3),!1;i=EmailSendingUtil.getProperMsg(a.attr("timeVal"),$("#ecSelectedDate").html()),$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).val($("#bstDate").val()+"##"+a.attr("time").replace(" ","##")),$("#timeSource_"+EmailComposeUtil.CURRENT_TAB).val("ecSchduleBestTime"),EmailComposeUtil.setTime(i,e)}else if($("#ecOneHourAhead").is(":checked")){var l=new Date;Utils.convertToUserTimezone(l);var o,n=("0"+l.getHours()).slice(-2),s=("0"+l.getMinutes()).slice(-2),m="today",r=Crm.userDetails.TIME_FORMAT;n=parseInt(n),s=parseInt(s),n>=23?(m="tomorrow",n=0):n+=1,"hh:mm a"===r?(n<12?o="AM":n>=12&&(o="PM"),i=(n=("0"+(n=n<=12?n:n-12)).slice(-2))+":"+(s=("0"+s).slice(-2))+" "+o):i=(n=("0"+n).slice(-2))+":"+(s=("0"+s).slice(-2))+" "+I18n.getMsg("crm.workflow.scheduler.hours"),$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).val(m+"##"+i.replace(" ","##")),i=EmailSendingUtil.getProperMsg(i,m),$("#timeSource_"+EmailComposeUtil.CURRENT_TAB).val("ecOneHourAhead"),EmailComposeUtil.setTime(i,e)}else if(t.is(":checked")){var d=t.val(),c=(r=Crm.userDetails.TIME_FORMAT,d.split("##")),E=(l=c[0],i=c[1],c[2]);"hh:mm"===r.toLowerCase()&&(i="20:00",E=I18n.getMsg("crm.workflow.scheduler.hours"));var p=(d=l+"##"+i+"##"+E).replace("##",", "),u=(p=p.replace("##"," ")).split(",");p=EmailSendingUtil.getProperMsg(u[1].toUpperCase(),u[0]),$("#timeSource_"+EmailComposeUtil.CURRENT_TAB).val("ecUpComing"),$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).val(d),EmailComposeUtil.setTime(p,e)}else if($("#ecSchduleTime").is(":checked")){var g=$("#tab_startDate_"+EmailComposeUtil.CURRENT_TAB);""!==g.val()?dateTimeValidate("startDate","startDate","Date","G",void 0,void 0,!0)&&EmailSendingUtil.validateAndSetTime(g,e):(renderingUtils.showCustomAlert(I18n.getMsg("crm.besttime.mail.msg.date.empty")),g.focus()),$("#timeSource_"+EmailComposeUtil.CURRENT_TAB).val("ecSchduleTime")}},EmailComposeUtil.setTime=function(e,i){var t=$("#emc_bestTime_"+EmailComposeUtil.CURRENT_TAB),a=$("#ecMailOptions").outerWidth();$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).prop("checked",!0),EmailSendingUtil.checkButtonName(),t.find("label").html('<span class="fL mR10 mT1" data-zcqa=""></span>'+e),t.removeClass("hide"),EmailSendingUtil.setWindowElementsHeight();var l=$("#startDate");$("#tab_startDate_"+EmailComposeUtil.CURRENT_TAB).val(l.val()),EmailUtil.hideSchedulePopUp(),$("#ecScheduledTime_"+EmailComposeUtil.CURRENT_TAB).html(EmailSendingUtil.ScheduledTime+", "+EmailSendingUtil.ScheduledDay),$(".ceVariousTextFormattingOptionContainer_"+EmailComposeUtil.CURRENT_TAB).css("left",a),i&&EmailCompose.sendMail(i)},EmailComposeUtil.setIntialValuesForScheduleMail=function(){var e=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB);e[0].value=e[0].value.replace(/[']/g,"");var i,t=e.is(":checked"),a=$("#startDate"),l=$("#schTimeMail");if($("#tab_startDate_"+EmailComposeUtil.CURRENT_TAB).val(a.val()),l.focus(),t){i=e.val();var o=(i=EmailDateTimeUtils.formatDate(i)).getDate(),n=i.getMonth(),s=i.getFullYear();crmCalendar.setCalendarNode=a,crmCalendar.displaySelectedDate(o+" "+n+" "+s,a);var m=Utils.getTimeInUserFormat(i);l.focus();var r=Crm.userDetails.TIME_FORMAT;m=EmailComposeUtil.getNextFormattedScheduleTime(m,r),sdTime||(sdTime=$(".ddTime")),setTime(m),l.focus()}},EmailComposeUtil.deleteDraft=function(e,i,t,a){var l=EmailComposeUtil.getAPIDraftURL(e,i,t);(new crmRequestPool).initiate({url:l,type:"DELETE",headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},success:function(i){if("success"===(i=i.Email_Drafts[0]).status){e=i.details.id;var t=EmailComposeUtil.getTabIdContainingGivenDraft(e);t&&!a&&EmailUtil.closeEmailTab(t,!0),EmailComposeUtil.removeDraftIdFromSessionStorage(e),($("#maxComposeBtn").hasClass("hide")&&!EmailSendingUtil.composeActive||$("#draftMails").hasClass("selectTab"))&&EmailComposeUtil.refreshDraftsList()}else"NO_PERMISSION"===i.code?EmailUtil.showMsg("error",I18n.getMsg("crm.security.error"),3e3):EmailUtil.showMsg("error",I18n.getMsg("crm.email.no.drafts.msg"),3e3)},error:function(i){i=i.responseJSON;var t=$("#deleteDraftIcon")[0],l=$("#"+e+"relatedlist")[0];t&&(t.classList.remove("loading"),t.classList.add("deleteIcon")),l&&(l.classList.remove("loading"),l.classList.add("deleteIcon")),EmailSendingUtil.composeActive&&!a&&EmailUtil.closeMailContentView(!0),"NO_PERMISSION"===i.code?EmailUtil.showMsg("error",I18n.getMsg("crm.security.error"),3e3):i.message&&i.message.includes("The record is in stop processing")?EmailUtil.showMsg("error",I18n.getMsg("crm.email.error.draft.delete.locked"),3e3):i.responseJSON&&"the related id given seems to be invalid"===i.responseJSON.message?EmailUtil.showMsg("error",I18n.getMsg("crm.email.label.error.item_deleted_or_removed",I18n.getMsg("Record")),3e3):EmailUtil.showMsg("error",I18n.getMsg("crm.email.no.drafts.msg"),3e3)}})},EmailComposeUtil.refreshDraftsList=function(){try{var e=$("#selectMails"),i="";if(void 0!==e&&e.length>0||$("#draftMails").length>0)if("DRAFTS"===e.val()){var t=$("#mailNav #navigationIndex");if(t&&t.length>0)var a=t.text(),l=parseInt(a)-10+"",o=$("#mailNav #navigationEntityId").text(),n=$("#mailNav #navigationModule").text(),s=$("#mailNav #navigationFullname").text();else l=-10,o=$("#entityId").val(),n=$("#module").val(),s=$("#fullname").val();var m=$("#mailTable").children().children(".topband_dv_row").length;l>=0&&m<=1&&(i="previous"),showMailsList(o,"",s,"",l,i,n)}else $("#isFromNewAPI").length>0&&$("#draftMails span").trigger("click")}catch(e){return!1}},EmailComposeUtil.getAPIUrl=function(e,i,t){return EmailComposeUtil.APIBaseURL+e+"/"+i+"/actions/"+t},EmailComposeUtil.postFormSubmission=function(e,i,t,a,l,o,n,s,m){var r=$("#emc_msg_Tab"),d=document.getElementById("navigationRefreshKey"),c=$("#emailDetailIframeContent").is(":visible");if(r.css({"z-index":"100",left:(EmailTabHomeUtil.ViewPortWidth-r.outerWidth())/2}),r.hide(),"SUCCESS"===e){if(r.attr("data-zcqa","emc_SendTab_Success"),EmailSendingUtil.isEntityWindow){$(window).off("beforeunload"),$(window).off("unload");var E=$("#bestTime");E.length>0&&E.is(":checked")&&""!==E.val()?$("#emailEntityComposepopup").html(I18n.getMsg("crm.case.schedule.message")):$("#emailEntityComposepopup").html(I18n.getMsg("crm.case.sent.message"));var p=$("#cmpCloseWindowOptn");cmpKanbanView.length>0&&"true"===cmpKanbanView.val()&&p.length?renderingUtils.triggerEvent("click",p):getOpenerObj("relatedPageContent")&&(d||!c?(EmailSendingUtil.refreshEmailRelList(),EmailSendingUtil.isConsentEmail&&opener.DataPrivacy.loadDataPrivacy($("#newleft_DataPrivacy")),"null"!==m&&void 0!==m&&$(getOpenerObj("dataRequestMailLink_"+m)).removeClass("dataRequestMailLink cP").text(I18n.getMsg("crm.data.subject.mail.sent")).unbind("click").addClass("eventNone")):$(getOpenerObj("navigationRefreshKey")).html("true"))}else r.removeAttr("data-zcqa"),EmailActionHandling.closeCompose(EmailSendingUtil.action,!0,i,t,a,n,s),EmailSendingUtil.constructDivElements(i,o,t,l,"CRM_EMAIL"),EmailSendingUtil.fetchMailsFromFolder("Sent");EmailSendingUtil.mailSentStatus=!0}else{if(e.indexOf(I18n.getMsg("crm.email.spam"))>-1){var u=e.split("::");e=u[0];var g=u[1];if(r.html(e+" "),null!==g&&""!==g&&"null"!==g){var C=document.createElement("a");C.setAttribute("id","EditTemplate"),C.setAttribute("href",Crm.getCrmBasePath()+"/settings/templates?type=email&step=edit&templateId="+g);var U=$("#ecTemplateId").val();void 0!==EmailSendingUtil.templateIdVsDetail[U]&&delete EmailSendingUtil.templateIdVsDetail[U],C.setAttribute("target","_blank"),C.text=" "+I18n.getMsg("crm.templates.edit.template"),document.getElementById("emc_msg_Tab").append(C)}}else r.html(e);r.attr("data-zcqa","emc_SendTab_Error"),EmailSendingUtil.isEntityWindow?($("#emailEntityComposeOverlay").hide(),$("#emailEntityComposepopup").hide(),setTimeout((function(){r.css("left",($(document).outerWidth()-r.outerWidth())/2).show()}),100)):setTimeout((function(){r.css("left",(EmailTabHomeUtil.ViewPortWidth-r.outerWidth())/2).show()}),100),setTimeout((function(){r.hide(),r.removeAttr("data-zcqa"),r.html("Loading...")}),8e3)}EmailSendingUtil.isEmailProgressing=!1},EmailComposeUtil.setUPSchedulePopup=function(){var e=$("#schedulerPopup"),i=(renderingUtils.windowOuterHeight-e.outerWidth())/2,t=(renderingUtils.windowOuterHeight-e.outerHeight())/2;$("#newFreezeLayer").removeClass("hide").css({opacity:"0.15"}),e.css({top:t,left:i}).show()},EmailComposeUtil.closeAllAlertPop=function(){EmailSendingUtil.closeTabALertPopup();var e=$L("#ecwSignaturePop")[0];e&&e.ltProp("show",!1);var i=$L("#ecwCloseAllPop")[0];i&&i.ltProp("show",!1);var t=$L("#ecwSubjectModal")[0];t&&t.ltProp("show",!1);var a=$L("#ecwDraftPop")[0];a&&a.ltProp("show",!1)},EmailComposeUtil.hideAllComposeRelatedPopup=function(){if(crmui.hideMsgBand(),EmailCompose.hideSchedulePop(),template){template.compCloseComponentPop();var e=$("#templateAnalyticsDIV");e&&e.hide()}ZSurvey.cancelPopup("lookupdiv");var i=$L("#zforms_popup")[0];i&&i.ltProp("show",!1);var t=$("#customConfirmationPop");t.length>0&&t.is(":visible")&&hideAnimatePopup("customConfirmationPop"),document.getElementById("linkdocsdialogdiv")&&ZDDialog.closePopUp("linkdocsdialogdiv"),document.getElementById("attachfiledialogdiv")&&ZDDialog.closePopUp("attachfiledialogdiv");var a=document.getElementById("attachdialogdiv"),l=document.getElementById("zohodocsframe");a&&(a.style.display="none"),l&&(l.style.display="none")},EmailComposeUtil.setSubject=function(e){var i=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB);i.val(e),EmailComposeUtil.updateTheEmailTabNameWithTheSubjectName(i)},EmailComposeUtil.setFromAddress=function(e,i){return EmailSendingUtil.OrgEmailArray&&EmailSendingUtil.OrgEmailArray.contains(e)&&EmailSendingUtil.other_emails_array&&!EmailSendingUtil.other_emails_array.contains(e)||i?EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!0:EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!1,$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB+" option[value='"+$.escapeSelector(e)+"']").length>0&&($("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).val(e).select2().trigger("change"),!0)},EmailComposeUtil.setReplyToAddress=function(e){e&&($("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB+" option[value='"+$.escapeSelector(e)+"']").length>0&&($("#ceReplyToLink_"+EmailComposeUtil.CURRENT_TAB).trigger("click"),$("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB).val(e).select2().trigger("change")))},EmailComposeUtil.zeCreate=function(e,i,t,a,l){var o,n=CrmEmailInitialize.ComposeMailData.user.compose_settings;if(o=EmailComposeUtil.composeSettingObj?EmailComposeUtil.composeSettingObj:{editorContainer:EmailComposeUtil.contentIdPrefix+e,parentElement:"emailEditor",toolbarPosition:"top",id:"editorContent_"+e,css:["inline_editor_min.css"],fontSize:{8:"1",10:"2",12:"3",14:"4",18:"5",24:"6",36:"7"}[n.font_size],fontFamily:{Arial:"Arial,Helvetica,sans-serif",Calibri:"Calibri,Candara,Segoe,Segoe UI,Optima,Arial,sans-serif","Comic Sans MS":"Comic Sans MS,cursive,sans-serif","Courier New":"Courier New,Courier,monospace",Georgia:"Georgia,Times New Roman,Times,serif","Lucida Console":"Lucida Console,Monaco,monospace","Lucida Sans Unicode":"Lucida Sans Unicode,Lucida Grande,sans-serif","MS Serif":"MS Serif,New York,serif",Tahoma:"Tahoma,Geneva,sans-serif","Times New Roman":"Times New Roman,Times,serif","Trebuchet MS":"Trebuchet MS,Arial,Helvetica,sans-serif",Verdana:"Verdana,Geneva,sans-serif"}[n.font_family],js:["InitializeDictionary.js"],composerHeight:"240px",domElements:[{element:"emcc_bestTime",appendAfter:"composeEditor"}],afterEditorLoad:function(i){i&&(EmailComposeUtil.tabDetails[e].zEditor=i,EmailComposeUtil.tabDetails[e].spellCheck={}),EmailCompose.postEditorLoad(l)},resourcesLoaded:t,tableResize:!0,parentFeature:"CrmEmail",dictionaryURL:crmConstants.dictionaryStaticURL,uploadImage:"/crm/v2/emails/attachments/upload",uploadAttachemnt:"/crm/v2/files",uploadThirdPartyAttachment:"/crm/v2/_internal/emails/attachments/add_attachment",attachmentSizeLimit:"10485760",tabId:e,activeTabId:EmailComposeUtil.tabIdPrefix+e,activeTabContentId:EmailComposeUtil.contentIdPrefix+e,toolbarOptions:[{attachment:{label:I18n.getMsg("crm.label.addons.gdocs"),cmd:"g_docs",callback:function(){EmailAttachmentsUtil.openForDocs("gdoc",RebrandLinkUtil.getProperty("GadGetsURL"),RebrandLinkUtil.getProperty("CRMURL")),EmailComposeUtil.handleAttachmentPopupInEditor()}}},{attachment:{label:I18n.getMsg("Zoho")+" "+I18n.getMsg("crm.gapp.attach.docs.br"),cmd:"z_docs",callback:function(){EmailAttachmentsUtil.openForDocs("zdoc",RebrandLinkUtil.getProperty("docsURL")),EmailUtil.showCustomFreezeLayer(),EmailComposeUtil.handleAttachmentPopupInEditor()}}},{attachment:{label:moduleRecordMapping.Documents.singular_label,cmd:"show_docs",callback:function(){EmailAttachmentsUtil.openZDocsLinkDialog(a),EmailComposeUtil.handleAttachmentPopupInEditor()}}},{attachment:{label:I18n.getMsg("crm.label.teamdrive"),cmd:"team_drive",callback:function(){EmailAttachmentsUtil.openForDocs("teamdrive",RebrandLinkUtil.getProperty("teamdriveURL")),EmailComposeUtil.handleAttachmentPopupInEditor()}}},{attachment:{label:I18n.getMsg("crm.email.entattach.label.entattach"),cmd:"rel_list_attach",callback:function(){EmailAttachmentsUtil.showRelatedListAttachment()}}},{attachment:{label:I18n.getMsg("crm.attach.cloud.picker"),cmd:"crm.attach.cloud.picker",callback:function(){var e={feature:"attachments",cloud_services:"gdrive,box,skydrive",callback:EmailSendingUtil.addAttachmentsFromCloudPicker,max_file_selection:5};CrmEmailInitialize.ComposeMailData.features_available.EMAIL_CLOUD_PICKER&&(e.cloud_services="gdrive,box,skydrive,dropbox,evernote"),Lyte.registeredMixins["crm-cloud-picker-mixin"].loadCloudPicker(e),EmailComposeUtil.handleAttachmentPopupInEditor()}}}]},EmailComposeUtil.editorLoaded=!1,EmailComposeUtil.isPrivacyEnabled()){var s={links:{label:"Consent Form",cmd:"consentform",callback:function(){CustomizeEditor.openAddLinkPop("consentFormLink")}}},m={links:{label:"Data Request",cmd:"datarequest",callback:function(){CustomizeEditor.openAddLinkPop("dataRequestLink")}}};o.toolbarOptions.push(s),o.toolbarOptions.push(m)}var r={links:{label:I18n.getMsg("crm.unsubscription.link"),cmd:"unSubscriptionLink",id:"unsubscribeLinkLi",callback:function(){CustomizeEditor.openAddLinkPop("unsubscribeLink")}}};if(o.toolbarOptions.push(r),EmailLaunchUtil.isInitialResourceLoaded||EmailComposeUtil.composeSettingObj)if("undefined"!=typeof ZBluePencil&&ZBluePencil){var d=networkUtils.returnDependencyFiles(["inlineEmailCompose_min.js"],crmConstants.jsStaticPath).concat(networkUtils.returnDependencyFiles(["crm-email-subjectpop.js"],crmConstants.jsStaticPathForLyte));d=d.concat(networkUtils.returnDependencyFiles(["email-emotions.js"],crmConstants.jsStaticPathForLyte));var c=networkUtils.returnDependencyFiles(["inline_ComposeEditor_min.css"],crmConstants.cssStaticPath).concat(networkUtils.returnDependencyFiles(["crm-email-subjectpop.css"],crmConstants.cssStaticPathForLyte)),E=[networkUtils.getI18nJSUrl("emailcompose"),networkUtils.getI18nJSUrl("emaileditor"),networkUtils.getI18nJSUrl("emailsRelatedList")],p=Lyte.injectResources(networkUtils.returnDependencyFiles(E,crmConstants.jsStaticPath),void 0,void 0),u=d.concat(c).concat(p);EmailLaunchUtil.resources_1=u,Lyte.injectResources(u,void 0,(function(){"undefined"!=typeof ZBluePencil&&ZBluePencil||Lyte.injectResources(o.dictionaryURL,void 0,(function(){})),editor.create(o)}))}else Lyte.injectResources(o.dictionaryURL,void 0,(function(){editor.create(o)}))},EmailComposeUtil.initialize=function(e,i,t){EmailComposeUtil.ComposeWindowLoaded?EmailComposeUtil.zeCreate(e,i,l,a,t):(EmailComposeUtil.appendInitialDOMElements(),EmailComposeUtil.zeCreate(e,i,EmailComposeUtil.resourcesLoaded,Crm.userDetails.ZGID,t),EmailComposeUtil.setInitialValues(),EmailSendingUtil.templatesFetched=!1,EmailSendingUtil.activeModule="");var a=EmailComposeUtil.ComposeMailData.user.zgid,l=EmailComposeUtil.resourcesLoaded;(i=i||"richtext",setTimeout((function(){EmailSendingUtil.timeInit(),EmailComposeUtil.doBindings()}),2500),EmailComposeUtil.bindSurveyEvents(),EmailComposeUtil.bindOrgEmailEvent(),EmailSendingUtil.bindZohoFormsFunctions(),""===$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).val())&&$("#emc_bestTime_"+EmailComposeUtil.CURRENT_TAB).addClass("hide");$("#emailTempModule_"+EmailComposeUtil.CURRENT_TAB).val(""),EmailComposeUtil.ComposeWindowLoaded=!0,EmailSendingUtil.composeActive=!0},EmailComposeUtil.setInitialValues=function(){EmailComposeUtil.sessionStoredDraftDetails=null;var e=$("#jsonForMergefields_"+EmailComposeUtil.CURRENT_TAB),i={};i&&(i=EmailComposeUtil.ComposeMailData.mergeFieldsData,i=JSON.parse(i),e.data("mergeFieldsData",i))},EmailComposeUtil.bindSalesIqLink=function(){var e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),i=!!(e=e?e.toUpperCase():e)&&("LEADS"===e||"CONTACTS"===e),t=$("#ecw_insertSalesIqLink_"+EmailComposeUtil.CURRENT_TAB);t&&i&&(t.removeClass("hide"),t.show(),EmailSendingUtil.bindSalesIqLinkEvents())},EmailComposeUtil.bindSurveyEvents=function(){var e=CrmEmailInitialize.ComposeMailData.features_available.zsurvey_enabled,i=Crm.userDetails.IS_ADMIN,t=$("#composeEditor");if(e)EmailComposeUtil.bindInsertSurvey();else{var a,l=EmailComposeUtil.getContextHelpURL("help.zsurvey.index");if(l=String(l),t)a=i?'<div class="ppContSlide etInsertSurvey dIB pA" style="display:none;"><div class="pR"><div class="secOneSlide secSlide activeSlide"><div class="secSlideHd f14 color_4f">'+I18n.getMsg("crm.survey.mailpopup.commessage1.new",[Crm.brandName,Crm.appName])+'</div><div class="secSlideDesc f12 color_4f mT15">'+I18n.getMsg("crm.survey.mailpopup.adminmsg1")+'</div></div></div><div class="slideFooter pR cBafter"><a href="javascript:;" onclick="ZSurvey.redirectToSurvey()" >'+I18n.getMsg("crm.tpi.ctiapi.label.knowmore")+'</a><div class="fSlideBut fR"><input type="button" class="slideBut f12 cP" value="'+I18n.getMsg("crm.label.yes")+'" onclick="ZSurvey.redirectToSurvey()" ><a href="javascript:;" class=" gray2 f12 mL10" onclick="EmailUtil.hidecallout()">'+I18n.getMsg("crm.zsurvey.label.doit.later")+"</a></div></div></div>":'<div class="ppContSlide etInsertSurvey dIB pA" style="display:none;"><div class="pR"><i class="setDDPopupAbGzs"><i class="setDDPopupAzs"></i></i><div class="pR" style="height:128px;overflow:hidden;"><div class="secOneSlide secSlide p30 pA activeSlide"><div class="secSlideHd f14 color_4f">'+I18n.getMsg("crm.survey.mailpopup.commessage1.new",[Crm.brandName,Crm.brandName])+'</div><div class="secSlideDesc f12 color_4f mT15">'+I18n.getMsg("crm.survey.mailpopup.othermsg1",Crm.brandName)+'</div></div></div></div><div class="slideFooter pR">'+I18n.getMsg("crm.label.formoredetails")+'&nbsp;<a href="javascript:openHelp('+l+');">'+I18n.getMsg("crm.webtoentity.generate.html")+'</a><div class="fSlideBut pA"><a href="javascript:;" class=" gray2 f12 mL10" onclick="EmailUtil.hidecallout()">'+I18n.getMsg("crm.button.close")+'</a><div class="clearB"></div></div><div class="clearB"></div></div></div>',t.append(a),EmailSendingUtil.bindSurveyEvents()}},EmailComposeUtil.bindInsertSurvey=function(){$(".surveyLink").click((function(){var e=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val();$(this).attr("data-params",'{"action":"surveyDetails","from":"email","entityId":"'+e+'"}'),ZSurvey.showSurveyDetails(this)}))},EmailComposeUtil.doBindings=function(){EmailSendingUtil.closeTabALertPopup(),EmailComposeUtil.toggleClickEventForEditor("bind"),$("#"+EmailComposeUtil.activeContentId+" .ceComposeSummary").on("click",EmailComposeUtil.displayComposeMetaFields),$("#wmsstatusbar").on("click",(function(e){"maxComposeBtn"!==e.target.parentNode.id&&EmailSendingUtil.composeActive&&EmailCompose.etMinimiseCompose()})),$("#wVisTitBar").on("click",(function(e){"maxComposeBtn"!==e.target.parentNode.id&&EmailSendingUtil.composeActive&&EmailCompose.etMinimiseCompose()})),$("#secondaryEmailOption_"+EmailComposeUtil.CURRENT_TAB).hover((function(){var e=$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB),i=$(this),t=i.offset().top+i.outerHeight()+10;e.show(),e.css("top",t)})),$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).hover((function(){$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).show()}),(function(){$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).hide()})),EmailComposeUtil&&"999"===EmailComposeUtil.CURRENT_TAB&&EmailComposeUtil.hideAllComposeRelatedPopup()},EmailComposeUtil.toggleClickEventForEditor=function(e){"bind"===e?$("#"+EmailComposeUtil.activeContentId+" .z_editor").contents().find("body").on("click",(function(){EmailComposeUtil.showComposeMetaSummary(),EmailComposeUtil.hideEditorPopups()})):"unbind"===e&&($("#"+EmailComposeUtil.activeContentId+" .z_editor").contents().find("body").off("click"),EmailComposeUtil.hideEditorPopups()),$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).hide()},EmailComposeUtil.getEntityDetailsFromDB=function(e,i,t){var a=EmailComposeUtil.getApiNameForModule(e),l="/crm/v2/"+a+"/"+i;if((new crmRequestPool).initiate({url:l,type:"GET",data:"approved=both",headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},content:"application/json; charset=UTF-8",dataType:"json",success:function(e){var l=(e=e?e.data[0]:{}).Email?e.Email:"",o=e.Secondary_Email?e.Secondary_Email:"",n=l||o,s=e.Full_Name?e.Full_Name:e.Name;if(l&&o){var m=EmailComposeUtil.getFormattedEmailAddress(s,l),r=EmailComposeUtil.getFormattedEmailAddress(s,o);EmailCompose.addSecondaryMailDropDown(m,r)}if("draft"!==t&&EmailCompose.setMailAddress(n,s,"To"),$("#ecId_"+EmailComposeUtil.CURRENT_TAB).val(i),$("#ecEmailId_"+EmailComposeUtil.CURRENT_TAB).val(n),$("#ecFullname_"+EmailComposeUtil.CURRENT_TAB).val(s),EmailSendingUtil.toAddr=EmailComposeUtil.getFormattedEmailAddress(s,n),Lyte.registeredMixins["crm-email-emotions-mixin"])Lyte.registeredMixins["crm-email-emotions-mixin"].getPreviousMailDetailsFromDB(a,i);else{var d=networkUtils.returnDependencyFiles(["email-emotions.js"],crmConstants.jsStaticPathForLyte);Lyte.injectResources(d,void 0,(function(){Lyte.registeredMixins["crm-email-emotions-mixin"].getPreviousMailDetailsFromDB(a,i)}))}}}),t&&"listview"!==t){var o=$("#mailListRelId"),n=o?o.val():"";$("#ecMailListRelId_"+EmailComposeUtil.CURRENT_TAB).val(n)}},EmailComposeUtil.getUserDetails=function(e,i){if(e){var t="/crm/v2/users/"+e;(new crmRequestPool).initiate({url:t,type:"GET",data:"approved=both",headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},content:"application/json; charset=UTF-8",dataType:"json",success:function(e){var t=e.users[0];i(t)},error:function(e){var i=e.status,t=(e=e.responseJSON,EmailUtil.getProperErrorMessage(e,i));crmui.showMsgBand("error",t,5e3)}})}},EmailComposeUtil.hideEditorPopups=function(){$("#ceVariousAttachmentOptionContainer ,.ceToolBarPopupActions").hide(),$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).select2("close"),$("#etSchedulePopId").addClass("hide"),EmailUtil.isReplyToAddressAdded()&&$("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB).select2("close")},EmailComposeUtil.hideAutoSuggestion=function(){var e;editor&&editor.zEditor&&((e=editor.zEditor.z_doc.getElementsByClassName("suggestedWord")[0])&&e.remove())},EmailComposeUtil.parseContentToRemoveAutoSuggestionElem=function(e){return e=e.replace(/<span(.)*?class=(\\s)*?['"]{1}suggestedWord['"]{1}(.)*?<\/span>/gi,"")},EmailComposeUtil.showComposeMetaSummary=function(){if("999"!==EmailComposeUtil.CURRENT_TAB){var e=$("#ceToAddr_"+EmailComposeUtil.CURRENT_TAB),i=$("#ceCCAddr_"+EmailComposeUtil.CURRENT_TAB),t=$("#ceBCCAddr_"+EmailComposeUtil.CURRENT_TAB),a=$("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB),l=$("#ceOption_replyto_"+EmailComposeUtil.CURRENT_TAB),o=$("#ceReplyToLink_"+EmailComposeUtil.CURRENT_TAB),n=o.length,s=l.is(":visible"),m=$("#emailComposeContainer_"+EmailComposeUtil.CURRENT_TAB).height();EmailSendingUtil.summarizeUserNameandEmail(),""!==e.val()&&e.val().length>5&&EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail(e.val()),EmailSendingUtil.formattedUsernameFromEmail(e.val()),null,e.closest("li")),""!==i.val()&&i.val().length>5&&EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail(i.val()),EmailSendingUtil.formattedUsernameFromEmail(i.val()),null,i.closest("li")),""!==t.val()&&t.val().length>5&&EmailSendingUtil.setUnameAndEmail(EmailSendingUtil.formatEmail(t.val()),EmailSendingUtil.formattedUsernameFromEmail(t.val()),null,t.closest("li"));var r="";if(l.is(":visible")&&a.children("option").length>0){var d=a.select2("data"),c=d?d[0].text:"";c&&(r+=" <b>"+I18n.getMsg("crm.label.reply.to")+"</b> "+$ESAPI.encoder().encodeForHTML(c))}var E="<span class='dB lH20'><span class='etsColumnLabel f15  mR5  fL'>"+I18n.getMsg("crm.label.to.email")+"</span>"+$ESAPI.encoder().encodeForHTML(EmailComposeUtil.getDisplayAddresses("ceToAddr"))+"</span>";0===$("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB).find("li").length&&(E="<span class='etsColumnLabel f15 mR5'>"+I18n.getMsg("crm.label.to.email")+"</span> <span style='color:#5c5c5c;'></span>"),$("#ceCCAddrDetails_"+EmailComposeUtil.CURRENT_TAB).find("li").length>1&&(E+="<span class='dB lH20'><span class='etsColumnLabel f15 mR5 fL'>"+I18n.getMsg("crm.label.cc.email")+"</span>"+$ESAPI.encoder().encodeForHTML(EmailComposeUtil.getDisplayAddresses("ceCCAddr"))+"</span>"),$("#ceBCCAddrDetails_"+EmailComposeUtil.CURRENT_TAB).find("li").length>1&&(E+="<span class='dB lH20'><span class='etsColumnLabel f15 mR5 fL'>"+I18n.getMsg("crm.label.bcc.email")+"</span> "+$ESAPI.encoder().encodeForHTML(EmailComposeUtil.getDisplayAddresses("ceBCCAddr"))+"</span>"),E=E.replace(/,/g,", ");var p=$("#"+EmailComposeUtil.activeContentId+" .ceSenderInfo"),u=$("#"+EmailComposeUtil.activeContentId+" .ceReceiverInfo");""!==r&&(p.find(".posRel").html(r),p.show()),u.find(".posRel").html(E),n>0&&!s||o.addClass("hide"),$("#"+EmailComposeUtil.activeContentId+" .ceComposeMeta").addClass("hide"),u.show(),m<=0&&(m=EmailTabHomeUtil.ViewPortHeight-60),$("#ecAutoCompleteContainer").addClass("hide"),EmailComposeUtil.toggleClickEventForEditor("unbind"),EmailSendingUtil.resizeEditorHeight()}},EmailComposeUtil.displayComposeMetaFields=function(){$("#"+EmailComposeUtil.activeContentId+" .ceComposeSummary").hide(),$("#"+EmailComposeUtil.activeContentId+" .ceComposeMeta").removeClass("hide"),$("#ceToAddr_"+EmailComposeUtil.CURRENT_TAB).focus(),EmailSendingUtil.resizeEditorHeight(),EmailComposeUtil.toggleClickEventForEditor("bind")},EmailComposeUtil.bindOrgEmailEvent=function(){EmailComposeUtil.bindEventForOrgEmails();var e=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB);thirdPartyUtils.bindSelect2(e),e.on("select2:open",(function(e){e.preventDefault(),$("#"+EmailComposeUtil.activeContentId+" .select2-container").addClass("emailComposeSelect"),$("#emcInsertOption_"+EmailComposeUtil.CURRENT_TAB).hide(),EmailUtil.hideSchedulePopUp()})),e.on("select2:select",(function(e){var i=e.params.data.element.value;EmailUtil.setSignature(i);var t=e.params.data.element.getAttribute("isorgemail");EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!1;var a="";if(t){EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!0;var l=i.lastIndexOf("<"),o=i.lastIndexOf(">");a=-1!==l&&-1!==o&&o>l?i.slice(i.lastIndexOf("@")+1,o):i.slice(i.lastIndexOf("@")+1,i.length),!CrmEmailInitialize.ComposeMailData.relay_domains||CrmEmailInitialize.ComposeMailData.relay_domains.map((e=>e.toLowerCase())).contains(a.toLowerCase())||EmailUtil.hideBand||(EmailUtil.hideBand=!1,crmui.showMsgBand("warning",I18n.getMsg("crm.email.orgemail.message",i),5e3))}}))},EmailComposeUtil.bindEventForOrgEmails=function(){var e=document.getElementById("etSenderList_"+EmailComposeUtil.CURRENT_TAB),i={},t=0,a=document.createElement("optgroup");a.setAttribute("Label",I18n.getMsg("crm.email.label.OrganisationEmail"));var l=e.childElementCount,o=e.children;EmailSendingUtil.other_emails_array=[];for(var n=l-1;n>=0;n--){(s=o[n]).getAttribute("isorgemail")||(EmailSendingUtil.other_emails_array.push(s.getAttribute("value")),i[s.getAttribute("value")]=s)}for(n=l-1;n>=0;n--){var s;(s=o[n]).getAttribute("isorgemail")?(a.appendChild(s),EmailSendingUtil.OrgEmailArray.push(s.getAttribute("value"))):t+=1}a.childElementCount>0&&e.appendChild(a),1===t&&EmailComposeUtil.disableReplyToAddressField()},EmailComposeUtil.initiateDraft=function(){setTimeout((function(){EmailActionHandling.saveDraftPeriodically($("#draftId").val(),!0)}),6e4),EmailComposeUtil.draftInterval=setInterval(EmailActionHandling.saveDraftPeriodically,18e4)},EmailComposeUtil.setEntityDetails=function(e,i){if(void 0===e&&(e=$("#module").val()),$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(e),EmailComposeUtil.isCustomModule(e)&&EmailComposeUtil.setCustomModuleName(e),void 0===i&&(i=$("#entityID").val()),i){EmailSendingUtil.isEntityWindow=!0,$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val(i);var t=document.getElementById("fileCheckVariable");if(t){var a=t.value;if(t.getAttribute("tempVal")){var l=document.createElement("div");l.setAttribute("id","fileCheckVariable"),l.setAttribute("name","fileCheckVariable"),l.setAttribute("tempVal","EntityMail"),l.value="EntityMail",document.getElementById("emailEditor").append(l)}else t.setAttribute("tempVal",a),t.value="EntityMail"}}Crm.userDetails.isBestTimeEnabled=EmailComposeUtil.ComposeMailData.user.isBestTimeEnabled},EmailComposeUtil.setEntityDetailsEquivalentToInventoryModule=function(e,i){var t=i.inventory_template.id,a=EmailComposeUtil.INVENTORY_TEMPLATE_API_URL+"/"+t;(new crmRequestPool).initiate({url:a,type:"GET",headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},success:function(i){if((i=i.inventory_templates)&&i.length>0){var t=(i=i[0]).module.api_name;EmailComposeUtil.setEntityDetails(t,e)}}})},EmailComposeUtil.initializeSpellCheck=function(){var e=document.getElementById("editorDiv"),i=Crm.userDetails.LOCALE;if(e.length>0){var t=ZWProofing.initialize("ZohoCrm",e),a=t.getSupportedLanguages();$.each(a,(function(e,a){a.language_code!==i||t.spellCheck(i)}))}},EmailComposeUtil.closeOtherPopUps=function(){$("#ecAutoCompleteContainer").addClass("hide")},EmailComposeUtil.appendInitialDOMElements=function(){var e=$("#composeEditor"),i=$("#ecAutoCompleteContainer");0===i.length&&(i='<div id="ecAutoCompleteContainer" class="hide"></div>',e.append(i));var t=$("#ecTemplateId");0===t.length&&(t='<input name="emailTemplateId" data-zcqa="emcTemplateId" id="ecTemplateId" type="hidden" value=""> ',e.append(t));var a=$("#etComposePanel"),l=$("#emailEntityComposepopup");if(0===l.length&&(l='<div id="emailEntityComposepopup"  class="emailEntityComposepopupClass" style="display:block">',a.append(l)),0===(o=document.getElementsByTagName("crm-emailrelatedlist-attachment")).length){var o="<crm-emailrelatedlist-attachment></crm-emailrelatedlist-attachment>";e.append(o)}if(0===$("#etSchedulePopId").length){e.append('<div class="w400 hide dIB etSchedulePop p30 pT20 bsbb bgFFF pA" id="etSchedulePopId">'),EmailCompose.populateEmailScheduleDetails()}var n=document.getElementById("msgid");n&&(n='<input type="hidden" id="msgid" value>',e.append(n));e.append('<div data-zcqa="addLinkDiv_editor_ecw" id="addLinkDiv"></div>'),e.append('<div data-zcqa="timesData_editor_ecw" id="timesData" style="z-index:1000;"></div>'),e.append('<div data-zcqa="newFreezeLayer_editor_ecw" id="newFreezeLayer" class="hide" style=" "></div>')},EmailComposeUtil.showComposeWindow=function(){EmailComposeUtil.isRefresh||$("#etComposePanel").css("right",0).css("top",0)},EmailComposeUtil.populateAddnEmail=function(e,i){$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).hide();var t="",a="",l="",o="//img.zohocdn.com/crm/images/nophoto_80ea3af_.png",n="selectedEmail",s="selectedEmail";if(i.indexOf("###")>-1){t=i.substr(i.indexOf("###")+3),i=i.substr(0,i.indexOf("###"));var m=EmailSendingUtil.getFormattedEmailAndUserName(i),r=EmailSendingUtil.getFormattedEmailAndUserName(t);i=m[0],a=m[1],t=r[0],l=r[1]}if(validationUtils.isValidEmail(i)||(s="invalidEmail"),validationUtils.isValidEmail(t)||(n="invalidEmail"),i=$ESAPI.encoder().encodeForHTMLAttribute(i),a=$ESAPI.encoder().encodeForHTMLAttribute(a),t=$ESAPI.encoder().encodeForHTMLAttribute(t),l=$ESAPI.encoder().encodeForHTMLAttribute(l),"EA"===e){var d="<li class='fL "+s+"' username='"+a+"' email='"+i+"' >";d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+a+"</span>",d=(d+="</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_'+$ESAPI.encoder().encodeForHTMLAttribute(email)+' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>")+"<li class='fL "+n+"' username='"+l+"' email='"+t+"' >",d=(d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+l+"</span>")+"</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_"+$ESAPI.encoder().encodeForHTMLAttribute(i)+"' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>"}else if("AO"===e){d="<li class='fL "+n+"' username='"+l+"' email='"+t+"' >";d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+l+"</span>",d+="</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_'+$ESAPI.encoder().encodeForHTMLAttribute(email)+' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>"}else{d="<li class='fL "+s+"' username='"+a+"' email='"+i+"' >";d=(d=(d+="<div class='selUserDetails fL' ondblclick='EmailSendingUtil.editUnameAndEmail($(this).parent())'>")+"<span class='ecUserImage'><img src='"+o+"' alt=''></span>")+"<span class='fL ecSelectedUserName'>"+a+"</span>",d+="</span></div><input autocomplete='off' class='fL ecTxtboxes mT2 hide'  type='text' onblur='EmailSendingUtil.handleBlurOnEmailTextBoxes(this)' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete( this, event );'  onclick='sE(event)' value=''><span class='fL mL8 selUserDetails closeIconB' data-zcqa='emc_remove_'+$ESAPI.encoder().encodeForHTMLAttribute(email)+' onclick='EmailSendingUtil.removeEmail(this);sE(event);'></span></li>"}$("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB).html(""),d+="<li class='fL ecAddrEditor' id='liToAddresDetails' style='background:#fff;'><input data-zcqa='emc_ceToAddr' initialliselection='true' autocomplete='off' class='fL ecTxtboxes mT2' type='text' onkeydown='EmailSendingUtil.handleKeyDownEventsForAutoComplete(this,event);sE(event);' onkeyup='EmailSendingUtil.handleKeyUpEventsForAutoComplete(this,event);sE(event);' onpaste='EmailSendingUtil.handlePasteEventForAutoComplete(this);sE(event);' onfocus='EmailSendingUtil.isCrtlKeyPressed = false;sE(event);' placeholder='' id='ceToAddr' onclick='sE(event)' value='' style='width: 54px;'></li>",$("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB).html(d),$(".liToAddresDetails").html("")},EmailComposeUtil.putAttachmentsOnEditor=function(e){if(EmailSendingUtil.SwitchedFromOldToNew&&EmailComposeUtil.isInventoryModule($("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val())&&EmailSendingUtil.inventObj){$("#layout_Id").val(EmailSendingUtil.inventObj.layout_Id),$("#layout_Name").val(EmailSendingUtil.inventObj.layout_Name),$("#viewType").val(EmailSendingUtil.inventObj.viewType),$("#paperType").val(EmailSendingUtil.inventObj.paperType);var i={},t={};t.id=EmailSendingUtil.inventObj.layout_Id,t.name=EmailSendingUtil.inventObj.layout_Name,i.inventory_template=t,i.paper_type=EmailSendingUtil.inventObj.paperType,i.view_type=EmailSendingUtil.inventObj.viewType,EmailUtil.setInventoryDetails(i)}$.each(e,(function(e,i){var t=editor.zEditor;if(t){EmailSendingUtil.SwitchedFromOldToNew&&(i.service_name="Desktop",EmailActionHandling.saveDraftDetails(i),i.id&&i.id.length>70&&(i.service_name="ZFSAttached")),t.showLoadingAttachment(),t.showAttachment(i,i),t.updateAttachmentCount();var a=i[EmailComposeUtil.FILE_SIZE];a&&t.addToTotalAttachmentSize(a)}})),setTimeout((function(){EmailSendingUtil.SwitchedFromOldToNew=!1}),5e3)},EmailComposeUtil.getFormattedEmailAddress=function(e,i){return e?e+"<"+i+">":i},EmailComposeUtil.showCustomFreezeLayer=function(){var e=$("#etComposePanel"),i=$("#z_freezeLayer");i.length>0?i.show():(i='<div id="z_freezeLayer" class="z_freezeLayer" style="display: block;z-index: 1;"></div>',e.append(i))},EmailComposeUtil.removeCustomFreezeLayer=function(){var e=$("#z_freezeLayer");e&&e.remove()},EmailComposeUtil.freezeLayer=function(e){var i=document.getElementById(EmailComposeUtil.freezeLayerId);if("show"===e){if(null===i){var t=document.createElement("div");t.setAttribute("id",EmailComposeUtil.freezeLayerId),t.setAttribute("class",EmailComposeUtil.freezeLayerId),$("#composeEditor").append(t),i=t}i.style.display="block"}else"hide"===e&&(i.style.display="none")},EmailComposeUtil.closeViewMailPopUp=function(){void 0!==$("#emailDetailIframeContent")&&EmailComposeUtil.closeIconBtn()},EmailComposeUtil.getMsgIdFromMailDetailsPopup=function(){var e,i=document.getElementById("emailDetailIframeContent"),t=$("#recentMailsDiv");i?e=i.contentDocument.getElementById("msgid"):t&&t.is(":visible")&&(e=$("#recentMailsDiv #msgid"));return e.value},EmailComposeUtil.closeIconBtn=function(){var e;"undefined"!=typeof isCrmPlusUser&&"true"===isCrmPlusUser||"undefined"!=typeof CrmPlusLib&&CrmPlusLib.isLoadedInCrmplusFrame?(e=$("#lookupdiv"),$("#chatbotDiv #kso_mails_list .kso_eachMailContainer").length?freezeBackground():removeFreezeLayer(),$("#ddm").hide(),$("#kanbanTaskDetailctn").removeClass("hide")):(e=parent.$("#lookupdiv"),$("#chatbotDiv #kso_mails_list .kso_eachMailContainer").length?freezeBackground():parent.removeFreezeLayer(),parent.$("#ddm").hide(),parent.$("#kanbanTaskDetailctn").removeClass("hide")),e.removeClass("p20");var i=$("#navigationRefreshKey");if(i.length>0&&"true"===i.html()){var t=$("module").val(),a="";a="Potentials"===t?$("#id").val():$("#entityId").val(),i.html("false"),window.parent.showMailsList(a,$("#emailId").val(),$("#fullname").val(),$("#mailListRelId").val(),"-10","next","","false",t)}e.html("").height("").hide()},EmailComposeUtil.getAPIDraftURL=function(e,i,t){var a=EmailComposeUtil.DraftAPIURL;return i||(i=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val()),i.startsWith("CustomModule")&&(i=Crm.userDetails.MODULE_LIST[i].api_name),i=EmailComposeUtil.getApiNameForModule(i),t||(t=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val()),a+="/"+i+"/"+t+"/"+EmailComposeUtil.DraftsAction,e&&(a+="/"+e),a},EmailComposeUtil.setSessionStorageDraft=function(e){var i=sessionStorage.getItem("draftDetails");i=i&&"null"!==i?JSON.parse(i):{};e=$("#draftId_"+EmailComposeUtil.CURRENT_TAB).val();var t=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),a=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val(),l=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val();e+="";var o=Object.keys(i);if(e&&!o.contains(e)){var n=e+":"+t+":"+a+":"+l;i[e]=n,i=JSON.stringify(i),sessionStorage.setItem("draftDetails",i)}},EmailComposeUtil.resetSessionStorageDraft=function(){sessionStorage.setItem("draftDetails",null)},EmailComposeUtil.removeDraftIdFromSessionStorage=function(e){var i=sessionStorage.getItem("draftDetails");i&&"null"!==i&&((i=JSON.parse(i))&&e&&delete i[e+=""],i&&0!==Object.keys(i).length?(i=JSON.stringify(i),sessionStorage.setItem("draftDetails",i)):EmailComposeUtil.resetSessionStorageDraft())},EmailComposeUtil.populateEmailAddress=function(e,i){var t,a=i,l=e[a];if(l){switch("string"==typeof e[a]&&(l=JSON.parse(e[a])),a){case"to":t="To";case"to_address":t="To";break;case"cc":t="CC";case"cc_address":t="CC";break;case"bcc":t="BCC";case"bcc_address":t="BCC";break;default:t=null}for(var o,n,s=l.length,m=0;m<s;m++){o=l[m].user_name;var r=(n=l[m].email).lastIndexOf("<"),d=n.lastIndexOf(">");-1!==r&&-1!==d&&d>r&&(o||(o=n.slice(0,r).trim()),n=n.slice(r+1,d)),EmailCompose.setMailAddress(n,o,t)}}},EmailComposeUtil.hideMaximizeComposeButton=function(){$("#maxComposeBtn").addClass("hide"),"undefined"!=typeof CrmPlusImpl&&("undefined"!=typeof isCrmPlusUser&&"true"===isCrmPlusUser||"undefined"!=typeof isZohoOneUser&&"true"===isZohoOneUser)&&CrmPlusImpl.handleDraftMailIcon(!1)},EmailComposeUtil.restoreComposePopup=function(){if(EmailUtil.removeCustomFreezeLayer(),$(".ze_toolbarbg").parent().remove(),EmailSendingUtil.isSendMailActionCalled=!1,$("#addNewSign")[0]){$("#z_imagePopup").css("display","none");var e=$("#z_freezeLayer");e[0]&&e.remove(),EmailComposeUtil.TEMP_TAB?(EmailComposeUtil.CURRENT_TAB=EmailComposeUtil.TEMP_TAB,EmailComposeUtil.activeContentId="composeContentPanel_"+EmailComposeUtil.CURRENT_TAB):EmailComposeUtil.CURRENT_TAB="1",null!==EmailComposeUtil.sessionStoredDraftDetails&&"null"!==EmailComposeUtil.sessionStoredDraftDetails||!EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB]?EmailComposeUtil.CURRENT_TAB="1":EmailComposeUtil.switchToCurrentEditor(EmailComposeUtil.CURRENT_TAB),$("#etComposePanel").attr("id","emailComposeEditor"),$("#composeEditor").attr("id","composeEmailEditor")}if("999"===EmailComposeUtil.CURRENT_TAB&&(EmailComposeUtil.CURRENT_TAB=EmailComposeUtil.TEMP_TAB),null!==EmailComposeUtil.sessionStoredDraftDetails&&"null"!==EmailComposeUtil.sessionStoredDraftDetails){var i=EmailComposeUtil.sessionStoredDraftDetails;EmailComposeUtil.sessionStoredDraftDetails=null;var t=Object.keys(i),a=t.length;EmailCompose.isSessionRestore=!0,setTimeout((function(){EmailCompose.isSessionRestore=!1}),1e3*a+1e3);for(var l=0;l<a;l++){var o=t[l],n=i[o].split(":");o=n[0];var s=n[1],m=n[2],r=n[3];l===a-1?(EmailCompose.isRefreshFirstOpen=!0,EmailCompose.fetchDraftDetails(o,s,m)):EmailComposeUtil.createComposeTab(o,s,m,r)}}else{var d=$("#gOnboardSection"),c=d[0]&&"block"===d.css("display"),E=EmailComposeUtil.isPopUpVisible(),p=$(".sticky-notes-label");p.length>0&&"viewed"===p.attr("data-active")&&crmStickies.viewStickyNewNote(p),E=EmailComposeUtil.isPopUpVisible(),"visible"===$("#chatbotDiv").css("visibility")&&"undefined"!=typeof zia&&zia&&zia.minimizeChat(),$("#remainder-notifi").is(":visible")&&Activities.showHideRemainder(),$("#rItemDataDiv").is(":visible")&&hideMenu(event),"none"!==$("#showSignalPop").css("display")&&(E=!1),E&&!c||EmailCompose.etMaximizeCompose()}},EmailComposeUtil.isPopUpVisible=function(){return $("lyte-modal-freeze").css("opacity")>0||$("#FreezeLayer, #freezeBackGround").is(":visible")},EmailComposeUtil.setScheduleTime=function(e,i){var t,a;if(e.time){var l=e.time;t=l.indexOf("T")>-1?EmailDateTimeUtils.ISO8601toDateObject(l):new Date(l),a=l.timezone}else t=e.indexOf("T")>-1?EmailDateTimeUtils.ISO8601toDateObject(e):new Date(e);var o="ecSchduleTime";i||(o=e.source?e.source:o);var n=new Date;if(Utils.convertToUserTimezone(n),!(t-n<=0)){var s,m=EmailDateTimeUtils.getDateInUserFormatFromDateObject(t),r=Crm.userDetails.TIME_FORMAT,d=t.getHours();"hh:mm a"===r&&(s=(d=parseInt(d))>=12?"pm":"am",d=d>12?d-12:d);var c,E=(d=("0"+d).slice(-2))+":"+("0"+t.getMinutes()).slice(-2);c=s?m+"##"+E+"##"+s:m+"##"+E+"##Hrs",a||(a=Crm.userDetails.USER_TIME_ZONE),c=c+"##"+a,$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).val(c);var p,u=s?s.toUpperCase():I18n.getMsg("crm.workflow.scheduler.hours");p=i?EmailComposeUtil.getProperScheduleTimeMsg(E+" "+u,EmailSendingUtil.formattedDate(m)):EmailSendingUtil.getProperMsg(E+" "+u,EmailSendingUtil.formattedDate(m)),EmailComposeUtil.setTime(p),EmailComposeUtil.setScheduleTimeSource(o),EmailComposeUtil.setIntialValuesForScheduleMail()}},EmailComposeUtil.setScheduleTimeSource=function(e){$("#timeSource_"+EmailComposeUtil.CURRENT_TAB).val(e);var i=$("#"+e+"_"+EmailComposeUtil.CURRENT_TAB).closest("li");EmailSendingUtil.selectCheckBox(i)},EmailComposeUtil.getProperScheduleTimeMsg=function(e,i,t){i=i.trim();var a="",l=(e=e.toUpperCase().trim()).split(" ");return e="AM"===l[1]||"PM"===l[1]?l[0]+" "+I18n.getMsg(l[1]):l[0]+" "+I18n.getMsg("crm.workflow.scheduler.hours"),t&&(e+=" "+t),i&&""!==i?"today"===i||"Today"===i?(i=I18n.getMsg("Today"),a=I18n.getMsg("crm.besttime.mail.scheduledat")+" "+e+", "+i):"tomorrow"===i||"Tomorrow"===i?(i=I18n.getMsg("Tomorrow"),a=I18n.getMsg("crm.besttime.mail.scheduledat")+" "+e+", "+i):a=I18n.getMsg("crm.besttime.mail.scheduledon")+" "+i+" "+I18n.getMsg("crm.homepage.at")+" "+e:a=I18n.getMsg("crm.besttime.mail.scheduledat")+" "+e+" "+i,a},EmailComposeUtil.getEditorContent=function(){var e="";if(Crm.userDetails.isNewEditor){if(!editor.zEditor)return;e="plainEditor"===editor.getEditorMode()?editor.zEditor.plainEditor.value:editor.getContent()}else e=editor.getContent();return e},EmailComposeUtil.setEditorContent=function(e){if(Crm.userDetails.isNewEditor){if(!editor.zEditor)return;"plainEditor"===editor.getEditorMode()?editor.zEditor.plainEditor.value=e:editor.setContent(e)}else editor.setContent(e)},EmailComposeUtil.getFormattedAttachmentDetails=function(e,i,t,a){var l={};return l[EmailComposeUtil.FILE_ID]=e,l[EmailComposeUtil.FILE_NAME]=i,l[EmailComposeUtil.FILE_SIZE]=t,l[EmailComposeUtil.SERVICE_NAME]=a,l},EmailComposeUtil.populateWithTemplate=function(e,i,t){$("#emcTemplateId_"+EmailComposeUtil.CURRENT_TAB).val(e);var a=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val();a&&a!==module&&$("#ceToAddr_"+EmailComposeUtil.CURRENT_TAB).val("");var l=$("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB).children().eq(0).attr("email"),o=$("#addrsVal_"+EmailComposeUtil.CURRENT_TAB).attr("selectedval"),n=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val(),s=$("#editorMode_"+EmailComposeUtil.CURRENT_TAB).val(),m=EmailUtil.getTemplateData(e,a,o,l,n,s);m.subject=i,m.body=t,EmailSendingUtil.populateNewEditorWithTemplate(m,a)},EmailComposeUtil.isCustomModule=function(e){return!!e.startsWith("CustomModule")},EmailComposeUtil.parseContentForInlineImage=function(e,i){EmailComposeUtil.inlineImagesReplacementGroup=[];for(var t,a=/.*?(<img(.*?)(class=\"ZCrmImage\")(.*?)src(\s*?)=(\s*?)(.*?img_id:(\w+?)\")(.*?\/>)).*/g;null!==(t=a.exec(e));){var l=t[1],o=t[8],n=t[7],s=EmailComposeUtil.getDownloadInlineImageURL(o,i),m=l.replace(n,s);e=e.replace(l,m)}return e},EmailComposeUtil.getDownloadInlineImageURL=function(e,i){var t=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),a=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val(),l=EmailComposeUtil.APIBaseURL+"/"+t+"/"+a+EmailComposeUtil.InlineImageURL;return l=l+"?"+("id="+e+"&user_id="+Crm.userDetails.USER_ID+"&message_id="+i+"&"+csrfParamName+"="+csrfToken)},EmailComposeUtil.getTextUptoCursorPostion=function(){var e,i=editor.zEditor.editorDiv.textContent.trim(),t=editor.zEditor,a=t.getSelection(),l=t.getRange(a),o=l.commonAncestorContainer;3===o.nodeType?(o,e=o.textContent):e=o.parentNode.innerText;var n=l.endOffset,s=e.substring(0,n);return(i.substring(0,i.lastIndexOf(s))+s).trim()},EmailComposeUtil.getTextUptoCursorPos=function(){for(var e=editor.zEditor.editorDiv,i=editor.zEditor,t=i.getSelection(),a=i.getRange(t),l=a.startContainer,o=l,n="";l!==e;)o=l,l=l.parentNode;for(var s=e.childNodes,m=s.length,r=0;r<m;r++){var d=s[r],c="";if(c=3===d.nodeType?d.textContent:d.innerText,d===o){var E=EmailUtil.getNodeText(a);E&&(n+=(c=c.substring(0,c.lastIndexOf(E)))+E);break}n+=c}return n},EmailComposeUtil.getCurrentLineCont=function(e){var i=e.childNodes,t=i.length;if(0===t)return e.innerText?e.innerText:e.textContent;for(var a=editor.zEditor,l=a.getSelection(),o=a.getRange(l),n=o.startContainer,s="",m=0;m<t;m++){var r=i[m],d="";if(d=3===r.nodeType?r.textContent:r.innerText,e===n){var c=o.endOffset;s+=d=d.substring(0,c)}else s+=d;return s}},EmailComposeUtil.isInventoryModule=function(e){return e||(e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val()),"Invoices"===(e=EmailComposeUtil.getApiNameForModule(e))||"Sales_Orders"===e||"Purchase_Orders"===e||"Quotes"===e},EmailComposeUtil.getContextHelpURL=function(e){switch(Crm.userDetails.LOCALE){case"fr_FR":return RebrandLinkUtil.getProperty("HELPLINK_URL_NEW")+"fr/crm/help/"+crmConstants.helpUrl[e];case"es_ES":return RebrandLinkUtil.getProperty("HELPLINK_URL_NEW")+"es-xl/crm/help/"+crmConstants.helpUrl[e];case"pt_BR":return RebrandLinkUtil.getProperty("HELPLINK_URL_NEW")+"pt-br/crm/help/"+crmConstants.helpUrl[e];case"de_DE":return RebrandLinkUtil.getProperty("HELPLINK_URL_NEW")+"de/crm/help/"+crmConstants.helpUrl[e];default:return"https://help.zoho.com/portal/kb/articles/zoho-survey-crm-integration"}},EmailComposeUtil.removeDraftDOMElement=function(){var e=$("#maxComposeBtn");if(e.length>0&&e.is(":visible")){if(EmailSendingUtil.composeActive||!EmailComposeUtil.editorLoaded)return EmailComposeUtil.hideMaximizeComposeButton(),void EmailComposeUtil.resetSessionStorageDraft();$("body #composeEditor").remove(),EmailComposeUtil.removeSpectrumElem(),EmailComposeUtil.editorLoaded=!1,EmailSendingUtil.composeActive=!1,EmailComposeUtil.editorContent="",EmailComposeUtil.ComposeMailData=CrmEmailInitialize.ComposeMailData,editor&&editor.zEditor&&(editor.zEditor.body[0].removeEventListener("click",editor.zEditor.hideAllProps,!1),editor.zEditor={}),tableResize.init={},$(".editorToolDiv").remove(),Lyte.removeFromCache(EmailComposeUtil.resources_1),Lyte.removeFromCache(EmailComposeUtil.resources_2),EmailComposeUtil.ComposeWindowLoaded=!1,null!==EmailComposeUtil.draftInterval&&clearInterval(EmailComposeUtil.draftInterval),EmailComposeUtil.hideMaximizeComposeButton(),EmailComposeUtil.resetSessionStorageDraft()}},EmailComposeUtil.removeSpectrumElem=function(){EmailComposeUtil.editorLoaded&&($("#lb_foreColor").spectrum("destroy"),$("#lb_bgColor").spectrum("destroy"),$("#sp_borderColor").spectrum("destroy"),$("#sp_fillColor").spectrum("destroy"))},EmailComposeUtil.setCustomModuleName=function(e){var i=$("#customModuleName_"+EmailComposeUtil.CURRENT_TAB);i&&i.val(e)},EmailComposeUtil.setEditorFocus=function(){editor&&editor.zEditor?(editor.zEditor.focusEditor(),editor.zEditor.editorDiv.click()):setTimeout((function(){editor&&editor.zEditor&&(editor.zEditor.focusEditor(),editor.zEditor.editorDiv.click())}),1e3)},EmailComposeUtil.setInitialComposeWindowFocus=function(){EmailSendingUtil.action===EmailTabHomeUtil.FORWARD||EmailSendingUtil.action===EmailTabHomeUtil.COMPOSE?$("#ceToAddr_"+EmailComposeUtil.CURRENT_TAB).focus():(EmailComposeUtil.setEditorFocus(),editor.zEditor.editorDiv.click())},EmailComposeUtil.isValidWordKey=function(e){return e>47&&e<58||e>64&&e<91||e>95&&e<112||e>185&&e<193||e>218&&e<223||32===e},EmailComposeUtil.isInvalidKey=function(e){return e.altKey||e.ctrlKey||27===e||13===e||37===e||38===e||40===e||33===e||34===e},EmailComposeUtil.validateMailSendingPermission=function(e,i,t,a){var l=e,o=i;"Accounts"===e&&(l="Contacts",o=$("#contactSelDropdownInAcc :selected").attr("value"));var n=Crm.getCrmBasePath()+"/mailer/EntReply.do",s="action=openComposeWindow&entType="+l+"&entityId="+o;var m="";commonUtils.showHideLoadingDiv(!0),(new crmRequestPool).initiate({type:"POST",url:n,data:s,success:function(l){if(EmailCompose.replaceTabid||EmailCompose.isSessionRestore||commonUtils.showHideLoadingDiv(),("1101"===(m=l)||"8011"===m||m.indexOf("UNCONFIRMED_USER")>-1||m.indexOf("TRANSMAIL_BLOCKED_ERROR")>-1||"1003"===m||"2309"===m)&&EmailSendingUtil.isFromCscript)return EmailSendingUtil.isFromCscript&&EmailSendingUtil.isFromCscript.callback&&EmailSendingUtil.isFromCscript.callback(m),EmailSendingUtil.isFromCscript=null,!1;var o=!1;if("1101"===m)renderingUtils.showCustomAlert(I18n.getMsg("crm.security.error"));else if("8011"===m)renderingUtils.showCustomAlert(I18n.getMsg("crm.priv.email.consent"));else if(m.indexOf("UNCONFIRMED_USER")>-1){var n=$("#shownotes");m=m.substring(16,m.length),n.addClass("newPopup p30"),n.html(m);var s=document.getElementById("shownotes");s.style.zIndex=21,s.style.width="600px",s.style.position="absolute",n.find("input").click((function(){var e=$("#shownotes");removeFreezeLayer(),e.html(""),e.hide()})),freezeBackground(),n.show(),mailsetCenter("shownotes")}else if(m.indexOf("TRANSMAIL_BLOCKED_ERROR")>-1&&"Potentials"!==e){var r=$("#emailalert"),d=parseInt($(".emailalert").css("margin-top"))-$("#wmstoolbar").outerHeight()-12;m=m.substring(23,m.length);var c="<div class='aligncenter proximas f20' text-align:auto;'>";c+=I18n.getMsg("crm.bouncemail.heading"),c+="</div>",r.hide(),m="<div class='massMailstatscloseIcon cP' style='top:20px;right:20px' onclick=closealertMail('emailalert')></div><div class='aligncenter proxima f14 mT20'>"+m+"</div> </div></div>",r.empty(),document.getElementById("emailalert").innerHTML=c+m,r.css({"margin-top":d,"max-height":renderingUtils.windowHeight-110}),$("html,body").css("overflow","hidden"),mailsetCenter("emailalert"),freezeBackground()}else if("1003"===m&&"Potentials"!==e)renderingUtils.showCustomAlert(I18n.getMsg("crm.label.emailoptout.alert.message"));else{if("2309"!==m)return o=!0,a(t,e,i),!0;renderingUtils.showCustomAlert(I18n.getMsg("crm.zmail.unableto.sendmail",Crm.moduleInfo[e].translatedSingularLabel),I18n.getMsg("crm.error.email.notfound"))}return o||EmailUtil.closeEmailTab(EmailComposeUtil.CURRENT_TAB),!1},error:function(e){if(commonUtils.showHideLoadingDiv(),EmailSendingUtil.isFromCscript)return EmailSendingUtil.isFromCscript&&EmailSendingUtil.isFromCscript.callback&&EmailSendingUtil.isFromCscript.callback(e),void(EmailSendingUtil.isFromCscript=null);renderingUtils.showCustomAlert(I18n.getMsg("crm.migration.general.error"))}})},EmailComposeUtil.validateEmailFieldsOfToCcBcc=function(){return!($("#ToDetails .selectedEmail").length+$("#CCDetails .selectedEmail").length+$("#BCCDetails .selectedEmail").length>EmailSendingUtil.numberOfEmailAddr)||(crmui.showMsgBand("error",maxLimitExceedMsg,5e3),!1)},EmailComposeUtil.getAutoCompleteSuggestedElem=function(){var e;if(editor&&editor.zEditor){var i=editor.zEditor.z_doc;e=i?i.getElementsByClassName("suggestedWord")[0]:e}return e},EmailComposeUtil.getApiNameForModule=function(e){var i=Crm.userDetails.MODULE_LIST[e],t=e;return i&&(t=i.api_name),t},EmailComposeUtil.isPrivacyEnabled=function(){return EmailComposeUtil.ComposeMailData.features_available.isPrivacyEnabled},EmailComposeUtil.showSubjectInputPopup=function(){var e=$L("#ecwSubjectModal")[0];if(e.ltProp("show",!0),EmailSendingUtil.isNewEditor()&&EmailSendingUtil.composeActive){var i=e.ltProp("wrapperClass");e.ltProp("wrapperClass",i+" emailComposeZindex")}},EmailComposeUtil.handleAttachmentPopupInEditor=function(){if(void 0!==EmailComposeUtil)var e=setInterval((function(){EmailComposeUtil.AttachmentPopupTriggerEvent()&&clearInterval(e)}),300)},EmailComposeUtil.AttachmentPopupTriggerEvent=function(){var e=$("#attachfiledialogdiv"),i=$("#linkdocsdialogdiv"),t=$("#zohodocsframe"),a=!1;return i.length>0?(i.on("remove",EmailComposeUtil.AttachmentPopupRemovalEvent),EmailComposeUtil.showCustomFreezeLayer(),a=!0):e.length>0?(e.on("remove",EmailComposeUtil.AttachmentPopupRemovalEvent),EmailComposeUtil.showCustomFreezeLayer(),a=!0):t.length>0&&(t.on("remove",EmailComposeUtil.AttachmentPopupRemovalEvent),a=!0),a},EmailComposeUtil.AttachmentPopupRemovalEvent=function(){EmailSendingUtil.isNewEditor()&&EmailSendingUtil.composeActive&&EmailComposeUtil.removeCustomFreezeLayer()},EmailComposeUtil.getNextFormattedScheduleTime=function(e,i){var t,a,l;if("hh:mm"===(i=i.toLowerCase()))t=e.split(":")[0],a=e.split(":")[1];else if("hh:mm a"===i){t=e.split(":")[0];var o=e.split(":")[1];a=o.split(" ")[0],l=o.split(" ")[1]}l&&(l=l.toUpperCase());var n=parseInt(t),s=parseInt(a);"00"!==a&&"30"!==a?s<29?a="30":s<=59&&(a="00",n<11?t=parseInt(t)+1:"11"===t&&"hh:mm a"===i?"AM"===l?(l="PM",t="12"):"PM"===l&&(l="AM",t="00"):"hh:mm a"===i&&"PM"===l?t="01":"hh:mm"===i&&(t="23"===t?"00":parseInt(t)+1)):"00"===a?a="30":"30"===a&&("hh:mm"===i&&n<23?(t=("0"+(n+=1)).slice(-2),a="00"):"hh:mm a"===i&&(a="00",11!==n?t=n+1:11===n&&("AM"===l?(t=n+1,l="PM"):a="30")));e=t+":"+a;return e=l?e+":"+l:e},EmailComposeUtil.updateTheEmailTabNameWithTheSubjectName=function(){var e=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val();$("#ceSubject1_"+EmailComposeUtil.CURRENT_TAB).val(e),e&&e.length>250&&crmui.showMsgBand("warning",I18n.getMsg("crm.email.compose.subject.len.check",250),3e3),""===e&&(e=I18n.getMsg("crm.email.label.newmessage")),$("#"+EmailComposeUtil.activeTabId+" .etTxt").text(e),$L("#"+EmailComposeUtil.activeTabId).attr("lt-prop-title",e)},EmailComposeUtil.disableReplyToAddressField=function(){var e=$("#ceOption_replyto_"+EmailComposeUtil.CURRENT_TAB),i=$("#ceReplyToLink_"+EmailComposeUtil.CURRENT_TAB);e.hide(),i.hide()},EmailComposeUtil.insertLinkInComposeEditor=function(e,i,t,a){var l=editor.zEditor;l.rangeObj&&l.restoreSelection(l.rangeObj);var o=editor.getEditorMode(),n=l.getSelection(),s=l.getRange(n),m=n.toString(),r=l.getClosestElement("a");if(l.editorDiv.focus(),e){var d=l.z_doc;if(t=t||"",i=i||e,"plainEditor"===o){var c=$("#emailEditor").find("iframe").eq(0).contentDocument;return d=c,void c.execCommand("insertHTML","true",e)}if(null!==r&&m)r.title=t,r.href=e,r.innerHTML!==i&&(r.innerHTML=i),r.target="_blank",s.selectNode(r),n.removeAllRanges(),n.addRange(s),n.collapseToEnd(),l.linkDesc&&(l.linkDesc.getElementsByClassName("goToLink")[0].innerText=e),l.rangeObj=l.saveCaretPostion();else if(m&&0!==m.length){d.execCommand("createlink",!1,e),(n=l.getSelection()).collapseToEnd();var E=l.getParentNode();r=E,"A"===E.tagName&&(t&&(E.title=t),E.innerHTML!==i&&(E.innerHTML=i),"ZForms"===a&&E.setAttribute("data_zformlink",e),E.target="_blank",s.selectNodeContents(E),n.removeAllRanges(),n.addRange(s),n.collapseToEnd())}else{if(l.isGecko)(p=d.createElement("A")).innerHTML=i,p.target="_blank",p.title=t,p.href=e,p.classList.add("cP"),d.execCommand("insertHTML",!1,p.outerHTML);else if(d.execCommand("createlink",!1,e)){(n=l.getSelection()).collapseToEnd(),"A"===(p=l.getParentNode()).tagName&&(p.innerHTML=i,p.target="_blank",p.title=t,"ZForms"===a&&p.setAttribute("data_zformlink",e),p.href=e,p.classList.add("cP"),(s=l.getRange(n)).selectNode(p),n.removeAllRanges(),n.addRange(s),n.collapseToEnd())}else{var p;(p=d.createElement("A")).innerHTML=i,p.target="_blank",p.href=e,p.title=t,p.classList.add("cP");n=d.getSelection(),s=l.getRange(n);"function"==typeof n.collapseToEnd?(s.deleteContents(),s.insertNode(p),s.selectNode(p),s.setStartAfter(p),s.setEndAfter(p),n.removeAllRanges(),n.addRange(s)):(s.pasteHTML(p.outerHTML),n.collapseToEnd())}}}},EmailComposeUtil.removeAutoSuggestedElement=function(){var e=EmailComposeUtil.getAutoCompleteSuggestedElem();e&&(e.parentElement.removeChild(e),EmailCompose.EnableTab=!1)},EmailComposeUtil.removeSuggestedElement=function(e){e&&(window.document.documentMode?e.parentElement.removeChild(e):e.remove())},EmailComposeUtil.loadI18nResources=function(){var e=[networkUtils.getI18nJSUrl("emailcompose"),networkUtils.getI18nJSUrl("emaileditor")];Lyte.injectResources(networkUtils.returnDependencyFiles(e,crmConstants.jsStaticPath),void 0,void 0)},EmailComposeUtil.setDefaultValues=function(){var e=CrmEmailInitialize.ComposeMailData.user.compose_settings,i={8:"1",10:"2",12:"3",14:"4",18:"5",24:"6",36:"7"},t=editor.zEditor.z_doc.getElementById("ecw_signature"),a=editor.zEditor.editorDiv.innerHTML;EmailComposeUtil.isReplyMail&&(editor.zEditor.editorDiv.innerHTML="<br>dummytextdummytext");var l=$(t).clone();if(e.font_size&&(editor.zEditor.focusEditor(),editor.zEditor.z_doc.execCommand("selectAll",!1,null),editor.zEditor.z_doc.execCommand("fontsize",!1,i[e.font_size]),zEditor.prototype.updateFontSize(i[e.font_size]),editor.zEditor.activeTabElem.querySelector("#z_fntsizeText").innerHTML=e.font_size),e.font_family){var o=editor.zEditor;zEditor.prototype.createFontFamily(),editor.zEditor.z_doc.execCommand("selectAll",!1,null),zEditor.prototype.updateFontFamily(getFontList()[e.font_family]),o.z_doc.execCommand("fontname",!1,getFontList()[e.font_family]),o.hideDD(o.fontFamilyDiv)}EmailComposeUtil.isReplyMail?(editor.zEditor.editorDiv.innerHTML=editor.zEditor.editorDiv.innerHTML+a,editor.zEditor.editorDiv.innerHTML=editor.zEditor.editorDiv.innerHTML.replaceAll("dummytextdummytext","")):t&&(t.remove(),editor.zEditor.editorDiv.append(l[0])),editor.zEditor.getSelection().removeAllRanges()},EmailComposeUtil.createNewComposeTab=function(e){var i=EmailComposeUtil.createComposeTab();return(e=void 0===e?EmailComposeUtil.ComposeMailData:e).tabId=i,EmailComposeUtil.createComposeBody(e,i),i},EmailComposeUtil.createComposeTab=function(e,i,t,a){var l=$("body"),o=$("#composeEditor");if(!o||0===o.length){(o=document.createElement("div")).setAttribute("id","composeEditor"),o.setAttribute("data-zcqa","composeEditorOuter_editor_ecw"),l.append(o);var n,s='<div data-zcqa="etNewMsg_ecw" class="cBafter etNewMsg">\t\t\t\t\t\t\t\t\t<div id="etZiaEmotionBand"></div>            \t\t\t\t\t\t<div class="fL">\t\t\t\t\t\t\t\t\t\t<ul class="m0 p0 dF" id="etComposeId">\t\t\t\t\t\t\t\t\t\t</ul>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t<div class="fR mR15 mT15">'+(CrmEmailInitialize.ComposeMailData.features_available.COMPOSE_SWITCH_OPTION||EmailSendingUtil.SwitchedFromOldToNew?'<span class="ecwTryOldVersion mR10 vam f12" onclick="EmailCompose.showEditorFeedBack()">'+I18n.getMsg("crm.email.compose.switch.old")+"</span>":"")+'<span data-zcqa="minimiseCompose_ecw" class="vam zcrm_svgIcons dIB etComposeMinIcon  cP mR15" onclick="EmailCompose.etMinimiseCompose();"></span><span class="vam zcrm_svgIcons dIB etComposeCloseIcon cP" onclick="EmailCompose.etCloseAllTabs()" ></span></div>\t\t\t\t\t\t\t  </div>';(n=document.createElement("div")).setAttribute("id","etComposePanel"),n.setAttribute("data-zcqa","etComposePanel_ecw"),n.setAttribute("id","etComposePanel"),n.setAttribute("class","etRightPanel bsbb"),(o=$(o)).append(n),(n=$(n)).append(s),($(".etTrendsWrapper").length||$(".etTrendsWrapperCNS").length)&&$("#etComposePanel").addClass("ziaForEmailsCheck")}var m,r,d=$("#etComposeId");return m=EmailComposeUtil.composeSettingObj?"999":EmailComposeUtil.getNextTabId(),EmailComposeUtil.tabDetails[m]&&EmailUtil.closeEmailTab(m),a||(a=I18n.getMsg("crm.email.label.newmessage")),r=e&&i&&t?'<li class=" p15 pR dIB mw250 etComposeHeaderNew"  temptab="true" lt-prop-title = '+a+'  id="ecw_tab_'+m+'"   data-draftId='+e+" data-module="+i+" data-entId="+t+' data-subject="'+a+'" data-etTab="etComposeId1"  onclick="EmailComposeUtil.switchToTab(this)"> \t\t<span class="f15 etTxt">'+a+'</span> \t\t<span class="svgIcons ico-close-white-small2 pA etClseIcn cP" onclick="EmailUtil.closeEmailTab('+m+');sE(event);"></span> \t</li>':'<li class="etComposeHeader p15 pR dIB mw250 etComposeHeaderNew" lt-prop-title = "New Message"  id="ecw_tab_'+m+'"  data-etTab="etComposeId1"  onclick="EmailComposeUtil.switchToTab(this)"> \t\t<span class="f15 etTxt" >'+I18n.getMsg("crm.email.label.newmessage")+'</span> \t\t<span class="svgIcons ico-close-white-small2 pA etClseIcn cP" onclick="EmailUtil.closeEmailTab('+m+');sE(event);"></span> \t</li>',d.append(r),EmailSendingUtil.isFromCscript&&EmailSendingUtil.isFromCscript.successcallback&&EmailSendingUtil.isFromCscript.successcallback(),EmailSendingUtil.isFromCscript=null,EmailComposeUtil.tabDetails[m]={},EmailComposeUtil.OPEN_TAB_COUNT+=1,m},EmailComposeUtil.createComposeBody=function(e,i){$etComposePanel=$("#etComposePanel");var t=document.createElement("div");t.setAttribute("data-zcqa","composeContentPanel_ecw_"+i),t.setAttribute("id","composeContentPanel_"+i),t.setAttribute("class","composeContentPanel hide"),e.integrationsAppName=Crm.integrationsAppName.ZOHO_SALESIQ,t.innerHTML=Handlebars.templates.EmailCompose(e),$etComposePanel.append(t),$("#composeContentPanel_"+i,"#ceSubject").on("input",EmailComposeUtil.updateTheEmailTabNameWithTheSubjectName)},EmailComposeUtil.createSignatureBody=function(e){var i=e.tabId;if(!EmailComposeUtil.tabDetails.NEW_TAB_ID){var t=e.holderContainer,a=document.getElementById(t),l=document.createElement("div");l.setAttribute("data-zcqa","composeContentPanel_ecw_"+i),l.setAttribute("id","composeContentPanel_"+i),l.setAttribute("class","composeContentPanel hide");var o=e.parentElement,n=document.createElement("div");n.setAttribute("id",o),n.setAttribute("class",o),l.append(n),a.append(l),EmailComposeUtil.tabDetails[i]={}}},EmailComposeUtil.getNextTabId=function(){var e,i,t=Object.keys(EmailComposeUtil.tabDetails),a=0,l=t.length,o=Number(EmailComposeUtil.OPEN_TAB_COUNT),n=Number(EmailComposeUtil.MAX_TAB_COUNT);if(o<n){var s=[];for(a=1;a<=n;a++){var m=a+"";s.push(m)}for(a=0;a<l;a++)i=t[a],s.removeFirstOccurenceOfElement(i);e=s[0]}else{var r=document.getElementsByClassName("etComposeHeaderNew")[0].getAttribute("id");e=Number(r.split(EmailComposeUtil.tabIdPrefix).pop())}return e},EmailComposeUtil.switchToTab=function(e){if($(".ze_toolbarbg").parent().remove(),$("#ecw_tab_"+EmailComposeUtil.CURRENT_TAB).attr("isActiveComposeTab",!1),$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).hide(),EmailComposeUtil.closeZiaEmotionBand(),EmailCompose.replaceTabid){var i=$("#"+e.id),t=i.clone();i.remove(),jQuery("#ecw_tab_"+EmailCompose.replaceTabid).replaceWith(jQuery(t)),$(e).appendTo("#ecw_tab_"+EmailCompose.replaceTabid),EmailUtil.closeEmailTab(EmailCompose.replaceTabid,!1,!1,!0),EmailCompose.replaceTabid=void 0,setTimeout(commonUtils.showHideLoadingDiv(),2e3)}$(".composeContentPanel").not(".hide").find(".select2-selection__rendered").removeClass("activeFromSpan");var a=EmailComposeUtil.CURRENT_TAB,l=e.getAttribute("id"),o=l.substring(l.lastIndexOf("_")+1,l.length);o=Number(o),EmailComposeUtil.handleTheTabSwitchEvent(a,l);var n=EmailComposeUtil.tabIdPrefix+o,s=EmailComposeUtil.contentIdPrefix+o,m=document.getElementById(n),r=document.getElementById(s);if(0!==a){var d=EmailComposeUtil.tabIdPrefix+a,c=EmailComposeUtil.contentIdPrefix+a,E=document.getElementById(d),p=document.getElementById(c);E&&($(".etComposeHeader").removeClass("etComposeHeader"),r?p.classList.add("hide"):e.classList.add("etComposeDummyHeader"))}r?(m.classList.add("etComposeHeader"),r.classList.remove("hide"),EmailComposeUtil.CURRENT_TAB=o,EmailComposeUtil.TEMP_TAB=EmailComposeUtil.CURRENT_TAB,$("#ecw_tab_"+EmailComposeUtil.CURRENT_TAB).attr("isActiveComposeTab",!0),EmailComposeUtil.switchToCurrentEditor(EmailComposeUtil.CURRENT_TAB+""),EmailComposeUtil.activeContentId=s,EmailComposeUtil.activeTabId=n,EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].lastActivityTime=(new Date).getTime()):(commonUtils.showHideLoadingDiv(!0),EmailComposeUtil.fetchAndPopulateBodyContent(e)),EmailLaunchUtil.showHideFromRecord(),setTimeout($(".composeContentPanel").not(".hide").find(".select2-selection__rendered").addClass("activeFromSpan"),300)},EmailComposeUtil.fetchAndPopulateBodyContent=function(e){var i=e.getAttribute("id"),t=i.split("ecw_tab_")[1];i=t;var a=e.getAttribute("data-draftId"),l=e.getAttribute("data-module"),o=e.getAttribute("data-entId");EmailCompose.replaceTabid=t,EmailCompose.hideDiscardPop=!0,setTimeout(EmailCompose.hideDiscardPop=!1,3e3),EmailCompose.fetchDraftDetails(a,l,o)},EmailComposeUtil.populateComposeWithDraftData=function(e,i,t,a){(e=EmailCompose.populateComposeData).Email_Drafts[0].rich_text||editor.zEditor.showPlainEditor(!0);var l="draft";if(EmailComposeUtil.isInventoryModule(t)||"Potentials"===t)EmailCompose.getParentEntityDetailsThenRelatedContactDetails(t,a,l);else if(EmailComposeUtil.isCustomModule(t)){var o=Crm.userDetails.MODULE_LIST[t].api_name;EmailComposeUtil.getEntityDetailsFromDB(o,a,l)}else EmailComposeUtil.getEntityDetailsFromDB(t,a,l);EmailComposeUtil.setEntityDetails(t,a),EmailCompose.populateComposeMailData(e),EmailCompose.populateComposeData={},i=e.Email_Drafts[0].id,$("#draftId_"+EmailComposeUtil.CURRENT_TAB).val(i),$("#deleteDraft_"+EmailComposeUtil.CURRENT_TAB).removeClass("hide"),EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails||(EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails={}),EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails.draftId=i,EmailComposeUtil.setEditorFocus()},EmailComposeUtil.handleTheTabSwitchEvent=function(e){EmailComposeUtil.handleAutoCompleteEventOnTabSwitch(e)},EmailComposeUtil.handleAutoCompleteEventOnTabSwitch=function(e){0!==e&&EmailComposeUtil.removeAutoSuggestedElement(),EmailCompose.autoCompleteReqPool="",EmailCompose.insertWord=!0,EmailCompose.enableTab=!1,EmailCompose.responseAwaiting=!1,EmailCompose.TypedTextBeforeRecievingResponse=""},EmailComposeUtil.switchToCurrentEditor=function(e){var i=EmailComposeUtil.tabDetails[e].zEditor;i&&editor&&(editor.zEditor=i)},EmailComposeUtil.getElementById=function(e){return e=EmailComposeUtil.getIdForCurrentTab(e),document.getElementById(e)},EmailComposeUtil.getIdForCurrentTab=function(e){return e=e+"_"+EmailComposeUtil.CURRENT_TAB},EmailComposeUtil.getIdForNextTab=function(e){return e=e+"_"+EmailComposeUtil.getNextTabId()},EmailComposeUtil.getCurrentTabId=function(){return EmailComposeUtil.tabIdPrefix+EmailComposeUtil.CURRENT_TAB},EmailComposeUtil.getCurrentContentId=function(){return EmailComposeUtil.contentIdPrefix+EmailComposeUtil.CURRENT_TAB},EmailComposeUtil.getLRUTabId=function(){var e,i,t,a,l=Object.keys(EmailComposeUtil.tabDetails),o=0,n=l.length;for(o=0;o<n;o++)t=l[o],a=EmailComposeUtil.tabDetails[t].lastActivityTime,(!i||actitvityTime<i)&&(i=a,e=t);return e},EmailComposeUtil.getMRUTabId=function(){var e,i,t,a,l=Object.keys(EmailComposeUtil.tabDetails),o=0,n=l.length;for(o=0;o<n;o++)t=l[o],a=EmailComposeUtil.tabDetails[t].lastActivityTime,(!i||a>i)&&(i=a,e=t);return e},EmailComposeUtil.getDisplayAddresses=function(e){var i="",t="#"+e+"Details_"+EmailComposeUtil.CURRENT_TAB+" li",a=$(t);return a.length>1&&a.each((function(){$(this).hasClass("ecAddrEditor")||(""!==$(this).attr("username")?i+=""===i?$(this).attr("username"):","+$(this).attr("username"):i+=""===i?$(this).attr("email"):","+$(this).attr("email"))})),i},EmailComposeUtil.setEmailAddresses=function(){var e=$("#toAddress_"+EmailComposeUtil.CURRENT_TAB),i=$("#toAddrUname_"+EmailComposeUtil.CURRENT_TAB);$("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length>=0&&(e.val(EmailComposeUtil.getCommaSeparatedEmails("ceToAddrDetails")),i.val(EmailComposeUtil.getCommaSeparatedUsernames("ceToAddrDetails")));var t=$("#ccAddress_"+EmailComposeUtil.CURRENT_TAB),a=$("#ccAddrUname_"+EmailComposeUtil.CURRENT_TAB);$("#ceCCAddrDetails_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length>=0&&(t.val(EmailComposeUtil.getCommaSeparatedEmails("ceCCAddrDetails")),a.val(EmailComposeUtil.getCommaSeparatedUsernames("ceCCAddrDetails")));var l=$("#bccAddress_"+EmailComposeUtil.CURRENT_TAB),o=$("#bccAddrUname_"+EmailComposeUtil.CURRENT_TAB);$("#ceBCCAddrDetails_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length>=0&&(l.val(EmailComposeUtil.getCommaSeparatedEmails("ceBCCAddrDetails")),o.val(EmailComposeUtil.getCommaSeparatedUsernames("ceBCCAddrDetails")))},EmailComposeUtil.getCommaSeparatedEmails=function(e){var i=$("#"+e+"_"+EmailComposeUtil.CURRENT_TAB).find("li"),t=[];return $.each(i,(function(e,i){if(i.hasAttribute("email")&&!t.contains(i.getAttribute("email"))){var a=i.getAttribute("email");t.push(a)}})),t.toString()},EmailComposeUtil.getCommaSeparatedUsernames=function(e){var i=$("#"+e+"_"+EmailComposeUtil.CURRENT_TAB).find("li"),t=[],a=[];return $.each(i,(function(e,i){if(i.hasAttribute("email")&&!t.contains(i.getAttribute("email"))){var l=i.getAttribute("username"),o=i.getAttribute("email");l||(l=o),a.push(l),t.push(o)}})),a.toString()},EmailComposeUtil.getTabIdContainingGivenDraft=function(e){for(var i,t=Object.keys(EmailComposeUtil.tabDetails),a=t.length,l=$("#isFromNewAPI").length>0,o=0;o<a;o++){var n=t[o],s=EmailComposeUtil.tabDetails[n].draftDetails;if(l&&s&&s.newRLDraftId===e)return i=n;if(s&&s.draftId===e)return i=n}return i},EmailComposeUtil.clearTemplate=function(){var e=$("#emcTemplateNameHolder_"+EmailComposeUtil.CURRENT_TAB),i=$("#ceSubject1_"+EmailComposeUtil.CURRENT_TAB),t=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB);EmailSendingUtil.IsReplyOrForwardMail()||(i.val(""),t.val("")),$("#ceAddtemplate_"+EmailComposeUtil.CURRENT_TAB).html(I18n.getMsg("crm.email.add.template")),e.removeClass("emcTemplateNameHolder"),e.addClass("hide"),$("#emcTemplateOptions_"+EmailComposeUtil.CURRENT_TAB).removeClass("hide"),EmailComposeUtil.updateTheEmailTabNameWithTheSubjectName(),EmailUtil.clearEditorAttachments(),$("#deleteDraft_"+EmailComposeUtil.CURRENT_TAB).hide();var a=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB);(0===a.length||"Quotes"!==a.val()&&"Invoices"!==a.val()&&"PurchaseOrders"!==a.val()&&"SalesOrders"!==a.val())&&$("#ecDisplayAttachmentNames_"+EmailComposeUtil.CURRENT_TAB).html(""),$("#emcTemplateId_"+EmailComposeUtil.CURRENT_TAB).val(""),editor.zEditor.plainEditor&&(editor.zEditor.plainEditor.value=""),editor.setContent("<br>"),EmailComposeUtil.editorContent=""},EmailComposeUtil.postLaunchHandling=function(){EmailSendingUtil.privacyPolicyDetails&&Object.keys(EmailSendingUtil.privacyPolicyDetails).length>0?EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].privacyPolicyDetails=EmailSendingUtil.privacyPolicyDetails:(EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].privacyPolicyDetails={},EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].privacyPolicyDetails.isConsentMail=!1),EmailSendingUtil.privacyPolicyDetails={}},EmailComposeUtil.preLaunchHandling=function(){var e=Object.keys(EmailComposeUtil.tabDetails);EmailComposeUtil.sessionStoredDraftDetails&&0===e&&(EmailComposeUtil.resetSessionStorage(),EmailComposeUtil.sessionStoredDraftDetails=null)},EmailComposeUtil.setFileCheckVariableValue=function(){if($("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val()){var e=document.getElementById("fileCheckVariable_"+EmailComposeUtil.CURRENT_TAB),i=e.value;e.setAttribute("tempVal",i),e.value="EntityMail"}},EmailComposeUtil.resetFileCheckVariableValue=function(){var e=document.getElementById("fileCheckVariable_"+EmailComposeUtil.CURRENT_TAB);if(e){var i=e.getAttribute("tempval");e.value=i,e.removeAttribute("tempval")}},EmailComposeUtil.isValidInputForAutoComplete=function(e){var i=!0;if(""===e.trim())i=!1;else{var t=e.length;length>1&&(160===e.charCodeAt(t-1)||32===e.charCodeAt(t-1))&&(i=!1)}return i},EmailComposeUtil.getErrorMessageFromCode=function(e){var i="action failed",t=e.indexOf("UNCONFIRMED_USER")>-1,a=e.indexOf("TRANSMAIL_BLOCKED_ERROR")>-1;if(t)i="unconfirmed user";else if(a)i="email blocked";else switch(e){case"1101":i="no permission to perform this action";break;case"8011":i="no consent";break;case"1003":i="email opted out";break;case"2309":i="module doesnt have email"}return i},EmailComposeUtil.formEmailObject=function(e){return e&&Array.isArray(e)?e.map((function(e){return{email:e.email,user_name:e.label}})):[]},EmailComposeUtil.preformAndComposeWindow=function(e,i,t){var a=e.from||"",l=EmailComposeUtil.formEmailObject(e.to),o=EmailComposeUtil.formEmailObject(e.cc),n=EmailComposeUtil.formEmailObject(e.bcc),s=e.subject||"",m=ZSEC.HTMLPurifier({ALLOWED_STYLE:"ALL",STYLE_VALIDATION:!1}).sanitize(e.body||""),r=i.module,d=i.record,c=d?d.id:"";EmailCompose.openComposeWindow(a,l,o,n,r,c,e.templateId,m,s,t)},EmailComposeUtil.closeZiaEmotionBand=function(){Lyte.registeredMixins["crm-email-emotions-mixin"].closeZiaEmotionBand()};var EmailCompose={tempCallback:"",tempData:"",tempEditorMode:"",isDraft:!1,hideDiscardPop:(!1,!1),disableToaddress:!1,openingScheduleMail:!1,replaceTabid:"",isSessionRestore:!1,isRefreshFirstOpen:!1};EmailComposeUtil.action=[],EmailCompose.populateEmailScheduleDetails=function(){(new crmRequestPool).initiate({action:EmailSendingUtil.URL,type:"GET",data:"action=loadScheduleOptions",success:function(e){var i=Handlebars.templates.ScheduleTime(e);$("#etSchedulePopId").append(i);var t=new Date;Utils.convertToUserTimezone(t),EmailSendingUtil.setBestTime(t);var a=$("#startDate");a&&a.on("change",(function(){var e=$("#tab_startDate_"+EmailComposeUtil.CURRENT_TAB),i=$("#startDate");e.val(i.val())}))}}),EmailComposeUtil.setUPSchedulePopup(!0)},EmailCompose.setMailContent=function(){var e=EmailComposeUtil.data;editor.setContent(e.user.signature)},EmailCompose.showInsertOptions=function(){crmui.hideMsgBand(),$("#emcInsertOption_"+EmailComposeUtil.CURRENT_TAB).show(),EmailCompose.initializeHideSchedulePop()},EmailCompose.setMailAddress=function(e,i,t){if(e){var a,l=$("#ce"+t+"AddrDetails_"+EmailComposeUtil.CURRENT_TAB);if(a=l.children(".ecAddrEditor"),EmailComposeUtil.validateEmailFieldsOfToCcBcc()&&EmailSendingUtil.setUnameAndEmail(e,i,null,a),2===l.children("li").length){var o=document.getElementById("ce"+t.toUpperCase()+"Link_"+EmailComposeUtil.CURRENT_TAB);o&&EmailSendingUtil.newshowHideoptions(o,t.toLowerCase())}}},EmailCompose.deleteDraft=function(e){var i=$("#draftId_"+EmailComposeUtil.CURRENT_TAB),t=i.val(),a=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),l=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val();t&&(i.val(""),EmailComposeUtil.deleteDraft(t,a,l,e))},EmailCompose.deleteDraftPopup=function(e,i,t){if(!e){var a=$("#draftId_"+EmailComposeUtil.CURRENT_TAB);e=a.val()}i||(i=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val()),t||(t=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val());var l=I18n.getMsg("crm.email.delete.confirm.msg",I18n.getMsg("crm.process.tab.draft")),o=event.target,n={val:I18n.getMsg("crm.button.delete"),fn:function(){EmailComposeUtil.deleteDraft(e,i,t),o&&$(o).is(":visible")&&(o.classList.remove("deleteIcon"),o.classList.add("loading")),EmailSendingUtil.composeActive&&EmailUtil.hideEditorFreezeLayer()}},s={val:I18n.getMsg("crm.button.cancel"),fn:function(){EmailSendingUtil.composeActive&&EmailUtil.hideEditorFreezeLayer(),$("#customConfirmationPop").hide()}};EmailSendingUtil.composeActive&&EmailUtil.showEditorFreezeLayer(),renderingUtils.showCustomConfirmMessageNewModel(l,n,s)},EmailCompose.removeTemplate=function(){if(EmailActionHandling.removeTemplate(),editor){editor.zEditor.showRichEditor();var e=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).select2("data");if(e){var i=e[0].element;EmailUtil.setSignature(i.value)}EmailComposeUtil.replyOrForWardMail[EmailComposeUtil.CURRENT_TAB]&&EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB]&&(editor.zEditor.editorDiv.innerHTML=editor.zEditor.editorDiv.innerHTML+EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB])}EmailComposeUtil.tempforwardAttach[EmailComposeUtil.CURRENT_TAB]=[],EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB]&&(EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].tempDraftDetails=editor.getContent())},EmailCompose.launchEmailCompose=function(e,i){(EmailComposeUtil.EditorContent="",CrmEmailInitialize.ComposeMailData)?(EmailComposeUtil.ComposeMailData=CrmEmailInitialize.ComposeMailData,CrmEmailInitialize.PopulateComposeMailData(),i?EmailCompose.launchEmailComposeWindow(e,undefined,i):EmailCompose.launchEmailComposeWindow(e)):CrmEmailInitialize.PopulateComposeMailData(e,!0,i)},EmailCompose.openComposeWindow=function(){EmailCompose.launchEmailCompose(),EmailCompose.setEntityToAddress(),EmailSendingUtil.composeActive=!0,showComposeWindow()},EmailCompose.loadEmailComposeResources=function(){EmailSendingUtil.composeMailData&&(EmailCompose.launchEmailCompose(),showComposeWindow())},EmailCompose.showFreezelayer=function(){var e=$("body"),i=$("#EmailComposeFreezelayer");if(!i||0===i.length){e.append("<div data-zcqa='emailComposeFreezelayer_editor_ecw' id='EmailComposeFreezelayer' class='EmailComposeFreezelayer'></div>"),e.addClass("oH")}},EmailCompose.removeFreezelayer=function(){$("body").removeClass("oH"),$("#EmailComposeFreezelayer").remove()},EmailCompose.launchSignatureEditor=function(e){var i=networkUtils.returnDependencyFiles(["inlineEmailCompose_min.js"],crmConstants.jsStaticPath).concat(networkUtils.returnDependencyFiles(["crm-email-subjectpop.js"],crmConstants.jsStaticPathForLyte)),t=networkUtils.returnDependencyFiles(["inline_ComposeEditor_min.css"],crmConstants.cssStaticPath).concat(networkUtils.returnDependencyFiles(["crm-email-subjectpop.css"],crmConstants.cssStaticPathForLyte)),a=[networkUtils.getI18nJSUrl("emailcompose"),networkUtils.getI18nJSUrl("emaileditor")];Lyte.injectResources(networkUtils.returnDependencyFiles(a,crmConstants.jsStaticPath),void 0,void 0);var l=i.concat(t);Lyte.injectResources(l,void 0,(function(){var i=e.tabId;EmailComposeUtil.CURRENT_TAB=i,EmailComposeUtil.tabDetails[i]={},"undefined"!=typeof ZBluePencil&&ZBluePencil?editor.create(e):Lyte.injectResources(e.dictionaryURL,void 0,(function(){EmailComposeUtil.hasDictionarySourceAdded=!0,editor.create(e)}))}))},EmailCompose.launchEmailComposeWindow=function(e,i,t,a){if(5===EmailComposeUtil.OPEN_TAB_COUNT&&!a&&!EmailCompose.replaceTabid)return EmailSendingUtil.openTabALertPopup=!0,EmailCompose.tempCallback=e,EmailCompose.tempData=i,EmailCompose.tempEditorMode=t,EmailCompose.disableToaddress=!0,$L("#ecwTabPop")[0].ltProp("show",!0),EmailSendingUtil.isSendMailActionCalled=!1,void setTimeout(EmailSendingUtil.openTabALertPopup=!1,2e3);EmailComposeUtil.editorContent="",EmailComposeUtil.isRefresh||(EmailCompose.showFreezelayer(),EmailComposeUtil.hideMaximizeComposeButton()),EmailComposeUtil.preLaunchHandling();var l=EmailComposeUtil.createNewComposeTab(i),o=document.getElementById(EmailComposeUtil.tabIdPrefix+l);EmailComposeUtil.switchToTab(o),EmailComposeUtil.initialize(l,t,e),EmailComposeUtil.showComposeWindow(),$("#editorContent_"+EmailComposeUtil.CURRENT_TAB).on("click",(function(){$("#ecAutoCompleteContainer, #etSchedulePopId").addClass("hide")})),$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).on("click",(function(){$("#ecAutoCompleteContainer, #etSchedulePopId").addClass("hide"),$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).hide()})),EmailComposeUtil.postLaunchHandling()},EmailCompose.getComposeBodyPart=function(e,i){e=EmailComposeUtil.ComposeMailData;EmailComposeUtil.createComposeBody(e,i),EmailComposeUtil.initialize(i),$("#editorContent_"+i).on("click",(function(){$("#ecAutoCompleteContainer, #etSchedulePopId").addClass("hide")})),$("#ceSubject_"+i).on("click",(function(){$("#ecAutoCompleteContainer, #etSchedulePopId").addClass("hide")}))},EmailCompose.setEntityToAddress=function(e,i,t){var a=EmailComposeUtil.isCustomModule(e);if("listview"===t)"Potentials"===e?EmailCompose.getParentEntityDetailsThenRelatedContactDetails(e,i):EmailComposeUtil.getEntityDetailsFromDB(e,i,t);else if("sendReminder"===t){var l=EmailComposeUtil.ReminderMail.userId;EmailComposeUtil.getUserDetails(l,(function(e){var i=e.email,t=e.entityName;EmailCompose.setMailAddress(i,t,"To"),EmailComposeUtil.ReminderMail={}}))}else if("Potentials"===e){var o=$("#cntId");if(o.length>0||o.val()){var n=o.val();EmailComposeUtil.getEntityDetailsFromDB("Contacts",n,t)}else EmailCompose.getParentEntityDetailsThenRelatedContactDetails(e,i,t)}else if("Accounts"===e){e="Contacts",null==(i=$("#contactSelDropdownInAcc :selected").attr("value"))&&(i=$("#contactSelDropdownInAcc").attr("lt-prop-selected")),EmailComposeUtil.getEntityDetailsFromDB(e,i,t)}else if("Invoices"===e||"SalesOrders"===e||"PurchaseOrders"===e||"Quotes"===e)EmailCompose.getParentEntityDetailsThenRelatedContactDetails(e,i,t);else if(a){var s=Crm.userDetails.MODULE_LIST[e].api_name;EmailComposeUtil.getEntityDetailsFromDB(s,i,t),EmailComposeUtil.setCustomModuleName(e)}else EmailComposeUtil.getEntityDetailsFromDB(e,i,t);EmailComposeUtil.setEntityDetails(e,i)},EmailCompose.getParentEntityDetailsThenRelatedContactDetails=function(e,i,t){var a=EmailComposeUtil.getApiNameForModule(e),l=EmailComposeUtil.pdfLayoutDetails?EmailComposeUtil.pdfLayoutDetails.isMailToVendor:void 0;l||(l=void 0),EmailComposeUtil.isMailToVendor=l;var o="/crm/v2/"+a+"/"+i;(new crmRequestPool).initiate({url:o,type:"GET",headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},content:"application/json; charset=UTF-8",dataType:"json",success:function(a){var l=(a=a?a.data[0]:{}).Contact_Name,o=EmailComposeUtil.isMailToVendor;if(EmailComposeUtil.isInventoryModule(e)&&EmailComposeUtil.pdfLayoutDetails&&(EmailComposeUtil.pdfLayoutDetails.subject=a.Subject,EmailComposeUtil.setSubject(a.Subject)),l&&!o)i=l.id,e="Contacts",EmailComposeUtil.getEntityDetailsFromDB(e,i,t);else if(o){var n=a.Vendor_Name;i=n.id,e="Vendors",EmailComposeUtil.getEntityDetailsFromDB(e,i,t)}EmailComposeUtil.isMailToVendor=!1}})},EmailCompose.addSecondaryMailDropDown=function(e,i){$("#secondaryEmailOption_"+EmailComposeUtil.CURRENT_TAB).removeClass("hide");var t=e+"###"+i,a=$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).find("ul").children("li"),l=["EO","EA","AO"];$.each(a,(function(e){this.setAttribute("onClick","EmailComposeUtil.populateAddnEmail('"+l[e]+"',\""+$ESAPI.encoder().encodeForJavaScript(t)+'")')}))},EmailCompose.fetchDraftDetails=function(e,i,t){i||(i=$("#module").val()),t||(t=$("#entityId").val()),EmailComposeUtil.loadI18nResources();var a=$("#isFromNewAPI").length>0,l=e,o=$("#dealOnlyDropDown");if(a&&"Potentials"==i&&o.length>0&&"dealsOnly"!=o.attr("lt-prop-selected")&&(i="Contacts",t=o.attr("lt-prop-selected")),!Crm.userDetails.isNewEditor){var n=Crm.getCrmBasePath()+"/mailer/EntReply.do?action=viewDraft",s="&user_id="+Crm.userDetails.USER_ID+"&module="+i+"&entId="+t+"&draftId="+e;return s+="&"+csrfParamName+"="+encodeURIComponent(csrfToken),void(new crmRequestPool).initiate({action:n,data:s,success:function(e){var i=$("#lookupdiv");0==$("crm-emails-related-list").length&&i.addClass("edvContainer");var t=$(document.createElement("iframe"));t.attr({id:"emailDetailIframeContent",style:"opacity:1; width:100%; height:100%;clear: both; border: medium none",src:"/crm/html/content1.html"}),$(document.getElementById("lookupdiv")).append(t).append('<div id="edvFreezeLayer" class="hide"><div id="loading-bar-spinner" class="spinner"><div class="spinner-icon"></div></div></div>'),$("#emailDetailIframeContent").load((function(){var i=$("#emailDetailIframeContent").contents(),t=i.find("body"),a=i.find("#emailDetailContentDivOuter .getFirstEmailContent").height();setTimeout((function(){$("#emailDetailIframeContent").parent().css("z-index",28),document.getElementById("emailDetailIframeContent").contentWindow.document.write(e),0==$("crm-emails-related-list").length&&mailsetCenter("lookupdiv")}),0),$("#lookupdiv").removeClass("p20").addClass("mB20"),t.css("overflow","hidden"),i.find("#emailDetailContentDivOuter").perfectScrollbar({wheelSpeed:1,wheelPropagation:!0,suppressScrollX:!1}),setTimeout((function(){var e=$("#emailDetailIframeContent").contents(),i=e.find("body"),t=e.find(".ecMailDp");i.css("margin","0");var l=t.hasClass("emptyImgContainer")?"/nophoto_80ea3af_.png":t.attr("src");if(a>545&&e.find("#mailClientPopupCss").addClass("headerFixCssAfter"),e.find("#emailDetailContentDivOuter").perfectScrollbar({wheelSpeed:1,wheelPropagation:!0,suppressScrollX:!1}),l&&"nophoto_80ea3af_.png"==l.substr(l.lastIndexOf("/")+1))t.addClass("emptyImgContainer"),createAvatar();else{var o='<img src="'+l+'" alt="" style=" border:1px solid #fff;border-radius:50%;" height="48" width="48">';t.parent().append(o),t.remove()}var n=$("#edvFreezeLayer");n.length&&n.addClass("hide"),"canvas"==Lyte.Router.getRouteInstance().routeName&&e.find(".enrichData").hide()}),200)})),freezeBackground();var a=$("#FreezeLayer");a.css({"z-index":"24"}),$("#isFromNewAPI").length>0&&(i.addClass("topAlignEmailDetail").show(),setPopCenter(i)),$("#kso_mails_list .kso_eachMailContainer").length?(i.css({position:"absolute",width:"1000px",height:"600px",zIndex:35,opacity:"1"}).show(),a.css({"z-index":"33"})):i.css({position:"absolute",width:"1000px",height:"600px",zIndex:30,opacity:"1"}).show(),EvalInnerScript(i.get(0)),$(".currViewedMail").removeClass("currViewedMail")}})}var m=EmailComposeUtil.validateMailSendingPermission(i,t,e,(function(e,i,t){var o=EmailComposeUtil.getTabIdContainingGivenDraft(e),n=$("#moduleName_"+o),s=$("#ecEntityId_"+o);if((e&&n.val()!==i&&s.val()!==t&&(n.val(i),s.val(t)),o)&&EmailCompose.etMaximizeCompose(o))return;if("Accounts"===(i=EmailComposeUtil.getApiNameForModule(i))){i="Contacts";var m=$("#contactSelDropdownInAcc :selected");t=m.attr("value");var r=$("#accountsDrafts");a&&r.length>0&&(t=r[0].ltProp("selected"))}var d=EmailComposeUtil.getAPIDraftURL(e,i,t);(new crmRequestPool).initiate({url:d,headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},type:"GET",success:function(o){if(!o){if(crmui.showMsgBand("error",I18n.getMsg("crm.email.no.drafts.msg"),5e3),EmailComposeUtil.removeDraftIdFromSessionStorage(e),EmailCompose.replaceTabid&&(EmailUtil.closeEmailTab(EmailCompose.replaceTabid,!1,!1,!0),EmailCompose.replaceTabid=""),0===EmailComposeUtil.OPEN_TAB_COUNT&&EmailCompose.isRefreshFirstOpen)$("#maxComposeBtn").addClass("hide");return commonUtils.showHideLoadingDiv(!1),void(EmailCompose.isRefreshFirstOpen=!1)}EmailCompose.isRefreshFirstOpen=!1;var n=o?o[EmailComposeUtil.Draft_Root_Element][0]:null;if($("#isFromNewAPI").length>0){var s=EmailComposeUtil.getTabIdContainingGivenDraft(n.id);if(s)if(EmailCompose.etMaximizeCompose(s))return}!!n&&n.email_opt_out?renderingUtils.showCustomAlert(I18n.getMsg("crm.label.emailoptout.alert.message")):(EmailCompose.populateComposeData=o,EmailCompose.isDraftOpen=!0,EmailCompose.launchEmailCompose((function(){(o=EmailCompose.populateComposeData).Email_Drafts[0].rich_text||editor.zEditor.showPlainEditor(!0);var n="draft";if(EmailComposeUtil.isInventoryModule(i)||"Potentials"===i)EmailCompose.getParentEntityDetailsThenRelatedContactDetails(i,t,n);else if(EmailComposeUtil.isCustomModule(i)){var s=Crm.userDetails.MODULE_LIST[i].api_name;EmailComposeUtil.getEntityDetailsFromDB(s,t,n)}else EmailComposeUtil.getEntityDetailsFromDB(i,t,n);EmailComposeUtil.setEntityDetails(i,t),EmailComposeUtil.bindSalesIqLink(),EmailCompose.populateComposeMailData(o),EmailCompose.populateComposeData={},e=o.Email_Drafts[0].id,$("#draftId_"+EmailComposeUtil.CURRENT_TAB).val(e),$("#deleteDraft_"+EmailComposeUtil.CURRENT_TAB).removeClass("hide"),$("#deleteDraftIcon_"+EmailComposeUtil.CURRENT_TAB).removeClass("hide"),$("#draftStatusMsg_"+EmailComposeUtil.CURRENT_TAB).text(I18n.getMsg("crm.email.label.delete.draft")),EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails?(EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails.draftId=e,a&&(EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails.newRLDraftId=l)):(EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails={},EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails.draftId=e,a&&(EmailComposeUtil.tabDetails[EmailComposeUtil.CURRENT_TAB].draftDetails.newRLDraftId=l)),EmailComposeUtil.setEditorFocus()}),o))},error:function(i){("204"===i.status&&crmui.showMsgBand(I18n.getMsg("crm.email.no.drafts.msg"),5e3),i.responseJSON&&"NO_PERMISSION"===i.responseJSON.code?EmailUtil.showMsg("error",I18n.getMsg("crm.security.error"),3e3):i.responseJSON&&"the id given seems to be invalid"===i.responseJSON.message?EmailUtil.showMsg("error",I18n.getMsg("crm.email.no.drafts.msg"),3e3):i.responseJSON&&"the related id given seems to be invalid"===i.responseJSON.message&&EmailUtil.showMsg("error",I18n.getMsg("crm.email.label.error.item_deleted_or_removed",I18n.getMsg("Record")),3e3),EmailComposeUtil.removeDraftIdFromSessionStorage(e),EmailCompose.replaceTabid&&(EmailUtil.closeEmailTab(EmailCompose.replaceTabid,!1,!1,!0),EmailCompose.replaceTabid=""),0===EmailComposeUtil.OPEN_TAB_COUNT&&EmailCompose.isRefreshFirstOpen)&&$("#maxComposeBtn").addClass("hide");EmailCompose.isRefreshFirstOpen=!1,commonUtils.showHideLoadingDiv(!1)}})}));if(!m)return!1},EmailCompose.launchReplyMail=function(e,i,t){if(CrmEmailInitialize.ComposeMailData)EmailCompose.TriggerLaunchReplyMail(e,i,t);else{var a={"X-ZOHO-SERVICE":"crm","X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken,"X-CRM-ORG":crmZgid};(new crmRequestPool).initiate({url:"/crm/v2/__internal/__emailcompose_meta",type:"GET",headers:a,content:"application/json",success:function(a){CrmEmailInitialize.ComposeMailData=a.data[0],CrmEmailInitialize.ComposeMailData&&(Crm.userDetails.isComposeAutoSuggestionEnabled=CrmEmailInitialize.ComposeMailData.features_available.auto_suggestion),EmailCompose.TriggerLaunchReplyMail(e,i,t)},error:function(){crmui.showMsgBand("error",I18n.getMsg("error.unexpected"),3e3)}})}},EmailCompose.TriggerLaunchReplyMail=function(e,i,t){EmailComposeUtil&&(EmailComposeUtil.ComposeMailData=CrmEmailInitialize.ComposeMailData),EmailComposeUtil&&EmailComposeUtil.ComposeMailData&&EmailComposeUtil.ComposeMailData.default_from&&(e.from_address=EmailComposeUtil.ComposeMailData.default_from),EmailComposeUtil.validateMailSendingPermission(i,t,e,EmailCompose.populateReplyMailDetails),EmailSendingUtil.SwitchedFromOldToNew=!1},EmailCompose.populateReplyMailDetails=function(e,i,t){EmailComposeUtil.isReplyMail=!0,EmailComposeUtil.closeViewMailPopUp(),EmailCompose.populateComposeData=e,EmailCompose.launchEmailCompose((function(){var e=EmailCompose.populateComposeData,i=e?e.data[0].attachments:{},t=i?EmailUtil.formatAttachment(i):[];EmailCompose.populateEmailContentOnReply(e),EmailComposeUtil.putAttachmentsOnEditor(t),EmailCompose.populateComposeData={},EmailComposeUtil.setEditorFocus()})),EmailComposeUtil.setEntityDetails(i,t)},EmailCompose.postEditorLoad=function(e){if(EmailCompose.action&&(EmailComposeUtil.action[EmailComposeUtil.CURRENT_TAB]=EmailCompose.action),EmailCompose.action="",$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).select2("open"),$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).select2("close"),$(".dv_consent_status_lists").hide(),EmailComposeUtil.ComposeMailData&&EmailComposeUtil.ComposeMailData.default_from&&("compose"===EmailSendingUtil.action||"reply"===EmailSendingUtil.action)){var i=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).find("[value='"+$.escapeSelector(EmailComposeUtil.ComposeMailData.default_from.email)+"']");"org_email"===EmailComposeUtil.ComposeMailData.default_from.type?(i&&i.length>1&&(i[0].value=EmailComposeUtil.ComposeMailData.default_from.email+EmailComposeUtil.CURRENT_TAB),EmailComposeUtil.setFromAddress(EmailComposeUtil.ComposeMailData.default_from.email,!0),i&&i.length>1&&(i[0].value=EmailComposeUtil.ComposeMailData.default_from.email),EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!0):(i&&i.length>1&&i[1]&&(i[1].value=EmailComposeUtil.ComposeMailData.default_from.email+EmailComposeUtil.CURRENT_TAB),EmailComposeUtil.setFromAddress(EmailComposeUtil.ComposeMailData.default_from.email),i&&i.length>1&&i[1]&&(i[1].value=EmailComposeUtil.ComposeMailData.default_from.email),EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!1)}EmailSendingUtil.switchedToOldWin=!1,EmailComposeUtil.isCloseAll=!1;var t=CrmEmailInitialize.ComposeMailData.from_address;if(t&&1===t.length?$("#fromDetails_"+EmailComposeUtil.CURRENT_TAB).addClass("ecwSingleUserList"):$("#fromDetails_"+EmailComposeUtil.CURRENT_TAB).removeClass("ecwSingleUserList"),EmailSendingUtil.SwitchedFromOldToNew){if(EmailComposeUtil.setFromAddress(EmailSendingUtil.fromAddr),EmailComposeUtil.setReplyToAddress(EmailSendingUtil.replyTo),EmailActionHandling.isSwitchSave=!0,EmailSendingUtil.oldScheduleText){var a=$("#emc_bestTime_"+EmailComposeUtil.CURRENT_TAB);a.removeClass("hide");var l=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB);l.prop("checked",!0),a.find("label")[0].innerText=EmailSendingUtil.oldScheduleText,l.val(EmailSendingUtil.oldScheduleval),$("#emcSendBtn").addClass("hide"),$("#emcScheduleMailBtn").removeClass("hide")}crmui.showMsgBand("success",I18n.getMsg("crm.email.compose.switchedToNew"),3e3)}else EmailCompose.isDraftOpen||"999"===EmailComposeUtil.CURRENT_TAB||EmailCompose.openingScheduleMail||EmailComposeUtil.isReplyMail||EmailSendingUtil.SwitchedFromOldToNew||EmailUtil.setSignature(EmailComposeUtil.ComposeMailData.default_from.email);if(EmailLaunchUtil.privacyPolicyDetails&&EmailLaunchUtil.privacyPolicyDetails.isConsentEmail?(EmailComposeUtil.isConsentEmail[EmailComposeUtil.CURRENT_TAB]=!0,EmailLaunchUtil.privacyPolicyDetails.isConsentEmail=!1):EmailComposeUtil.isConsentEmail[EmailComposeUtil.CURRENT_TAB]=!1,EmailLaunchUtil.privacyPolicyDetails&&EmailLaunchUtil.privacyPolicyDetails.dataReqObj){EmailComposeUtil.dataReqObj[EmailComposeUtil.CURRENT_TAB]=EmailLaunchUtil.privacyPolicyDetails.dataReqObj;var o=EmailComposeUtil.getFormattedAttachmentDetails(EmailLaunchUtil.privacyPolicyDetails.dataReqObj.id,I18n.getMsg("crm.mail.label.DataRequest")+"_"+$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val()+".csv");o.EDITOR_ATTACH=1,editor.zEditor.displayAttachment(o),EmailLaunchUtil.privacyPolicyDetails.dataReqObj=""}else EmailComposeUtil.dataReqObj[EmailComposeUtil.CURRENT_TAB]="";if(EmailLaunchUtil.showHideFromRecord(),!EmailCompose.openingScheduleMail&&EmailComposeUtil.isReplyMail?EmailComposeUtil.replyOrForWardMail[EmailComposeUtil.CURRENT_TAB]=!0:EmailComposeUtil.replyOrForWardMail[EmailComposeUtil.CURRENT_TAB]=!1,EmailComposeUtil.tempforwardAttach[EmailComposeUtil.CURRENT_TAB]=[],EmailCompose.isDraftOpen=!1,EmailCompose.openingScheduleMail=!1,EmailComposeUtil.editorLoaded=!0,EmailComposeUtil.resourcesLoaded=!0,EmailCompose.autoComplete(),EmailComposeUtil.initiateDraft(),EmailUtil.initializePlainTextEditor(),EmailComposeUtil.bindSalesIqLink(),EmailComposeUtil.doBindings(),!initializeSpellCheck.isSpellCheckEnabled)var n=0,s=setInterval((function(){if(initializeSpellCheck&&"undefined"!=typeof ZBluePencil&&ZBluePencil||n++>10){"undefined"!=typeof ZBluePencil&&ZBluePencil||clearInterval(intervalId),initializeSpellCheck.startSpellCheck();var e=EmailComposeUtil.getCurrentContentId();document.getElementById(e).querySelector("#spellcheck_li").children[0].classList.add("selectedLi"),clearInterval(s)}}),250);editor.zEditor.editorDiv.onclick=function(){var e=EmailComposeUtil.getAutoCompleteSuggestedElem();e&&(e.parentElement.removeChild(e),editor.zEditor.enableTab=!1)},EmailComposeUtil.setInitialComposeWindowFocus(),EmailComposeUtil.displayComposeMetaFields(),editor.zEditor.editorDiv.focus(),EmailSendingUtil.templateData&&EmailSendingUtil.isLoadTemplate&&(EmailSendingUtil.isLoadTemplate=!1,EmailSendingUtil.populateEditorWithTemplate(EmailSendingUtil.templateData,EmailSendingUtil.module),EmailComposeUtil.setSubject(EmailSendingUtil.templateData.subject),EmailSendingUtil.templateData="");var m=editor.zEditor.saveCaretPostion();e?e():EmailComposeUtil.editorContent&&editor.setContent(EmailComposeUtil.editorContent),EmailSendingUtil.switchPlaineditor&&(editor.zEditor.switchToPlainEditor(),EmailSendingUtil.switchPlaineditor=!1),$(".etComposeHeader:not(#ecw_tab_"+EmailComposeUtil.CURRENT_TAB+")").removeClass("etComposeHeader"),m.collapse=!0,editor.zEditor.restoreCaretPosition(m),EmailComposeUtil.setInitialComposeWindowFocus(),"999"!==EmailComposeUtil.CURRENT_TAB&&EmailComposeUtil.setDefaultValues(),EmailComposeUtil.isReplyMail=!1,setTimeout(EmailUtil.saveTempDraftDetails,1e3),setTimeout((function(){EmailSendingUtil.removeFocus?(editor.zEditor.editorDiv.blur(),EmailSendingUtil.removeFocus=!1):EmailComposeUtil.setInitialComposeWindowFocus()}),500),editor.zEditor.z_doc.getElementById("editorDiv").style.outline="none",$(".composeContentPanel").not(".hide").find(".select2-selection__rendered").addClass("activeFromSpan"),EmailComposeUtil.TEMP_TAB=EmailComposeUtil.CURRENT_TAB,EmailSendingUtil.isSendMailActionCalled=!1,commonUtils.showHideLoadingDiv(!1),$("[isActiveComposeTab]").attr("isActiveComposeTab",!1),$("#ecw_tab_"+EmailComposeUtil.CURRENT_TAB).attr("isActiveComposeTab",!0)},EmailCompose.setCursorFocus=function(){$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).focus()},EmailCompose.insertWord=!0,EmailCompose.suggestedString,EmailCompose.enableTab,EmailCompose.partOfTheSuggestedWordTyped,EmailCompose.responseAwaiting=!1,EmailCompose.TypedTextBeforeRecievingResponse="",EmailCompose.autoComplete=function(){editor.zEditor.z_doc.getElementById("editorDiv").addEventListener("keydown",(function(e){var i=editor.zEditor,t=i.z_doc;if(EmailComposeUtil.isAutoCorrectionEnabled){var a;if(i.enableTab){if(a=t.getElementsByClassName("suggestedWord")[0],9===e.keyCode||39===e.keyCode){e.preventDefault(),e.stopPropagation();var l=t.getSelection(),o=l.getRangeAt(0);return setTimeout((function(){var e=editor.zEditor.z_doc,t=a?a.innerText:"",n=e.createTextNode(t);o.insertNode(n),EmailCompose.insertWord=!0;var s=e.getElementsByClassName("suggestedWord")[0];s&&s.innerText&&Crm.client_tracking("Compose Auto Complete"),EmailComposeUtil.removeSuggestedElement(s),o.setStart(l.anchorNode.nextSibling,l.anchorNode.nextSibling.length),o.collapse(!0),l.removeAllRanges(),l.addRange(o),i.enableTab=!1,EmailCompose.suggestedString=""}),1),!1}var n=EmailCompose.suggestedString,s=e.keyCode,m=e.key;if(EmailComposeUtil.isValidWordKey(s))if(EmailCompose.partOfTheSuggestedWordTyped+=m,n===EmailCompose.partOfTheSuggestedWordTyped)a&&EmailComposeUtil.removeSuggestedElement(a),i.enableTab=!1,EmailCompose.suggestedString="";else if(n.startsWith(EmailCompose.partOfTheSuggestedWordTyped)){var r=EmailCompose.partOfTheSuggestedWordTyped.length,d=n.slice(r);if(a&&(a.innerText=d)," "===e.key||"Space"===e.key||32===e.keyCode)return}else a&&EmailComposeUtil.removeSuggestedElement(a),i.enableTab=!1,EmailCompose.suggestedString="";else if("Backspace"===e.key){if(0===EmailCompose.partOfTheSuggestedWordTyped.length)a&&EmailComposeUtil.removeSuggestedElement(a),i.enableTab=!1,EmailCompose.suggestedString="";else if(EmailCompose.partOfTheSuggestedWordTyped=EmailCompose.partOfTheSuggestedWordTyped.slice(0,-1),n.startsWith(EmailCompose.partOfTheSuggestedWordTyped)){r=EmailCompose.partOfTheSuggestedWordTyped.length,d=n.slice(r);a&&(a.innerText=d,a.hidden=!1)}}else EmailComposeUtil.isInvalidKey(s)&&(a&&EmailComposeUtil.removeSuggestedElement(a),i.enableTab=!1,EmailCompose.suggestedString="")}else if(EmailCompose.responseAwaiting){s=e.keyCode,m=e.key;EmailComposeUtil.isValidWordKey(s)&&(EmailCompose.TypedTextBeforeRecievingResponse+=m)}if(!EmailCompose.responseAwaiting&&(" "===e.key||"Space"===e.key||32===e.keyCode)){var c=EmailComposeUtil.getTextUptoCursorPos();if(!EmailComposeUtil.isValidInputForAutoComplete(c))return;var E=$("#ceToAddrDetails_"+EmailComposeUtil.CURRENT_TAB).find("li").eq(0).attr("email"),p=E||"",u=$("#select2-etSenderList_"+EmailComposeUtil.CURRENT_TAB+"-container").text(),g=u||"",C={},U=(new Date).getTime();U=parseInt(U);var h=parseInt(U/1e3);C.input=c.trim(),C.to_address=p,C.from_address=g,C.timestamp=h+"",C=JSON.stringify(C),EmailCompose.responseAwaiting=!0;var v=t.createElement("span");v.classList.add("suggestedWord"),v.setAttribute("style","color:#ccc;"),v.setAttribute("data-zbluepencil-ignore",!0),EmailCompose.autoCompleteReqPool=new crmRequestPool,EmailCompose.autoCompleteReqPool.initiate({url:"/crm/zia/text/api/v2/autocomplete.do",type:"POST",data:C,xhrFields:{withCredentials:!0},headers:{"Content-Type":"application/json","X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},dataType:"json",content:"application/json; charset=UTF-8",success:function(a){if(!(a="string"==typeof a?JSON.parse(a):a))return!1;if(a.sentence||a.word){var l=a.sentence?a.sentence:a.word;if(t.getElementsByClassName("suggestedWord")[0])return!1;if(EmailCompose.insertWord){e.preventDefault(),e.stopPropagation();var o=t.getSelection(),n=o.getRangeAt(0);if(EmailCompose.responseAwaiting=!1,EmailCompose.partOfTheSuggestedWordTyped=EmailCompose.TypedTextBeforeRecievingResponse,EmailCompose.TypedTextBeforeRecievingResponse="",!l.startsWith(EmailCompose.partOfTheSuggestedWordTyped))return EmailCompose.partOfTheSuggestedWordTyped&&Crm.client_tracking("Compose Auto Complete Slowness"),!1;var s=EmailCompose.partOfTheSuggestedWordTyped.length,m=l.slice(s);return EmailCompose.suggestedString=l,i.enableTab=!0,v.innerText=m,n.insertNode(v),n.setStart(o.anchorNode,o.anchorNode.length),n.collapse(!0),o.removeAllRanges(),o.addRange(n),!1}}},complete:function(){EmailCompose.responseAwaiting=!1,EmailCompose.TypedTextBeforeRecievingResponse=""}})}}}))},EmailCompose.populateComposeMailData=function(e){var i=e.Email_Drafts[0],t=i.subject?i.subject:"",a=i.from_address,l=i.content?i.content:"";"string"==typeof a&&a.indexOf("{")>-1&&(a=JSON.parse(a).email);var o=i.replyto_address;if(EmailComposeUtil.setReplyToAddress(o),EmailComposeUtil.setFromAddress(a),EmailComposeUtil.populateEmailAddress(i,"to_address"),EmailComposeUtil.populateEmailAddress(i,"cc_address"),EmailComposeUtil.populateEmailAddress(i,"bcc_address"),i.schedule_details){var n=i.schedule_details;EmailComposeUtil.setScheduleTime(n)}if(i.template){var s=i.template.id;EmailComposeUtil.populateWithTemplate(s,t,l)}else EmailComposeUtil.setSubject(t),l&&("undefined"!=typeof editor?(editor.setContent(l),EmailComposeUtil.editorContent=l):EmailComposeUtil.editorContent=l);if(i[EmailComposeUtil.INVENTORY_DETAILS]){var m=i[EmailComposeUtil.INVENTORY_DETAILS];if(m)if(EmailUtil.setInventoryDetails(m),!EmailComposeUtil.isInventoryModule()){var r=m.record.id;EmailComposeUtil.setEntityDetailsEquivalentToInventoryModule(r,m)}}EmailComposeUtil.putAttachmentsOnEditor(i.attachments)},EmailCompose.populateEmailContentOnReply=function(e){if(e){var i=e.data[0],t=i.subject,a=i.from,l=i.content,o=i.enc_msgid,n=i.msgid,s=i.enc_thread_id,m=$("#sendMailType_"+EmailComposeUtil.CURRENT_TAB);if("string"==typeof a&&a.indexOf("{")>-1&&(a=JSON.parse(a).email),a&&(EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!1),i.sent_time?(EmailComposeUtil.setFromAddress(a.email),EmailSendingUtil.OrgEmailArray.contains(a.email)&&EmailSendingUtil.other_emails_array&&!EmailSendingUtil.other_emails_array.contains(a.email)&&(EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!0)):(a=EmailComposeUtil.ComposeMailData.default_from.email,EmailComposeUtil.setFromAddress(a),EmailSendingUtil.OrgEmailArray.contains(a)&&EmailSendingUtil.other_emails_array&&!EmailSendingUtil.other_emails_array.contains(a)&&(EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB]=!0)),EmailSendingUtil.SwitchedFromOldToNew&&EmailSendingUtil.fromAddr&&EmailComposeUtil.setFromAddress(EmailSendingUtil.fromAddr),t&&EmailComposeUtil.setSubject(t),EmailComposeUtil.populateEmailAddress(i,"to"),EmailComposeUtil.populateEmailAddress(i,"cc"),EmailComposeUtil.populateEmailAddress(i,"bcc"),i.sent_time){var r=i.sent_time;EmailComposeUtil.setScheduleTime(r,!0),m.val(EmailComposeUtil.EDIT_IN_COMPOSE)}else if(l){var d=l.indexOf("<div data-zbluepencil-ignore=true id=ecw_signature>");if(d<20&&d>-1){var c=$(l),E=$("<p>").append(c),p=E.find("#ecw_signature")[0];p&&p.remove();var u=E.html();u="<br><br><div data-zbluepencil-ignore=true id=ecw_signature></div>"+u,EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB]=u}else l="<br><br><div data-zbluepencil-ignore=true id=ecw_signature></div>"+l,EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB]=l;0===EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB].indexOf("<br><br><br><br>")&&EmailSendingUtil.pMailContent[EmailComposeUtil.CURRENT_TAB].replace("<br><br>","")}else l="<br><br><div data-zbluepencil-ignore=true id=ecw_signature></div>";var g=$("#msgId_"+EmailComposeUtil.CURRENT_TAB),C=$("#enc_msgId_"+EmailComposeUtil.CURRENT_TAB),U=$("#enc_threadId");if(g.val(n),C.val(o),U.val(s),l&&("undefined"!=typeof editor?(editor.setContent(l),EmailComposeUtil.editorContent=l):EmailComposeUtil.editorContent=l,i.sent_time||EmailSendingUtil.SwitchedFromOldToNew||EmailUtil.setSignature($("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).val())),null!=i.to)if(Lyte.registeredMixins["crm-email-emotions-mixin"])Lyte.registeredMixins["crm-email-emotions-mixin"].loadEmotionBand(i.emotion,i.to[0].user_name);else{var h=networkUtils.returnDependencyFiles(["email-emotions.js"],crmConstants.jsStaticPathForLyte);Lyte.injectResources(h,void 0,(function(){Lyte.registeredMixins["crm-email-emotions-mixin"].loadEmotionBand(i.emotion,i.to[0].user_name)}))}}},EmailCompose.SendMailEvent=function(e,i,t,a){if(i)if(CrmEmailInitialize.ComposeMailData)EmailCompose.TriggerMailEvent(e,i,t,a);else{var l={"X-ZOHO-SERVICE":"crm","X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken,"X-CRM-ORG":crmZgid};(new crmRequestPool).initiate({url:"/crm/v2/__internal/__emailcompose_meta",type:"GET",headers:l,content:"application/json",success:function(l){CrmEmailInitialize.ComposeMailData=l.data[0],CrmEmailInitialize.ComposeMailData&&(Crm.userDetails.isComposeAutoSuggestionEnabled=CrmEmailInitialize.ComposeMailData.features_available.auto_suggestion),EmailCompose.TriggerMailEvent(e,i,t,a)},error:function(){crmui.showMsgBand("error",I18n.getMsg("error.unexpected"),3e3)}})}else renderingUtils.showCustomAlert("Not an Entity Window... will be handled soon.")},EmailCompose.TriggerMailEvent=function(e,i,t,a){if(hideMenu(),EmailSendingUtil.isEntityWindow=!0,EmailSendingUtil.action="compose",EmailComposeUtil.setMessagesForAlerts(),EmailComposeUtil.resourcesLoaded)EmailCompose.launchEmailComposeEvent(a),EmailCompose.disableToaddress?EmailCompose.disableToaddress=!1:EmailCompose.setEntityToAddress(e,i,t);else{var l=[networkUtils.getI18nJSUrl("emailcompose"),networkUtils.getI18nJSUrl("emaileditor")];Lyte.injectResources(networkUtils.returnDependencyFiles(l,crmConstants.jsStaticPath),void 0,(function(){EmailCompose.launchEmailComposeEvent(a),EmailCompose.disableToaddress?EmailCompose.disableToaddress=!1:EmailCompose.setEntityToAddress(e,i,t)}))}},EmailCompose.launchEmailComposeEvent=function(e){e?EmailCompose.launchEmailCompose(e):EmailCompose.launchEmailCompose()},EmailCompose.sendMailEventForInventoryModule=function(e,i,t){var a,l,o,n,s;EmailComposeUtil.pdfLayoutDetails={},a=t.layout_id,l=t.layout_name,o=t.paperType,n=t.viewType,s="string"==typeof(s=t.flag)&&"true"===s,EmailComposeUtil.pdfLayoutDetails.layoutId=a,EmailComposeUtil.pdfLayoutDetails.layoutName=l,EmailComposeUtil.pdfLayoutDetails.paperType=o,EmailComposeUtil.pdfLayoutDetails.viewType=n,EmailComposeUtil.pdfLayoutDetails.isMailToVendor=s;EmailLaunchUtil.SendMailEvent(e,i,"",(function(){var e=EmailComposeUtil.pdfLayoutDetails.layoutId,i=EmailComposeUtil.pdfLayoutDetails.layoutName,t=EmailComposeUtil.pdfLayoutDetails.paperType,a=EmailComposeUtil.pdfLayoutDetails.viewType,l=EmailComposeUtil.pdfLayoutDetails.subject;EmailComposeUtil.pdfLayoutDetails={},t="default"===t?"A4":t,(i+=".pdf").includes(".pdf")||(i+=".pdf");var o=EmailComposeUtil.getFormattedAttachmentDetails(e,i);o.EDITOR_ATTACH=1,editor.zEditor.displayAttachment(o),$("#layout_Id_"+EmailComposeUtil.CURRENT_TAB).val(e),$("#layout_Name_"+EmailComposeUtil.CURRENT_TAB).val(i),$("#paperType_"+EmailComposeUtil.CURRENT_TAB).val(t),$("#viewType_"+EmailComposeUtil.CURRENT_TAB).val(a),$("#inventoryMailFlag_"+EmailComposeUtil.CURRENT_TAB).val(s),l&&EmailComposeUtil.setSubject(l),EmailUtil.setSignature(EmailComposeUtil.ComposeMailData.default_from.email),editor.setContent(EmailComposeUtil.editorContent)}))},EmailCompose.editScheduleMail=function(e,i,t){var a=Crm.userDetails.USER_ID,l="editInCompose",o="/crm/v2/__internal/"+(e=EmailComposeUtil.getApiNameForModule(e))+"/"+i+"/Emails/"+t+"/actions/"+l;EmailComposeUtil.isCustomModule(e)&&(o="/crm/v2/__internal/"+Crm.userDetails.MODULE_LIST[e].api_name+"/"+i+"/Emails/"+t+"/actions/"+l);var n="user_id="+a+"&mail_type=ALLUSERSMAILS&sent=true";(new crmRequestPool).initiate({action:o,headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},data:n,type:"GET",success:function(t){if(t.data&&t.data[0]&&t.data[0].enc_msgid){EmailCompose.openingScheduleMail=!0;var a="/crm/email/v2/"+e+"/"+i+"/Emails?message_id="+t.data[0].enc_msgid+"composescheduledelete",o={"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken};(new crmRequestPool).initiate({type:"DELETE",url:a,data:{},headers:o,success:function(){EmailUtil.refreshEmailRelList()}})}EmailSendingUtil.action=l,EmailCompose.launchReplyMail(t,e,i)},error:function(){crmui.showMsgBand("error",I18n.getMsg("crm.migration.general.error"),3e3)}})},EmailCompose.etScheduleEvent=function(e,i){1===i?EmailComposeUtil.assignTimeSchedule():EmailComposeUtil.assignTimeSchedule(!0)},EmailCompose.showScheduleMailPopup=function(e){var i=$(e),t=editor.zEditor.z_doc;t=$(t);var a=i.offset(),l=$("#etSchedulePopId");thirdPartyUtils.bindSelect2("#timeZone"),event.stopPropagation(),t.find("#attachmentDiv").addClass("emailComposeCRM"),l.removeClass("hide");var o=l.innerHeight(),n=l.innerWidth(),s=a.left-n/2+35,m=a.top-o-15;l.css({left:s,top:m}),$("#timeZone").on("select2:open",(function(){$(".select2-dropdown").addClass("ecwTimeZone")})),l.click((function(e){e.stopPropagation(),$("#calenDiv").hide()}))},EmailCompose.etShowSchedule=function(e){EmailComposeUtil.closeOtherPopUps();var i=$("#ecUpComing"),t=i.is(":checked"),a=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val();EmailSendingUtil.processAndSetBestTime(EmailSendingUtil.bestTimeData,a,!1),t&&(i.prop("checked",t),$("#timeZone").parent().hide()),EmailCompose.showScheduleMailPopup(e),EmailCompose.initializeHideSchedulePop();var l=$("#startDate");$("#tab_startDate_"+EmailComposeUtil.CURRENT_TAB).val(l.val()),EmailSendingUtil.timeInit(),$(window).resize((function(){var e=$("#etSchedulePopId"),i=$("#ecAttachmentsOption_ecw"),t=$("#attachmentDIV"),a=i.offset(),l=a.left,o=a.top,n=t.innerHeight();e.is(":visible")&&e.addClass("hide"),t.css({top:o-n,left:l})}))},EmailCompose.resetSchedulePopupPosition=function(){var e=$("#etShowSchedule_"+EmailComposeUtil.CURRENT_TAB).offset(),i=$("#etSchedulePopId"),t=i.innerHeight(),a=i.innerWidth(),l=e.left-a/2+35,o=e.top-t-15;i.css({left:l,top:o})},EmailCompose.initializeHideSchedulePop=function(){$("#z_editor").contents().find(".editorDiv").click((function(){EmailCompose.hideSchedulePop(),EmailUtil.hidecallout()})),$("#EmailComposeFreezelayer,#etComposePanel").on("click",(function(){EmailCompose.hideSchedulePop()}))},EmailCompose.hideSchedulePop=function(){$("#addSecondaryEmail_"+EmailComposeUtil.CURRENT_TAB).hide();var e=$("#etSchedulePopId"),i=$("#calenDiv");e.addClass("hide"),$("#emcInsertOption_"+EmailComposeUtil.CURRENT_TAB).hide(),i.addClass("hide");var t=$("#timeZone"),a=$("#etSenderList");t.data("select2")&&t.select2("close"),a.data("select2")&&a.select2("close"),$("#sdiv").hide()},EmailCompose.etCloseAllTabs=function(){for(var e=EmailComposeUtil.CURRENT_TAB,i=EmailComposeUtil.OPEN_TAB_COUNT,t=!1,a=1;a<=i;a++)if(EmailComposeUtil.switchToCurrentEditor(EmailComposeUtil.CURRENT_TAB+""),EmailActionHandling.hasAnythingChanged()){t=!0;break}if(EmailComposeUtil.CURRENT_TAB=e,t)$L("#ecwCloseAllPop")[0].ltProp("show",!0);else{for(a=0;a<i;a++)EmailUtil.closeEmailTab(EmailComposeUtil.CURRENT_TAB,!1,!0);$("#addNewSign")[0]?(EmailComposeUtil.CURRENT_TAB="999",EmailComposeUtil.TEMP_TAB="999"):(EmailComposeUtil.CURRENT_TAB=0,EmailComposeUtil.TEMP_TAB=0),EmailComposeUtil.lastDraftUpdatedTime=0}},EmailCompose.etMinimiseCompose=function(){var e=$("#etComposePanel");EmailSendingUtil.isSendMailActionCalled=!1,EmailComposeUtil.setSessionStorageDraft();var i=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB);i.val()&&(EmailSendingUtil.module=i.val());var t=$("#maxComposeBtn");setTimeout((function(){t.addClass("enableRipple"),$L(".etMinimize").removeClass("etMinimize")}),700),t.removeClass("hide");var a=t[0].getBoundingClientRect(),l=e[0].getBoundingClientRect().x+e.width()/2;if(e[0].style.right=-(a.x-l+t.width()/2)+"px",e.addClass("etMinimize"),e.css("top","100%"),EmailComposeUtil.removeAutoSuggestedElement(),EmailComposeUtil.closeAllAlertPop(),EmailComposeUtil.hideAllComposeRelatedPopup(),EmailCompose.removeFreezelayer(),EmailComposeUtil.removeCustomFreezeLayer(),EmailActionHandling.saveDraftDetails(),EmailSendingUtil.composeActive=!1,EmailComposeUtil.ComposeWindowLoaded=!1,$("#ecAutoCompleteContainer").addClass("hide"),EmailComposeUtil.resetFileCheckVariableValue(),Lyte.registeredMixins["crm-email-emotions-mixin"])Lyte.registeredMixins["crm-email-emotions-mixin"].closeZiaEmotionBand();else{var o=networkUtils.returnDependencyFiles(["email-emotions.js"],crmConstants.jsStaticPathForLyte);Lyte.injectResources(o,void 0,(function(){Lyte.registeredMixins["crm-email-emotions-mixin"].closeZiaEmotionBand()}))}"undefined"!=typeof CrmPlusImpl&&("undefined"!=typeof isCrmPlusUser&&"true"===isCrmPlusUser||"undefined"!=typeof isZohoOneUser&&"true"===isZohoOneUser)&&CrmPlusImpl.handleDraftMailIcon(!0),t.hasClass("hide")||$(".EmailComposeFreezelayer").remove(),$("#addNewSign")[0]&&($("#emailComposeEditor").attr("id","etComposePanel"),$("#composeEmailEditor").attr("id","composeEditor"),EmailComposeUtil.TEMP_TAB=EmailComposeUtil.CURRENT_TAB,EmailComposeUtil.CURRENT_TAB="999",EmailComposeUtil.activeContentId="composeContentPanel_999",EmailComposeUtil.switchToCurrentEditor("999")),EmailComposeUtil.lastDraftUpdatedTime=0},EmailCompose.showComposeWindow=function(){$("#etComposePanel").css("right",0).css("top",0)},EmailCompose.etMaximizeCompose=function(e){if(EmailLaunchUtil.showHideFromRecord(),e){var i=EmailComposeUtil.tabIdPrefix+e,t=document.getElementById(i);if(!t)return!1;EmailCompose.showFreezelayer(),$etComposePanel.css("right",0).css("top",0),EmailComposeUtil.hideMaximizeComposeButton(),EmailSendingUtil.composeActive=!0,EmailComposeUtil.ComposeWindowLoaded=!0,EmailComposeUtil.switchToTab(t)}else EmailCompose.showFreezelayer(),$etComposePanel.css("right",0).css("top",0),EmailComposeUtil.hideMaximizeComposeButton(),EmailSendingUtil.composeActive=!0,EmailComposeUtil.ComposeWindowLoaded=!0;return EmailComposeUtil.setFileCheckVariableValue(),!0},EmailCompose.sendMail=function(e){if(EmailUtil.validateMailData()){var i=function(){var i,t=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).select2("data")[0].element,a={};a.email=t.value,a.user_name=t.getAttribute("username"),a.isOrgEmail=t.getAttribute("isOrgEmail");var l=EmailComposeUtil.getEditorContent();l=EmailComposeUtil.parseContentToRemoveAutoSuggestionElem(l);var o=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val(),n=$("#jsonForMergefields_"+EmailComposeUtil.CURRENT_TAB).data("mergeFieldsData");null!=n&&(l=EmailSendingUtil.convertMergeFieldstoFieldIds(l,n),o=EmailSendingUtil.convertMergeFieldstoFieldIds(o,n)),EmailComposeUtil.setEmailAddresses();var s={};if(EmailUtil.isReplyToAddressAdded()){var m=$("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB).select2("data")[0].element;s.user_name=m.getAttribute("username"),s.email=m.getAttribute("value")}var r,d=$("#toAddress_"+EmailComposeUtil.CURRENT_TAB).val(),c=$("#ccAddress_"+EmailComposeUtil.CURRENT_TAB).val(),E=$("#bccAddress_"+EmailComposeUtil.CURRENT_TAB).val(),p=$("#emcTemplateId_"+EmailComposeUtil.CURRENT_TAB).val();if(e&&(r=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB).val()),""!==d){if(!p){EmailUtil.addAttachments();i=EmailUtil.getAttachmentDetails(!0)}var u={};EmailUtil.createJSONObjectForMailContent(u,a,l,o,d,c,E,p,r,i,s),EmailCompose.sendMailFromAPI(!0,u)}else crmui.showMsgBand("error",I18n.getMsg("crm.email.toaddr.empty"),3e3)},t=$("#tab_startDate_"+EmailComposeUtil.CURRENT_TAB);e&&t?EmailSendingUtil.validateScheduleTime(t,i):i()}},EmailCompose.scheduleMail=function(){var e=$("#etComposeId1 #select2-etSenderList-container").find("span").text(),i=editor.getContent(),t="richEditor"===editor.getEditorMode()?"html":"text",a=$("#ceSubject").val();if(""===a&&Crm.showAlertMsg(I18n.getMsg("crm.field.empty.check",I18n.getMsg("crm.label.subject"))),EmailSendingUtil.isEntityWindow&&(EmailUtil.sendingPopup(),EmailSendingUtil.setEntityAttachDetails()),EmailSendingUtil.validate()){EmailComposeUtil.setEmailAddresses();var l=$("#toAddress").val();if(""!==l){var o=$("#ccAddress").val(),n=$("#bccAddress").val(),s=$("#bestTime").val(),m={};EmailUtil.createJSONObjectForMailContent(m,e,i,a,l,o,n,"",s),m.mail_format=t,EmailCompose.sendMailFromAPI(!0,m)}else crmui.showMsgBand("error",I18n.getMsg("crm.email.toaddr.empty"),3e3)}},EmailCompose.sendMailFromAPI=function(e,i){var t=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),a=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val();t=EmailComposeUtil.getApiNameForModule(t);var l=EmailUtil.getSendMailURL(t,a),o="POST";document.getElementById("msgId_"+EmailComposeUtil.CURRENT_TAB).value&&(o="PUT"),e&&(i=JSON.stringify(i)),(new crmRequestPool).initiate({url:l,type:o,data:i,headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken,"X-REQUEST-GROUP":"mailer"},contentType:"application/json; charset=UTF-8",dataType:"json",beforeSend:EmailUtil.sendingPopup,afterSend:EmailUtil.closeSendingPopup,success:function(){var e=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB),i=EmailComposeUtil.isConsentEmail[EmailComposeUtil.CURRENT_TAB],t=$("#draftId_"+EmailComposeUtil.CURRENT_TAB),a=t.val(),l=t.val();if(EmailUtil.closeSendingPopup(),a){t.val("");a=l;t&&t.val()===a&&(EmailComposeUtil.hideMaximizeComposeButton(),EmailComposeUtil.sessionStoredDraftId=null,EmailComposeUtil.removeDraftDOMElement()),$("#mails").hasClass("selectTab")?EmailUtil.refreshEmailRelList():EmailComposeUtil.refreshDraftsList()}else EmailUtil.refreshEmailRelList();EmailSendingUtil.isEmailProgressing=!1;var o=$("#newleft_DataPrivacy");i&&Crm.userDetails.detailView_newUI&&o&&o.hasClass("sel")&&DataPrivacy.loadDataPrivacy(o);var n=EmailComposeUtil.dataReqObj[EmailComposeUtil.CURRENT_TAB];if(n){var s=$("#dataRequestMailLink_"+n.id);n&&n.id&&s&&s.removeClass("dataRequestMailLink cP").text(I18n.getMsg("crm.data.subject.mail.sent")).unbind("click").addClass("eventNone")}commonUtils.showHideLoadingDiv(!1),EmailUtil.closeEmailTab(EmailComposeUtil.CURRENT_TAB,!0),e.length>0&&e.is(":checked")?crmui.showMsgBand("success",I18n.getMsg("crm.case.schedule.message"),3e3):crmui.showMsgBand("success",I18n.getMsg("crm.case.sent.message"),3e3)},error:function(e){EmailUtil.closeSendingPopup();var i=e.status,t=(e=e.responseJSON,EmailUtil.getProperErrorMessage(e,i));t.includes("Mail Sending Failed! Your SMTP server does not allow sending emails to addresses which contain special and/or foreign characters")||t.includes("Error while processing the request! javax.mail.MessagingException: 5.5.2 Syntax error")?EmailUtil.showMsg("error",I18n.getMsg("chatacters_not_allowed_by_smtp_server"),5e3):crmui.showMsgBand("error",t,5e3)}})},EmailCompose.closeBcCc=function(e){var i=$(e).closest(".ceComposeinfo"),t=i.attr("id");i.removeClass("ceComposeMeta"),EmailUtil.removeAllAddedEmails(t),$("#ecAutoCompleteContainer, #etSchedulePopId").addClass("hide"),i.addClass("hide"),$("[data-divid='"+t+"']").removeClass("hide"),EmailSendingUtil.resetEmailAddresses()},EmailCompose.launchComposeMailWithSurvey=function(){if(ZSurvey.insertText(),EmailUtil.setSignature(EmailComposeUtil.ComposeMailData.default_from.email),EmailComposeUtil.editorContent){var e=editor.zEditor.z_doc.getElementById("editorDiv");e.innerHTML=e.innerHTML+EmailComposeUtil.editorContent}},EmailCompose.SwitchToOldEditor=function(){var e=$L("#ecwFeedBackPop");e&&e.get(0).ltProp("show",!1);var i=EmailTabHomeUtil.ACTION+"=composeFeedback";i+="&"+csrfParamName+"="+csrfToken+"&switchType=newToOld",(new crmRequestPool).initiate({action:EmailSendingUtil.URL,type:EmailTabHomeUtil.POST_REQUEST_TYPE,data:i,error:EmailTabHomeUtil.handleAjaxAbort});var t=editor.zEditor.z_doc.getElementsByClassName("suggestedWord")[0];t&&t.remove();var a=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),l=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val();EmailSendingUtil.entityId&&(l=EmailSendingUtil.entityId),l||(l=$("#ecEntityId").val());var o=$("#contactSelDropdownInAcc :selected");o&&o.attr("value")&&(a="Accounts");var n=$("#layout_Name_"+EmailComposeUtil.CURRENT_TAB).val();if(EmailComposeUtil.isInventoryModule(a)&&n?(n.includes(".pdf")||(n+=".pdf"),EmailSendingUtil.inventObj={layout_Id:$("#layout_Id_"+EmailComposeUtil.CURRENT_TAB).val(),layout_Name:n,viewType:$("#viewType_"+EmailComposeUtil.CURRENT_TAB).val(),paperType:$("#paperType_"+EmailComposeUtil.CURRENT_TAB).val()}):EmailSendingUtil.inventObj=void 0,"undefined"!=typeof editor&&editor&&editor.zEditor){EmailSendingUtil.switchedToOldEditor=!0,EmailSendingUtil.switchedToOldWin=!0,EmailSendingUtil.subject=$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val(),editor.zEditor.editorDiv?EmailSendingUtil.tempContent=editor.zEditor.editorDiv.innerHTML.replace("?Subject=","?subject="):EmailSendingUtil.tempContent="",EmailSendingUtil.setEmailAddresses(),EmailSendingUtil.fromAddr=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).val(),EmailSendingUtil.toAddr=EmailSendingUtil.getUserNameWithEmailForSwitch("ceToAddr"),EmailSendingUtil.bccAddr=EmailSendingUtil.getUserNameWithEmailForSwitch("ceBCCAddr"),EmailSendingUtil.ccAddr=EmailSendingUtil.getUserNameWithEmailForSwitch("ceCCAddr");var s=document.getElementById("ceOption_replyto");if(s&&!s.classList.contains("hide")){var m=$("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB);EmailSendingUtil.replyTo=m.val()}else EmailSendingUtil.replyTo="";EmailUtil.addAttachments(),EmailSendingUtil.attachArray=EmailUtil.getAttachmentDetails();var r=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB);if(r.is(":checked")){var d=EmailDateTimeUtils.formatDate(r.val()),c=d.getTime(),E=$("#emc_bestTime_"+EmailComposeUtil.CURRENT_TAB);EmailSendingUtil.ScheduleText=E.find("label")[0].innerText;var p=EmailUtil.getTimeZoneOffsetFromTextString(EmailSendingUtil.ScheduleText),u=c-60*d.getTimezoneOffset()*1e3;u+=60*(Utils.getTimezoneOffset()+p)*1e3,EmailSendingUtil.ScheduledTime=u;E=$("#emc_bestTime_"+EmailComposeUtil.CURRENT_TAB);EmailSendingUtil.ScheduleText=E.find("label")[0].innerText}else EmailSendingUtil.ScheduledTime="";editor.zEditor.editorMode&&("plainEditor"===editor.zEditor.editorMode?(EmailSendingUtil.tempEditor="plaintext",EmailSendingUtil.tempContent=editor.zEditor.plainEditor.value):EmailSendingUtil.tempEditor="richtext"),Crm.userDetails.isNewEditor=!1,EmailSendingUtil.view?EntSendMail(a,l,EmailSendingUtil.view):EntSendMail(a,l,"",EmailSendingUtil.singularMod)}EmailComposeUtil.isCloseAll=!0,setTimeout((function(){EmailSendingUtil.switchedToOldWin=!1}),4e5);for(var g=EmailComposeUtil.OPEN_TAB_COUNT,C=0;C<g;C++)EmailComposeUtil.lastDraftUpdatedTime=0,EmailUtil.closeEmailTab(EmailComposeUtil.CURRENT_TAB,!1,!0);EmailComposeUtil.CURRENT_TAB=0,EmailComposeUtil.TEMP_TAB=0,EmailComposeUtil.lastDraftUpdatedTime=0},EmailCompose.showEditorFeedBack=function(){var e=editor.zEditor.z_doc.getElementById("attachmentList");if(e&&e.getElementsByClassName("loadingAttachment")[0])return crmui.showMsgBand("error",I18n.getMsg("crm.email.attach.inprogess"),3e3),!1;$L("#ecwFeedBackPop").get(0).ltProp("show",!0)},EmailCompose.closeEditorFeedBack=function(){$L("#ecwFeedBackPop").get(0).ltProp("show",!1)},EmailCompose.openDraftDisclaimer=function(e,i,t){EmailSendingUtil.entityId=t,EmailSendingUtil.activeModule=i,EmailSendingUtil.draftId=e,$L("#draftEditOld")[0].ltProp("show",!0)},EmailCompose.closeDraftDisclaimer=function(){$L("#draftEditOld")[0].ltProp("show",!1)},EmailCompose.openDraftFromOldCompose=function(){$L("#draftEditOld")[0].ltProp("show",!1);var e=EmailTabHomeUtil.ACTION+"=composeFeedback";e+="&"+csrfParamName+"="+csrfToken+"&switchType=oldToNew",(new crmRequestPool).initiate({action:EmailSendingUtil.URL,type:EmailTabHomeUtil.POST_REQUEST_TYPE,data:e,success:function(){Crm.userDetails.isNewEditor=!0,parent.removeFreezeLayer(),EmailCompose.fetchDraftDetails(EmailSendingUtil.draftId,EmailSendingUtil.activeModule,EmailSendingUtil.entityId),EmailSendingUtil.SwitchedFromOldToNew=!0;var e=$("#lookupdiv");e.empty(),e[0].style.display="none"},error:EmailTabHomeUtil.handleAjaxAbort})},EmailCompose.openComposeWindow=function(e,i,t,a,l,o,n,s,m,r){var d=!1;Crm.userDetails.isNewEditor||(d=!0,Crm.userDetails.isNewEditor=!0);var c={},E=[],p={};if(p.content=s,p.enc_msgid="",p.enc_thread_id="",p.from=e,p.subject="",p.to=i,p.cc=t,p.bcc=a,p.subject=m,n&&(p.subject="",p.content=""),E.push(p),c.data=E,EmailSendingUtil.isFromCscript=r,EmailSendingUtil.removeFocus=!0,EmailLaunchUtil.launchReplyMail(c,l,o),n){EmailSendingUtil.isLoadTemplate=!0,EmailSendingUtil.module=l;var u=EmailUtil.getTemplateData(n,l,e,p.to[0].email,o,"richtext",!0);EmailSendingUtil.templateData=u}d&&setTimeout((function(){Crm.userDetails.isNewEditor=!1}),4e3)};var EmailTabHomeUtil={dragAndDropObject:{}};EmailTabHomeUtil.dragAndDropObject.dropedElement=void 0,EmailTabHomeUtil.dragAndDropObject.isCompleted=!0,EmailTabHomeUtil.dragAndDropObject.fromMod=void 0,EmailTabHomeUtil.dragAndDropObject.toMod=void 0,EmailTabHomeUtil.tempEleScrVal=0,EmailTabHomeUtil.isOnSentimentDiv=!1,EmailTabHomeUtil.URL=Crm.getCrmBasePath()+"/View.do",EmailTabHomeUtil.ACTION="action",EmailTabHomeUtil.POST_REQUEST_TYPE="POST",EmailTabHomeUtil.GET_REQUEST_TYPE="GET",EmailTabHomeUtil.DISABLED_DROPNDIV="disabledDropDiv",EmailTabHomeUtil.GET_FILE_DATA="getFileData",EmailTabHomeUtil.COMPOSE="compose",EmailTabHomeUtil.REPLY="reply",EmailTabHomeUtil.REPLYALL="replyAll",EmailTabHomeUtil.FORWARD="forward",EmailTabHomeUtil.VIEW_MAILS="viewMails",EmailTabHomeUtil.LOAD_MAILS="loadMails",EmailTabHomeUtil.LOAD_MORE_SEARCH_MAILS="loadMoreSearchMails",EmailTabHomeUtil.CONVERT_UNMATCHED_TO_COLLEAGUES="convertUnMatchedMailToColleaugesList",EmailTabHomeUtil.DELETE="delete",EmailTabHomeUtil.DELETE_DRAFT="deleteDraft",EmailTabHomeUtil.MOVE_TO_TRASH="moveToTrash",EmailTabHomeUtil.MOVE_MAIL="moveMail",EmailTabHomeUtil.MOVE_TO_FOLDER="moveToFolder",EmailTabHomeUtil.MARK_AS_SPAM="markAsSpam",EmailTabHomeUtil.MARK_AS_READ="markAsRead",EmailTabHomeUtil.MARK_AS_UNREAD="markAsUnread",EmailTabHomeUtil.SEARCH="search",EmailTabHomeUtil.GET_ALL_TEMPLATES_FOR_MODULE="getAllTemplatesForModule",EmailTabHomeUtil.GET_TEMPLATE_DETAIL_BY_ID="getTemplatesDetailById",EmailTabHomeUtil.GET_POTENTIAL_STATGES="getPotentialStages",EmailTabHomeUtil.EMAIL_DETAILVIEW_PARENT="emaildetailresult",EmailTabHomeUtil.EMAIL_CONVIEW_PARENT="etConvDetailView",EmailTabHomeUtil.imgStaticServerPath="",EmailTabHomeUtil.ViewPortWidth="",EmailTabHomeUtil.ViewPortHeight="",EmailTabHomeUtil.KanbanViewBoxHeight="",EmailTabHomeUtil.KanbanViewSelectionObject="",EmailTabHomeUtil.Loading="#etLoading",EmailTabHomeUtil.detailViewParent="",EmailTabHomeUtil.uiSender=null,EmailTabHomeUtil.uiItem=null,EmailTabHomeUtil.droppedElement="",EmailTabHomeUtil.DragStart="",EmailTabHomeUtil.mailActionsOpener=null,EmailTabHomeUtil.SUCCESS="SUCCESS",EmailTabHomeUtil.selectedMailsIds=new Array,EmailTabHomeUtil.selectedThreadIds=new Array,EmailTabHomeUtil.MailInView="",EmailTabHomeUtil.ThreadIdInView="",EmailTabHomeUtil.MessageIdInView="",EmailTabHomeUtil.CurrentlyDetailViewOpened=!1,EmailTabHomeUtil.MAIL_SELECTION_LIMIT=200,EmailTabHomeUtil.DefaultMailBoxWidth=260,EmailTabHomeUtil.KanbanViewBoxHeight="",EmailTabHomeUtil.KanbanViewBoxLength=4,EmailTabHomeUtil.CustomMailBoxWidth=-1,EmailTabHomeUtil.VisibleModulesCount=0,EmailTabHomeUtil.subMenuActive=0,EmailTabHomeUtil.mainMenuActive=0,EmailTabHomeUtil.KanbanMailBoxWidth="",EmailTabHomeUtil.ModuleVsParentDivId={},EmailTabHomeUtil.QuickEditDeleteIcons=0,EmailTabHomeUtil.MailMultiSelect=0,EmailTabHomeUtil.MailSelection=0,EmailTabHomeUtil.ContextMenuParent="",EmailTabHomeUtil.isChatEnabled="",EmailTabHomeUtil.isMenuEnabled=!0,EmailTabHomeUtil.FullnameView=0,EmailTabHomeUtil.FullnameQuickView=0,EmailTabHomeUtil.shouldReloadView=!1,EmailTabHomeUtil.createdEntitiesJsonResponse=[],EmailTabHomeUtil.EmailcontainerHeight,EmailTabHomeUtil.HasPotentialStagesBeenFetched=0,EmailTabHomeUtil.CloseSuccDiv=0,EmailTabHomeUtil.PotentialStages,EmailTabHomeUtil.createPotentialFrom=null,EmailTabHomeUtil.isShiftKeyPressed=!1,EmailTabHomeUtil.isInitialLoad=!1,EmailTabHomeUtil.lastSelectedMailLi=null,EmailTabHomeUtil.isMailMultiSelectEnabled=!1,EmailTabHomeUtil.TopMenuBarHeight=0,EmailTabHomeUtil.BottomChatBarHeight=0,EmailTabHomeUtil.httpprotocol=location.protocol+"//",EmailTabHomeUtil.viewOrLabelLimit=32,EmailTabHomeUtil.currentThreadMailDetailContainer=null,EmailTabHomeUtil.viewNameWidth=0,EmailTabHomeUtil.syncStatus=0,EmailTabHomeUtil.searchIndexStatus=null,window.ajaxPager=!0,EmailTabHomeUtil.showNewTooltip=function(e){var i=$("#ecTTPointer"),t=$(e).attr("toolTipVal");if(t){var a,l=$(e).offset(),o=$("#ecNewToolTip"),n=l.left-o.outerWidth()/2;n=EmailTabHomeUtil.ViewPortWidth<n+o.outerWidth()?EmailTabHomeUtil.ViewPortWidth-o.outerWidth()-5:n<0?5:l.left-o.outerWidth()/2;var s=l.top-o.outerHeight();a=l.left-o.offset().left+$(e).outerWidth()/2-14,s>10?(s=l.top-35,i.css("bottom","-4px").removeClass("rotate180")):(s=l.top+$(e).outerHeight()+10,i.css("bottom",o.outerHeight()-1+"px").addClass("rotate180")),o.css({top:s,left:n}).show(),i.css("left",a+"px"),$("#ecTTVal").text(t),o.show()}},EmailTabHomeUtil.hideNewTooltip=function(){$("#ecNewToolTip").hide()},EmailTabHomeUtil.handleAjaxAbort=function(e){var i=$(EmailTabHomeUtil.Loading);if(i.hide(),i.removeAttr("data-zcqa"),451==e.status||452==e.status||453==e.status||454==e.status)Crm.showAlertMsg(e.responseText);else if(455!=e.status){var t=arguments[0].readyState;0!==t&&Crm.showAlertMsg(I18n.getMsg("crm.security.error.add.user"))}},EmailTabHomeUtil.closeSuccessDiv=function(){0==EmailTabHomeUtil.CloseSuccDiv&&$("#mailSentSuccessfullyDiv").hide()},EmailTabHomeUtil.customConfirmation=function(e,i,t){var a=e.confirm?e.confirm:I18n.getMsg("crm.button.ok"),l=e.cancel?e.cancel:I18n.getMsg("crm.button.cancel"),o="emailGeneralConfirmMsgDiv";$("#contextMenuLabels").hide();var n=$("#"+o),s=n.find(".confirm"),m=n.find(".cancelBtn"),r=n.find(".ceCloseIconBold");return e.close&&(r.removeClass("hide"),r.off("click").click((function(e){var i=$("#"+o);return i.find(".ceCloseIconBold").addClass("hide"),i.hide(),removeFreezeLayer(),renderingUtils.stopEvent(e),!1}))),s.text(a),m.text(l),n.find(".infoCont").text(e.info),s.off("click").click((function(e){var t=$("#"+o);t.find(".ceCloseIconBold").addClass("hide"),t.hide(),removeFreezeLayer(),i&&i(),renderingUtils.stopEvent(e)})),m.off("click").click((function(e){var i=$("#"+o);return i.find(".ceCloseIconBold").addClass("hide"),i.hide(),removeFreezeLayer(),renderingUtils.stopEvent(e),t&&t(),!1})),freezeBackground(),mailsetCenter(o),n.show(),!1},EmailTabHomeUtil.NavigateToIMAP=function(){crmTab.redirectToSalesInbox=!0,Crm.trackSpotLightAction("SalesInbox - Configure Now Click")},EmailTabHomeUtil.initiateConfig=function(){crmTab.isMailClientEnabled&&!crmTab.isMailClientActive&&($("#etsImportFilter").removeClass("hide"),freezeBackground(),Crm.isInitialFilterConfig=!0,mailsetCenter("etsImportFilter"),EmailImportFilter.saveConfig=EmailTabHomeUtil.startMigration)},EmailTabHomeUtil.startMigration=function(){var e=$("#tryNowBtn");e.prop("disabled",!0),e.attr("opacity",.5);var i=EmailTabHomeUtil.ACTION+"=trySalesinbox";i+="&"+csrfParamName+"="+csrfToken,(new crmRequestPool).initiate({type:EmailTabHomeUtil.POST_REQUEST_TYPE,url:Crm.getCrmBasePath()+"/SalesInboxIntro.do",data:i,success:function(e){"SUCCESS"!==e&&"ALREADY_ACTIVE"!==e||("undefined"!=typeof CrmPlusImpl&&CrmPlusImpl.isLoadedInCrmplus()?CrmPlusImpl.trigger("updateSalesInboxConfigurationData",[{"isconfigured ":!0,isfromconfigrationview:!0,has_access:!0,isemailadded:!0}]):window.location=crmHistory.locationOrigin+Crm.getOrgSpecificURL(Urls.Salesinbox))}})},EmailTabHomeUtil.adjustRightpanelTab=function(){setTimeout((function(){var e=$("#unknownConvertbuttonDiv");if(e.is(":visible")){var i=$("#krp_Conversation_Container"),t=i.outerHeight(),a=e.outerHeight(),l=$("#krp_Conversation_InnerContainer"),o=l[0].scrollHeight;i.css("height",t-a),l.css({height:o}),$$rightPanel.setPerfectScrollBar("krp_Conversation_Container","krp_Conversation_InnerContainer","")}$("#kso_rightpanel_title").addClass("hide")}),50)},EmailTabHomeUtil.appendCreateEntityAfterMailFetch=function(e,i){return function(){var t=EmailTabHomeUtil.getEmailToCreateEntity(e,i);if(!EmailTabHomeUtil.showEntityCreatedSuccessMsg(t)){var a=$.parseJSON('{"emailAddr":"'+t+'"}');a.leadpermission=crmTab.tabList.contains("Leads")&&Crm.userDetails.permissions.Crm_Implied_Create_Leads,a.contactpermission=crmTab.tabList.contains("Contacts")&&Crm.userDetails.permissions.Crm_Implied_Create_Contacts,EmailTabHomeUtil.populateUnMatchedEntityDetails("CreateEntityFromUnMatchedMails",a)}}},EmailTabHomeUtil.getEmailToCreateEntity=function(e,i){var t="";e===$("#configuredZmailAddr").val()?t=i.split(",")[0]:t=e;return t},EmailTabHomeUtil.showEntityCreatedSuccessMsg=function(e){var i=!1;if(null!=EmailTabHomeUtil.createdEntitiesJsonResponse&&EmailTabHomeUtil.shouldReloadView){var t=$(".outlookqCreate");$.each(EmailTabHomeUtil.createdEntitiesJsonResponse,(function(a,l){if(l.fromAddr===e||t.length)return l.taskpermission=crmTab.tabList.contains("Activities")&&Crm.userDetails.permissions.Crm_Implied_Create_Tasks,l.potentialpermission=crmTab.tabList.contains("Potentials")&&Crm.userDetails.permissions.Crm_Implied_Create_Potentials,EmailTabHomeUtil.populateUnMatchedEntityDetails("PostCreateEntity",l),i=!0,!0}))}return i},EmailTabHomeUtil.populateUnMatchedEntityDetails=function(e,i){var t=$("#kso_social_rightpanel");if(t.length){var a=Handlebars.templates[e](i);a+=t[0].outerHTML,EmailTabHomeUtil.adjustRightpanelTab(),$("#entityInfoOuterDiv").html(a),"undefined"!=typeof $$rightPanel&&$(".outlookqCreate").length&&$$rightPanel.bindClickEventForOutlook()}},EmailTabHomeUtil.reloadOnEntityCreationFromUnMatched=function(){var e=$(".emailnavLink.aliaslinksel");e.removeClass("aliaslinksel"),e.parent().find(".elpSelectedOption").removeClass("elpSelectedOption");var i=e.attr("emailViewId");EmailTabHomeUtil.shouldReloadView=!1,EmailTabHomeUtil.createdEntitiesJsonResponse=[],EmailViewsUtil.getMailsbyViewId(i)},EmailTabHomeUtil.postEntityCreate=function(e){if(EmailTabHomeUtil.shouldReloadView||(EmailTabHomeUtil.createdEntitiesJsonResponse=[],EmailTabHomeUtil.shouldReloadView=!0),"update"===e.action)$.each(EmailTabHomeUtil.createdEntitiesJsonResponse,(function(i,t){if(e.entityId===t.entityId)return"Tasks"===e.module?t.taskId=e.taskId:"Potentials"===e.module&&(t.potentialId=e.potentialId),!0}));else if("create"===e.action){var i=$("#"+EmailTabHomeUtil.detailViewParent).find("iframe").contents().find("#"+EmailTabHomeUtil.currentThreadMailDetailContainer);e.fromAddr="salesinbox"==Q.source?Q.actionDetails.email:i.length?i.find(".fromAddr").val():$("#rightPanelfromAddr").val(),EmailTabHomeUtil.createdEntitiesJsonResponse.push(e)}EmailTabHomeUtil.showEntityCreatedSuccessMsg($ESAPI.encoder().decodeFromURL($$rightPanel.rpSearchEmailAddr))},EmailTabHomeUtil.getViewPort=function(){var e,i;if(void 0!==window.innerWidth)e=window.innerWidth,i=window.innerHeight;else if(void 0!==document.documentElement&&void 0!==document.documentElement.clientWidth&&0!=document.documentElement.clientWidth)e=document.documentElement.clientWidth,i=document.documentElement.clientHeight;else{var t=document.getElementsByTagName("body")[0];e=t.clientWidth,i=t.clientHeight}EmailTabHomeUtil.ViewPortWidth=e,EmailTabHomeUtil.ViewPortHeight=i};var EmailUtil={dots:0,tempSignature:[],hideBand:!1,tempFrom:[],cancelFrom:"",tempDraftTab:"",isContinue:!1,validate:function(){if($("#ceFromAddr").val($("#addrsVal").attr("selectedval")),$("#ceReplyToAddr").val($("#ceReplyToAddrSpan").attr("selectedVal")),EmailSendingUtil.composeActive&&EmailSendingUtil.validateMailData()){if(skipConfirmation)return!1;var e=$("#ceSubject1");if(""===e.val().trim()){var i=Utils.showCustomprompt(I18n.getMsg("crm.email.specify.subject"));if(i&&i.length>250)i=i.substring(0,250);else if(!i)return Crm.showAlertMsg(I18n.getMsg("crm.field.empty.check",I18n.getMsg("crm.label.subject"))),!1;e.val(i),void 0!==modField&&null!==modField&&(i=EmailSendingUtil.convertMergeFieldstoFieldIds(i,JSON.parse(modField))),$("#ceSubject").val(i)}}},refreshEmailRelList:function(){var e=$("#module").val(),i=$("#entityId").val(),t=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),a=$("#ecEntityId_"+EmailComposeUtil.CURRENT_TAB).val(),l=$("#ecEmailId_"+EmailComposeUtil.CURRENT_TAB),o=$("#mailListRelId"),n=i===a&&e===t;if(o&&o.length>0&&o.val()&&n){if(l){var s=l.val(),m=$("#ecFullname_"+EmailComposeUtil.CURRENT_TAB).val(),r=o.val(),d="";d=i,$("#isFromNewAPI").length>0||null!=getOpenerObj("isFromNewAPI")?0!=$("#emcScheduleMailBtn").length&&!$("#emcScheduleMailBtn").hasClass("hide")||0!=$("#emcScheduleMailBtn_"+EmailComposeUtil.CURRENT_TAB).length&&!$("#emcScheduleMailBtn_"+EmailComposeUtil.CURRENT_TAB).hasClass("hide")||$("#scheduledMails").hasClass("selectTab")?showMailsListViaAPI("","-10","next",null,"scheduledMails"):showMailsListViaAPI("","-10","next",null,"mails"):showMailsList(d,s,m,r,"-10","next","","false",e)}document.querySelector("crm-zsurvey-rl-label")&&ZSurvey.refreshSurveyPersonality(e,i.value)}},openComposewindowForDraft:function(e){var i=$("#module").val(),t=$("#entityId").val(),a=EmailComposeUtil.APIBaseURL;a+=a+i+"/"+t+"/actions/fetch_details?draftId="+e,(new crmRequestPool).initiate({url:a,method:"GET",headers:{"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken},data:"application/json",success:function(e){EmailCompose.openComposeWindow(e,"draft")},error:function(){renderingUtils.showCustomAlert("error in fetching the draft")}})},getSignaturebyEmail:function(e){var i,t=!1;if(e){var a=e.indexOf("<"),l=e.indexOf(">");-1!==a&&-1!==l&&a<l&&(e=e.slice(a+1,l))}var o=CrmEmailInitialize.ComposeMailData.user.compose_settings.email_signatures;if(o){for(var n=o.length,s=0;s<n&&!t;s++)if(e&&o[s].from){for(var m=o[s].from.length,r=0;r<m;r++)if(e.toLocaleLowerCase()===o[s].from[r].email.toLocaleLowerCase()){i=o[s].content,t=!0;break}}else if(o[s].default){i=o[s].content;break}return i}},setSignature:function(e,i){var t=editor.zEditor.z_doc.getElementById("ecw_signature");if(!$("#emcTemplateId_"+EmailComposeUtil.CURRENT_TAB).val()||t){if(!i&&t&&EmailUtil.tempSignature[EmailComposeUtil.CURRENT_TAB]&&EmailUtil.tempSignature[EmailComposeUtil.CURRENT_TAB]!==t.innerHTML)return EmailComposeUtil.setFromAddress(EmailUtil.tempFrom[EmailComposeUtil.CURRENT_TAB]),EmailUtil.cancelFrom=EmailUtil.tempFrom[EmailComposeUtil.CURRENT_TAB],$L("#ecwSignaturePop")[0].ltProp("show",!0),EmailUtil.hideBand=!0,void(EmailUtil.tempFrom[EmailComposeUtil.CURRENT_TAB]=e);if(EmailUtil.tempFrom[EmailComposeUtil.CURRENT_TAB]=e,"999"!==EmailComposeUtil.CURRENT_TAB){var a=EmailUtil.getSignaturebyEmail(e),l=editor.getEditorMode(),o=editor.zEditor.z_doc.getElementById("editorDiv");if("richEditor"===l){if(e&&t)return a||(a=""),"richEditor"===l&&(t.innerHTML=a),void(EmailUtil.tempSignature[EmailComposeUtil.CURRENT_TAB]=t.innerHTML);a=a?"<br><br><br><br><br><br><br><br><br><br><br><br><br><br><span data-zbluepencil-ignore='true' id='ecw_signature'>"+a+"</span>":"<br><br><br><br><br><br><br><br><br><br><br><br><br><br><span data-zbluepencil-ignore='true' id='ecw_signature'></span>",t||(o.innerHTML.includes("<div>")?editor.setContent(a):o.innerHTML=e?o.innerHTML+a.replace("<br><br><br><br><br><br><br><br><br><br>",""):o.innerHTML+a.replace("<br><br><br><br><br><br>",""))}else e&&a&&editor.getContent()?editor.setContent(editor.getContent()+"\n"+EmailUtil.convertToPlainText(a)):a=a?"\n\n\n\n"+convertToPlainText(a):"\n\n\n\n";(t=editor.zEditor.z_doc.getElementById("ecw_signature"))&&(EmailUtil.tempSignature[EmailComposeUtil.CURRENT_TAB]=t.innerHTML)}}},convertToPlainText:function(e){var i=document.createElement("div");i.innerHTML=e.replace(/<(p|div|h\\d|br)>/gi,"\n");var t=i.innerText;return i=void 0,t},closeMailTab:function(){var e=$("#draftId").val();EmailActionHandling.closeTab=!0;var i=EmailActionHandling.hasAnythingChanged();EmailActionHandling.closeTab=!1,e&&""!==e||i||EmailUtil.isEditInScheduleMail()&&!EmailCompose.hideDiscardPop?$L("#ecwDraftPop")[0].ltProp("show",!0):EmailUtil.closeMailContentView()},saveAndcloseMailTab:function(){crmui.hideMsgBand(),EmailUtil.closeMailContentView()},closeEmailTab:function(e,i,t,a){if(EmailSendingUtil.isSendMailActionCalled=!1,!i)if(t)EmailUtil.tempDraftTab=EmailComposeUtil.CURRENT_TAB,EmailComposeUtil.CURRENT_TAB=e,EmailActionHandling.saveDraftDetails(),EmailComposeUtil.CURRENT_TAB=EmailUtil.tempDraftTab;else{EmailUtil.tempDraftTab=EmailComposeUtil.CURRENT_TAB,EmailComposeUtil.CURRENT_TAB=e,EmailComposeUtil.switchToCurrentEditor(e);var l=EmailUtil.isEditInScheduleMail()||EmailActionHandling.hasAnythingChanged();if(EmailComposeUtil.CURRENT_TAB=EmailUtil.tempDraftTab,EmailComposeUtil.switchToCurrentEditor(EmailComposeUtil.CURRENT_TAB),l){var o=$L("#ecwDraftPop")[0];if(o&&!a&&l&&!EmailCompose.hideDiscardPop)return EmailUtil.tempDraftTab=e,void o.ltProp("show",!0);EmailCompose.hideDiscardPop=!1}}if(Lyte.registeredMixins["crm-email-emotions-mixin"])Lyte.registeredMixins["crm-email-emotions-mixin"].closeZiaEmotionBand();else{var n=networkUtils.returnDependencyFiles(["email-emotions.js"],crmConstants.jsStaticPathForLyte);Lyte.injectResources(n,void 0,(function(){Lyte.registeredMixins["crm-email-emotions-mixin"].closeZiaEmotionBand()}))}EmailComposeUtil.action[EmailComposeUtil.CURRENT_TAB]="";var s=EmailComposeUtil.tabIdPrefix+e,m=EmailComposeUtil.contentIdPrefix+e,r=$("#"+s),d=$("#"+m);r.remove(),d.remove();var c,E=EmailComposeUtil.tabDetails[e].draftDetails;if(E&&(c=E.draftId),c&&EmailComposeUtil.removeDraftIdFromSessionStorage(c),delete EmailComposeUtil.tabDetails[e],0!==EmailComposeUtil.OPEN_TAB_COUNT&&(EmailComposeUtil.OPEN_TAB_COUNT=Number(EmailComposeUtil.OPEN_TAB_COUNT)-1),EmailComposeUtil.CURRENT_TAB===Number(e)){var p=EmailComposeUtil.getMRUTabId(),u=EmailComposeUtil.tabIdPrefix+p,g=document.getElementById(u);p&&p!==EmailComposeUtil.CURRENT_TAB&&"999"!==p&&g?(EmailComposeUtil.switchToTab(g),EmailComposeUtil.TEMP_TAB=EmailComposeUtil.CURRENT_TAB,EmailComposeUtil.activeContentId="composeContentPanel_"+EmailComposeUtil.CURRENT_TAB):(EmailUtil.closeEmailContent(),$("#addNewSign")[0]&&($("#emailComposeEditor").attr("id","etComposePanel"),$("#composeEmailEditor").attr("id","composeEditor"),EmailComposeUtil.TEMP_TAB=EmailComposeUtil.CURRENT_TAB,EmailComposeUtil.CURRENT_TAB="999",EmailComposeUtil.activeContentId="composeContentPanel_999",EmailComposeUtil.switchToCurrentEditor("999")))}EmailComposeUtil.TEMP_TAB=EmailComposeUtil.CURRENT_TAB},closeEmailContent:function(){EmailComposeUtil.hideAllComposeRelatedPopup(),EmailComposeUtil.hideMaximizeComposeButton(),EmailComposeUtil.removeCustomFreezeLayer(),EmailCompose.removeFreezelayer(),$("#etComposePanel").css("right","-100%"),$("body #composeEditor").remove(),EmailComposeUtil.removeSpectrumElem(),EmailComposeUtil.editorLoaded=!1,EmailSendingUtil.composeActive=!1,editor.zEditor={},tableResize.init={},EmailUtil.removeEmailComposePopupBasedDOMElements(),$("#addNewSign")[0]||(Lyte.removeFromCache(EmailLaunchUtil.resources_1),Lyte.removeFromCache(EmailComposeUtil.resources_2)),EmailComposeUtil.ComposeWindowLoaded=!1;var e=document.getElementById("fileCheckVariable");if(e){var i=e.getAttribute("tempval");e.value=i,e.removeAttribute("tempval")}},removeEmailComposePopupBasedDOMElements:function(){$(".editorToolDiv").remove()},closeMailContentView:function(e){crmui.hideMsgBand(),e||EmailActionHandling.saveDraftDetails(),EmailComposeUtil.hideAllComposeRelatedPopup(),EmailComposeUtil.hideMaximizeComposeButton(),EmailComposeUtil.removeCustomFreezeLayer(),EmailCompose.removeFreezelayer(),$("#etComposePanel").css("right","-100%"),$("body #composeEditor").remove(),EmailComposeUtil.removeSpectrumElem(),EmailComposeUtil.editorLoaded=!1,EmailSendingUtil.composeActive=!1,EmailComposeUtil.editorContent="",EmailComposeUtil.ComposeMailData=CrmEmailInitialize.ComposeMailData,document.body.removeEventListener("click",editor.zEditor.hideAllProps,!1),editor.zEditor={},tableResize.init={},$(".editorToolDiv").remove(),Lyte.removeFromCache(EmailComposeUtil.resources_1),Lyte.removeFromCache(EmailComposeUtil.resources_2),initializeSpellCheck&&initializeSpellCheck.stopSpellCheck(),EmailComposeUtil.ComposeWindowLoaded=!1,null!==EmailComposeUtil.draftInterval&&clearInterval(EmailComposeUtil.draftInterval),EmailComposeUtil.resetSessionStorageDraft();var i=document.getElementById("fileCheckVariable");if(i){var t=i.getAttribute("tempval");i.value=t,i.removeAttribute("tempval")}},pushDocsToArray:function(e,i){EmailSendingUtil.docsAttachmentArray.push(e),i&&"true"===i&&EmailUtil.docsHandling()}};pushDocsToArray=function(e,i){EmailSendingUtil.docsAttachmentArray.push(e),i&&"true"===i&&EmailUtil.docsHandling()},EmailUtil.hidecallout=function(){var e=$(".ppContSlide");e.css({top:"0px",left:"0px",opacity:"1"}),e.hide()},EmailUtil.docsHandling=function(){var e=document.getElementById("attachdialogdiv"),i=document.getElementById("zohodocsframe");e&&(e.style.display="none"),i&&(i.style.display="none"),Crm.userDetails.isNewEditor&&EmailUtil.removeCustomFreezeLayer(),EmailUtil.uploadDocsAttachments()},EmailUtil.uploadDocsAttachments=function(){var e=$("#draftId").val();EmailSendingUtil.isEntityWindow||e&&"null"!==e?EmailUtil.processDocsAttachments():EmailActionHandling.formDraftAndUploadDocs()},EmailUtil.processDocsAttachments=function(){for(var e;void 0!==(e=EmailSendingUtil.docsAttachmentArray.pop());){var i=e.split(":::")[0],t=e.split(":::")[1];t=i+":::"+(t=(t=t.replace(i+",","")).replace(",",":::")),EmailUtil.saveAndUploadAttachment(t)}},EmailUtil.saveAndUploadAttachment=function(e){var i=e.split(":::"),t=i[0],a=i[1],l=i[2],o=EmailComposeUtil.getFormattedAttachmentDetails(l,t,null,a);delete o[EmailComposeUtil.FILE_SIZE],editor.zEditor.thirdPartyAttachment(o)},EmailUtil.putAttachmentsOnEditor=function(e){$.each(e,(function(e,i){var t="undefined"==typeof editor?void 0:editor.zEditor;t&&(t.showLoadingAttachment(),t.showAttachment(i,i),t.updateAttachmentCount())}))},EmailUtil.getAttachmentDetails=function(e){var i,t,a=$("#"+EmailComposeUtil.activeContentId+" #z_editor").contents().find("#attachmentDiv #attachCount").text(),l=[],o=$("#entAttachId_"+EmailComposeUtil.CURRENT_TAB),n=o.val()?o.val().split("###"):[],s=$("#entAttachName_"+EmailComposeUtil.CURRENT_TAB),m=s.val()?s.val().split("###"):[],r=$("#attachServiceNames_"+EmailComposeUtil.CURRENT_TAB),d=r.val()?r.val().split("###"):[],c=$("#entAttachSZ_"+EmailComposeUtil.CURRENT_TAB),E=c.val()?c.val().split("###"):[];if(!a||0===a)return l;for(i=0;i<a;i++){var p=n?n.pop():void 0;if(p){var u={};if(t=d.pop(),u.id=p,u.file_name=m.pop(),t)switch(t){case"null":case"":case EmailComposeUtil.Attachment.Desktop:u.service_name="";break;case"IMAPAttached":case"GMailAttached":case"ZMAILAttached":case"RawZFSFile":u.service_name=t;break;default:u.service_name="ZFSAttached"}else u.service_name="";e||(u.file_size=parseInt(E.pop())),l[i]=u}}return l},EmailUtil.addAttachments=function(){var e="",i="",t="",a="",l="";$("#"+EmailComposeUtil.activeContentId+" #z_editor").contents().find("#attachmentList").find("li").each((function(){var o=$(this).attr("data-fileid"),n=$(this).attr("data-xAttach");if(o&&!n){var s=$(this).find(".attach_size");""===e?(e=$(this).attr("data-fileid"),a=$(this).attr("data-serviceName")?$(this).attr("data-serviceName"):"null",i=$(this).attr("title")?$(this).attr("title"):"null",t=s.html(),l=$(this).attr("data-filesize")?$(this).attr("data-filesize"):"null"):(e+=$(this).attr("data-fileid")?"###"+$(this).attr("data-fileid"):"###null",a+=$(this).attr("data-serviceName")?"###"+$(this).attr("data-serviceName"):"###null",i+=$(this).attr("title")?"###"+$(this).attr("title"):"###null",t+=s.html()?"###"+s.html():"###null",l+=$(this).attr("data-filesize")?"###"+$(this).attr("data-filesize"):"###null")}})),$("#entAttachId_"+EmailComposeUtil.CURRENT_TAB).val(e),$("#entAttachName_"+EmailComposeUtil.CURRENT_TAB).val(i),$("#entAttachSize_"+EmailComposeUtil.CURRENT_TAB).val(t),$("#attachServiceNames_"+EmailComposeUtil.CURRENT_TAB).val(a),$("#entAttachSZ_"+EmailComposeUtil.CURRENT_TAB).val(l)},EmailUtil.removeAttachments=function(){var e=editor.zEditor.z_doc.getElementById("attachmentList");void 0!==(e=$(e))&&e.find("li").each((function(){editor.zEditor.removeAttachment(this)}))},EmailUtil.clearEditorAttachments=function(){var e=editor.zEditor.z_doc.getElementById("attachmentList");if(void 0!==(e=$(e))&&0!==e.length){if(EmailComposeUtil.replyOrForWardMail[EmailComposeUtil.CURRENT_TAB]&&0==EmailComposeUtil.tempforwardAttach[EmailComposeUtil.CURRENT_TAB].length){var i=[];return e.find("li").each((function(){i.push(this.id)})),void(EmailComposeUtil.tempforwardAttach[EmailComposeUtil.CURRENT_TAB]=i)}e.find("li").each((function(){var e=this.getAttribute("data-xattach");e&&"true"===e||EmailComposeUtil.tempforwardAttach[EmailComposeUtil.CURRENT_TAB].contains(this.id)||editor.zEditor.clearAttachment(this)}))}},EmailUtil.isAttachmentLoading=function(){if("undefined"!=typeof editor?editor.zEditor:void 0){var e=editor.zEditor.z_doc.getElementById("attachmentList");if(e){var i=e.getElementsByClassName("loadingAttachment");if(i&&i.length>0)return!0}}return!1},EmailUtil.createJSONObjectForMailContent=function(e,i,t,a,l,o,n,s,m,r,d){l=$("#toAddress_"+EmailComposeUtil.CURRENT_TAB).val();var c=$("#toAddrUname_"+EmailComposeUtil.CURRENT_TAB).val(),E=EmailUtil.returnJSONObject(l.split(","),c.split(",")),p=$("#draftId_"+EmailComposeUtil.CURRENT_TAB).val(),u=(o=$("#ccAddress_"+EmailComposeUtil.CURRENT_TAB).val(),$("#ccAddrUname_"+EmailComposeUtil.CURRENT_TAB).val()),g=EmailUtil.returnJSONObject(o.split(","),u.split(",")),C=(n=$("#bccAddress_"+EmailComposeUtil.CURRENT_TAB).val(),$("#bccAddrUname_"+EmailComposeUtil.CURRENT_TAB).val()),U=EmailUtil.returnJSONObject(n.split(","),C.split(",")),h=[],v={from:{}};v.from.email=i.email,v.from.user_name=i.user_name,d&&(v.reply_to=d);var f={};f.id=p,p&&p.length>0&&(v.email_draft=f);var T=i.isOrgEmail||EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB];T=i.isOrgEmail||EmailSendingUtil.isOrgEmail[EmailComposeUtil.CURRENT_TAB];v.org_email=!!T,EmailComposeUtil.action[EmailComposeUtil.CURRENT_TAB]&&(v.mode=EmailComposeUtil.action[EmailComposeUtil.CURRENT_TAB].toLowerCase());i=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).val();var S=CrmEmailInitialize.ComposeMailData.from_address;try{if(S&&v.org_email&&i){v.org_email=!1;for(var A=S.length,_=0;_<A;_++)if((S[_].email.includes(i)||EmailSendingUtil.OrgEmailArray.contains(i))&&"org_email"===S[_].type){v.org_email=!0;break}}}catch(e){v.org_email=!0}v.to=E,g&&g.length>0&&(v.cc=g),U&&U.length>0&&(v.bcc=U),v.subject=a,r&&r.length>0&&(v.attachments=r),v.template_id=s,m&&(v.scheduled_time=m),v.mail_format="richEditor"===editor.getEditorMode()?"html":"text","text"===v.mail_format?v.plainTextContent=t:v.content=t,EmailComposeUtil.dataReqObj[EmailComposeUtil.CURRENT_TAB]&&(v.data_subject_request=EmailComposeUtil.dataReqObj[EmailComposeUtil.CURRENT_TAB]),(EmailSendingUtil.consentEmail||EmailComposeUtil.isConsentEmail[EmailComposeUtil.CURRENT_TAB])&&(v.consent_email=!0);var b=document.getElementById("msgId_"+EmailComposeUtil.CURRENT_TAB).value,R=document.getElementById("sendMailType_"+EmailComposeUtil.CURRENT_TAB).value,y=document.getElementById("enc_msgId_"+EmailComposeUtil.CURRENT_TAB).value,I=$("#enc_threadId").val();if(b&&R===EmailComposeUtil.EDIT_IN_COMPOSE&&!EmailUtil.isEditInScheduleMail()?v.message_id=b:y?v.in_reply_to=y:I&&(v.in_reply_to=I),EmailUtil.isInventoryModule()){var M=$("#layout_Id_"+EmailComposeUtil.CURRENT_TAB).val(),L=$("#layout_Name_"+EmailComposeUtil.CURRENT_TAB).val(),D=$("#paperType_"+EmailComposeUtil.CURRENT_TAB).val(),w=$("#viewType_"+EmailComposeUtil.CURRENT_TAB).val();v.layout_id=M,v.layout_name=L,v.paper_type=D,v.view_type=w}return EmailSendingUtil.dataReqObj&&(v.data_subject_request=EmailSendingUtil.dataReqObj),h.push(v),e.data=h,e},EmailUtil.isInventoryModule=function(e){return EmailComposeUtil.isInventoryModule(e)},EmailUtil.validateMailData=function(){var e=editor.zEditor,i=EmailComposeUtil.getEditorContent();if(i.length>16e6)return crmui.showMsgBand("error",I18n.getMsg("crm.email.char.max.msg"),5e3),!1;if(EmailComposeUtil.ComposeMailData.features_available.EMAIL_PREFERENCE&&EmailComposeUtil.ComposeMailData.features_available.mandateUnsubLink&&"plainEditor"!==editor.getEditorMode()&&-1===i.indexOf("${Unsubscribe"))return crmui.showMsgBand("error",I18n.getMsg("crm.email.preference.mandatory.unsublink.sendmail"),5e3),!1;if($("#editorMode_"+EmailComposeUtil.CURRENT_TAB).val(e.editorMode),!EmailUtil.validateEmailFieldsOfToCcBcc("ceToAddr","ceCCAddr","ceBCCAddr",EmailSendingUtil.maxLimitExceedsMsg.toCcBcc))return!1;if(!EmailUtil.validateAllEmailFields("ceToAddr",!0,EmailSendingUtil.numberOfEmailAddr,I18n.getMsg("crm.email.toaddr.empty"),I18n.getMsg("crm.email.toaddr.provide.valid")))return!1;if(!EmailSendingUtil.missedAttachmentInBody())return!1;if(!EmailUtil.validateAllEmailFields("ceCCAddr",!1,EmailSendingUtil.numberOfEmailAddr,null,I18n.getMsg("crm.email.ccaddr.provide.valid")))return!1;if(!EmailUtil.validateAllEmailFields("ceBCCAddr",!1,EmailSendingUtil.numberOfEmailAddr,null,I18n.getMsg("crm.email.bccaddr.provide.valid")))return!1;if(!EmailUtil.validateAllEmailFields("ceReplyToAddr",!1,1,null,I18n.getMsg("crm.email.replyaddr.provide.valid")))return!1;if($("#ceReplyToAddrDetails_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length>1)return crmui.showMsgBand("error",maxLimitExceedMsg,5e3),!1;if(EmailUtil.isAttachmentLoading())return crmui.showMsgBand("warning",I18n.getMsg("crm.email.attach.inprogess"),5e3),!1;EmailSendingUtil.selectedEmailMatches()||EmailSendingUtil.isEntityWindow||($("#moduleName").val(""),$("#ecEntityId").val(""));var t=$("#ceSubject1_"+EmailComposeUtil.CURRENT_TAB).val();if(""===$("#ceSubject_"+EmailComposeUtil.CURRENT_TAB).val().trim())return EmailComposeUtil.showSubjectInputPopup(),!1;if(t&&t.length>250){var a=I18n.getMsg("crm.email.compose.subject.len.check","250");return crmui.showMsgBand("warning",a,3e3),!1}if(EmailComposeUtil.filesFlag>0)return crmui.showMsgBand("error",I18n.getMsg("crm.email.attach.inprogess"),5e3),!1;if(editor.zEditor.totalAttachmentSize>10485760)return crmui.showMsgBand("error",I18n.getMsg("crm.mail.attach.restriction.individual.error1"),5e3),!1;var l=!0;if(-1===i.search(/\$\{ConsentForm\.[a-zA-Z0-9_]+\}/)){l=!1;l=-1!==i.search(/\/crm\/MyConsentPortal\?id=([a-z0-9A-z]*)/)}if(!0===l)EmailComposeUtil.isConsentEmail[EmailComposeUtil.CURRENT_TAB]||$("#dataPrivacyContainerDiv").html(""),$("#emc_isConsentMail").val("true"),EmailComposeUtil.isConsentEmail[EmailComposeUtil.CURRENT_TAB]=!0;else if(EmailComposeUtil.isConsentEmail[EmailComposeUtil.CURRENT_TAB])return crmui.showMsgBand("error",I18n.getMsg("crm.send.consent.link.missing.message"),5e3),CustomizeEditor.mapClicks($(".ceSvgEmbedLink").closest("li")),!1;return EmailSendingUtil.composeActive=!1,!0},EmailUtil.validateAllEmailFields=function(e,i,t,a,l){var o=$("#"+e+"_"+EmailComposeUtil.CURRENT_TAB);if(0===o.length)return!0;var n=o.val().trim();return""!==n&&EmailSendingUtil.setUnameAndEmail(n,"",null,o.closest("li")),$("#"+e+"Details_"+EmailComposeUtil.CURRENT_TAB+" .invalidEmail").length>0?(crmui.showMsgBand("error",l,5e3),!1):"ceToAddr"!==e||0!==$("#"+e+"Details_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length||(crmui.showMsgBand("error",a,5e3),!1)},EmailUtil.checkForXssContent=function(e){var i=e.indexOf("<script>"),t=e.indexOf("<\/script>");return i>-1&&t>-1},EmailUtil.validateEmailFieldsOfToCcBcc=function(e,i,t,a){var l=$("#"+e+"Details_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length,o=$("#"+i+"Details_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length,n=$("#"+t+"Details_"+EmailComposeUtil.CURRENT_TAB+" .selectedEmail").length;if(l+o+n>EmailSendingUtil.numberOfEmailAddr)return crmui.showMsgBand("error",a,5e3),!1;var s="",m=$("#etSenderList_"+EmailComposeUtil.CURRENT_TAB).val(),r=CrmEmailInitialize.ComposeMailData.from_address;if(r)for(var d=r.length,c=0;c<d;c++)if(r[c].email.includes(m)&&"imap"===r[c].type){s="IMAP";break}var E="IMAP"==s?10:1;return!(-1!==editor.getContent().search(/\$\{Unsubscribe\.(.*?)\}/)&&l+o+n>E)||(crmui.showMsgBand("error",I18n.getMsg("crm.email.toaddr.provide.nomore"),3e3),!1)},EmailUtil.returnJSONObject=function(e,i){var t,a=[],l=e.length,o={};for(t=0;t<l;t++)""!==e[t].trim()&&(o.user_name=i[t],o.email=e[t],a.push(o),o={});return a},EmailUtil.getFormattedScheduleTime=function(e){var i,t=e.split("##"),a=EmailComposeUtil.getUserDatePattern(),l=t[0],o=t[1],n=t[2],s=$("#emc_bestTime").text(),m=/(.+?)\(([A-Z]+? )([0-9:\-+]+?)\)(.+?)$/;m.test(s)&&(i=m.exec(s)[3]);var r=(l=EmailDateTimeUtils.convertDateToGivenPattern(l,a,"MM/dd/yyyy"))+" "+o;return n&&/(am|pm|AM|PM)$/.test(n)&&(r+=" "+n),i&&(r+=" "+i),new Date(r)},EmailUtil.getUserNameWithEmail=function(e){var i=[],t=$("#"+e+"Details_"+EmailComposeUtil.CURRENT_TAB).find("li");return t.length>0&&t.each((function(){if($(this).hasClass("selectedEmail")||$(this).hasClass("invalidEmail")){var e={};e.user_name=$(this).attr("username"),e.email=$(this).attr("email"),i.push(e)}})),i},EmailUtil.hideSchedulePopUp=function(){$("#etSchedulePopId,#calenDiv").addClass("hide")},EmailUtil.showMaximizeComposeButton=function(){$("#maxComposeBtn").removeClass("hide"),"undefined"!=typeof CrmPlusImpl&&("undefined"!=typeof isCrmPlusUser&&"true"===isCrmPlusUser||"undefined"!=typeof isZohoOneUser&&"true"===isZohoOneUser)&&CrmPlusImpl.handleDraftMailIcon(!0)},EmailUtil.showCustomFreezeLayer=function(){$("#etComposePanel").append('<div id="z_freezeLayer" class="z_freezeLayer" style="display: block;"></div>')},EmailUtil.removeCustomFreezeLayer=function(){var e=$(".z_freezeLayer");e&&e.remove()},EmailUtil.showEditorFreezeLayer=function(){var e=$("#etComposePanel"),i=$("#z_freezeLayer");i.length>0?i.show():(i='<div id="z_freezeLayer" class="z_freezeLayer" style="display: block;"></div>',e.append(i))},EmailUtil.hideEditorFreezeLayer=function(){$("#etComposePanel #z_freezeLayer").hide()},EmailUtil.sendingPopup=function(){EmailUtil.showEditorFreezeLayer();var e=$("#bestTime_"+EmailComposeUtil.CURRENT_TAB),i=$("#emailEntityComposepopup");e.length>0&&(e.is(":checked")?i.html(I18n.getMsg("scheduling")+'<span id="eECDots"></span>'):i.html(I18n.getMsg("sending")+'<span id="eECDots"></span>')),EmailUtil.dots=0,setInterval(EmailUtil.animateDots,500)},EmailUtil.animateDots=function(){EmailUtil.dots<3?($("#eECDots").append("."),EmailUtil.dots++):($("#eECDots").text(""),EmailUtil.dots=0)},EmailUtil.closeSendingPopup=function(){$("#emailEntityComposepopup").html(""),EmailUtil.hideEditorFreezeLayer()},EmailUtil.newshowHideoptions=function(e,i){$(e).addClass("hide");var t=$("#ceOption_"+i+"_"+EmailComposeUtil.CURRENT_TAB);t.addClass("ceComposeMeta"),t.removeClass("hide"),$("#ecAutoCompleteContainer").addClass("hide");var a=t.find("input");if(a.val(""),"replyto"===i){var l=$("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB),o=l.find("option").eq(0).attr("value");l.attr("selectedval",o)}EmailComposeUtil.displayComposeMetaFields(),a.focus(),EmailSendingUtil.resizeEditorHeight(),thirdPartyUtils.bindSelect2(l)},EmailUtil.formatAttachment=function(e){var i=[];return $.each(e,(function(e,t){var a={};a[EmailComposeUtil.FILE_NAME]=t.name,a[EmailComposeUtil.FILE_ID]=t.id,""===t.service||"IMAPAttached"===t.service||"GMailAttached"===t.service||"ZMAILAttached"===t.service?a[EmailComposeUtil.SERVICE_NAME]=t.service:a[EmailComposeUtil.SERVICE_NAME]="ZFSAttached",t.filesize&&(a[EmailComposeUtil.FILE_SIZE]=t.filesize),i.push(a)})),i},EmailUtil.removeUnnecessarySpacingAndNewLines=function(e){return e=(e=(e=(e=e.replace(/<br>/g,"")).replace(/<div>/g,"")).replace(/<\/div>/g,"")).replace(/&nbsp;/g,"")},EmailUtil.saveTempDraftDetails=function(){EmailComposeUtil.setEmailAddresses(),EmailActionHandling.setDraftDetails()},EmailUtil.initializePlainTextEditor=function(){editor.zEditor.createPlainEditor(),editor.zEditor.plainEditor.style.display="none"},EmailUtil.getSendMailURL=function(e,i){return"/crm/v2/"+e+"/"+i+"/actions/send_mail"},EmailUtil.addLinkToTheEditor=function(e){editor.zEditor.insertHTML(e)},EmailUtil.isReplyToAddressAdded=function(){var e=$(".ceSenderInfo");return $(".ceReceiverInfo").is(":visible")||e.is(":visible")?e.is(":visible"):$("#ceReplyToAddrSpan_"+EmailComposeUtil.CURRENT_TAB).is(":visible")},EmailUtil.setInventoryDetails=function(e){if(e||(e=EmailComposeUtil.inventory_details),e){var i=e.inventory_template;if(i){var t=i.id,a=i.name,l=e.paper_type,o=e.view_type,n=EmailComposeUtil.getFormattedAttachmentDetails(t,a);n.EDITOR_ATTACH=1,n.file_name.includes(".pdf")||(n.file_name=n.file_name+".pdf"),editor.zEditor.displayAttachment(n),$("#layout_Id_"+EmailComposeUtil.CURRENT_TAB).val(t),$("#layout_Name_"+EmailComposeUtil.CURRENT_TAB).val(a),$("#paperType_"+EmailComposeUtil.CURRENT_TAB).val(l),$("#viewType_"+EmailComposeUtil.CURRENT_TAB).val(o)}}},EmailUtil.putInventoryTemplateAttachmentOnEditor=function(e){if(e||(e=EmailComposeUtil.inventory_details),e){var i=e.inventory_template;if(i){var t=i.id,a=i.name,l=EmailComposeUtil.getFormattedAttachmentDetails(t,a);editor.zEditor.displayAttachment(l)}}},EmailUtil.removeAllAddedEmails=function(e){var i=$("#"+e);if(0!==i.length){var t=i.find("li");$.each(t,(function(e,i){i.classList.contains("ecAddrEditor")||i.remove()}))}},EmailUtil.getNodeText=function(e){var i="",t=e.startContainer,a=e.endOffset;if(t)if(t.innerText)i=t.innerText;else{var l=t.wholeText,o=t.textContent;i=o===l.trim()?l:o}return i=i.substring(0,a)},EmailUtil.putSignature=function(){if(!editor)return!1;EmailUtil.setSignature(),editor.setContent(EmailComposeUtil.editorContent)},EmailUtil.getProperErrorMessage=function(e,i){var t="";if(e&&e.data&&e.data[0]||e.message){if(e.message||(e=e.data[0]),e&&e.message)if(e.message.includes("permission"))t=I18n.getMsg("crm.security.error");else if(e.message.includes("Account confirmation required"))t=I18n.getMsg("crm.mail.user.not.confirmed.new");else if(e.message.includes("Email Confirmation Required"))t=I18n.getMsg("crm.mail.user.email.not.confirmed");else if(e.message.includes("You have reached the daily mail usage"))t=I18n.getMsg("crm.mail.free.mail.count.exceeded");else if(e.message.includes("your organization has been blocked"))t=I18n.getMsg("crm.mail.free.mail.blocked",[RebrandLinkUtil.getProperty("SUPPORTMAILID")]);else if(e.message.includes("Have not consented to receive email")){var a="<a href="+RebrandLinkUtil.getProperty("CRM_BLOCKEDEMAIL_HELPLINK")+" target=_blank class=link> help page </a>";t=e.details.email&&"null"!==e.details.email?I18n.getMsg("crm.mail.address.blocked",["("+e.details.email+")",I18n.getMsg("crm.priv.email.consent"),a]):I18n.getMsg("crm.mail.address.blocked",["",I18n.getMsg("crm.priv.email.consent"),a])}else if(e.message.includes("The record is in stop processing"))t=I18n.getMsg("crm.email.error.sending.locked");else if(e.message.includes("cannot send an email to this customer"))t=I18n.getMsg("crm.label.emailoptout.alert.message");else if(e.message.includes("recipient email's contain one or more blocked email")){a="<a href="+RebrandLinkUtil.getProperty("CRM_BLOCKEDEMAIL_HELPLINK")+" target=_blank class=link> help page </a>";t=I18n.getMsg("crm.mail.address.blocked",["("+e.details.email+")",e.details.reason,a])}else if(e.message.includes("Compliance settings is not enabled"))t=I18n.getMsg("crm.email.consent.confirmation.title.modulediffer");else if(e.message.includes("license type does not support email scheduling"))t=I18n.getMsg("crm.email.editor.error.schedule");else if(e.message.includes("From_address_is_not_available"))t=I18n.getMsg("crm.email.label.from_address_is_not_available");else if(e.message.includes("the related id given seems to be invalid"))t=I18n.getMsg("crm.email.label.error.item_deleted_or_removed",I18n.getMsg("Record"));else{if(e.message.includes("Connectivity issue occured when sending mail via your SMTP server"))return e.details.reason;e.message.includes("File Size Exceeds")?t=I18n.getMsg("crm.attach.file.limit.msg"):e.message.includes("Error occured while processing attachments")&&e.details.reason?t=e.details.reason.replace("Could not send the email due to an issue with the attached file",I18n.getMsg("crm.transmail.error.attachment.process")+" ").replaceAll(" ' ","'"):e.message.includes("Error occured while processing attachments")&&(t="Error occured while processing attachments. Kindly check the file(s) again.")}if(""!==t)return t;if(e&&e.code){var l=e.code;if(l.includes("INVALID_REQUEST")||l.includes("REQUIRED_PARAM_MISSING"))return I18n.getMsg("crm.label.xmlparseError")}}switch(i){case 400:case 403:t=e.message;break;default:t=e&&e.message?e.message:I18n.getMsg("error.unexpected")}return t=t&&"Internal Server Error"!==t?t.replace(/( api )/g," send mail "):I18n.getMsg("error.unexpected")},EmailUtil.getFormattedTime=function(e){var i,t,a,l,o,n=e.split("##"),s=n[0];if("today"===s||"tomorrow"===s){var m=new Date;"tomorrow"===i&&m.setDate(m.getDate()+1),i=m.getDay(),t=m.getMonth(),a=m.getFullYear()}else{var r=EmailComposeUtil.getUserDatePattern(),d=r.indexOf("yyyy");a=s.substring(d,d+4);var c=r.indexOf("MM");t=s.substring(c,c+2),t=parseInt(t),t-=1;var E=r.indexOf("dd");i=s.substring(E,E+2)}var p=Crm.userDetails.TIME_FORMAT;e=n[1];(l=parseInt(e.split(":")[0]),o=parseInt(e.split(":")[1]),t=parseInt(t),"hh:mm a"===p)&&("PM"===n[2]&&(l+=12));return new Date(a,t,i,l,o).toISOString()},EmailUtil.getTemplateData=function(e,i,t,a,l,o){if(-1!==parseInt(e)){var n="action="+EmailComposeUtil.GET_TEMPLATE_DETAIL_BY_ID+"&templateId="+e+"&module="+i+"&toAddr="+encodeURIComponent(a)+"&fromAddr="+encodeURIComponent(t)+"&entId="+l+"&editorMode="+o;$(EmailTabHomeUtil.Loading).show(),(new crmRequestPool).initiate({type:EmailTabHomeUtil.GET_REQUEST_TYPE,url:EmailTabHomeUtil.URL,data:n,dataType:"json",success:function(i){var t=$(EmailTabHomeUtil.Loading);t.hide(),t.removeAttr("data-zcqa"),EmailSendingUtil.templateIdVsDetail[e]=i;var a=EmailSendingUtil.templateIdVsDetail[e];return EmailSendingUtil.templateData=a,editor&&editor.zEditor&&a&&EmailSendingUtil.isLoadTemplate&&EmailComposeUtil.editorLoaded&&(EmailSendingUtil.isLoadTemplate=!1,EmailSendingUtil.populateEditorWithTemplate(EmailSendingUtil.templateData,EmailSendingUtil.module),EmailComposeUtil.setSubject(EmailSendingUtil.templateData.subject),EmailSendingUtil.templateData=""),a},error:EmailTabHomeUtil.handleAjaxAbort})}},EmailUtil.showMsg=function(e,i,t){crmui.showMsgBand(e,i,t);var a=$("#crm-msg");$("#composeContentPanel").append(a),a.addClass("pA")},EmailUtil.convertDateToISO=function(e){var i,t,a=e.split("##"),l=Crm.userDetails.TIME_FORMAT,o=a[0],n=a[1];if("today"!==o&&"tomorrow"!==o||(o=EmailDateTimeUtils.convertDateTodayTomorrow(o)),a.length>2&&(i=a[2],"hh:mm a"===l&&(n=n+" "+i)),a.length>3){t=a[3];var s=$("#timeZone option[value='"+t+"']").text();t=s.substring(0,s.indexOf(")")+1)}return new Date(o+" "+n+" "+t).toISOString()},EmailUtil.isValidWebURL=function(e){return validationUtils.isValidWebURL(e)},EmailUtil.isSpecialLink=function(e){var i=!1;return validationUtils.isValidWebUrl(e)||e.indexOf("${")>=0&&(i=!0),i},EmailUtil.addRelatedListAttachment=function(e){for(var i=e.length,t=i,a=0,l=0;l<i;l++){var o=e[l].id,n=e[l].fileName,s=e[l].fileSize;e[l].service_name="RawZFSFile";var m=EmailComposeUtil.getFormattedAttachmentDetails(o,n,s,"RawZFSFile");editor.zEditor.z_doc.getElementById("attachment_"+m.id)?(e.deleteElementAt(l),l--,i--,a++):editor&&(editor.zEditor.displayAttachment(m),e[l].file_name=e[l].fileName,e[l].file_size=e[l].fileSize,editor.zEditor.totalAttachmentSize=editor.zEditor.totalAttachmentSize+parseInt(e[l].fileSize),delete e[l].fileSize,delete e[l].fileName)}1===t&&1===a?crmui.showMsgBand("error",I18n.getMsg("crm.email.entattach.error.duplicate"),5e3):a>0&&t>1&&crmui.showMsgBand("error",I18n.getMsg("crm.email.entattach.error.duplicate2"),5e3),e.length>0&&EmailActionHandling.saveDraftOnAttachmentAddition(e)},EmailUtil.isEditInScheduleMail=function(){var e=$("#sendMailType_"+EmailComposeUtil.CURRENT_TAB);return!!(e&&e.length>0&&e.val()===EmailComposeUtil.EDIT_IN_COMPOSE)},EmailUtil.getTimeZoneOffsetFromTextString=function(e){var i=0,t=e.match(/\GMT[\s]{1}([\-]{0,1}.*?)\)/);if(t&&t.length>0){var a=t[1].split(":"),l=Number(a[0]),o=Number(a[1]);i=-(i=l<0?60*l-o:60*l+o)}return i};var CrmEmailInitialize={sessionStorageDetails:void 0,isInitialResourcesLoaded:!1,editorLoaded:!1,ComposeMailData:void 0,initialize:function(){CrmEmailInitialize.PopulateComposeMailData(),CrmEmailInitialize.LoadResource_EmailCompose()},LoadResource_EmailCompose:function(){CrmEmailInitialize.setMaximizeMinimizeButton()},PopulateComposeMailData:function(e,i,t){var a={"X-ZOHO-SERVICE":"crm","X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken,"X-CRM-ORG":crmZgid};(new crmRequestPool).initiate({url:"/crm/v2/__internal/__emailcompose_meta",type:"GET",headers:a,content:"application/json",success:function(a){CrmEmailInitialize.ComposeMailData=a.data[0],CrmEmailInitialize.ComposeMailData&&(Crm.userDetails.isNewEditor=!!CrmEmailInitialize.ComposeMailData.features_available.inline_compose_window,Crm.userDetails.isComposeAutoSuggestionEnabled=CrmEmailInitialize.ComposeMailData.features_available.auto_suggestion,EmailComposeUtil.editorLoaded&&editor&&editor.zEditor),i?EmailCompose.launchEmailCompose(e,t):e&&e(CrmEmailInitialize.ComposeMailData)},error:function(){CrmEmailInitialize.ComposeMailData={}}})}};$(document).ready((function(){CrmEmailInitialize.ComposeMailData&&(Crm.userDetails.isNewEditor=!!CrmEmailInitialize.ComposeMailData.features_available.inline_compose_window)})),CrmEmailInitialize.setMaximizeMinimizeButton=function(){setTimeout((function(){var e=$("#maxComposeBtn");if(e){var i=sessionStorage.getItem("draftDetails");(i=JSON.parse(i))&&(delete i.undefined,"null"!==i&&0!==Object.keys(i).length&&(EmailComposeUtil.loadI18nResources(),EmailLaunchUtil.sessionStoredDraftDetails=i,e.removeClass("hide"),"undefined"!=typeof CrmPlusImpl&&("undefined"!=typeof isCrmPlusUser&&"true"===isCrmPlusUser||"undefined"!=typeof isZohoOneUser&&"true"===isZohoOneUser)&&CrmPlusImpl.handleDraftMailIcon(!0)))}}),5e3)};var EmailLaunchUtil={sessionStoredDraftDetails:void 0,isInitialResourceLoaded:!1,postResourceLoadInitialization:void 0,SendMailEvent:function(e,i,t,a){if(EmailLaunchUtil.isInitialResourceLoaded)EmailCompose.SendMailEvent(e,i,t,a);else{var l=EmailLaunchUtil.getInitialResources();EmailLaunchUtil.resources_1=l,Lyte.injectResources(l,void 0,(function(){EmailLaunchUtil.isInitialResourceLoaded=!0,EmailLaunchUtil.postResourceLoadInitialization&&(EmailLaunchUtil.postResourceLoadInitialization.call(),EmailLaunchUtil.postResourceLoadInitialization=void 0),EmailCompose.SendMailEvent(e,i,t,a)}))}},sendMailEventForInventoryModule:function(e,i,t){if(EmailLaunchUtil.isInitialResourceLoaded)EmailCompose.sendMailEventForInventoryModule(e,i,t);else{var a=EmailLaunchUtil.getInitialResources();EmailLaunchUtil.resources_1=a,Lyte.injectResources(a,void 0,(function(){EmailLaunchUtil.isInitialResourceLoaded=!0,EmailLaunchUtil.postResourceLoadInitialization&&(EmailLaunchUtil.postResourceLoadInitialization.call(),EmailLaunchUtil.postResourceLoadInitialization=void 0),EmailSendingUtil.entityId=i,EmailCompose.sendMailEventForInventoryModule(e,i,t)}))}},launchReplyMail:function(e,i,t){if(EmailLaunchUtil.isInitialResourceLoaded)EmailCompose.launchReplyMail(e,i,t);else{var a=EmailLaunchUtil.getInitialResources();EmailLaunchUtil.resources_1=a,Lyte.injectResources(a,void 0,(function(){EmailLaunchUtil.isInitialResourceLoaded=!0,EmailLaunchUtil.postResourceLoadInitialization&&(EmailLaunchUtil.postResourceLoadInitialization.call(),EmailLaunchUtil.postResourceLoadInitialization=void 0),EmailCompose.launchReplyMail(e,i,t)}))}},editScheduleMail:function(e,i,t){if(EmailLaunchUtil.isInitialResourceLoaded)EmailCompose.editScheduleMail(e,i,t);else{var a=EmailLaunchUtil.getInitialResources();EmailLaunchUtil.resources_1=a,Lyte.injectResources(a,void 0,(function(){EmailLaunchUtil.isInitialResourceLoaded=!0,EmailLaunchUtil.postResourceLoadInitialization&&(EmailLaunchUtil.postResourceLoadInitialization.call(),EmailLaunchUtil.postResourceLoadInitialization=void 0),EmailCompose.editScheduleMail(e,i,t)}))}},fetchDraftDetails:function(e,i,t){if(EmailLaunchUtil.isInitialResourceLoaded)EmailCompose.fetchDraftDetails(e,i,t);else{var a=EmailLaunchUtil.getInitialResources();EmailLaunchUtil.resources_1=a,Lyte.injectResources(a,void 0,(function(){EmailLaunchUtil.isInitialResourceLoaded=!0,EmailLaunchUtil.postResourceLoadInitialization&&(EmailLaunchUtil.postResourceLoadInitialization.call(),EmailLaunchUtil.postResourceLoadInitialization=void 0),EmailCompose.fetchDraftDetails(e,i,t)}))}},restoreComposePopup:function(){if(!$("#profileEditPopup").hasClass("zcrm-show")&&!$("#localeEditPopup").hasClass("zcrm-show"))if($L("#etComposePanel").removeClass("etMinimize"),EmailLaunchUtil.isInitialResourceLoaded)EmailComposeUtil.hideAllComposeRelatedPopup(),EmailUtil.removeCustomFreezeLayer(),EmailComposeUtil.restoreComposePopup();else{var e=EmailLaunchUtil.getInitialResources();EmailLaunchUtil.resources_1=e,Lyte.injectResources(e,void 0,(function(){EmailLaunchUtil.isInitialResourceLoaded=!0,EmailLaunchUtil.postResourceLoadInitialization&&(EmailLaunchUtil.postResourceLoadInitialization.call(),EmailLaunchUtil.postResourceLoadInitialization=void 0),EmailComposeUtil.sessionStoredDraftDetails=EmailLaunchUtil.sessionStoredDraftDetails,EmailComposeUtil.restoreComposePopup()}))}},getApiNameForModule:function(e){var i=Crm.userDetails.MODULE_LIST[e],t=e;return i&&(t=i.api_name),t},launchComposeMailWithSurvey:function(){EmailUtil.setSignature(EmailComposeUtil.ComposeMailData.default_from.email),EmailComposeUtil.editorContent&&editor.setContent(EmailComposeUtil.editorContent),ZSurvey.insertText()},removeDraftDOMElement:function(){EmailLaunchUtil.isInitialResourceLoaded?EmailComposeUtil.removeDraftDOMElement():EmailLaunchUtil.getInitialResources()},showHideFromRecord:function(){var e=$("#moduleName_"+EmailComposeUtil.CURRENT_TAB).val(),i=$("#module");!e&&i.val()&&(e=i.val()),e&&store.findAll("related_list",{module:EmailComposeUtil.getApiNameForModule(e)},!0).then((function(e){var i=$("#zi_sub_rel_list_attach");0===e.filter((function(e){return"ATTACHMENTSPERSONALITY"===e.personality_name&&!1===e.visible})).length?i.removeClass("hide"):i.addClass("hide")}))},loadResources:function(e){if(EmailLaunchUtil.isInitialResourceLoaded)e();else{var i=EmailLaunchUtil.getInitialResources();EmailLaunchUtil.resources_1=i,Lyte.injectResources(i,void 0,(function(){EmailLaunchUtil.isInitialResourceLoaded=!0,EmailLaunchUtil.postResourceLoadInitialization&&(EmailLaunchUtil.postResourceLoadInitialization.call(),EmailLaunchUtil.postResourceLoadInitialization=void 0),e()}))}},getInitialResources:function(){var e=[networkUtils.getI18nJSUrl("emailcompose"),networkUtils.getI18nJSUrl("emaileditor"),networkUtils.getI18nJSUrl("emailsRelatedList")];Lyte.injectResources(networkUtils.returnDependencyFiles(e,crmConstants.jsStaticPath),void 0,void 0);var i=networkUtils.returnDependencyFiles(["inlineEmailCompose_min.js"],crmConstants.jsStaticPath).concat(networkUtils.returnDependencyFiles(["crm-email-subjectpop.js"],crmConstants.jsStaticPathForLyte));i=i.concat(networkUtils.returnDependencyFiles(["email-emotions.js"],crmConstants.jsStaticPathForLyte));var t=networkUtils.returnDependencyFiles(["inline_ComposeEditor_min.css"],crmConstants.cssStaticPath).concat(networkUtils.returnDependencyFiles(["crm-email-subjectpop.css"],crmConstants.cssStaticPathForLyte));return i.concat(t)},isComposeActive:function(){var e=!1;return EmailLaunchUtil.isInitialResourceLoaded&&(e=EmailSendingUtil.composeActive),e}};