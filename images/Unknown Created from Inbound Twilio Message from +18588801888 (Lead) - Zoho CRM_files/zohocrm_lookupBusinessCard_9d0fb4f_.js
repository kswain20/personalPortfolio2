var crmLookupBusinessCard={moduleName:"",entityId:"",result:null,showingSide:"showOnRight",cleartimeout:"",getRecordJSon:function(e,t,s,r){if(crmLookupBusinessCard.moduleName===e&&crmLookupBusinessCard.entityId===t&&crmLookupBusinessCard.result)crmLookupBusinessCard.showBC(crmLookupBusinessCard.result,s);else{var o="/crm/v2.2/"+moduleRecordMapping[e].api_name+"/"+t;"Potentials"===e&&(o="/crm/v2.1/"+moduleRecordMapping[e].api_name+"/"+t);var a={"X-ZCSRF-TOKEN":csrfParamName+"="+csrfToken,"X-ZOHO-SERVICE":"crm/lookupTooltip"};clientPortalName&&(a["X-CRMPORTAL"]=clientPortalName);var n={apply_fields:"business_card",include:"fields",approved:"both"};null!==(r="Leads"===e?null!==r&&!0===r&&r:null)&&(n.converted=r),"Events"===e&&(n.fields="Remind_At"),(new crmRequestPool).initiate({action:o,data:n,type:"GET",headers:a,success:function(r){r&&r.fields&&r.fields.length>1&&r.data&&1==r.data.length?(r.data=r.data[0],crmLookupBusinessCard.result=r,crmLookupBusinessCard.moduleName=e,crmLookupBusinessCard.entityId=t,crmLookupBusinessCard.showBC(r,s)):crmLookupBusinessCard.showBC(null,s)},error:function(){crmLookupBusinessCard.showBC(null,s)}})}},showBC:function(e,t){var s,r=$(t).parents(".outlookInfoCont").length;null==e?s=I18n.getMsg("crm.security.error"):("Events"===crmLookupBusinessCard.moduleName&&$.each(e.fields,(function(e,t){"Venue"!==t.api_name&&"Owner"!==t.api_name&&"Remind_At"!==t.api_name||(t.businesscard_supported=!0)})),s=crmLookupBusinessCard.isPhotoFieldPresence()||"Events"===crmLookupBusinessCard.moduleName?$(Handlebars.templates.ToolTipBusinessCard(e.fields.slice(1))):$(Handlebars.templates.ToolTipBusinessCard(e.fields))),r&&(crmLookupBusinessCard.showingSide="showOnBottom"),crmui.showTooltip({content:s,isHTML:!0,position:crmLookupBusinessCard.showingSide,target:t,classList:"customLookupDetails"});var o=$(".customLookupDetails");if(r&&o.addClass("outLookInside"),"showOnLeft"===crmLookupBusinessCard.showingSide){var a=o.offset().left,n=a-30;n<=50&&(n=(a=t.offset().left-o.width())-60,o.hasClass("showOnRight")&&o.removeClass("showOnRight").addClass("showOnLeft")),o.css("left",n)}o.hasClass("top")&&o.css("margin-top","5px")},isPhotoFieldPresence:function(){return!(!crmLookupBusinessCard.result||!crmLookupBusinessCard.result.fields[0]||"Record_Image"!==crmLookupBusinessCard.result.fields[0].api_name)},getFieldValue:function(e,t){var s=crmLookupBusinessCard.result.data[e.api_name],r="Salutation";if(!s)return"";var o=e.data_type;if("formula"===o&&(o=e.formula.return_type),"multiselectpicklist"===o&&"Tax"===e.api_name){var a=[];return s.forEach((function(e){a.push(e.value)})),$ESAPI.encoder().encodeForHTML(a.join(";"))}if(o.indexOf("lookup")>-1)return $ESAPI.encoder().encodeForHTML(s.name);if("boolean"===o)return s?'<span class="yes"></span>':"";if("datetime"===o){if(e.api_name){var n=s.replace(/[+-]\d{2}:\d{2}/,"");i=new Date(n)}else i=new Date(s);return Utils.getDateTimeInUserFormat(i,!0)}if("date"===o){var i=new Date(s+" 00:00:00");return isNaN(i.getTime())&&(i=new Date(s)),Utils.getDateInUserDatePattern(i,!0)}if("multiselectpicklist"===o)return $ESAPI.encoder().encodeForHTML(s.join(";"));if(t){if(crmLookupBusinessCard.moduleName===crmModuleConstants.Contacts||crmLookupBusinessCard.moduleName===crmModuleConstants.Leads){r=s[r];var d=s.First_Name,u="";if(Crm&&Crm.userDetails){var l=Crm.userDetails.NAME_FORMAT.split(","),m=s[l[0].replace(" ","_")],c=s[l[1].replace(" ","_")],p=s[l[2].replace(" ","_")];m&&(u=m+" "),c&&(u=u+c+" "),p&&(u+=p)}else r&&(u=r+" "),d&&(u=u+d+" "),u+=s.Last_Name;s=u}return s='<a  data-cid=\'detailView\' data-params=\'{"lookback":"true","module":"'+crmLookupBusinessCard.moduleName+'","id":"'+crmLookupBusinessCard.entityId+'"}\' href="'+Crm.getCrmBasePath()+"/EntityInfo.do?module="+encodeURIComponent(crmLookupBusinessCard.moduleName)+"&id="+encodeURIComponent(crmLookupBusinessCard.entityId)+"\" onClick=\"crmNTCGlobal.closeGlobalNotifications(); Crm.trackSpotLightAction('Lookup Hover Click',{'Module':'"+crmLookupBusinessCard.moduleName+"'})\">"+$ESAPI.encoder().encodeForHTML(s)+"</a>"}return"Layout"==e.api_name?$ESAPI.encoder().encodeForHTML(s.name):e.ui_type==CrmField.UITYPES.SERVICE_DURATION?Handlebars.helpers.setServiceDuration(s):"Wizard"==e.api_name?$ESAPI.encoder().encodeForHTML(s.name):!e.separator||e.ui_type!==CrmField.UITYPES.NUMERIC_FIELD&&e.ui_type!==CrmField.UITYPES.DECIMAL&&e.ui_type!==CrmField.UITYPES.LONG_INTEGER&&e.ui_type!==CrmField.UITYPES.AGGREGATE_FIELD?$ESAPI.encoder().encodeForHTML(s.toString()):$ESAPI.encoder().encodeForHTML(Search.formatNumber(s.toString()))},getEventStart_EndTime:function(e,t){var s=crmLookupBusinessCard.result.data[e.api_name],r=crmLookupBusinessCard.result.data[t.api_name],o=new Date(s),a=new Date(r);return crmLookupBusinessCard.result.data.All_day?o.getUTCDate()==a.getUTCDate()&&o.getUTCMonth()==a.getUTCMonth()&&o.getUTCFullYear()==a.getUTCFullYear()?(o=new Date(o.getUTCFullYear(),o.getUTCMonth(),o.getUTCDate()),Utils.getDateInUserDatePattern(o,!0)):(a=new Date(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate()),Utils.getDateInUserDatePattern(o,!0)+" - "+Utils.getDateInUserDatePattern(a,!0)):Utils.getDateTimeInUserFormat(o,!0)+" - "+Utils.getDateTimeInUserFormat(a,!0)},getAlldayEvent:function(){if(crmLookupBusinessCard.result.data.All_day){var e=crmLookupBusinessCard.result.fields.filter((function(e){return"All_day"===e.api_name}));return'<tr><td><span class="dIB">'+$ESAPI.encoder().encodeForHTML(e[0].field_label)+'</span></td><td><span class="dIB"><span class="yes"></span></span></td></tr>'}return""},showLookupDetails:function(e){var t=(e=$(e))[0].parentElement,s=void 0!==t?t.parentElement:null,r=void 0!==$(s)?$(s).attr("class"):"",o=null,a=document.querySelectorAll("crm-client-portal-user-type-users").length;void 0===r||"timeline_Converted Leads"!==r.trim()&&"timeline_added Contacts"!==r.trim()&&"timeline_added Accounts"!==r.trim()&&"timeline_added Potentials"!==r.trim()||(o=!0);var n=e.data("params");crmLookupBusinessCard.showingSide="showOnRight",renderingUtils.windowWidth-e.offset().left<425&&(crmLookupBusinessCard.showingSide="showOnLeft"),n&&n.module&&n.id&&(clearTimeout(crmLookupBusinessCard.cleartimeout),crmui.hideTooltip(),a&&$("#wf_tooltip").hide(),crmLookupBusinessCard.cleartimeout=setTimeout((function(){e.is(":hover")&&crmLookupBusinessCard.getRecordJSon(n.module,n.id,e,o)}),250))},getPhotoField:function(e){if(crmLookupBusinessCard.isPhotoFieldPresence()){e=e.api_name;var t=crmLookupBusinessCard.result.fields[0].api_name,s=crmLookupBusinessCard.result.data,r=s[t];if(void 0!==r){var o="";if(r){o='<div id="imgContainer" class="emptyLCPhoto mR10 dIB vam" style="background-position: 0px 0px;"><img src="'+(Crm.getCrmBasePath()+"/EntityImageAttach.do?action_module="+encodeURIComponent(crmLookupBusinessCard.moduleName)+"&entityId="+encodeURIComponent(crmLookupBusinessCard.entityId)+"&actionName=readImage&fileId="+r)+'"></div>'}else{var a=["0px 0px","-53px 0px","-103px 0px","-154px 0px","-205px 0px","0px -55px","-53px -55px","-103px -55px","-154px -55px","-205px -55px"];o="background-position: "+a[Math.floor(Math.random()*a.length)];var n=s[e];crmLookupBusinessCard.moduleName!==crmModuleConstants.Contacts&&crmLookupBusinessCard.moduleName!==crmModuleConstants.Leads||(n=n.First_Name?n.First_Name:n.Last_Name),n=n.charAt(0),o='<div id="imgContainer" class="emptyImgBusinesCard emptyLCPhoto mR10 dIB vam">'+$ESAPI.encoder().encodeForHTML(n)+"</div>"}return o}}return""}};Handlebars.registerHelper("getPhotoField",(function(e){return crmLookupBusinessCard.getPhotoField(e)})),Handlebars.registerHelper("getFieldValue",(function(e,t){return crmLookupBusinessCard.getFieldValue(e,t)})),Handlebars.registerHelper("getEventStart_EndTime",(function(e,t){return crmLookupBusinessCard.getEventStart_EndTime(e,t)})),Handlebars.registerHelper("getAlldayEvent",(function(e,t){return crmLookupBusinessCard.getAlldayEvent(e,t)}));