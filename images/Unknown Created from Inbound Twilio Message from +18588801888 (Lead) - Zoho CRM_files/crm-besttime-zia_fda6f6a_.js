Lyte.Component.register("crm-besttime-zia",{_template:'<template tag-name="crm-besttime-zia" style="order:3;"> <template is="if" value="{{besttimeshow}}"><template case="true"> <div class="dIBestTimeContainer{{viewType}} dIBestTimetoCallContainer {{if(ifNotEquals(viewType,\'DetailsPage\'),\'schedule\',\'\')}}"> <div id="dIBestTime" class="dIB dIBestTime dIBestTime{{viewType}}"> <span class="fL dIBestTimeLabel pR mB2 cB besttimeTitle"> <span class="dIBestTimeLabel dIB">{{getI18n("crm.best.time.to.label")}}</span> <span class="dIBestTimeLabel BestimetoLabelDropdown dIB"> <template is="if" value="{{callTextDropDown}}"><template case="true"> <lyte-dropdown id="BestimeDropdown" lt-prop-selected="{{if(ifEquals(type,\'Text\'),\'Text\',\'Call\')}}" on-option-selected="{{method(\'changeType\',this)}}"> <template is="registerYield" yield-name="yield"> <lyte-drop-box> <lyte-drop-body> <lyte-drop-item data-zcqa="Zia_SelectCall" data-value="Call">{{getI18n("Call")}}</lyte-drop-item> <lyte-drop-item data-zcqa="Zia_SelectText" data-value="Text">{{getI18n("Email")}}</lyte-drop-item> </lyte-drop-body> </lyte-drop-box> </template> </lyte-dropdown> </template><template case="false"><template is="if" value="{{callonly}}"><template case="true"> <span data-value="Call">{{getI18n("Call")}} -</span> </template><template case="false"> <span data-value="Text">{{getI18n("Email")}} -</span> </template></template></template></template> </span> <template is="if" value="{{isDetailsPage}}"><template case="true"> <div id="bestTimeDayDropDown" class="dIB proxima dIBestTimeLink cP" data-zcqa="bt_{{viewType}}_date" onclick="{{action(\'showDayDropDownPopUp\',this,viewType)}}"> {{inputDate}} </div> </template><template case="false"> <div class="dIB proxima dIBestTimeLink cP" data-zcqa="bt_{{viewType}}_date"> {{inputDate}} </div> </template></template> <lyte-popover lt-prop-wrapper-class="besttimedropinlyte" lt-prop-scrollable="true" lt-prop-origin-elem="#bestTimeDayDropDown" lt-prop-max-width="400px" id="BestTimeDayDrop" lt-prop-duration="0" lt-prop-show-close-button="false" lt-prop-freeze="false" on-close="{{method(\'closeBestTimeDropDownPopover\')}}"> <template is="registerYield" yield-name="popover"> <lyte-popover-content id="besttimedropinlytecontent"> <div id="BestTimelyteCalendar" class="lyteCalenderInBesttime" style="display:{{if(calendarshow,\'block\',\'none\')}}"> <lyte-calendar lt-prop-yield="true" lt-prop-format="YYYY/MM/DD" on-date-selected="{{method(\'changeDate\')}}" id="BestTimelyteCalendar" lt-prop-min-date="{{minimumDate}}"> </lyte-calendar> </div> <div id="BestTimeDropDown" class="dIBestTimeDropdown" style="display:{{if(dropdownshow,\'block\',\'none\')}}"> <ul class="m0 p0"> <template is="for" items="{{dropDownDisplayDates}}" item="item" index="index"> <li class="m0 BestTimeDropDownli {{if(checkComparison(label,inputDate,\'=\'),proximas,\'\')}}" data-zcqa="bt_dd_{{viewType}}_{{index}}" onclick="{{action(\'changeDateForViewType\',item.date,viewType)}}">{{dropDownDisplayDates[index].label}}</li> </template> </ul> <div class="dIBestTimeToOpenCalendar dIB pT10 cP w100p proxima pB10" onclick="{{action(\'showCalendar\',this)}}"> <span class="dIOpenCalendarText pR" id="bestTimeCal">{{getI18n("crm.best.time.open.calendar")}}</span> </div> </div> </lyte-popover-content> </template> </lyte-popover> </span> <template is="if" value="{{showDetailedToday}}"><template case="true"> <span class="dIBestTimeTodayContent fL cB mT3"> <template is="if" value="{{allTimesLapsed}}"><template case="true"> <div class="dIBestTimeLabel dIB"> <span id="tryTomorrow" class="mT5 dIB" data-zcqa="bt_{{viewType}}_trynext">{{getI18n("crm.best.time.no.besttime")}}</span> </div> </template><template case="false"> <span id="remindmepop" class="dIImmediateBestTimeMin cP remColumn" data-zcqa="zia_setReminder" onclick="{{action(\'showRemindMePopup\',this,true)}}"> {{bestTimeToShow}} </span> <span class="dIB proxima dIBestTimeMins" id="dIBestTimeMins" mints="{{diffTime}}">{{bestTimeToShowEtaa}}</span> </template></template> </span> </template><template case="false"> <span class="dIBestTimeContent fL cB mT3 pB10"> <template is="if" value="{{expHandlers(reminderTime.length,\'>\',0)}}"><template case="true"> <template is="for" items="{{reminderTime}}" item="item" index="index"> <span id="BestTimeValue_{{index}}" class="timeDi cP starredIcon pR lev{{item.level}}" onclick="{{action(\'showDetailsPagePopOver\',index,item.bestTime,item.dateTime)}}"><i></i>{{item.bestTime}}</span> </template> </template><template case="false"> <div class="dIBestTimeLabel dIB"> <span id="tryTomorrow" class="mT5 dIB" data-zcqa="bt_{{viewType}}_trynext">{{getI18n("crm.best.time.no.besttime")}}</span> </div> </template></template> </span> </template></template> </div> <lyte-popover lt-prop-wrapper-class="besttimedropinlyte" lt-prop-scrollable="true" lt-prop-origin-elem="#remindmepop" id="BestTimeRemindeMe" lt-prop-duration="0" lt-prop-show-close-button="false" lt-prop-freeze="false"> <template is="registerYield" yield-name="popover"> <lyte-popover-content class="remindMeTime"> <div> <template is="for" items="{{reminderTime}}" item="item" index="index"> <template is="if" value="{{getUserDetail(\'isZiaReminderEnabled\')}}"><template case="true"> <div id="reminderTime" class="proxima fL cB w100p mB5 listElements lev{{item.level}} {{if(item.reminder,\'liSelected\',\'\')}} {{if(ifEquals(index,0),\'mT5\',\'\')}}" data-zcqa="remindTime_{{index}}" onclick="{{action(\'onReminderIntiated\',index,item.bestTime)}}" onmouseenter="{{action(\'showTooltip\',this)}}" onmouseleave="{{action(\'hideTooltip\')}}"> <div class="dIB bstTimeForGray">{{item.bestTime}}</div> <div class="mL10 dIB hide col666"></div> </div> </template><template case="false"> <div id="reminderTime" class="disableReminder proxima fL cB w100p mB5 listElements lev{{item.level}} {{if(item.reminder,\'liSelected\',\'\')}} {{if(ifEquals(index,0),\'mT5\',\'\')}}" data-zcqa="remindTime_{{index}}"> <div class="dIB bstTimeForGray">{{item.bestTime}}</div> <div class="mL10 dIB hide col666"></div> </div> </template></template> </template> </div> </lyte-popover-content> </template> </lyte-popover> <lyte-popover lt-prop-content-padding="0" lt-prop-wrapper-class="besttimedropinlyte" lt-prop-scrollable="true" id="BestTimeActivitiesOption" lt-prop-duration="0" lt-prop-show-close-button="false" lt-prop-freeze="false"> <template is="registerYield" yield-name="popover"> <lyte-popover-content> <div class="activitesOptionPop"> <ul class="pB10 pT10 pL0 pR0 m0"> <li id="Zia_CreateTask" data-zcqa="Zia_CreateTask" onclick="{{action(\'triggerCreateTask\',event,this)}}"> {{getI18n("crm.button.create.task")}}</li> <template is="if" value="{{ifEquals(type,\'Call\')}}"><template case="true"> <li id="Zia_CreateCall" data-zcqa="Zia_CreateCall" onclick="{{action(\'triggerCreateCall\',event,this)}}">{{getI18n("crm.button.create")}} {{getI18n("Call")}}</li> </template><template case="false"> <li id="Zia_ScheduleMail" data-zcqa="Zia_ScheduleMail" onclick="{{action(\'schedulemail\')}}">{{getI18n("crm.reportschedule")}} {{getI18n("crm.label.premium.email")}}</li> </template></template> </ul> </div> </lyte-popover-content> </template> </lyte-popover> <lyte-popover lt-prop-content-padding="0" lt-prop-wrapper-class="besttimedropinlyte" lt-prop-scrollable="true" id="BestTimeActivitiesOptionText" lt-prop-duration="0" lt-prop-show-close-button="false" lt-prop-freeze="false"> <template is="registerYield" yield-name="popover"> <lyte-popover-content style="padding : 0"> <div class="activitesOptionPop"> <ul class="pB10 pT10 pL0 pR0 m0"> <li id="Zia_CreateTask" data-zcqa="Zia_CreateTask" onclick="{{action(\'triggerCreateTask\',event,this)}}"> {{getI18n("crm.button.create.task")}}</li> <li id="Zia_ScheduleMail" data-zcqa="Zia_ScheduleMail" href="javascript:;" onclick="{{action(\'EntSendMail\')}}">{{getI18n("crm.reportschedule")}} {{getI18n("crm.label.premium.email")}}</li> </ul> </div> </lyte-popover-content> </template> </lyte-popover> </div> </template></template> </template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1]},{type:"text",position:[1,1,1,1,0]},{type:"attr",position:[1,1,1,3,1]},{type:"if",position:[1,1,1,3,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"registerYield",position:[1,1],dynamicNodes:[{type:"text",position:[1,1,1,0]},{type:"componentDynamic",position:[1,1,1]},{type:"text",position:[1,1,3,0]},{type:"componentDynamic",position:[1,1,3]},{type:"componentDynamic",position:[1,1]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[0]},{type:"if",position:[0],cases:{true:{dynamicNodes:[{type:"text",position:[1,0]}]},false:{dynamicNodes:[{type:"text",position:[1,0]}]}},default:{}}]}},default:{}},{type:"attr",position:[1,1,1,5]},{type:"if",position:[1,1,1,5],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1]}]}},default:{}},{type:"attr",position:[1,1,1,7]},{type:"registerYield",position:[1,1,1,7,1],dynamicNodes:[{type:"attr",position:[1,1],attr:{style:{name:"style",helperInfo:{name:"concat",args:["'display:'",{type:"helper",value:{name:"if",args:["calendarshow","'block'","'none'"]}}]}}}},{type:"attr",position:[1,1,1]},{type:"componentDynamic",position:[1,1,1]},{type:"attr",position:[1,3],attr:{style:{name:"style",helperInfo:{name:"concat",args:["'display:'",{type:"helper",value:{name:"if",args:["dropdownshow","'block'","'none'"]}}]}}}},{type:"attr",position:[1,3,1,1]},{type:"for",position:[1,3,1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]}]},{type:"attr",position:[1,3,3]},{type:"text",position:[1,3,3,1,0]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1,1,1,7]},{type:"attr",position:[1,1,3]},{type:"if",position:[1,1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"text",position:[1,1,0]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1]},{type:"attr",position:[3]},{type:"text",position:[3,0]}]}},default:{}}]},false:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"if",position:[1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"for",position:[1],dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1]}]}]},false:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"text",position:[1,1,0]}]}},default:{}}]}},default:{}},{type:"registerYield",position:[1,3,1],dynamicNodes:[{type:"attr",position:[1,1,1]},{type:"for",position:[1,1,1],dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1,0]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,1,0]}]}},default:{}}]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1,3]},{type:"registerYield",position:[1,5,1],dynamicNodes:[{type:"attr",position:[1,1,1,1]},{type:"text",position:[1,1,1,1,1]},{type:"attr",position:[1,1,1,3]},{type:"if",position:[1,1,1,3],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]},{type:"text",position:[1,2]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"text",position:[1,0]},{type:"text",position:[1,2]}]}},default:{}},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1,5]},{type:"registerYield",position:[1,7,1],dynamicNodes:[{type:"attr",position:[1,1,1,1]},{type:"text",position:[1,1,1,1,1]},{type:"attr",position:[1,1,1,3]},{type:"text",position:[1,1,1,3,0]},{type:"text",position:[1,1,1,3,2]},{type:"componentDynamic",position:[1]}]},{type:"componentDynamic",position:[1,7]}]}},default:{}}],_observedAttributes:["viewType","dropDownDisplayDates","inputDate","diffTime","reminderTime","showReminder","bestTimeToShow","bestTimeToShowEtaa","allTimesLapsed","showDetailedToday","seid","module","type","gmtTime","reminderTimeSetCall","reminderTimeSetText","besttimecomp","dueDate","minimumDate","besttimeshow","isDetailsPage","interval","calendarshow","dropdownshow","dateinMS","dateForMail","calltextdrop","callTextDropDown","callonly","mailonly","storedata","days","months"],data:function(){return{viewType:Lyte.attr("string"),dropDownDisplayDates:Lyte.attr("array"),inputDate:Lyte.attr("string"),diffTime:Lyte.attr("number"),reminderTime:Lyte.attr("array"),showReminder:Lyte.attr("boolean"),bestTimeToShow:Lyte.attr("string"),bestTimeToShowEtaa:Lyte.attr("string"),allTimesLapsed:Lyte.attr("boolean",{default:!1}),showDetailedToday:Lyte.attr("boolean",{default:!1}),seid:Lyte.attr("string"),module:Lyte.attr("string"),type:Lyte.attr("string"),gmtTime:Lyte.attr("object"),reminderTimeSetCall:Lyte.attr("string"),reminderTimeSetText:Lyte.attr("string"),besttimecomp:Lyte.attr("object"),dueDate:Lyte.attr("object"),minimumDate:Lyte.attr("string"),besttimeshow:Lyte.attr("boolean",{default:!1}),isDetailsPage:Lyte.attr("boolean",{default:!1}),interval:Lyte.attr("number"),calendarshow:Lyte.attr("boolean",{default:!1}),dropdownshow:Lyte.attr("boolean",{default:!0}),dateinMS:Lyte.attr("number"),dateForMail:Lyte.attr("number"),calltextdrop:Lyte.attr("array",{default:["Call","Text"]}),callTextDropDown:Lyte.attr("boolean",{default:!1}),callonly:Lyte.attr("boolean",{default:!1}),mailonly:Lyte.attr("boolean",{default:!1}),storedata:Lyte.attr("object"),days:Lyte.attr("array",{default:["crm.best.time.day.short.sunday","crm.best.time.day.short.monday","crm.best.time.day.short.tuesday","crm.best.time.day.short.wednesday","crm.best.time.day.short.thursday","crm.best.time.day.short.friday","crm.best.time.day.short.saturday"]}),months:Lyte.attr("array",{default:["crm.best.time.month.short.january","crm.best.time.month.short.february","crm.best.time.month.short.march","crm.best.time.month.short.april","crm.best.time.month.short.may","crm.best.time.month.short.june","crm.best.time.month.short.july","crm.best.time.month.short.august","crm.best.time.month.short.september","crm.best.time.month.short.october","crm.best.time.month.short.november","crm.best.time.month.short.december"]})}},init:function(){if(Crm.userDetails.isBestTimeEnabledCall||Crm.userDetails.isBestTimeEnabledMail){Crm.userDetails.isBestTimeEnabledCall&&Crm.userDetails.isBestTimeEnabledMail?this.setData("callTextDropDown",!0):Crm.userDetails.isBestTimeEnabledCall&&Crm.userDetails.permissions.Crm_Implied_Create_Calls?(this.setData("callonly",!0),this.setData("type","Call")):Crm.userDetails.isBestTimeEnabledMail&&(this.setData("mailonly",!0),this.setData("type","Text")),"Potentials"===this.getData("module")&&this.setData("module","Contacts"),this.getData("viewType")&&"DetailsPage"!==this.getData("viewType")||(this.setData("dueDate",new Date),this.setDropDownDateDetails(),this.setMinimumDate()),this.getData("type")||this.setData("type","Call");var e=store.findAll("besttime_zia",{id:this.getData("seid"),module:this.getData("module"),type:this.getData("type"),reqDate:this.getData("dueDate").getTime()}),t=this;e.then((function(){var e=store.peekRecord("besttime_zia",t.getData("seid"));e&&(t.setData("storedata",e),t.setDataToThisComponent(e),"DetailsPage"===t.getData("viewType")&&(crmBstTime.setPosition(),t.startInterval()))}))}},actions:{showCalendar:function(e){this.setData("calendarshow",!0),this.setData("dropdownshow",!1)},showRemindMePopup:function(){document.getElementById("BestTimeRemindeMe").ltProp("show",!0)},showDetailsPagePopOver:function(e,t,i){if("DetailsPage"===this.getData("viewType")){this.setData("dateForMail",this.getData("gmtTime")[t]),crmBstTime.detailsPageDate=i,crmBstTime.detailsPageTime=t.match(new RegExp("(\\d+):(\\d+) ?("+I18n.getMsg("AM")+"|"+I18n.getMsg("PM")+"|)"));var a=document.getElementById("BestTimeActivitiesOption");a.ltProp("originElem","#BestTimeValue_"+e),a.ltProp("show",!0)}else{var s=this.getData("viewType");if("CreateTask"===s){var o=$("#Crm_Tasks_RemindAt_Start_Date1_TimeOption");o.val(t).effect("highlight",{},1e3);var n=o.val().split(" ")[0].split(":"),r=n[0],l=n[1];r="PM"===Utils.getMeridiem(o.timeEntry("getTime")).toUpperCase()?parseInt(r)+12:r;var m=crmCalendar.getDateObjectFromGivenDateString($("#Crm_Tasks_RemindAt_Start_Date1").val());m.setHours(r),m.setMinutes(l),$("#Tasks_fldRow_RemindAt_Start_Date1 #Crm_Tasks_RemindAt_Start_Date1").data("dateObj",m)}else"CreateCall"===s&&$("#Crm_Calls_CALLSTARTDATETIME_TimeOption").val(t).effect("highlight",{},1e3);Crm.client_tracking("BestTime - Usage",{Module:this.getData("module"),viewType:s,BestTimeTo:this.getData("type"),DateCri:crmBstTime.getDateCri(m)})}},triggerCreateCall:function(e,t){document.getElementById("BestTimeActivitiesOption").ltProp("show",!1),$L(t).addClass("BT"),crmRelatedList.logCall(e,t),Crm.client_tracking("BestTime - Usage",{Module:this.getData("module"),viewType:"DetailsPage",BestTimeTo:this.getData("type"),DateCri:crmBstTime.getDateCri(crmBstTime.detailsPageDate)})},triggerCreateTask:function(e,t){document.getElementById("BestTimeActivitiesOption").ltProp("show",!1),$L(t).addClass("BT"),crmRelatedList.newTask(e,t),Crm.client_tracking("BestTime - Usage",{Module:this.getData("module"),viewType:"DetailsPage",BestTimeTo:this.getData("type"),DateCri:crmBstTime.getDateCri(crmBstTime.detailsPageDate)})},schedulemail:function(){var e=new Date(this.getData("dateForMail")),t=e.getFullYear(),i=(1+e.getMonth()).toString();i=i.length>1?i:"0"+i;var a=e.getDate().toString(),s=i+"/"+(a=a.length>1?a:"0"+a)+"/"+t+"##"+crmBstTime.detailsPageTime[1]+":"+crmBstTime.detailsPageTime[2]+"##"+crmBstTime.detailsPageTime[3];Crm.client_tracking("BestTime - Usage",{Module:this.getData("module"),viewType:"Schedule Mail-DetailsPage",BestTimeTo:"Text",DateCri:crmBstTime.getDateCri(crmBstTime.detailsPageDate)}),EntSendMail(this.getData("module"),this.getData("seid"),"BestTimeMail",this.getData("module").slice(0,-1),"","","","","",this.getData("dateForMail"),encodeURIComponent(s))},showDayDropDownPopUp:function(){"DetailsPage"===this.getData("viewType")&&(this.setData("dropdownshow",!0),document.getElementById("BestTimeDayDrop").ltProp("show",!0))},onReminderIntiated:function(e,t){var i="Call"===this.getData("type"),a=store.peekRecord("besttime_zia",this.getData("seid")),s=i?a.$.get("bestTime_call")[e].reminder:a.$.get("bestTime_text")[e].reminder;i?a.$.set("bestTime_call["+e+"].reminder",!s):a.$.set("bestTime_text["+e+"].reminder",!s),crmui.hideTooltip(),this.setData("storedata",a);var o=this.getData("gmtTime"),n="Contacts"===this.getData("module")?"-1":"-2",r={seId:this.getData("seid"),reminderTime:this.getData("gmtTime")[t],viewId:n,seModule:this.getData("module")},l=i?this.getData("reminderTimeSetCall"):this.getData("reminderTimeSetText"),m=i?a.$.get("bestTime_call").length:a.$.get("bestTime_text").length;if(s)r.operation="remove",i?this.setData("reminderTimeSetCall",void 0):this.setData("reminderTimeSetText",void 0),this.setData("reminderTimeSet",void 0);else{l&&(r.oldReminderTime=this.getData("gmtTime")[l]);for(var p=0;p<m;p++)p!=e&&(i?a.$.set("bestTime_call["+p+"].reminder",!1):a.$.set("bestTime_text["+p+"].reminder",!1));for(var d in r.reminderTime=o[t],r.operation="add",Crm.client_tracking("BestTime - Usage",{Module:this.getData("module"),viewType:"DetailsPage",BestTimeTo:this.getData("type"),DateCri:"Today"}),r.userTZ=Crm.userDetails.USER_TIME_ZONE,r.timeFormat=Crm.userDetails.TIME_FORMAT,o)o[d]===r.reminderTime&&(i?this.setData("reminderTimeSetCall",d):this.setData("reminderTimeSetText",d),this.setData("reminderTimeSet",d))}this.sendBestTimeReminderRequest(r),document.getElementById("BestTimeRemindeMe").ltProp("show",!1)},changeDateForViewType:function(e){if(document.getElementById("BestTimeDayDrop").ltProp("show",!1),e.setHours(0),e.setMinutes(0),e.setSeconds(0),this.getData("callTextDropDown")){var t=document.getElementById("BestimeDropdown").ltProp("selected");this.setData("type",t.trim())}var i=store.peekRecord("besttime_zia",this.getData("seid"));i&&i.$.deleteRecord(),this.getRecordForEmptyStore(e),"DetailsPage"===this.getData("viewType")&&crmBstTime.setPosition()},showTooltip:function(e){crmui.showTooltip(I18N.getMsg("crm.best.time.set.reminder"),!1,"showOnRight",e)},hideTooltip:function(){crmui.hideTooltip()},EntSendMail:function(){EntSendMail("Leads",this.getData("seid"),"","Lead")}},methods:{closeBestTimeDropDownPopover:function(){this.setData("calendarshow",!1),document.getElementById("BestTimeDayDrop").ltProp("show",!1)},changeType:function(e){var t=e.ltProp("selected");this.setData("type",t.trim());var i=new Date(this.getData("dateinMS"));Crm.client_tracking("BestTime - Switch",{Module:this.getData("module"),viewType:this.getData("viewType"),BestTimeTo:t,DateCri:crmBstTime.getDateCri(i)}),(new Date).getDate()===i.getDate()&&(new Date).getMonth()===i.getMonth()&&(new Date).getYear()===i.getYear()&&(i=new Date);var a="Call"===t,s=store.peekRecord("besttime_zia",this.getData("seid"));s?a?s.bestTime_call?this.getRecord():this.getRecordForEmptyStore(i):s.bestTime_text?this.getRecord():this.getRecordForEmptyStore(i):this.getRecordForEmptyStore(i)},getDiffTime:function(e){if(e=crmBstTime.component){var t=e.getData("gmtTime"),i=e.getData("bestTimeToShow");if(i){var a=t[i],s=-(new Date-new Date(a))/6e4,o=Math.ceil(Math.ceil(s)%60),n=Math.ceil(Math.ceil(s)/60);e.setData("diffTime",s);var r="";0===n?r=0===o?I18n.getMsg("crm.Now"):1===o?I18n.getMsg("crm.best.time.nl.str.minute.only",o):I18n.getMsg("crm.best.time.nl.str.minutes.only",o):1===n?(n-=1,r=1===o?I18n.getMsg("crm.best.time.nl.str.minute.only",o):I18n.getMsg("crm.best.time.nl.str.minutes.only",o)):n>1&&(n-=1,r=0===o?I18n.getMsg("crm.best.time.nl.str.hours.only",n):1===o?I18n.getMsg("crm.best.time.nl.str.both.hours.and.minute",[n,o]):I18n.getMsg("crm.best.time.nl.str.both.hours.and.minutes",[n,o])),e.setData("bestTimeToShowEtaa",r)}else clearTimeout(e.getData("interval")),crmBstTime.component=void 0}},changeDate:function(){var e=(a=arguments[1]).split("/"),t=e[0],i=e[1]-1,a=e[2],s=new Date(t,i,a),o=store.peekRecord("besttime_zia",this.getData("seid"));o&&o.$.deleteRecord(),this.getRecordForEmptyStore(s),this.setData("calendarshow",!1),document.getElementById("BestTimeDayDrop").ltProp("show",!1)}},setDataToThisComponent:function(e){if(void 0!==e.bestTime_all||void 0!==e.bestTime_call||void 0!==e.bestTime_text){var t=$L("#bestTimeToContactDiv"),i=$L("#BestTimeDetailsPage");if(0!==t.length&&t.removeClass("dN"),0!==i.length&&i.removeClass("dN"),"All"===this.getData("type"))this.setData("reminderTime",e.bestTime_all);else{var a="Call"===this.getData("type");this.setData("reminderTime",a?e.bestTime_call:e.bestTime_text)}this.setData("inputDate",e.inputDate),this.setData("dateinMS",e.dateInMS),this.getData("viewType")||this.setData("viewType","DetailsPage"),"DetailsPage"===this.getData("viewType")&&this.setData("isDetailsPage",!0);for(var s=this.getData("reminderTime"),o=!(s.length>0),n=e.inputDate===I18n.getMsg("Today")&&"DetailsPage"===this.getData("viewType"),r={},l=s.length,m=0;m<l;m++)r[s[m].bestTime]=s[m].dateTime.getTime();if(this.setData("gmtTime",r),s.length>0&&n){crmBstTime.detailsPageDate=s[0].dateTime,this.setData("bestTimeToShow",s[0].bestTime);for(l=s.length,m=0;m<l;m++)s[m].reminder&&(a?this.setData("reminderTimeSetCall",s[m].bestTime):this.setData("reminderTimeSetText",s[m].bestTime),this.setData("reminderTimeSet",s[m].bestTime))}this.setData("allTimesLapsed",o),this.setData("showDetailedToday",n),this.setData("besttimeshow",!0),"DetailsPage"===this.getData("viewType")&&(crmBstTime.setPosition(),n&&(crmBstTime.component=this,this.getMethods().getDiffTime(this)))}},startInterval:function(){var e=new Date;e.setMinutes(e.getMinutes()+1),e.setSeconds(0);var t=this;this.setData("interval",setTimeout((function(){crmBstTime.component=t,t.callIntervalUpdate(t)}),e-new Date))},callIntervalUpdate:function(e){e?e.getData("inputDate")===I18n.getMsg("Today")&&e.getData("gmtTime")&&(setInterval(e.getMethods().getDiffTime,6e4),e.getMethods().getDiffTime(e)):clearTimeout(e.getData("interval"))},setMinimumDate:function(){var e=new Date,t=e.getFullYear(),i=(1+e.getMonth()).toString();i=i.length>1?i:"0"+i;var a=e.getDate().toString();a=a.length>1?a:"0"+a,this.setData("minimumDate",t+"/"+i+"/"+a)},setDropDownDateDetails:function(){for(var e=[],t=0,i=0;i<7;i++){var a=new Date;a.setDate(a.getDate()+t++);var s={date:a};s.label=I18n.getMsg(this.getData("days")[a.getDay()])+", "+I18n.getMsg(this.getData("months")[a.getMonth()])+" "+a.getDate(),e.push(s)}e[0].label=I18n.getMsg("Today"),e[1].label=I18n.getMsg("Tommorow"),this.setData("dropDownDisplayDates",e)},getRecord:function(){var e=store.peekRecord("besttime_zia",this.getData("seid"));this.setDataToThisComponent(e)},getRecordForEmptyStore:function(e){var t=this;store.findAll("besttime_zia",{id:this.getData("seid"),type:this.getData("type").toUpperCase(),module:this.getData("module"),reqDate:e.getTime()}).then((function(){t.getRecord()}))},changeDate:function(e){document.getElementById("BestTimeDayDrop").ltProp("show",!1);var t=e.split("/"),i=t[0],a=t[1]-1,s=(e=t[2],new Date(i,a,e)),o=store.peekRecord("besttime_zia",this.getData("seid"));o&&o.$.deleteRecord(),this.getRecordForEmptyStore(s)},changeDateForCreateTask:function(e){$L($("crm-besttime-zia")[0]).show();var t=store.peekRecord("besttime_zia",this.getData("seid"));t&&t.$.deleteRecord(),this.getRecordForEmptyStore(e)},sendBestTimeReminderRequest:function(e){var t=store.findAll("zia_reminder",e),i=this;t.then((function(){if("remove"!==e.operation){var t=store.peekRecord("zia_reminder",i.getData("seid"));t&&("Call"===i.getData("type")?i.setData("reminderTimeSetCall",t.reminderTime):i.setData("reminderTimeSetText",t.reminderTime),i.setData("reminderTimeSet",t.reminderTime))}}))}});
