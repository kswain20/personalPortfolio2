var crmCallsNew={sections:{CallInfo:{sysRefName:"Call Information",divId:"secDiv_Call_Information"},Purpose:{sysRefName:"Purpose Of Outgoing Call",divId:"secDiv_Purpose_Of_Outgoing_Call"},Outcome:{sysRefName:"Outcome Of Outgoing Call",divId:"secDiv_Outcome_Of_Outgoing_Call"},Reason:{sysRefName:"Reason For Incoming Call",divId:"secDiv_Reason_For_Incoming_Call"}},fields:{Call_Duration:"Calls_fldRow_CALLDURATION",Call_Type:"Calls_fldRow_CALLTYPE",Call_StartDate:"Crm_Calls_CALLSTARTDATETIME",Call_StartTime:"Crm_Calls_CALLSTARTDATETIME_TimeOption",Reminder:"Calls_fldRow_REMINDAT",Call_Owner:{fieldRow:"Calls_fldRow_SMOWNERID",dataElement:"Crm_Calls_SMOWNERID",displayNameEl:"ownerNameLookupSpan"}},buttons:{SaveBt:"saveCallBtn",CallBt:"startCallingBtn"},remindBefore:[{value:"0",i18nKey:"None",i18nParams:null,valueInMin:0},{value:"5 mins",i18nKey:"crm.event.remind.mins",i18nParams:[5],valueInMin:5},{value:"10 mins",i18nKey:"crm.event.remind.mins",i18nParams:[10],valueInMin:10},{value:"15 mins",i18nKey:"crm.event.remind.mins",i18nParams:[15],valueInMin:15},{value:"30 mins",i18nKey:"crm.event.remind.mins",i18nParams:[30],valueInMin:30},{value:"1 hrs",i18nKey:"crm.event.remind.hrs",i18nParams:[1],valueInMin:60},{value:"2 hrs",i18nKey:"crm.event.remind.hrs",i18nParams:[2],valueInMin:120},{value:"1 days",i18nKey:"crm.event.remind.day",i18nParams:[1],valueInMin:1440},{value:"2 days",i18nKey:"crm.event.remind.days",i18nParams:[2],valueInMin:2880}],getSections:function(e,a){if(!isNewCallView)return e;var l,t=[];return"Outbound"==a?l=crmCallsNew.sections.Reason.sysRefName:"Inbound"!=a&&"Missed"!=a||(l=crmCallsNew.sections.Outcome.sysRefName),e&&e.each((function(e){e.name===l&&(e.FL&&(e.FL=e.FL.filter((function(e){return"DESCRIPTION"!=e.colname}))),e.splFL&&e.splFL[0]&&(e.splFL[0]=e.splFL[0].filter((function(e){return"DESCRIPTION"!=e.colname})))),t.push(e)})),t},getCallStartTimeWithInfo:function(e,a,l){var t=crmCallsNew.getCallStartCrmDate(e,a,l);return t.whichCall||(t.isFutureTime()?t.whichCall="ScheduledCall":t.whichCall="CompletedCall"),t},getCallStartCrmDate:function(e,a,l){var t=$("#createEditCallPopup"),i=e||t.find("#"+crmCallsNew.fields.Call_StartDate),r=(a||t.find("#"+crmCallsNew.fields.Call_StartTime)).val(),s=i.val().trim(),n=splitDateVal(s),o=r.split(":"),m=n[0],d=n[1],c=n[2],C=o[0],u=o[1],v=null;if(l)v=l.val();else if("HH:mm"!==Crm.userDetails.TIME_FORMAT){var p=o[1].split(" ");u=p[0],v=p[1]}return CrmDateUtils.getCrmDateFromUserTime(d,m,c,C,u,null,v)},initiateCallViaZPB:function(e,a,l,t,i){crmCallsNew.getClick2CallPromise(a,l,t,i).then((function(t){ZPB.clickToDial.trigger(e,l,a,t)}))},getClick2CallPromise:function(e,a,l,t){return isNaN(t)&&(t=void 0),isNewCallView&&CTIAPI.CTI.showC2Cform&&validationUtils.isEmpty(t)?new Promise((function(t,i){var r=function(e){e?t():(Calls.c2cResolveFun=t,Calls.c2cRejectFun=i)},s={};validationUtils.isNotEmpty(e)&&validationUtils.isNotEmpty(a)&&validationUtils.isNotEmpty(l)&&(s="Contacts"===a?{Who_Id:{id:e,name:l},$se_module:"Contacts"}:{What_Id:{id:e,name:l},$se_module:a});var n=networkUtils.returnDependencyFiles(["crm-call-menu.js","crm-manual-call-list.js"],crmConstants.jsStaticPathForLyte),o=networkUtils.returnDependencyFiles(["crm-call-menu.css"],crmConstants.cssStaticPathForLyte),m=networkUtils.returnDependencyFiles([networkUtils.getI18nJSUrl("manualcalllist")],crmConstants.jsStaticPath),d=n.concat(o).concat(m);Lyte.injectResources(d,void 0,(function(){Lyte.registeredMixins["crm-call-form-mixin"].initCallForm("Click2Call_Form",r,s)}))})):(validationUtils.isNotEmpty(t)&&(i=JSON.stringify({isActivityCreated:!0,callActivityId:t})),new Promise((function(e){e(i)})));var i},validateEntity:function(e,a,l,t,i,r){var s,n=!0,o={result:!0},m=r||a;if(e.length){var d=e.data(),c=d.name,C=d.uitype+"";s="string"==typeof(s=commonUtils.getValue(e))?s.trim():s;var u=d.colname,v=d.oldValue,p=d.mandate+"",f=Crm.getSaveParamName(e,l,a),_=e.data();C+="";var T={};if("true"===p&&"ADDCOMMENT"===u&&validationUtils.isFieldEmpty(e)&&!/create|clone/.test(window[a].currentStatus)?(o.mandateFailed=!0,n=!1):"true"!=p||"HANDLER"!==u&&"221"!=C||e.data("id")?"true"===p&&("duration"!==u&&"durationUnit"!==u||!$("#Crm_Consents_duration_radio1").prop("checked"))&&validationUtils.isFieldEmpty(e)&&"HANDLER"!==u&&"221"!==C&&"SMOWNERID"!==u&&"ADDCOMMENT"!==u&&(o.mandateFailed=!0,n=!1):(o.mandateFailed=!0,n=!1),n||""!=s)switch(C){case"27":case"555":case"42":case"123":case"41":default:break;case"33":case"35":validationUtils.isValidPhoneNo(e,e.val())||(o.checkFailed=!0,n=!1);break;case"34":case"38":var y=d.maxlength-(F=d.decimalLength);if(validationUtils.isValidDecimal(s,y,F))validationUtils.decimalLengthCheck(s,F)||(o.decimalLengthCheckFailed=!0,n=!1);else o.checkFailed=!0,n=!1;break;case"32":case"52":""===s||validationUtils.isValidInteger(s)||(o.integerFailed=!0,n=!1);break;case"1":case"2":"-None-"===s&&(s=""),"CALLDURATION"===u&&(""===s||validationUtils.isValidInteger(s)?(s=parseInt(s,10),/^\d{1}$/.test(s)&&(s="0"+s)):(o.integerFailed=!0,n=!1));break;case"100":s||(s=""),s&&(s=s.join(";"));break;case"17":s=t.find("input[type='radio'][name='"+c+"']:checked").val();break;case"18":t.find("."+d.colname).each((function(){this.checked&&(T[this.name]="on")}));break;case"21":var h=e.val().trim();validationUtils.isValidWebUrl(h)||(o.checkFailed=!0,n=!1);break;case"22":var I=e.val().trim();validationUtils.isValidTwitter(I)||(o.checkFailed=!0,n=!1);break;case"25":h=e.val().trim();validationUtils.isValidEmail(h)||(o.checkFailed=!0,n=!1);break;case"301":case"300":s=e.is(":checked")?"on":"";break;case"24":case"14":case"786":case"30":case"333":if(s=s.replace(Crm.userDetails.DATE_PATTERN,""),"24"!=C)var N=t.find("#"+e.attr("id")+"_TimeOption").val().split(" ")[0];if(d.mandate+""=="true"&&"24"!=C&&""==N&&(n=!1,o.mandateFailed=!0),""==s||Utils.isValidDate(Crm.userDetails.DATE_PATTERN,s)||(o.checkFailed=!0,n=!1),("786"==C||"30"==C||"14"==C||"333"==C)&&""!=s&&""!=N){var g=N.split(":"),D=Utils.getMeridiem(t.find("#"+e.attr("id")+"_TimeOption").timeEntry("getTime")).toUpperCase(),E=g[0],w=g[1];Utils.isValidTime(E,w)||(o.checkFailed=!0,n=!1),E&&(T[f.substring(0,f.indexOf(")"))+"hour)"]=E),w&&(T[f.substring(0,f.indexOf(")"))+"minute)"]=w),D&&"HH:mm"!==Crm.userDetails.TIME_FORMAT&&(T[f.substring(0,f.indexOf(")"))+"ampm)"]=D);var O=s+" "+E+":"+w;"HH:mm"!==Crm.userDetails.TIME_FORMAT&&(O=O+" "+D),i[u]=crmCallsNew.getColumnParamsObj(c,C,O)}break;case"Time":Utils.isValidTime(e.val())||(n=!1);break;case"221":s=e.data().id;break;case"8":s=e.val(),T["property(ownerId)"]=e.data().id,T["property(ownerName)"]=t.find("#ownerNameLookupSpan").text(),i[u]=crmCallsNew.getColumnParamsObj(c,C,e.data().id);break;case"208":T["property(Layout)"]=e.val();break;case"55":s=e.val(),T["property(ownerName:Handler)"]=e.data().id,i[u]=crmCallsNew.getColumnParamsObj(c,C,e.data().id);break;case"4":case"5":case"6":case"7":case"9":case"10":case"12":case"13":case"15":case"133":(s=e.data("id"))&&"null"!=s?s+="":s="";var b=t.find("#Crm_"+m+"_SEID_label_select").val()||t.find("#Crm_"+m+"_SEID_select").val(),k=t.find("#Crm_"+m+"_SEID"),A="$se_module";if((P=t.find("#Crm_"+m+"_CONTACTID_WhoId_select").val())||(T["property(modsel)"]=b,T["property(modname)"]=k.val(),""!=trimBoth(k.val())&&(T["property(modid)"]=k.data("id"))),/Events|Calls|Tasks/.test(a)&&"CONTACTID"==u&&P&&"None"!=P){var L=t.find("#Crm_"+m+"_CONTACTID").val();"Leads"==P||"Contacts"==P||"Accounts"==P?(T["property(leContModId)"]=s,T["property(leContModSel)"]=P,T["property(leContModName)"]=L,T["property(modsel)"]=b,T["property(modname)"]=k.val(),""!=trimBoth(k.val())&&(T["property(modid)"]=k.data("id")),"Contacts"===P?i[u]=crmCallsNew.getColumnParamsObj(c,C,e.data().id):"Leads"===P&&(i.SEID=crmCallsNew.getColumnParamsObj(c,C,e.data().id),i.$se_module=crmCallsNew.getColumnParamsObj(A,void 0,P))):"Others"==P?(T["property(modsel)"]=b,T["property(modname)"]=k.val(),""!=trimBoth(k.val())&&(T["property(modid)"]=k.data("id"))):"PhoneNumbers"==P&&(T["property(Customer Number)"]=L),s=void 0}else if("SEID"==u)i.$se_module||(i[u]=crmCallsNew.getColumnParamsObj(c,C,e.data().id),i.$se_module=crmCallsNew.getColumnParamsObj(A,void 0,b)),s=void 0;else{var M="true"==_.customfield?_.colname:_.name;T["property("+M+")"]=e.val()}if("Calls"===a&&isNewCallView&&"CONTACTID"===u&&validationUtils.isEmpty(T["property(leContModId)"]))if("ScheduledCall"==crmCallsNew.getCallStartTimeWithInfo(t.find("#Crm_Calls_CALLSTARTDATETIME"),t.find("#Crm_Calls_CALLSTARTDATETIME_TimeOption")).whichCall){var R=I18n.getMsg("crm.call.callto.empty.check.qcreate");renderingUtils.showCustomAlert(R),n=!1}break;case"444":var S="";(s=e.data("id"))&&"null"!=s||(s=e.data("selectedid"))&&"null"!=s||(s=""),e.data("unselectedid")&&(S=e.data("unselectedid")),s=s+"-"+S;var P;b=t.find("#Crm_"+m+"_SEID_label_select").val()||t.find("#Crm_"+m+"_SEID_select").val(),k=t.find("#Crm_"+m+"_SEID");if("Tasks"===a||"Calls"===a)(P=t.find("#Crm_"+m+"_CONTACTID_WhoId_select").val())||(T["property(modsel)"]=b,T["property(modname)"]=k.val(),""!=trimBoth(k.val())&&(T["property(modid)"]=k.data("id")));if(/Events|Calls|Tasks/.test(a)&&"CONTACTID"==u&&P&&"None"!=P)"Leads"==P||"Contacts"==P?(T["property(leContModId)"]=s,T["property(leContModSel)"]=P,T["property(leContModName)"]=t.find("#Crm_"+m+"_CONTACTID").val(),T["property(modsel)"]=b,T["property(modname)"]=k.val(),""!=trimBoth(k.val())&&(T["property(modid)"]=k.data("id"))):"Others"==P&&(T["property(modsel)"]=b,T["property(modname)"]=k.val(),""!=trimBoth(k.val())&&(T["property(modid)"]=k.data("id"))),s=void 0;else if("SEID"==u)s=void 0;else if(-1!=u.indexOf("MXNDUMMYCOLUMN")){M="true"==_.customfield?_.colname:_.name;T["property("+M+")"]=s}else{M="true"==_.customfield?_.colname:_.name;T["property("+M+")"]=e.val()}if("Calls"===a&&isNewCallView&&"CONTACTID"===u&&validationUtils.isEmpty(T["property(leContModId)"]))if("ScheduledCall"==crmCallsNew.getCallStartTimeWithInfo(t.find("#Crm_Calls_CALLSTARTDATETIME"),t.find("#Crm_Calls_CALLSTARTDATETIME_TimeOption")).whichCall){R=I18n.getMsg("crm.call.callto.empty.check.qcreate");renderingUtils.showCustomAlert(R),n=!1}break;case"1234":var U=t.find("#Crm_"+a+"_REMINDAT").val();U&&"none"!=U&&"0"!=U&&(T.remCheckTask="on",T.remTime=U,T.remTaskRepeat="none");break;case"143":case"144":case"145":case"36":var F;y=d.maxlength-(F=d.decimalLength);if(s&&!currencyUtils.isValidCurrency(s,y,F))return o.checkFailed=!0,o.result=!1,o;validationUtils.decimalLengthCheck(s,F)||(o.decimalLengthCheckFailed=!0,n=!1)}if(null!=s&&"555"!=C&&(T[f]=s,u&&!i[u]&&("300"!==C&&"301"!==C||(s="on"===s),i[u]=crmCallsNew.getColumnParamsObj(c,C,s))),"Calls"===a&&"CALLDURATION"==u){O=t.find("#Crm_Calls_CALLDURATION_Mins").val()+":"+t.find("#Crm_Calls_CALLDURATION_Secs").val();i[u]=crmCallsNew.getColumnParamsObj(c,C,O),T["property(Call Duration)"]=O}s!==v&&(Crm.isRecordModified=!0)}return o.paramvalues=T,o.result=n,o},validateEntityAndShowErrorMsg:function(e,a,l,t,i,r){a=a||{},l=l||{};var s,n={},o="Calls";e.find(".mandatory").removeClass("mandatory");var m=!0,d=!0;return Calls.fieldSet.forEach((function(i){var m=e.find("#"+i);if(m.length){var c=m.data();if("116"==c.uitype||"117"==c.uitype||"RECURRING_WEEKLY_REPEAT"===m.colname)return;if((void 0===c.restricted||void 0!==c.restricted&&!c.restricted)&&c.readonly)return;if(isNewCallView&&!m.is(":visible")&&"SUBJECT"!=c.colname)return;var C=c.name,u=c.displaylabel;e.find("#errorMsg_"+m.attr("id")).remove(),m.closest(".tabDiv,.tabDivCreate").removeClass("errorFieldP"),"786"===c.uitype&&e.find("#"+i+"_TimeOption").closest(".tabDiv,.tabDivCreate").removeClass("errorFieldP");var v=crmCallsNew.validateEntity(m,o,true,e,n,t);for(var p in v.paramvalues)a[p]=v.paramvalues[p];var f=r||0;for(var _ in n)if(n.hasOwnProperty(_)){var T=0==f?"columnName":"columnName"+f,y=0==f?"fieldValue":"fieldValue"+f,h=0==f?"fieldLabel":"fieldLabel"+f,I=n[_];l[T]=_,l[y]=I.paramValue,l[h]=I.fieldLabel,f++}!(d=v.result?d:v.result)&&!s&&m&&m[0]&&(s=m),Crm.showErrorMessage(v,m,o,C,u,c)}})),m=!!d&&m,s&&("SELECT"===s[0].nodeName?(s.focus(),s.select2("open")):s.focus()),m},getColumnParamsObj:function(e,a,l){var t={};return t.fieldLabel=e,t.uitype=a,t.paramValue=l,t},submitCreate:function(){var e=$("#saveCallBtn"),a=$("#startCallingBtn"),l=$("#c2cResolveBtn");return e.is(":visible")?e.click():a.is(":visible")?a.click():l.is(":visible")&&l.click(),!1},filterBestTimeClicked:function(e){var a=$(e),l=a.parent();l.find("li:not(.bestTime)").toggle(),l.find("ul").scrollTop(0);var t=a.data("hovermessage");t=t===I18n.getMsg("crm.best.time.tooltip.show.best.time")?I18n.getMsg("crm.best.time.tooltip.show.all.time"):I18n.getMsg("crm.best.time.tooltip.show.best.time"),a.data("hovermessage",t)},filterBestTimeHovered:function(e){var a=$(e).data("hovermessage");crmui.showTooltip({content:a,position:"showOnRight"})}};