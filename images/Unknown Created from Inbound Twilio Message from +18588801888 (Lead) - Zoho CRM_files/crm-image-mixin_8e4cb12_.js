Lyte.Mixin.register("crm-image-mixin",{changeUsedName:function(e,t){var a,i,r=this.getData("usedNames"),n=1,o=e,s=o.lastIndexOf(".");if(o=e.substring(0,s),void 0===t&&(t=e.substring(s,e.length)),!r.includes(e))return o+t;a=e.lastIndexOf("("),i=e.lastIndexOf(")");var d=e.substring(a+1,i);return 0!==Number(d)&&Number.isInteger(Number(d))?n=parseInt(d)+1:(a=-1,i=-1),-1!==a&&-1!==i&&(o=e.substring(0,a)),o+"("+n+")"+t},checkNameAvailability:function(e){return!!this.getData("usedNames").includes(e)},convertStreamToActualSize:function(e){var t,a,i,r,n,o,s;if(a=0,i="B",e>0){for(t=o=0,s=(n=["TB","GB","MB","KB","B"]).length;o<s;t=++o)if(r=n[t],e>=Math.pow(1024,4-t)){a=e/Math.pow(1024,4-t),i=r;break}a=Math.round(10*a)/10}return a+" "+i},convertAllFormatsToMBCount:function(e){var t,a=e;return-1!==e.indexOf("MB")?t=Number(a.substring(0,a.length-2)):-1!==e.indexOf("KB")?t=Number(a.substring(0,a.length-2))/1024:-1!==e.indexOf("B")&&(t=Number(a.substring(0,a.length-1))/1048576),t},setModifiedDetails:function(e,t,a,i){for(var r=this.getData("previewPageChanges"),n=r.length,o=0;o<n;o++)if(r[o].uploadid===e)return void 0!==t&&(r[o].name=t),void 0!==a&&(r[o].description=a),void(void 0!==i&&(r[o].encryptedUploadId=i));var s={};void 0!==t&&(s.name=t),void 0!==a&&(s.description=a),void 0!==i&&(s.encryptedUploadId=i),s.uploadid=e,s.fieldId=this.getData("fieldid"),r.push(s),this.setData("previewPageChanges",r)},retreiveNameData:function(e,t,a){for(var i=[].concat(this.getData("imageData")),r=i.length,n=0;n<r;n++)if(e===i[n].uploadid){if(void 0!==i[n].uploadedValues){var o=JSON.parse(i[n].uploadedValues);o.fileName=t,i[n].uploadedValues=JSON.stringify(o)}this.setModifiedDetails(e,t,void 0,void 0),i[n].filename=t;break}this.setData("imageData",i),a&&this.setData("imageView",i)},retreiveDescriptionData:function(e,t,a){for(var i=[].concat(this.getData("imageData")),r=i.length,n=0;n<r;n++)if(e===i[n].uploadid){if(void 0!==i[n].uploadedValues){var o=JSON.parse(i[n].uploadedValues);o.description=t,i[n].uploadedValues=JSON.stringify(o)}this.setModifiedDetails(e,void 0,t,void 0),i[n].description=t;break}this.setData("imageData",i),a&&this.setData("imageView",i)},retreiveCropData:function(e,t,a){for(var i=[].concat(this.getData("imageData")),r=i.length,n=this.getData("maxUploadedSize"),o=0;o<r;o++)if(e===i[o].uploadid){var s=this.convertStreamToActualSize(i[o].stream);void 0!==t.uploadedValues?(i[o]=t,i[o].encryptedUploadId=t.encryptedUploadId):(i[o].src=t.src,i[o].original_src=t.original_src,i[o].stream=t.stream,i[o].fileId=t.fileId,i[o].size=this.convertStreamToActualSize(t.stream)),this.setModifiedDetails(e,void 0,void 0,t.encryptedUploadId);var d=Number(n)-Number(this.convertAllFormatsToMBCount(s));n=d<0?0:d,n=Number(n)+Number(this.convertAllFormatsToMBCount(this.convertStreamToActualSize(t.stream)));break}this.setData("imageData",i),a&&this.setData({maxUploadedSize:n,barsize:n/20*100,imageView:i})},isInViewport:function(e){if(e){var t=$L(window).scrollTop(),a=renderingUtils.windowHeight,i=t+a,r=$L(e),n=r.offset().top,o=r.height(),s=top+o;return n>=t&&n<i||s>t&&s<=i||o>a&&n<=t&&s>=i}},makeRequestForThumbnail:function(){Lyte.objectUtils(this.getData("configuration"),"add","DOMConstructed",!0);var e=this;if(!0===this.getData("thumbnailRequest")){var t=Crm.getCrmBasePath()+"/EntityImageAttach.do?actionName=getGroupedThumbnailImages&fieldId="+this.getData("fieldid")+"&parentId="+this.getData("entityId")+"&module="+$ESAPI.encoder().encodeForURL(this.getData("module"))+"&allImages=false";t=Crm.getPortalURL(t),$L.ajax({url:t,type:"GET",dataType:"JSON",processData:!1,contentType:!1,success:function(t){var a=e.getData("imageData");if(a){var i=a.length,r=[];for(var n in t)for(var o=0;o<i;o++)if(n===a[o].uploadid){!1===t[n]&&null===a[o].state?r.push(a[o]):a[o].src=t[n];break}for(n=0;n<i;n++)Lyte.arrayUtils(e.getData("imageData"),"replaceAt",n,a[n]);r.length>0?e.fetchThumbnails(r,0).then((function(t){for(var r=t.length,n=0;n<i;n++)for(var o=0;o<r;o++)if(a[n].uploadid===t[o].uploadid){Lyte.arrayUtils(a,"replaceAt",n,t[o]);break}e.imagesLoaded()})):e.imagesLoaded()}}})}else this.imagesLoaded()},fetchThumbnails:function(e,t){var a=this;return new Promise((function(i){t>e.length-1&&i(e),a.constructSizeMinimizedImage(e[t].original_src).then((function(r){e[t].src=r.url,a.fetchThumbnails(e,t+1).then((function(){i(e)}))}))}))},getMimeTypeFromExtn:function(e){switch(e){case".jpg":return"image/jpeg";case".png":return"image/png";case".jpeg":return"image/jpeg";case".bmp":return"image/bmp";case".gif":return"image/gif"}},checkForFailedUploads:function(e){for(var t=e.length,a=!1,i=0;i<t;i++)if(!0===e[i].failed){a=!0;break}return a},constructImageUrl:function(e,t,a,i,r,n){if("processing"!==n&&"system_rejected"!==n&&"waiting_for_approval"!==n){var o=r.replace(/ /g,"+"),s=Crm.getCrmBasePath()+"/ViewImage?fileId="+e+"&module="+t+"&parentId="+a+"&id="+i+"&name="+encodeURIComponent(o)+"&downLoadMode=inline";return s=Crm.getPortalURL(s)}},constructSizeMinimizedImage:function(e){return new Promise((function(t){var a=new Image;a.addEventListener("load",(function(){var e=a.width,i=a.height;e>i?e>400&&(i*=400/e,e=400):i>300&&(e*=300/i,i=300);var r=document.createElement("canvas");r.width=e,r.height=i;var n=r.getContext("2d");n.imageSmoothingEnabled=!1,Lyte.injectResources([networkUtils.returnDependencyFiles(["exif-plugin.js"],crmConstants.jsStaticPathForLyte)],void 0,function(){$L.exif({target:a,getData:function(o){var s=o.exifdata.Orientation,d=$L(".temporaryImageOrientationCheck")[0];if(void 0!==d&&"from-image"!==getComputedStyle(d).imageOrientation)switch(s){default:n.drawImage(a,0,0,e,i);break;case 6:r.width=a.height,r.height=a.width,n.rotate(90*Math.PI/180),n.drawImage(a,0,-a.height);break;case 8:r.width=a.height,r.height=a.width,n.rotate(-90*Math.PI/180),n.drawImage(a,-a.width,0);break;case 3:r.width=a.width,r.height=a.height,n.rotate(Math.PI/180*180),n.drawImage(a,0,0,-a.width,-a.height)}else n.drawImage(a,0,0,e,i);n.drawImage(a,0,0,e,i);var u=r.toDataURL("image/jpeg");t({url:u,status:"ok"})}})}.bind(this))})),a.addEventListener("error",(function(){t({url:void 0,status:"ok"})})),a.src=e}))},rearrangeSequenceComplete:function(e){for(var t=this.getData("imageData"),a=t.length,i=e,r=i.length,n=1,o=this.getData("sequenceChanges"),s=0;s<r;s++)for(var d=i[s].id,u=0;u<a;u++)if(t[u].uploadid===d){if(t[u].sequence=n++,void 0!==t[u].uploadedValues){var l=JSON.parse(t[u].uploadedValues);l.sequence=t[u].sequence,t[u].uploadedValues=JSON.stringify(l)}else o[t[u].uploadid]=t[u].sequence;break}t.sort((function(e,t){return e.sequence-t.sequence}));for(s=0;s<a;s++)Lyte.arrayUtils(t,"replaceAt",s,t[s]);this.setData("sequenceChanges",o),this.getMethods("onImageSequenceChange")&&this.executeMethod("onImageSequenceChange",t)},fetchDeletedImageIdsPopup:function(e){for(var t=e.length,a=this.getData("tempRemovedIds"),i=a.length,r=this.getData("removedIds"),n=0;n<i;n++)for(var o=0;o<t;o++)if(e[o].uploadid===a[n]){r.push(a[n]);break}this.setData("removedIds",r)},fetchPreviewPageChangesPopup:function(e){if(void 0!==e&&e.length>0)for(var t=e.length,a=0;a<t;a++){var i,r,n;void 0!==e[a].name&&(i=e[a].name),void 0!==e[a].description&&(r=e[a].description),void 0!==e[a].encryptedUploadId&&(n=e[a].encryptedUploadId),this.setModifiedDetails(e[a].uploadid,i,r,n)}},sortImagesComplete:function(e){return e.sort((function(e,t){return e.sequence-t.sequence})),e},constructAPIRequestBody:function(){var e=[],t=this.getData("removedIds");if(t.length>0)for(var a=t.length,i=0;i<a;i++){(d={}).id=t[i],d._delete=null,e.push(d)}var r=this.getData("imageData"),n=this.getData("previewPageChanges"),o=n.length;if(r.length>0){var s=r.length;for(i=0;i<s;i++){var d={};void 0!==r[i].uploadedValues?d.Encrypted_Id=r[i].encryptedUploadId:d.id=r[i].uploadid,d.Sequence_Number=r[i].sequence;for(var u=0;u<o;u++)if(n[u].uploadid===r[i].uploadid){void 0!==n[u].name&&(d.File_Name=n[u].name),void 0!==n[u].description&&(d.Description=n[u].description),void 0!==n[u].encryptedUploadId&&(d.Encrypted_Id=n[u].encryptedUploadId);break}e.push(d)}}return e},addUsedImageNames:function(e,t){var a=[].concat(this.getData("usedNames"));void 0!==t&&a.removeLastOccurenceOfElement(t),a.includes(e)||a.push(e),this.setData("usedNames",a)},openFeaturePopup:function(e,t,a,i,r){if(null!==a&&"Image_Validation"===e.getData("parentFeature")){if("processing"===a)return void detailView.renderVisionErrorPopUp("image_processing");if("waiting_for_approval"===a||"system_rejected"===a){var n=[];n=(n=(n=n.concat(networkUtils.returnDependencyFiles(["crm-image-upload-ziaError.js","crm-vision-helper.js"],crmConstants.jsStaticPathForLyte))).concat(networkUtils.returnDependencyFiles(["crm-image-upload-ziaError.css"],crmConstants.cssStaticPathForLyte))).concat(Crm.getVisionMyJobsDependency());var o=e.getData("apiName");o||(o=store.peekRecord("field",e.getData("fieldid")).api_name),Lyte.injectResources(n,void 0,function(){e.renderVisionErrorPopUpForOtherFields(r,!0,e.getData("module"),i,e.getData("entityId"),t,o,"system_rejected"===a?"do_not_create":void 0)}.bind(e))}}}}),Lyte.Component.registerHelper("renderNameToolTip",(function(e){if(e){var t=e.substring(0,e.lastIndexOf(".")),a=e.substring(e.lastIndexOf("."),e.length);return Crm.userDetails.RTL_ENABLED?a.substring(1,a.length)+"."+t:t+a}return e})),Lyte.Component.registerHelper("getNameHeadFromFileName",(function(e){return void 0!==e?-1!==e.lastIndexOf(".")?e.substring(0,e.lastIndexOf(".")):e.substring(0,e.length-1):e})),Lyte.Component.registerHelper("getExtnFromFileName",(function(e){return e.substring(e.lastIndexOf("."),e.length)}));
